"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var i=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>i.length)&&(t=i.length),t-=e.length;var n=i.lastIndexOf(e,t);return-1!==n&&n===t}),function(){var e=angular.module("serviceExpert",["uiGmapgoogle-maps","angularMoment","ui.bootstrap","chart.js","MstResolver"]);e.run(["amMoment",function(e){e.changeLocale(userLocale)}]),e.config(["$sceDelegateProvider","$compileProvider","MstResolverProvider",function(e,t,i){var n=null,r=_.debounce(window.scheduler.updateView,100).bind(window.scheduler);window.updateViewDebounced=function(){n||0!==document.body.clientWidth?0!==document.body.clientWidth&&(n&&(clearInterval(n),n=null),r()):n=setInterval(window.updateViewDebounced,1e3)},debugMode||t.debugInfoEnabled(!1),i.setConfig({fslOperationRemoteAction:RemoteActions.getFslOperation,getAsyncApexJobRemoteAction:RemoteActions.getAsyncApexJob,apiVersion:"41.0",fieldNames:fieldNames.FslOperation,autoConnect:!1}),e.resourceUrlWhitelist(["self","https://**.force.com"])}])}(),angular.module("serviceExpert").controller("ctrlGantt",["$scope","$rootScope","$q","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","DeltaService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","RegisterService","OptimizationRequestsService",function(c,r,e,l,p,v,t,i,s,n,m,h,g,a,o,d,u,f,S,y,b,T,w,L,C,A,D,I,k,R,F,M,x){var O="",P="",E={},N=!0,G=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),V=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});function H(){c.currentViewOptions.numOfMonths<=2?(scheduler.matrix.LongView.x_unit="day",scheduler.matrix.LongView.x_length=7,scheduler.matrix.LongView.x_size=30*c.currentViewOptions.numOfMonths):(scheduler.matrix.LongView.x_unit="week",scheduler.matrix.LongView.x_size=Math.ceil(4.5*c.currentViewOptions.numOfMonths),scheduler.matrix.LongView.x_length=1)}G.setOverflowHeight(15),V.setOverflowHeight(15),c.selectedGanttServices={},c.resourceFilterHelper=s,c.StateService=g,c.resources=[],c.searchEmployee="",c.resourceFieldToSortyBy="Name",c.successfullyScheduled=0,c.currentSchedulingIndex=0,c.ganttLocked=i.GetUserSettingsProperty("Lock_Gantt__c")||!1,c.timelineName="",c.nowTimespans=[],c.selectedSkills={},c.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),c.hasCustomPermission=v.hasCustomPermission,c.crewViewActive=!1,c.crewsFilter=v.crewsFilter,c.useResourceSkillFilter=useResourceSkillFilter,c.numberOfDaysInUtilizationView=14,c.skillsLogicOperator=i.GetUserSettingsProperty("Skills_Logic_Operator__c")||"and",c.editPalette=v.hasCustomPermission("Gantt_Palettes_Edit"),c.viewPalette=v.hasCustomPermission("Gantt_Palettes_View"),scheduler.attachEvent("onTemplatesReady",function(){scheduler.matrix.MonthlyView&&(scheduler.matrix.MonthlyView.x_size=i.GetUserSettingsProperty("DaysInUtilizationView__c")||14,c.numberOfDaysInUtilizationView=scheduler.matrix.MonthlyView.x_size),H()}),c.currentViewOptions={highlightWeekeneds:i.GetUserSettingsProperty("Highlight_Weekeneds__c")||!1,minServiceDuration:void 0===i.GetUserSettingsProperty("Longterm_Min_Service_Duration__c")?8:i.GetUserSettingsProperty("Longterm_Min_Service_Duration__c"),minNaDuration:void 0===i.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c")?8:i.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c"),numOfMonths:i.GetUserSettingsProperty("Longterm_Num_Of_Months__c")||1,showMdt:i.GetUserSettingsProperty("Show_Only_MDT_In_Longterm__c")||!1},window.__currentViewOptions=c.currentViewOptions,c.saveMdtFilterSa=_.debounce(function(){i.SetUserSettingsProperty("Show_Only_MDT_In_Longterm__c",c.currentViewOptions.showMdt),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&c.getTimePhasedObjects()},400),c.saveHighlightWeekends=_.debounce(function(){i.SetUserSettingsProperty("Highlight_Weekeneds__c",c.currentViewOptions.highlightWeekeneds),updateViewDebounced()},400),c.saveMinimumLongtermServiceDuration=_.debounce(function(){i.SetUserSettingsProperty("Longterm_Min_Service_Duration__c",c.currentViewOptions.minServiceDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&c.getTimePhasedObjects()},400),c.saveMinimumLongtermAbsenceDuration=_.debounce(function(){i.SetUserSettingsProperty("Longterm_Min_Absence_Duration__c",c.currentViewOptions.minNaDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&c.getTimePhasedObjects()},400),c.handleLongTermViewSizeChange=_.debounce(function(){var e=i.GetUserSettingsProperty("Longterm_Num_Of_Months__c");c.currentViewOptions.numOfMonths||(c.currentViewOptions.numOfMonths=1),i.SetUserSettingsProperty("Longterm_Num_Of_Months__c",c.currentViewOptions.numOfMonths),H(),"LongView"===scheduler._mode&&scheduler.setCurrentView(),e<c.currentViewOptions.numOfMonths&&c.getTimePhasedObjects()},200),c.shouldShowSkill=function(e,t){return e.toUpperCase().includes(t.toUpperCase())},c.saveUserPropSkillsLogic=function(){i.SetUserSettingsProperty("Skills_Logic_Operator__c",c.skillsLogicOperator)},c.paletteViewActive=!1,c.showPaletteView=function(){window.paletteViewActive=!0,c.paletteViewActive=!0,updateViewDebounced()},c.hidePaletteView=function(){window.paletteViewActive=!1,c.paletteViewActive=!1,updateViewDebounced()},c.$watch("StateService.isLoadingNewLocations",function(e,t){void 0!==t&&!1!==t||1!=e||(c.paletteViewActive=!1)}),r.statusTranslations=v.statusTranslations,r.$on("moveToCrewView",function(){c.crewViewActive=!0,h.isCrewViewActive=!0}),c.$watch("resourceFilterHelper",function(e,t){$("#resourceExplainCrap").html(c.resourceFilterHelper.generateFilterExplanation(c.resourceFilters.showWorkingResource)),angular.equals(e,t)||i.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:c.resourceFilterHelper.resourceFieldToSortyBy,asc:c.resourceFilterHelper.descending,showWorkingResource:c.resourceFilters.showWorkingResource,booleanFields:c.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:c.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:c.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:c.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:c.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:c.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),d.getEmployeeAbsenceTypes().then(function(e){c.nonAvailabilityTypes=e,c.defaultDragNa={selectedNaDuration:JSON.parse(i.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:i.GetUserSettingsProperty("Drag_Na_Type__c")||c.nonAvailabilityTypes[Object.keys(c.nonAvailabilityTypes)[0]],selectedNaLabel:i.GetUserSettingsProperty("Drag_Na_Label__c")}}),c.businessHoursRange={start:v.ganttSettings.startHour,end:v.ganttSettings.finishHour,includeWeekends:i.GetUserSettingsProperty("Include_Weekends__c")},c.resourceFilters={showWorkingResource:!!JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c"))&&JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource,resourcesWorkingInRange:{}},c.isInConsole=g.isInConsole,c.openConsoleTab=v.openConsoleTab,c.capacityFields=n.capacityCalculationFields,Object.defineProperty(c.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e=[];for(var t in this)this[t]&&e.push(t);return e}}),c.isGanttFilterApplied=function(){return v.crewsFilter||c.skillsFilter||s.isResourceFilterApplied()||c.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var B=!0;function U(){if(B)B=!1;else{setHoursToDisplay(c.businessHoursRange.start,c.businessHoursRange.end,c.businessHoursRange.includeWeekends),scheduler.setCurrentView(),v.ganttSettings.startHour=c.businessHoursRange.start,v.ganttSettings.finishHour=c.businessHoursRange.end;var e={};e.Gantt_View_Start_Hour__c=v.ganttSettings.startHour,e.Gantt_View_Finish_Hour__c=v.ganttSettings.finishHour,e.Include_Weekends__c=c.businessHoursRange.includeWeekends,i.SetUserSettingProperties(e)}}function z(e,t){""===t&&(t=prompt(customLabels.msg_to_post_to_chatter,"")),null!==t&&(""!==t?(1===e.length&&(p.recentlyUsed[e[0]]=!0),p.postToChatter(e,t).then(function(e){})):alert(customLabels.no_empty_msg_to_chatter))}c.$watchCollection("businessHoursRange",U),m.promises.resources().then(function(){c.resources=m.getResources}),c.saveDragNaDefaults=function(e){switch(e){case"duration":i.SetUserSettingsProperty("Drag_Na_Duration__c",c.defaultDragNa.selectedNaDuration);break;case"type":i.SetUserSettingsProperty("Drag_Na_Type__c",c.defaultDragNa.selectedNaType);break;case"label":i.SetUserSettingsProperty("Drag_Na_Label__c",c.defaultDragNa.selectedNaLabel)}},c.getTimePhasedObjects=function(e){var t=scheduler.getState().min_date,i=scheduler.getState().max_date,n=864e5;return"LongView"===scheduler._mode&&(n*=scheduler.matrix.LongView.x_length),"left"===e?(t.setTime(t.getTime()-n),i.setTime(i.getTime()-n)):"right"===e&&(t.setTime(t.getTime()+n),i.setTime(i.getTime()+n)),h.getTimePhasedObjects(t,i).then(function(e){if(r.$broadcast("ganttFinishedLoadingServices"),N){N=!1,updateViewDebounced();var t=null;-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){v.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service)}})},c.changeDatesByArrows=function(e){c.getTimePhasedObjects(e)},scheduler.attachEvent("onDblClick",function(e,t){v.safeApply(c,function(){"service"===scheduler.getEvent(e).type?(p.recentlyUsed[e]=!0,b.open(e)):"contractorcapacity"===scheduler.getEvent(e).type?a.open(e):S.open(e)})}),scheduler.attachEvent("onBeforeFolderToggle",function(e,t){return folderJustToggled=!0,v.safeApply(c,function(){g.ganttOpenedTerritories[e.key]=t,j()}),!0});var j=_.debounce(function(){i.SetUserSettingsProperty("Toggled_Territories__c",JSON.stringify(g.ganttOpenedTerritories))},800);function q(){for(var e in c.selectedGanttServices)delete c.selectedGanttServices[e]}scheduler.attachEvent("onBeforeViewChange",function(e,t,i,n){return"MonthlyView"===e&&"MonthlyView"!==i&&"__Utilization__"===s.resourceFieldToSortyBy&&(s.resourceFieldToSortyBy="Name"),!0}),scheduler.attachEvent("onViewChange",function(e,t){v.safeApply(c,function(){switch(scheduler._mode){case"ZoomLevel2":c.timelineName=customLabels.In_Day;break;case"ZoomLevel3":c.timelineName=customLabels.Daily;break;case"ZoomLevel4":c.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":c.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":c.timelineName=customLabels.Weekly;break;case"ZoomLevel7":c.timelineName=customLabels.TwoWeeks;break;case"MonthlyView":c.timelineName=customLabels.Utilization;break;case"MTDView":c.timelineName=customLabels.MDTVIEW;break;case"LongView":c.timelineName=customLabels.LongView}$("#MonthlyLocationViewTooltip").remove(),J(),updateViewDebounced(),scheduler._old.mode===e&&scheduler._old.date===t||T.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(e,t,i){if(!e||!scheduler._events[e].isDummy){var n=void 0,r=i.ctrlKey||i.metaKey;if(!e||"create"===t){if(!r)for(n in c.selectedGanttServices)c.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);return!1}if(e&&"service"===scheduler.getEvent(e).type){if(r)return V.hide(),c.selectedGanttServices[e]?c.selectedGanttServices[e]=!1:c.selectedGanttServices[e]=!0,scheduler.updateEvent(e),!1;for(n in c.selectedGanttServices[e]=!0,c.selectedGanttServices)n!==e&&(c.selectedGanttServices[n]=!1,scheduler.getEvent(n)&&scheduler.getSection(scheduler.getEvent(n).resourceId)&&scheduler.updateEvent(n))}else if(!r&&1<=c.selectedGanttServices.getSelected().length)for(n in c.selectedGanttServices)c.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);if(!("service"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type||e&&"service"===scheduler.getEvent(e).type&&scheduler.getEvent(e).pinned&&preventUpdateOfPinned))return!0}}),c.$watchCollection("selectedGanttServices",function(e,t){globalSelectedGanttServices=c.selectedGanttServices}),c.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(e,t){scheduler.setCurrentView(e),scheduler.destroyCalendar(),c.changeDatesByArrows()}})};var W=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});W.setOverflowHeight(15),W.addNewChild(W.topId,0,"details",v.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),W.attachEvent("onClick",function(e,t,i){switch(e){case"details":v.safeApply(c,function(){S.open(P)});break;case"delete":v.safeApply(c,function(){confirm(customLabels.naDeleteConfirm)&&d.deleteAbsence(P).then(function(e){e?scheduler.deleteEvent(P):alert(customLabels.Failed_To_Delete_Break)})});break;default:if(0===e.indexOf("custom_")){var n=scheduler._events[P].type,r=parseInt(e.split("_")[1]),s=v.getCustomActions(n)[r];if(s.visualforce){var a=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),o=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();k.open(s.name,s.visualforce+"?id="+P+"&type="+n+"&start="+a+"&end="+o);break}l.runCustomAbsenceAction(s.className,P,n,scheduler._min_date,scheduler._max_date).then(function(e){e&&v.addNotification(s.name,e,null,null)}).catch(function(e){return v.addNotification(s.name,e.message,null,null)});break}}}),G.addNewChild(G.topId,0,"details",v.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),G.addNewChild(G.topId,3,"reschedule",v.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),G.addNewChild(G.topId,4,"candidates",v.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),G.addNewChild(G.topId,10,"reshuffle",v.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),G.addNewChild(G.topId,11,"groupNearby",v.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),G.addNewChild(G.topId,5,"status",v.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),G.addNewChild(G.topId,6,"map",v.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),G.addNewChild(G.topId,8,"unschedule",v.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(G.addNewChild(G.topId,7,"chatter",v.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),G.addNewChild("chatter",0,"chatter_welldone",v.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),G.addNewChild("chatter",1,"chatter_hurryup",v.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),G.addNewChild("chatter",2,"chatter_requestupdate",v.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),G.addNewChild("chatter",3,"chatter_custom",v.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1)),v.customActionsPromise.then(function(){v.getCustomActions("gantt").forEach(function(e,t){e.icon?G.addNewChild(G.topId,12+t,"custom_"+t,v.getSVGIconHTML(e.icon)+e.name,!1):G.addNewChild(G.topId,12+t,"custom_"+t,e.name,!1)})});var Z={};function K(e){for(var t in c.selectedGanttServices)c.selectedGanttServices[t]&&(p.flagged[t]=e);updateViewDebounced()}function Y(e){var t=0<arguments.length&&void 0!==e?e:1,i=Math.abs(scheduler._max_date.getTime()-scheduler._min_date.getTime());i=Math.ceil(i/864e5)*t;var n=new Date(scheduler._min_date);n.setDate(n.getDate()+i),scheduler.setCurrentView(n,scheduler._mode)}function J(){if(scheduler._is_initialized()&&c.datalessMethods){for(var e=0;e<c.nowTimespans.length;e++)scheduler.deleteMarkedTimespan(c.nowTimespans[e]);c.nowTimespans.length=0;for(var t=scheduler.serverList("resources"),i=getMinAndMaxHoursToDisplay(),n=0;n<t.length;n++){var r=new Date,s=new Date(r.valueOf()+6e4*r.getTimezoneOffset());if(useLocationTimezone?s.setMinutes(s.getMinutes()+v.getLocationOffset(s,t[n].key)):s=v.convertDateBetweenTimeZones(s,"GMT",userTimeZone),i.min<=s.getHours()&&s.getHours()<i.max&&!c.datalessMethods.isDateInsideWeekend(s)&&"MonthlyView"!==scheduler._mode){var a={};a[scheduler.getState().mode]=[];for(var o=0;o<t[n].children.length;o++)a[scheduler.getState().mode].push(t[n].children[o].key);c.nowTimespans.push(scheduler.addMarkedTimespan({start_date:s,end_date:scheduler.date.add(s,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:a}))}}}}scheduler.attachEvent("onContextMenu",function(e,t){if(scheduler.config.readonly)return!0;if(e&&"service"!==scheduler.getEvent(e).type&&"break"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type)return!1;if(e){G.hide(),V.hide(),W.hide(),scheduler.dhtmlXTooltip.hide();var i=0,n=0;if(t.pageX||t.pageY?(i=t.pageX,n=t.pageY):(t.clientX||t.clientY)&&(i=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),c.selectedGanttServices.getSelected().length<2)return"break"===scheduler._events[e].type?(W.removeItem("delete"),v.getCustomActions("na").forEach(function(e,t){W.removeItem("custom_"+t)}),v.getCustomActions("break").forEach(function(e,t){W.removeItem("custom_"+t)}),v.getCustomActions("break").forEach(function(e,t){W.addNewChild(G.topId,t+10,"custom_"+t,v.getSVGIconHTML(e.icon)+e.name,!1)}),W.showContextMenu(i,n),P=e):"na"===scheduler._events[e].type?(W.removeItem("delete"),W.addNewChild(W.topId,1,"delete",v.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete,!1),v.getCustomActions("na").forEach(function(e,t){W.removeItem("custom_"+t)}),v.getCustomActions("break").forEach(function(e,t){W.removeItem("custom_"+t)}),v.getCustomActions("na").forEach(function(e,t){W.addNewChild(G.topId,12+t,"custom_"+t,v.getSVGIconHTML(e.icon)+e.name,!1)}),W.showContextMenu(i,n),P=e):(function(e){for(var t=!1,i=0;i<c.pinnedStatusesSF.length;i++)scheduler._events[e].status===c.pinnedStatusesSF[i]&&(t=!0);scheduler._events[e].pinned||t?(G.hideItem("reschedule"),G.hideItem("candidates"),G.hideItem("unschedule"),G.hideItem("status"),G.hideItem("reshuffle"),G.hideItem("groupNearby")):(G.showItem("reschedule"),G.showItem("candidates"),G.showItem("unschedule"),G.showItem("status"),G.showItem("reshuffle"),G.showItem("groupNearby")),scheduler._events[e].pinned?G.hideItem("status"):G.showItem("status"),scheduler._events[e].latitude&&scheduler._events[e].longitude&&v.hasCustomPermission("Group_Nearby")?G.showItem("groupNearby"):G.hideItem("groupNearby"),v.hasCustomPermission("Schedule")?G.showItem("reschedule"):G.hideItem("reschedule"),v.hasCustomPermission("Reshuffle")?G.showItem("reshuffle"):G.hideItem("reshuffle"),G.removeItem("showRelated"),(scheduler._events[e].isServiceInChain||scheduler._events[e].relatedTo||scheduler._events[e].relatedFather)&&G.addNewChild(G.topId,5,"showRelated",v.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),g.isMapEnabled()&&null!==scheduler._events[e].latitude?G.showItem("map"):G.hideItem("map"),G.removeItem("flag"),p.flagged[e]?G.addNewChild(G.topId,1,"flag","<span class='emptyFlag'>"+v.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Unflag,!1):G.addNewChild(G.topId,1,"flag","<span class='fullFlag'>"+v.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Flag,!1),G.removeItem("pin"),scheduler._events[e].pinned?G.addNewChild(G.topId,9,"pin","<span class='emptyFlag'>"+v.getSVGIconHTML(lsdIcons.unpin)+"</span> "+customLabels.Unpin,!1):G.addNewChild(G.topId,9,"pin","<span class='fullFlag'>"+v.getSVGIconHTML(lsdIcons.pin)+"</span> "+customLabels.Pin,!1),G.removeItem("consoleTab"),c.isInConsole()&&G.addNewChild(G.topId,1,"consoleTab",v.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1)}(e),scheduler.getEvent(e).pinned||function(e){var t=void 0,i=0;if(_.isEmpty(v.statusFlow))for(var n in G.removeItem("status"),G.addNewChild(G.topId,5,"status",v.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),v.statuses)t="ContextMenu_"+v.statusTranslations[v.statuses[n]].split(" ").join(""),G.addNewChild("status",i,"status_change_"+i,"<span class='StatusColorChanger "+t+" "+v.getCSSClassForContext(v.statusTranslations[v.statuses[n]],C)+"'></span>"+v.statusTranslations[v.statuses[n]],!1),Z["status_change_"+i++]=v.statuses[n];else if(v.statusFlow[e]&&0<v.statusFlow[e].length)for(G.removeItem("status"),G.addNewChild(G.topId,5,"status",v.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),Z={},i=0;i<v.statusFlow[e].length;i++)t="ContextMenu_"+v.statusFlow[e][i].split(" ").join(""),G.addNewChild("status",i,"status_change_"+i,"<span class='StatusColorChanger "+t+" "+v.getCSSClassForContext(v.statusFlow[e][i],C)+"'></span>"+v.statusTranslations[v.statusFlow[e][i]],!1),Z["status_change_"+i]=v.statusFlow[e][i];else G.removeItem("status")}(scheduler.getEvent(e).status),G.showContextMenu(i,n),O=e),!1;V.removeItem("selectedNumber"),V.addNewChild(V.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(c.selectedGanttServices.getSelected().length),!0),V.removeItem("status"),V.addNewChild(V.topId,4,"status",v.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),Z={};var r=0;for(var s in v.statuses){var a="ContextMenu_"+v.statusTranslations[v.statuses[s]].split(" ").join("");V.addNewChild("status",r,"status_change_"+r,"<span class='StatusColorChanger "+a+" "+v.getCSSClassForContext(v.statusTranslations[v.statuses[s]],C)+"'></span>"+v.statusTranslations[v.statuses[s]],!1),Z["status_change_"+r++]=v.statuses[s]}return V.showContextMenu(i,n),!1}return!(P=O="")}),G.attachEvent("onShow",function(e){contextShown=!0}),G.attachEvent("onHide",function(e){contextShown=!1}),W.attachEvent("onShow",function(e){contextShown=!0}),W.attachEvent("onHide",function(e){contextShown=!1}),G.attachEvent("onClick",function(s,e,t){c.$evalAsync(function(){switch(s){case"details":v.safeApply(c,function(){b.open(O)});break;case"consoleTab":c.openConsoleTab(null,O);break;case"flag":c.$evalAsync(function(){p.flagged[O]=!p.flagged[O],scheduler.updateEvent(O)});break;case"pin":p.changePin([scheduler._events[O].id],!scheduler._events[O].pinned).then(function(){return updateViewDebounced()});break;case"reschedule":c.$evalAsync(function(){p.autoScheduleService(O).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),p.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){var t=h.serviceAppointments()[O].name;v.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){b.open(O)})})});break;case"reshuffle":c.$evalAsync(function(){l.runReshuffle(O,g.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){v.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"groupNearby":c.$evalAsync(function(){l.runGroupNearby(O,g.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){v.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"candidates":D.get(O);break;case"chatter_welldone":z([O],customLabels.Well_done_mate);break;case"chatter_hurryup":z([O],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":z([O],customLabels.please_update_service);break;case"chatter_custom":z([O],"");break;case"unschedule":c.$evalAsync(function(){Q([O])});break;case"map":c.showOnMap(O);break;case"showRelated":if(usingNewMstModel)return void k.open("Related Services For "+scheduler._events[O].name,mstPage+"?ingantt=true&id="+O);if(scheduler._events[scheduler._events[O].relatedFather])return void v.showOnGantt(scheduler._events[O].relatedFather);if(scheduler._events[scheduler._events[O].relatedTo])return void v.showOnGantt(scheduler._events[O].relatedTo);scheduler._events[O].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(h.serviceAppointments()[scheduler._events[O].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(h.serviceAppointments()[scheduler._events[O].relatedTo].name));break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=[O],i=v.getCustomActions("gantt")[e];if(i.visualforce){var n=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),r=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();k.open(i.name,i.visualforce+"?id="+O+"&start="+n+"&end="+r);break}l.runCustomServiceAction(i.className,t,scheduler._min_date,scheduler._max_date).then(function(e){e&&v.addNotification(i.name,e,null,null)}).catch(function(e){return v.addNotification(i.name,e.message,null,null)});break}c.$evalAsync(function(){ee([O],Z[s])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),V.addNewChild(V.topId,1,"flag",v.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),V.addNewChild(V.topId,2,"unflag","<span class='emptyFlag'>"+v.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),V.addNewChild(V.topId,3,"reschedule",v.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),V.addNewChild(V.topId,5,"unschedule",v.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),V.addNewChild(V.topId,7,"pin",v.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),V.addNewChild(V.topId,8,"unpin","<span class='emptyFlag'>"+v.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1),v.customActionsPromise.then(function(){v.getCustomActions("gantt").forEach(function(e,t){e.icon?V.addNewChild(V.topId,t+12,"custom_"+t,v.getSVGIconHTML(e.icon)+e.name,!1):V.addNewChild(V.topId,t+12,"custom_"+t,e.name,!1)})}),V.attachEvent("onShow",function(e){contextShown=!0}),V.attachEvent("onHide",function(e){contextShown=!1}),V.attachEvent("onClick",function(s,e,t){c.$evalAsync(function(){switch(s){case"flag":v.safeApply(c,function(){K(!0)});break;case"unflag":v.safeApply(c,function(){K(!1)});break;case"reschedule":I.schedule(c.selectedGanttServices.getSelected());break;case"pin":p.changePin(c.selectedGanttServices.getSelected(),!0).then(function(){return updateViewDebounced()});break;case"unpin":p.changePin(c.selectedGanttServices.getSelected(),!1).then(function(){return updateViewDebounced()});break;case"unschedule":Q(c.selectedGanttServices.getSelected());break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=c.selectedGanttServices.getSelected(),i=v.getCustomActions("gantt")[e];if(i.visualforce){var n=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),r=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();k.open(i.name,i.visualforce+"?services="+t.join(",")+"&start="+n+"&end="+r);break}l.runCustomServiceAction(i.className,c.selectedGanttServices.getSelected(),scheduler._min_date,scheduler._max_date).then(function(e){e&&v.addNotification(i.name,e,null,null)}).catch(function(e){return v.addNotification(i.name,e.message,null,null)});break}ee(c.selectedGanttServices.getSelected(),Z[s])}})}),c.lockGanttToggle=function(){scheduler.config.readonly=!scheduler.config.readonly,c.ganttLocked=scheduler.config.readonly,i.SetUserSettingsProperty("Lock_Gantt__c",c.ganttLocked)},c.unSelecteAllSkills=function(){for(var e in c.selectedSkills)c.selectedSkills[e]=!1},c.selectAllSkills=function(){for(var e in c.selectedSkills)c.selectedSkills[e]=!0},u.promises.skills().then(function(e){c.skills=e}),scheduler.attachEvent("onYScaleClick",function(e,t,i){window.__lastResourceClicked=t;for(var n=["resourceMenuBtn","resourceMenuIcon"],r=0;r<n.length;r++)if(i.target.classList&&i.target.classList.contains(n[r])||i.target.parentNode&&i.target.parentNode.classList.contains(n[r]))return void o.open(t.resourceId,t.key,i.target);t.children||y.open(t.resourceId,t.key)}),scheduler.attachEvent("onBeforeTooltip",function(e){return setTimeout(function(){var e=$(".dhtmlXTooltip");0!==e.length&&(e.position().top<0?e.css("height",e.height()+e.position().top-15+"px"):15<e.position().top&&e.css("height","initial"))},400),!0}),c.$on("keypress",function(e,t){if($("#MonthlyViewTooltip").remove(),!g.isLightboxOpened()&&!$("*:focus").is("textarea, input"))switch(t.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(p.recentlyUsed[scheduler._selected_id]=!0,b.open(scheduler._select_id));break;case 37:t.shiftKey?(Y(-1),c.changeDatesByArrows()):$(".dhx_cal_prev_button").click();break;case 38:var i=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(i-30);break;case 39:t.shiftKey?(Y(),c.changeDatesByArrows()):$(".dhx_cal_next_button").click();break;case 40:i=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(i+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(c.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):v.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&!scheduler.getEvent(scheduler._select_id).isDummy&&(c.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):v.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:c.jumpToToday();break;case 70:1===c.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(p.flagged[scheduler._select_id]?p.flagged[scheduler._select_id]=!1:p.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id));break;case 48:case 96:c.changeTimeline(0);break;case 49:case 97:c.changeTimeline(1);break;case 50:case 98:c.changeTimeline(2);break;case 51:case 99:c.changeTimeline(3);break;case 55:c.changeTimeline(7);break;case 77:v.hasCustomPermission("MDT_View")&&!v.hasCustomPermission("Longterm_View")&&c.changeTimeline(35);break;case 85:v.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&c.changeTimeline(30);break;case 103:c.changeTimeline(7)}}),c.changeTimeline=function(e){var t=scheduler._min_date,i=scheduler._max_date,n=void 0;switch(e){case 0:if((n="ZoomLevel2")===scheduler._mode)return;c.timelineName=customLabels.In_Day;break;case 1:if((n="ZoomLevel3")===scheduler._mode)return;c.timelineName=customLabels.Daily;break;case 2:if((n="ZoomLevel4")===scheduler._mode)return;c.timelineName=customLabels.X2_Days;break;case 3:if((n="ZoomLevel5")===scheduler._mode)return;c.timelineName=customLabels.X3_Days;break;case 7:if((n="ZoomLevel6")===scheduler._mode)return;c.timelineName=customLabels.Weekly;break;case 14:if((n="ZoomLevel7")===scheduler._mode)return;c.timelineName=customLabels.TwoWeeks;break;case 30:if((n="MonthlyView")===scheduler._mode)return;c.timelineName=customLabels.Utilization;break;case 35:if((n="MTDView")===scheduler._mode)return;c.timelineName=customLabels.MDTVIEW;break;case 180:if((n="LongView")===scheduler._mode)return;c.timelineName=customLabels.LongView}scheduler.setCurrentView(t,n),c.changeDatesByArrows(i)},setInterval(J,6e5),c.jumpToToday=function(){var e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),scheduler.setCurrentView(e),c.changeDatesByArrows()},r.$on("afterShowEvent",function(){setTimeout(function(){c.changeDatesByArrows(),J(),updateViewDebounced()},800)}),c.showOnMap=function(e){r.$broadcast("showServiceOnMap",e),v.safeApply(c)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,i,n){var r=e.resourceId.split("_"),s=x.isTerritoryHasInDayOptimizationInProgress(e.start_date,e.end_date,r[1]);if(s){if(!1===confirm(customLabels.In_Day_Optimization_In_Progress_Confirm))return!1;"Rollback"===v.getSchedulingPolicyObject(s.policy)[fieldNames.SchedulingPolicy.Commit_Mode__c]&&x.updateProgressStatus(s.id,"Aborted")}var a=void 0,o=void 0,c=void 0,l=void 0;if(p.handleSnap(e,t),e.resourceId===n.resourceId){if(a=e.start_date.getTime(),o=e.end_date.getTime(),c=n.start_date.getTime(),l=n.end_date.getTime(),Math.abs((a-c)/1e3/60)<minDragMinutes||Math.abs((o-l)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"===e.type)return!1;if(g.areContractorsSupported()&&"service"===e.type&&m.getResources()[e.getGanttResource()].isCapacityBased){for(var d in h.resourceCapacities()){var u=h.resourceCapacities()[d];if(u.resource===m.getResources()[e.getGanttResource()].id&&e.start.getTime()>=u.start_date.getTime()&&e.start.getTime()<=u.end_date.getTime())return e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,te(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return E=GanttService.copy(n),snapTo=t.ctrlKey,te(e),e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,!0}),c.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&updateViewDebounced(),X()};var X=_.debounce(function(){i.SetUserSettingsProperty("Utilization_Properties__c",JSON.stringify(c.capacityFields))},800);function Q(e){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var t=[],i=[];e.forEach(function(e){i.push(h.serviceAppointments()[e]),t.push(h.serviceAppointments()[e].resource),p.recentlyUsed[e]=!0}),p.unscheduleServices(e,g.selectedPolicyId).then(function(e){p.drawServicesAndAbsences(e.services,e.absences),T.calculateKpis(),q()}).catch(function(e){v.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function ee(e,t){if(t===C.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel))return!0;var i=[],n=[];e.forEach(function(e){n.push(h.serviceAppointments()[e]),i.push(h.serviceAppointments()[e].resource),p.recentlyUsed[e]=!0}),p.changeStatus(e,t).then(function(e){p.drawServicesAndAbsences(e.services),q()}).catch(function(e){v.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function te(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,i="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,n=t%serviceJumpsOnGantt,r=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!=n&&(e.start_date=r<n?new Date(e.start_date.getTime()+60*r*1e3):new Date(e.start_date.getTime()-60*n*1e3),e.end_date=new Date(e.start_date.getTime()+i+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}c.cancelCrewView=function(){c.crewViewActive=!1,h.isCrewViewActive=!1},r.$on("gotNewTimePhasedObjects",function(e,t){p.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities)}),r.$on("timePhasedObjectsCheckRules",function(e,t){p.checkRules(t).then(p.drawViolationsOnGantt)}),l.isStreamingShouldBeActive().then(function(e){"true"===e?g.setStreamingActiveState(!0):(g.setStreamingActiveState(!1),"false"!==e&&v.addNotification(customLabels.GanttLiveRefreshNotSupported,e,null,null)),R.initStreaming()}),M.register("services",function(e){p.drawServicesAndAbsences(e.updated||[],[],e.deleted||[])}),M.register("absences",function(e){p.drawServicesAndAbsences([],e.updated||[],e.deleted||[])}),M.register("capacities",function(e){p.drawServicesAndAbsences([],[],e.deleted||[],e.updated||[])}),M.register("rules",function(e){p.checkRules(e).then(p.drawViolationsOnGantt)}),scheduler.attachEvent("onEventChanged",function(e,t){"service"!==t.type&&"na"!==t.type||v.safeApply(c,function(){"na"!==t.type?p.saveChangesToServiceAppointment(E,t).then(function(e){}).catch(function(e){console.warn("Couldn't update service. "+e[2]),v.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):d.saveChangesToAbsence(E,t,g.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e[0].error?v.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].error):v.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})})}),c.$on("JumpToDate",function(e,t){scheduler.setCurrentView(t),c.changeDatesByArrows()}),c.$on("GotSlots",function(e,t){var i=getMinAndMaxHoursToDisplay();(t.minDateOfCandidate.getHours()<i.min||t.minDateOfCandidate.getHours()>=i.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(t.minDateOfCandidate.getHours()<i.min?c.businessHoursRange.start=t.minDateOfCandidate.getHours():c.businessHoursRange.end=24,U())}),c.changeUtilizaionDays=function(e){-1===e&&1===c.numberOfDaysInUtilizationView||1===e&&30===c.numberOfDaysInUtilizationView||(c.numberOfDaysInUtilizationView+=e,c.daysInUtilizationChanged())},c.daysInUtilizationChanged=function(){scheduler.matrix.MonthlyView.x_size=c.numberOfDaysInUtilizationView,i.SetUserSettingsProperty("DaysInUtilizationView__c",c.numberOfDaysInUtilizationView),"MonthlyView"===scheduler._mode&&(scheduler.updateView(),c.getTimePhasedObjects())},c.getRowSizeClass=function(){return v.ganttSettings.resourceRowHeight+"-css"},scheduler.attachEvent("onAfterEventDisplay",function(e){setTimeout(function(){e.showEventPopupEffect=!1,T.calculateKpis(),r.$broadcast("afterShowEvent")},2500)})}]),angular.module("serviceExpert").controller("ctrlIframeMap",["$scope","sfdcService","$rootScope","MapService","servicesService","TimePhasedDataService",function(i,e,t,n,r,s){i.filter=r.filter,i.$on("showServiceOnMap",function(e,t){n.showServiceOnMap(t,i.floatingMapOn,i.workingState)}),i.$on("gotNewResources",function(e,t){n.initializeGanttMap(!0)}),i.$watch("filter",function(e,t){"map"!==i.workingState&&!i.floatingMapOn||n.updateGanttMapFilter()},!0),i.$watch("floatingMapOn",function(e){e&&n.updateGanttMapFilter()}),i.$watch("workingState",function(e){"map"!==e&&!i.floatingMapOn||n.updateGanttMapFilter()}),t.$on("paletteUpdated",function(){n.updateGanttMapServices(s.serviceAppointments(),{})}),t.$on("updateTimePhaseData",function(e,t){n.updateGanttMapServices(t,{})}),t.$on("deleteTimePhaseData",function(e,t){n.updateGanttMapServices({},t)}),t.$on("gotNewTimePhasedObjects",function(e,t){n.initializeGanttMap(!1),n.updateGanttMapServices(t.serviceAppointments,[],!0),n.updateGanttMapView()}),scheduler.attachEvent("onViewChange",function(){"map"!==i.workingState&&!i.floatingMapOn||(n.updateGanttMapView(),n.updateGanttMapServices(r.filteredServices.servicesArray,[]))})}]),angular.module("serviceExpert").controller("mainController",["$scope","StateService",function(e,t){e.isOSX=t.isOSX,e.lang=t.lang}]),angular.module("serviceExpert").controller("ctrlMap",["$scope","sfdcService","$rootScope","$q","userSettingsManager","servicesService","bulkScheduleService","$timeout","$filter","utils","ServiceAppointmentLightboxService","ResourceLightboxService","TimePhasedDataService","FieldSetFieldsService","ResourcesAndTerritoriesService","LastKnownPositionService","DeltaService","SERVICE_STATUS","SERVICE_CATEGORY","DRAWING_STATES","StreamingAPIService","RegisterService","GeneralLightbox",function(u,a,t,p,s,o,c,n,e,v,r,l,d,i,m,h,g,f,S,y,b,T,w){u.SERVICE_STATUS=f,u.invokedActions={},u.allMarkersArray=[],u.reports={},u.reportsData={},u.map=null,u.markersControl={},u.territoriesMarkers=[],u.firstMapShow=!0,u.trafficLayerEnabled=!1,u.mapControl={center:{latitude:0,longitude:0},zoom:19},u.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}};var L=JSON.parse(s.GetUserSettingsProperty("Map_Object_Markers__c"))||{services:!0,resources:!0,positions:!0,territories:!0};function C(e){u.allMarkersArray=[],u.showResources&&function(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=d.resourcesByPrimariesAndRelocations();for(var n in i){var r=i[n];for(var s in r){var a=r[s];isIntersect(e,t,a.effectiveStartDate,a.effectiveEndDate)&&I(a)}}}(),u.showServices&&function(){for(var e=u.filteredServices.servicesArray,t=0;t<e.length;t++){var i=e[t];i.id!=u.currentShowOnMapServiceId&&R(i)}u.currentShowOnMapServiceId&&R(d.serviceAppointments()[u.currentShowOnMapServiceId])}(),u.showLivePositions&&function(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=d.resourcesAndTerritories(),n=h.lastKnownPositions();for(var r in n){var s=i[r];for(var a in s){var o=s[a];if(isIntersect(e,t,o.effectiveStartDate,o.effectiveEndDate)){D(n[r]);break}}}}(),u.showTerritories&&F(),function(e){var t=maxReportMarkers;for(var i in u.reportsData){var n=u.reportsData[i];if(n.show)for(var r=n.displayCount=0;r<n.data.length;r++){var s=n.data[r];if(0==t){e&&(u.showTooManyReportsAlert=!0);break}A(s,i+n.displayCount)&&(n.displayCount++,t--)}}}(e)}function A(e,t){if(e.latitude){var i=staticResources.report;"ServiceAppointment"===e.sObjectType?i=staticResources.service_png:void 0!==staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]&&(i=staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]);var n={id:t,icon:i,type:"report",coords:{latitude:e.latitude,longitude:e.longitude},item:e};return u.allMarkersArray.push(n),!0}}function D(e){var t=m.getResources()[e.id];if(u.isEmpty(u.filteredResources)||u.filteredResources[t.id]){var i={id:e.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})};i.item.lastModifiedDate=v.convertDateBetweenTimeZones(i.item.lastModifiedDate,"UTC",userTimeZone),u.allMarkersArray.push(i)}}function I(e){if(e.latitude){var t=m.getResources()[e.serviceResource];if(t&&(u.isEmpty(u.filteredResources)||u.filteredResources[t.id])){var i={id:e.id,icon:staticResources.homebase_png,type:"resource",resourceId:t.id,serviceTerritory:e.serviceTerritory,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})};u.allMarkersArray.push(i)}}}function k(e,t){for(var i=new google.maps.LatLngBounds,n=0;n<e.length;n++){var r=t?e[n].coords.latitude:e[n].latitude,s=t?e[n].coords.longitude:e[n].longitude;if(r&&s){var a=new google.maps.LatLng(r,s);i.extend(a)}}return i}function R(e){if(!e.latitude)return!1;if(!u.showServices)return!1;var t=e.getGanttResource();if(!(u.isEmpty(u.filteredResources)||null!=t&&u.filteredResources[t]))return!1;var i=staticResources.service_png;e.statusCategory==S.COMPLETED&&(i=staticResources.service_completed_png);var n={id:e.id,icon:i,type:"service",animation:2,coords:{latitude:e.latitude,longitude:e.longitude},item:e};u.allMarkersArray.push(n)}function F(){var e=m.territories();for(var t in e)e[t].latitude&&u.allMarkersArray.push({id:t,icon:staticResources.territory_map_icon,type:"territory",animation:2,coords:{latitude:e[t].latitude,longitude:e[t].longitude},item:e[t]})}function M(e,t){if(u.polygons[e])u.polygons[e].polygon.setVisible(t),x(e,t);else if(m.territories()[e]||"NoTerritoryPolygon"==e){x(e);for(var i=u.myTreeView.getSubItems(e),n=0;n<i.length;n++)r=i[n],t?u.myTreeView.checkItem(r):u.myTreeView.uncheckItem(r)}var r;s.SetUserSettingsProperty("Invisible_Polygons__c",JSON.stringify(u.InvisiblePolygons))}function x(e,t){for(var i=0;i<u.InvisiblePolygons.length;i++)if(u.InvisiblePolygons[i]==e)return void u.InvisiblePolygons.splice(i,1);t||u.InvisiblePolygons.push(e)}function O(){u.selectedShape&&("marker"!==u.selectedShape.type&&u.selectedShape.setEditable(!1),u.selectedShape.set("strokeWeight",1),u.selectedShape=null,u.currentEditPolygon=null,u.polygonName="",u.polygonTerritory="null"),u.drawState=u.drawState==y.DRAW?y.EDIT:y.NONE}function P(e){if(this&&(e=this),u.drawState==y.INTERSECT){if(u.currentIntersectingId==e.id)return;return u.selectedIntersectingPolygons[e.id]?delete u.selectedIntersectingPolygons[e.id]:u.selectedIntersectingPolygons[e.id]=!0,void u.$apply()}"marker"!==e.type&&(O(),u.selectedColor=u.selectedShapeColor=e.get("fillColor"),u.drawState!=y.EDIT&&(u.drawState=y.SELECTED)),u.polygonName=e.name,u.polygonTerritory=e.territory||"null",u.selectedShape=e,u.selectedShape&&u.selectedShape.set("strokeWeight",3),e.id!=u.myTreeView.getSelectedId()&&(u.shouldBound=!1,u.myTreeView.selectItem(e.id)),u.$apply()}function E(e){u.geoXmlParser.parseKmlString(e[fieldNames.Polygon.KML__c]);for(var t=u.geoXmlParser.docs.length-1,i=0;i<u.geoXmlParser.docs[t].placemarks.length;i++)u.geoXmlParser.docs[t].placemarks[i].id=e.Id,u.geoXmlParser.docs[t].placemarks[i].polygon.id=e.Id,u.geoXmlParser.docs[t].placemarks[i].polygon.name=e.Name,u.geoXmlParser.docs[t].placemarks[i].polygon.territory=e[fieldNames.Polygon.Service_Territory__c],u.geoXmlParser.docs[t].placemarks[i].polygon.addListener("click",function(){u.shouldBound=!1,V.hide(),P(this)}),u.geoXmlParser.docs[t].placemarks[i].polygon.addListener("rightclick",B),u.polygons[e.Id]=e,u.polygons[e.Id].polygon=u.geoXmlParser.docs[t].placemarks[i].polygon}u.showServices=L.services,u.showResources=L.resources,u.showLivePositions=L.positions,u.showTerritories=L.territories,u.showOnMap=!1,u.setMapMarkerUserSettings=function(){s.SetUserSettingsProperty("Map_Object_Markers__c",JSON.stringify({services:u.showServices,resources:u.showResources,positions:u.showLivePositions,territories:u.showTerritories}))},u.showTooManyReportsAlert=!1,u.resourcesFilterList=[],u.filterResourceInputValue="",u.filteredResources={},u.selectedReport="null",u.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},report:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},u.serviceInfoWindow={show:!1,control:{}},u.resourceInfoWindow={show:!1,control:{}},u.territoryInfoWindow={show:!1,control:{}},u.reportInfoWindow={show:!1,control:{}},u.livePosInfoWindow={show:!1,control:{}},u.filteredServices=o.filteredServices,u.filter=o.filter,u.currentShowOnMapServiceId=null,u.drawingStates=y,u.drawState=y.NONE,u.selectedShape=null,u.selectedShapeColor=u.selectedColor,u.drawingManager,u.setSelectedShapeColor=function(e){u.selectedShape&&(u.selectedShape.set("fillColor",e),u.selectedShapeColor=e),u.selectedColor=e},u.polygons={},u.polygonName="",u.polygonTerritory="null",u.territories={},u.selectedIntersectingPolygons={},u.shouldBound=!0,u.cancelDrawingShape=!1,u.InvisiblePolygons=null==s.GetUserSettingsProperty("Invisible_Polygons__c")?[]:JSON.parse(s.GetUserSettingsProperty("Invisible_Polygons__c")),u.hasCustomPermission=v.hasCustomPermission,u.getServiceInfoRowClass=v.getServiceInfoRowClass,u.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,u.getReportsError=function(){return u.reportsError},v.getReports().then(function(e){if(e)for(var t=0;t<e.length;t++)u.reports[e[t].Id]=e[t]}).catch(function(e){u.reportsError=!0}),h.getLastKnownPositions(),u.redrawAllMarkers=C,u.$watch("workingState",function(e){"map"==e?(u.map=u.mapControl.getGMap(),n(function(){if(function(){u.resourcesFilterList=[];var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=d.resourcesAndTerritories(),n=m.getResources();for(var r in n){var s=i[r],a=n[r];for(var o in s){var c=s[o];if(isIntersect(e,t,c.effectiveStartDate,c.effectiveEndDate)){u.resourcesFilterList.push({label:a.name,value:a.id});break}}}}(),C(),google.maps.event.trigger(u.mapControl.getGMap(),"resize"),u.firstMapShow){u.showOnMap||function(){var e=new google.maps.LatLng(37.794024,-122.394837),t=k(u.filteredServices.servicesArray);t.isEmpty()&&(t=k(_.values(d.serviceAppointments()))),t.isEmpty()?u.map.setCenter(e):u.map.fitBounds(t)}();var e=u.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};e.setOptions(t);var i={fillOpacity:.5,strokeWeight:1,editable:!0,draggable:!0,fillColor:u.selectedColor};u.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,drawingModes:["polygon"]},polygonOptions:i,rectangleOptions:i}),u.drawingManager.setMap(u.map),google.maps.event.addListener(u.drawingManager,"overlaycomplete",function(e){var i=e.overlay;if(u.cancelDrawingShape)return u.cancelDrawingShape=!1,void i.setMap(null);i.type=e.type,i.set("fillColor",u.selectedColor),i.set("name",u.polygonName),i.set("territory",u.polygonTerritory),u.drawingManager.setDrawingMode(null),google.maps.event.addListener(i,"click",function(e){if(void 0!==e.vertex&&i.type===google.maps.drawing.OverlayType.POLYGON){var t=i.getPaths().getAt(e.path);t.removeAt(e.vertex),t.length<3&&i.setMap(null)}P(i)}),P(i)}),"function"!=typeof google.maps.Polygon.prototype.ToWKT&&(google.maps.Polygon.prototype.ToWKT=function(){for(var e="POLYGON(",t=this.getPaths(),i=0;i<t.getLength();i++){var n=t.getAt(i);e+="(";for(var r=0;r<n.getLength();r++)e+=n.getAt(r).lng().toString()+" "+n.getAt(r).lat().toString()+",";e+=n.getAt(0).lng().toString()+" "+n.getAt(0).lat().toString()+"),"}return e=e.substring(0,e.length-1)+")"}),function(){if(u.geoXmlParser=new geoXML3.parser({map:u.map,suppressInfoWindows:!0,zoom:!1}),!u.isEmpty(u.polygons)){var e=0;try{for(var t in u.polygons){u.geoXmlParser.parseKmlString(u.polygons[t][fieldNames.Polygon.KML__c]);for(var i=0;i<u.geoXmlParser.docs[e].placemarks.length;i++)if(u.geoXmlParser.docs[e].placemarks[i].polygon){u.geoXmlParser.docs[e].placemarks[i].id=u.polygons[t].Id,u.geoXmlParser.docs[e].placemarks[i].polygon.id=u.polygons[t].Id,u.geoXmlParser.docs[e].placemarks[i].polygon.name=u.polygons[t].Name,u.geoXmlParser.docs[e].placemarks[i].polygon.territory=u.polygons[t][fieldNames.Polygon.Service_Territory__c];var n=-1==u.InvisiblePolygons.indexOf(t);u.geoXmlParser.docs[e].placemarks[i].polygon.setVisible(n),u.geoXmlParser.docs[e].placemarks[i].polygon.addListener("click",function(){u.shouldBound=!1,V.hide(),P(this)}),u.geoXmlParser.docs[e].placemarks[i].polygon.addListener("rightclick",B),u.polygons[t].polygon=u.geoXmlParser.docs[e].placemarks[i].polygon}e++}}catch(e){alert("Problem parsing KML string"),console.error(e)}}}(),google.maps.event.addListener(u.map,"click",function(){u.map.setOptions({draggableCursor:"grab"}),V.hide()}),V=new H(u.map,N),u.firstMapShow=!1,u.showOnMap=!1}},0)):u.currentShowOnMapServiceId=null}),u.$on("resizeMap",function(e,t){google.maps.event.trigger(u.mapControl.getGMap(),"resize")}),u.$on("showServiceOnMap",function(e,i){u.currentShowOnMapServiceId=i,t.$broadcast("changeWorkingState","map"),u.map=u.mapControl.getGMap(),u.showOnMap=!0,n(function(){google.maps.event.trigger(u.mapControl.getGMap(),"resize");var e=d.serviceAppointments()[i],t=new google.maps.LatLng(e.latitude,e.longitude);u.map.setCenter(t),u.map.setZoom(20),n(function(){u.markersControl.getPlurals().get(i)&&u.markersControl.getPlurals().get(i).gObject.setAnimation(google.maps.Animation.BOUNCE),n(function(){var e=u.markersControl.getPlurals().get(i);e&&e.gObject.setAnimation(null)},3500)},150)},0)}),i.fieldsSetFields().then(function(e){u.serviceFields=e.MapInfo}),u.isEmpty=function(e){return!e||_.isEmpty(e)},u.markerCloseClicked=function(){u.serviceInfoWindow.show=!1,u.resourceInfoWindow.show=!1,u.territoryInfoWindow.show=!1,u.reportInfoWindow.show=!1,u.livePosInfoWindow.show=!1,u.$apply()},u.openLink=function(e,t){"Resource__r"!=t.APIName?v.openLink(e,t):u.openLightbox(e.resourceId,"resource")},u.openReportLink=function(e){e.isReference&&("ServiceResource"!=e.APIName?"ServiceAppointment"!=e.APIName?v.openConsoleTab(null,e.Value)||window.open("../"+e.Value,"_blank"):u.openLightbox(e.Value,"service"):u.openLightbox(e.Value,"resource"))},u.markerClicked=function(e,t,i){!function(e){var t=e.type;switch(u.serviceInfoWindow.show=!1,u.resourceInfoWindow.show=!1,u.territoryInfoWindow.show=!1,u.reportInfoWindow.show=!1,u.livePosInfoWindow.show=!1,u.currentMarker=e,t){case"service":u.serviceInfoWindow.show=!0,u.currentMarker.item=d.serviceAppointments()[e.id];break;case"lastKnownPosition":u.livePosInfoWindow.show=!0;break;case"resource":u.resourceInfoWindow.show=!0;break;case"territory":u.territoryInfoWindow.show=!0;break;case"report":u.reportFields=[],u.reportFields.push.apply(u.reportFields,e.item.otherProperties),u.reportInfoWindow.show=!0}n(function(){u.$apply(),v.setMapCloseButtonPosition()},0)}(i)},u.openLightbox=function(e,t,i){var n=null;switch(i&&(n=v.generateResourceId(e,i)),t){case"service":o.recentlyUsed[e]=!0,r.open(e);break;case"resource":l.open(e,n);break;case"homeBase":u.$emit("showResourceLightbox",u.resources[e])}},u.$watch("filter",function(e,t){"map"===u.workingState&&C()},!0),u.clearResource=function(e){delete u.filteredResources[e],C()},u.clearAllResources=function(){u.filteredResources={},C()},u.addResourceToFilterList=function(){var e=m.getResources();""!=u.filterResourceInputValue&&e[u.filterResourceInputValue.value]&&(u.filteredResources[u.filterResourceInputValue.value]=e[u.filterResourceInputValue.value],u.filterResourceInputValue="",C())},u.toggleReportMarkers=function(e){var t=u.reportsData[e];t.show=!t.show,C()},u.removeReportFromMap=function(e){delete u.reportsData[e],C()},u.removeAllReportsFromMap=function(){u.reportsData={},C()},u.showReportOnMap=function(){"null"!=u.selectedReport&&a.getReportRowsForMap(u.selectedReport).then(function(e){u.reportsData[u.selectedReport]={show:!0,data:e,displayCount:0},C(!0)})},T.register("positions",function(e){C()}),u.isPinnedStatus=function(){if(u.currentMarker){for(var e=u.pinnedStatusesSF.split(","),t=0;t<e.length;t++)if(u.currentMarker.item.status===e[t])return!0;return!1}},u.needToShowScheduleButton=function(){return u.currentMarker&&"service"==u.currentMarker.type&&!u.currentMarker.item.pinned&&!u.isPinnedStatus()&&u.hasCustomPermission("Schedule")},u.needToShowDispatchButton=function(){return u.currentMarker&&"service"==u.currentMarker.type&&u.currentMarker.item.statusCategory!=S.DISPATCHED&&u.currentMarker.item.statusCategory==S.SCHEDULED},u.isServiceCurrentlyDispatching=function(){return u.currentMarker&&"dispatched"==u.invokedActions[u.currentMarker.id]},u.changeStatusToDispatch=function(e){u.invokedActions[e]?alert(customLabels.another_operation_running):(u.invokedActions[u.currentMarker.id]="dispatched",o.changeStatus([e],f.DISPATCHED).then(function(e){0<e.services.length&&(u.currentMarker.item=e.services[0])}).finally(function(){delete u.invokedActions[u.currentMarker.id]}))},u.isServiceCurrentlyScheduling=function(){return u.currentMarker&&"schedule"==u.invokedActions[u.currentMarker.id]},u.autoScheduleService=function(t){t=u.currentMarker.id,u.invokedActions[t]?alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,u.invokedActions[t]="schedule",o.autoScheduleService(t).then(function(e){o.drawServicesAndAbsences(e.services,e.absences),delete u.invokedActions[t]}))},u.myTreeView={},u.lastSelectedLeafId=null,p.all([v.getPolygons(),m.promises.territories()]).then(function(e){for(var t in function(e){if(e)for(var t=0;t<e.length;t++)e[t][fieldNames.Polygon.KML__c]&&(u.polygons[e[t].Id]=e[t])}(e[0]),m.territories())-1!=v.getFilteredLocations().indexOf(t)&&(u.territories[t]=m.territories()[t]);F(),function(){var e=p.defer(),t=m.territories(),i={},n=[],r=(v.getFilteredLocations(),{NoTerritoryPolygon:{id:"NoTerritoryPolygon"}});for(var s in u.polygons)i[s]={id:s,parent:u.polygons[s][fieldNames.Polygon.Service_Territory__c]?t[u.polygons[s][fieldNames.Polygon.Service_Territory__c]]:r.NoTerritoryPolygon,text:u.polygons[s].Name,icons:{file:"fa-square"},icon_color:u.polygons[s][fieldNames.Polygon.Color__c],checked:-1==u.InvisiblePolygons.indexOf(s)?1:0,items:[]};for(var a in t)i[a]={id:a,parent:m.territories()[a].parentTerritory?m.territories()[a].parentTerritory:0,text:m.territories()[a].name,icons:{file:"fa-building-o"},checked:-1==u.InvisiblePolygons.indexOf(a)?1:0,items:[]};for(var o in i.NoTerritoryPolygon={id:"NoTerritoryPolygon",parent:0,text:customLabels.Polygons_without_Service_Territory,icons:{file:"fa-building-o"},checked:-1==u.InvisiblePolygons.indexOf("NoTerritoryPolygon")?1:0,items:[]},i){var c=i[o],l=d(c);0!==c.parent&&l?i[l.id].items.push(c):n.push(c)}function d(e){if(e.id&&e.parent){if(i[e.parent.id])return e.parent;var t={};return m.allTerritories[e.parent.id]&&(t={id:m.allTerritories[e.parent.id].id,parent:m.allTerritories[e.parent.id].parentTerritory?m.allTerritories[e.parent.id].parentTerritory:0}),d(t)}}return e.resolve(n),e.promise}().then(function(e){u.locationsTree=e,u.myTreeView=new dhtmlXTreeView({parent:"polygonsByTerritoriesTree",iconset:"font_awesome",checkboxes:!0,items:u.locationsTree}),u.myTreeView.attachEvent("onSelect",function(e,t){if(u.drawState!=y.NONE&&u.drawState!=y.SELECTED)return!1;u.lastSelectedLeafId||(u.lastSelectedLeafId=e),!u.polygons[e]||null==u.lastSelectedLeafId||u.lastSelectedLeafId==e&&null==u.polygons[e]?O():(t&&(P(u.polygons[e].polygon),u.shouldBound&&u.selectedShape.getVisible()&&u.map.fitBounds(u.selectedShape.bounds),u.shouldBound=!0),u.lastSelectedLeafId=u.polygons[e].Id)}),u.myTreeView.attachEvent("onCheck",M)})}),u.toggleDrawMode=function(){u.drawState!=y.INTERSECT&&(u.drawingManager.setDrawingMode("polygon"),O(),function(e){var t=u.drawingManager.get("polygonOptions");t.fillColor=e,u.drawingManager.set("polygonOptions",t)}(u.selectedColor),u.drawState=y.DRAW)},u.cancelPolygon=function(){null!=u.drawingManager.getDrawingMode()&&(u.cancelDrawingShape=!0,u.drawingManager.setDrawingMode(null)),u.drawState==y.EDIT&&u.selectedShape&&(u.selectedShape.setMap(null),n(function(){u.currentEditPolygon&&E(u.currentEditPolygon),u.polygonName="",u.polygonTerritory="null"},0)),u.drawState=y.NONE,u.selectedIntersectingPolygons={}},u.editPolygon=function(){u.drawState==y.SELECTED&&u.selectedShape.getVisible()&&(u.currentEditPolygon=u.polygons[u.selectedShape.id],u.drawState=y.EDIT,u.selectedShape.setEditable(!0),u.selectedShape.setDraggable(!0))},u.savePolygon=function(){if(u.selectedShape){var i=[];u.selectedShape.getPath().forEach(function(e,t){i.push({lat:e.lat(),lng:e.lng()})});var t=u.selectedShape.id||null,e="null"!=u.polygonTerritory?u.polygonTerritory:null;u.polygonName?(a.savePolygon(function(e,t,i){return'<?xml version="1.0" encoding="UTF-8"?> \n                            <kml xmlns="http://www.opengis.net/kml/2.2">\n                                <Style id="'+i.replace(" ","")+'Style"> \n                                    <LineStyle> \n                                        <width>1</width> \n                                    </LineStyle> \n                                    <PolyStyle> \n                                        <color>'+function(e,t){return t+e.substring(5,7)+e.substring(3,5)+e.substring(1,3)}(t,80)+"</color> \n                                    </PolyStyle> \n                                </Style> \n                                <Placemark> \n                                    <name>"+i.replace(" ","")+"</name> \n                                    <styleUrl>#"+i.replace(" ","")+"Style</styleUrl> \n                                    <Polygon> \n                                        <outerBoundaryIs> \n                                            <LinearRing>\n                                                <coordinates>"+function(e){for(var t="",i=0;i<e.length;i++)t+=e[i].lng+","+e[i].lat+",0\n";return t+=e[0].lng+","+e[0].lat+",0"}(e)+"</coordinates> \n                                            </LinearRing> \n                                        </outerBoundaryIs> \n                                    </Polygon> \n                                </Placemark> \n                            </kml>"}(i,u.selectedShapeColor,u.polygonName),u.polygonName,u.selectedShapeColor,e,t).then(function(e){u.selectedShape.setMap(null),E(e),function(e,t){t&&u.myTreeView.deleteItem(t);var i=e[fieldNames.Polygon.Service_Territory__c]?e[fieldNames.Polygon.Service_Territory__c]:"NoTerritoryPolygon";u.myTreeView.addItem(e.Id,e.Name,i),u.myTreeView.checkItem(e.Id),u.myTreeView.setItemIcons(e.Id,{file:"fa-square"}),u.myTreeView.setIconColor(e.Id,e[fieldNames.Polygon.Color__c])}(e,t),u.selectedShape=u.polygons[e.Id].polygon}),u.drawState=y.NONE):alert(customLabels.Polygon_name_field_is_empty)}},u.deletePolygon=function(){if(u.selectedShape){if(confirm(customLabels.This_will_delete_the_selected_polygon.replaceAll(u.selectedShape.name))){var t=u.selectedShape.id||null;a.deletePolygon(t).then(function(e){u.selectedShape.setMap(null),u.myTreeView.deleteItem(t),O()}),u.drawState=y.NONE}}else u.drawState=y.NONE};var N={},G=[],V=void 0;function H(e,t){t=t||{},this.setMap(e),this.mapDiv=e.getDiv(),this.menuItems=t.menuItems||{},this.isVisible=!1}function B(e){V.hide(),P(this.clickedPolygon_=this);var t=V.getProjection().fromLatLngToDivPixel(e.latLng);V.show(t),u.map.setOptions({draggableCursor:"pointer"})}function U(e){for(var t=[],i=0;i<u.filteredServices.servicesArray.length;i++){var n=u.filteredServices.servicesArray[i];if(null!=n.latitude&&null!=n.longitude){var r=new google.maps.LatLng(n.latitude,n.longitude);google.maps.geometry.poly.containsLocation(r,e)&&t.push(n.id)}}return t}(H.prototype=new google.maps.OverlayView).onAdd=function(){$("<div id='cMenu' class='context-menu-polygon'></div>").appendTo($("#map"));for(var e=$("#cMenu").get(0),t=0;t<this.menuItems.length;t++){var i=this.menuItems[t];$('<div id="'+i.id+'" class="truncate context-menu-polygon-item" title="'+i.name+'">'+i.label+"</div>").appendTo(e)}this.div_=e,this.getPanes().overlayMouseTarget.appendChild(this.div_);var n=this;for(t=0;t<this.menuItems.length;t++)i=this.menuItems[t],google.maps.event.addDomListener($("#"+i.id).get(0),"click",$.proxy(function(){n.clickedItem=this.id,google.maps.event.trigger(n,"click")},i));google.maps.event.addListener(n,"click",function(){!function(e){switch(e){case"menu-edit-polygon":u.mapOptionsToggle=!0,$(".polygonsTab").click(),u.editPolygon();break;case"menu-intersect-polygon":u.mapOptionsToggle=!0,$(".polygonsTab").click(),u.currentIntersectingId=angular.copy(u.selectedShape.id),u.drawState=y.INTERSECT,u.$apply();break;case"menu-delete-polygon":u.deletePolygon();break;case"menu-schedule-polygon":c.schedule(U(u.selectedShape)),u.$apply();break;case"menu-unschedule-polygon":o.unscheduleServices(U(u.selectedShape));break;case"menu-dispatch-polygon":o.changeStatus(U(u.selectedShape),f.DISPATCHED).then(function(e){o.drawServicesAndAbsences(e.services)}).catch(function(e){v.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)});break;case"menu-joepardy-polygon":o.setInJeopardy(U(u.selectedShape));break;default:if(0===e.indexOf("custom_")){var t=parseInt(e.split("_")[1]),i=U(u.selectedShape),n=v.getCustomActions("map")[t];if(n.visualforce){var r=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),s=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===i.length?w.open(n.name,n.visualforce+"?id="+i[0]+"&start="+r+"&end="+s):w.open(n.name,n.visualforce+"?services="+i.join(",")+"&start="+r+"&end="+s);break}a.runCustomServiceAction(n.className,U(u.selectedShape),scheduler._min_date,scheduler._max_date).then(function(e){e&&v.addNotification(n.name,e,null,null)}).catch(function(e){return v.addNotification(n.name,e.message,null,null)});break}}}(n.clickedItem),event.stopPropagation(),V.hide()})},H.prototype.draw=function(){},H.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},H.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},H.prototype.show=function(e){if(this.div_){var t=this.div_;t.style.left=e.x+5+"px",t.style.top=e.y+10+"px",this.div_.style.visibility="visible"}},u.hasCustomPermission("Polygons_create_update")&&G.push({id:"menu-intersect-polygon",className:"context_menu_item",eventName:"intersect",label:v.getSVGIconHTML(lsdIcons.cut)+customLabels.Cut_Intersections,name:customLabels.Cut_Intersections}),u.hasCustomPermission("Bulk_Schedule")&&G.push({id:"menu-schedule-polygon",className:"context_menu_item",eventName:"schedule",label:v.getSVGIconHTML(lsdIcons.calendar)+customLabels.Schedule,name:customLabels.Schedule}),u.hasCustomPermission("Bulk_Unschedule")&&G.push({id:"menu-unschedule-polygon",className:"context_menu_item",eventName:"unschedule",label:v.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,name:customLabels.Unschedule}),u.hasCustomPermission("Bulk_Dispatch")&&G.push({id:"menu-dispatch-polygon",className:"context_menu_item",eventName:"dispatch",label:v.getSVGIconHTML(lsdIcons.dispatch)+customLabels.Dispatch,name:customLabels.Dispatch}),G.push({id:"menu-joepardy-polygon",className:"context_menu_item",eventName:"joepardy",label:v.getSVGIconHTML(lsdIcons.jeopardy)+customLabels.In_Jeopardy,name:customLabels.In_Jeopardy}),u.hasCustomPermission("Polygons_create_update")&&G.push({id:"menu-delete-polygon",className:"context_menu_item",eventName:"delete",label:v.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete_polygon,name:customLabels.Delete_polygon}),N.menuItems=G,v.customActionsPromise.then(function(){v.getCustomActions("map").forEach(function(e,t){G.push({id:"custom_"+t,className:"context_menu_item",eventName:"custom_"+t,label:e.icon?v.getSVGIconHTML(e.icon)+e.name:e.name,name:e.name})})}),u.getIntersectionsForPolygons=function(){if(!u.isEmpty(u.selectedIntersectingPolygons))try{var e=new jsts.io.WKTReader,t=e.read(u.selectedShape.ToWKT());for(var i in u.selectedIntersectingPolygons){var n=e.read(u.polygons[i].polygon.ToWKT());t=t.difference(n)}!function(e){for(var t=e.slice(9,e.length-2).split(","),i=[],n=0;n<t.length;n++){var r=t[n].split(" ");i.push(new google.maps.LatLng({lat:parseFloat(r[1]),lng:parseFloat(r[0])}))}u.selectedShape.setPath(i),u.savePolygon(),u.selectedIntersectingPolygons={}}((new jsts.io.WKTWriter).write(t))}catch(e){alert("Problem finding intersections in given polygons."),console.error(e)}}}]),angular.module("serviceExpert").controller("ctrlRightSide",["$q","$scope","$rootScope","$filter","$sce","sfdcService","utils","servicesService","kpiCalculationsService","StateService","DeltaService","TimePhasedDataService","StreamingAPIService","RegisterService","OptimizationRequestsService","LeftSideLocationFilteringService",function(e,i,t,n,r,s,a,o,c,l,d,u,p,v,m,h){var g={opacity:1,left:null,top:null,height:400,width:600};i.isMapEnabled=l.isMapEnabled(),i.servicesObjects=o.servicesObjects,i.servicesScheduledToCapacity={},i.notifications=a.butlerNotifications,i.unreadNotifications=0,i.showServiceList=a.showServiceList,i.workingState="gantt",i.openConsoleTab=a.openConsoleTab,i.openSObjectLink=a.openSObjectLink,i.activeRequests=s.activeRequests,i.activeRuleCheckRequests=s.activeRuleCheckRequests,i.kpi=c.kpis,i.marginLeftForBox=0,i.mapAvailable=mapMode,i.optimizationRequests=m.optimizationRequests,i.floatingMapOn=!1,i.optRequestPercentage=0,i.OptimizationRequestsProgressStatus=m.OptimizationRequestsProgressStatus,i.generateRequestResultText=m.generateRequestResultText,i.canAbortOR=m.canAbortOR,i.abortOptRequest=m.abortOptRequest,i.isUseEdge=a.isUseEdge,i.isNoTerritoryLoadded=h.isNoTerritoryLoadded,i.reachedMaxRows=u.reachedMaxRows,i.maxResourceRowsOnGantt=window.__gantt.maxResourceRowsOnGantt,i.$watch("workingState",function(e){"gantt"===e&&setTimeout(function(){scheduler._is_initialized()&&updateViewDebounced()},0)}),s.getServiceMapInfoWindowFields().then(function(e){i.serviceFields=e}),i.getServiceInfoRowClass=a.getServiceInfoRowClass,i.openLink=a.openLink,i.order=function(e,t){i.orderByField=e,i.reverse=t},i.$on("changeWorkingState",function(e,t){"gantt"===(i.workingState=t)?setTimeout(function(){updateViewDebounced()},100):$(".dhtmlXTooltip").remove()}),i.showNotifications=function(){i.unreadNotifications=0,a.butlerNotifications().forEach(function(e){return e.unread=!1})},i.calcUnreadNotifications=function(){return i.unreadNotifications=0,a.butlerNotifications().forEach(function(e){e.unread&&i.unreadNotifications++}),i.unreadNotifications},i.numOfNotifications=function(){var t=0;return a.butlerNotifications().forEach(function(e){e.show&&t++}),t},i.formatTravel=function(e){var t=Math.floor(e/60/60),i=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+i+customLabels.kpi_m},i.toggleServiceList=function(){i.showServiceList.show=!0,setTimeout(function(){updateViewDebounced(),t.$broadcast("resizeMap",{})},830)},i.isEmpty=function(e){return Object.keys(e).length},i.getRequestCss=function(e){switch(e){case"Hold":case"Post Processing":case"In Progress":return"smart_in_progress";case"Completed":return"smart_completed";case"Completed First Optimization Day":return"smart_completed_first_day";case"Failed":return"smart_failed";case"Open":return"smart_open";case"Queued":return"smart_queued";case"Aborting":return"smart_in_progress";case"Aborted":return"smart_failed"}},i.moveLocalDtToUserTimezoneDt=function(e){var t=new Date(e);return a.convertDateBetweenTimeZones(t,"GMT",userTimeZone)},i.getNumOfRunningRequests=function(){return m.getNumOfActiveOptimizationRequests()},i.openSomethingBox=function(e,t){i.marginLeftForBox="smart"===t?e.target.offsetLeft-227:e.target.offsetLeft-200},i.shouldShowLongTermError=function(){return"LongView"===scheduler._mode&&"gantt"===i.workingState&&(window.__gantt.reachedMaxNumberOfServicesInLongView||window.__gantt.reachedMaxNumberOfAbsencesInLongView)},window.__gantt.shouldShowLongTermError=i.shouldShowLongTermError,i.showFloatingMap=function(e){e.stopPropagation(),i.floatingMapOn=!0;var t=$("#MapContainer");t.css("opacity",g.opacity),t.css("height",g.height+"px"),t.css("width",g.width+"px"),g.left&&(t.css("left",g.left+"px"),t.css("top",g.top+"px"),t.css("bottom","auto"))},i.changeWorkingState=function(e){e!==i.workingState&&(i.workingState=e,i.floatingMapOn=!1,"map"===e?$("#MapContainer").removeAttr("style").resizable("disable"):$("#MapContainer").removeAttr("style").resizable("enable"))},i.closeFloatingMap=function(){i.floatingMapOn=!1,$("#MapContainer").removeAttr("style").resizable("disable")},setTimeout(function(){$("#MapContainer").draggable({handle:"#FloatingMapControls",containment:"document",start:function(){},stop:function(e,t){g.left=t.position.left,g.top=t.position.top}}).resizable({maxHeight:window.innerHeight-75,maxWidth:window.innerWidth-75,minHeight:300,minWidth:450,handles:"all",containment:"document",distance:10,start:function(){},stop:function(e,t){g.width=t.size.width,g.height=t.size.height,g.left=t.position.left,g.top=t.position.top}}),$("#FloatingMapOpacity").slider({range:"min",min:40,max:100,value:100,slide:function(e,t){$("#MapContainer").css("opacity",t.value/100),g.opacity=t.value/100}})},2e3)}]),angular.module("serviceExpert").controller("serviceListCtrl",["$scope","$compile","$rootScope","$filter","utils","$timeout","$sce","servicesService","sfdcService","ResourcesAndTerritoriesService","GetSlotsService","userSettingsManager","StateService","TimePhasedDataService","LoadServiceListService","FieldSetFieldsService","ServiceAppointmentLightboxService","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","RegisterService","GanttFilterService","GeneralLightbox","LeftSideLocationFilteringService","$q",function(s,e,r,n,o,c,t,a,l,d,i,u,p,v,m,h,g,f,S,y,b,T,w,L,C,A){function D(e){delete s.filtersMap[e];for(var t=-1,i=0;i<s.filterOptions.length;i++)if(s.filterOptions[i].Id===e){t=i;break}-1!==t&&s.filterOptions.splice(t,1),s.filter.selectedFilter="All",u.GetUserSettingsProperty("Selected_List_View__c")!==s.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",s.filter.selectedFilter)}angular.element(document).ready(function(){var o=!1;function e(){var e=u.GetUserSettingsProperty("Left_Panel_Width_Percentage__c"),t=400,i=$("#contentWrapper"),n=u.GetUserSettingsProperty("Services_List_Height_Percentage__c"),r=250,s=$("#SmartPanelContainer");if(0===i.length&&(i=$(window)),0===s.length&&(s=$(window)),0==!i.width()&&!o){o=!0,null!=e&&0<e&&e<100&&(t=i.width()*e*.01),t<400&&(t=400);var a=t+3;$("#RightSideContainer").width("calc(100% - "+a+"px)"),Split(["#LeftSideContainer","#RightSideContainer"],{sizes:[t+"px"],minSize:[400,700],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$("#LeftSideContainer").width()/i.width();e*=100,u.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e)}})}c(function(){if(100!==s.height()){null!=n&&0<n&&n<100&&(r=s.height()*n*.01),250<r&&(r=250);var e=r+5;$("#ServiceListBottomContainer").height("calc(100% - "+e+"px");var t=s.height()-250,i=s.find(".gutter-vertical");i.length&&i.remove(),Split(["#ServiceListTopContainer","#ServiceListBottomContainer"],{direction:"vertical",sizes:[r+"px"],minSize:[5,t],snapOffset:10,gutterSize:5,onDragEnd:function(){var e=$("#ServiceListTopContainer").height()/s.height();e*=100,u.SetUserSettingsProperty("Services_List_Height_Percentage__c",e)}})}},0)}e(),$(window).bind("resize",e)}),"territories"===u.GetUserSettingsProperty("DefaultLeftPanel__c")&&u.GetUserSettingsProperty("locations").length&&C.open(),useNewFilters&&w.filtersPromise.then(function(e){var n=[];s.filterOptions.forEach(function(e){var t={};for(var i in e)t[i]=e[i];t.Name=e.name,t.old=!0,t.Id=e.value,n.push(t)}),s.filterOptions=[].concat(n,_toConsumableArray(e)),s.filtersMap={},s.filterOptions.forEach(function(e){return s.filtersMap[e.Id]=e})}).finally(function(){s.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0}),w.setFilterMap(s.filtersMap)}),window.__closeFilterLightbox=function(t){o.safeApply(s,function(){var e=L.closeLightboxFromOutside();e&&e(),t&&w.getFilterFromSalesforce(t).then(function(e){if(s.filtersMap[e.Id]){for(var t=0;t<s.filterOptions.length;t++)if(s.filterOptions[t].Id===e.Id){s.filterOptions[t]=e;break}}else s.filterOptions.push(e),s.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0});s.filtersMap[e.Id]=e})})},s.openGanttFilterLightbox=function(e){var t=s.filtersMap[s.filter.selectedFilter];switch(e){case"new":L.open(customLabels.FilterEditor,filterEditorPage);break;case"edit":L.open(customLabels.FilterEditor,filterEditorPage+"?&id="+t.Id);break;case"delete":if(!confirm(customLabels.ConfirmFilterDelete))return;w.deleteFilter(t.Id).then(D);break;case"hide":if(!confirm(customLabels.ConfirmFilterHide))return;w.hideFilter(t.Id).then(D)}},s.showNewFilterButton=function(){return customPermissions.Create_custom_Gantt_filters},s.showEditFilterButton=function(){if(!s.filtersMap)return!1;var e=s.filtersMap[s.filter.selectedFilter];return!(!e||e.old||(!customPermissions.Create_custom_Gantt_filters||customPermissions.Publish_custom_Gantt_filters||e.CreatedById!==userId)&&!customPermissions.Publish_custom_Gantt_filters)},s.showDeleteFilterButton=function(){if(!s.filtersMap)return!1;var e=s.filtersMap[s.filter.selectedFilter];return!(!e||e.old)&&customPermissions.Create_custom_Gantt_filters&&e.CreatedById===userId},s.showHideFilterButton=function(){if(!s.filtersMap)return!1;var e=s.filtersMap[s.filter.selectedFilter];return!(!e||e.old)&&customPermissions.Publish_custom_Gantt_filters&&customPermissions.Create_custom_Gantt_filters},s.newFilterChanged=function(){if("SearchOnServer"!==s.filterOptions[s.filterOptions.length-1].Id)if("SearchOnServer"!==s.filter.selectedFilter.Id&&"SearchOnServer"===s.filterOptions[s.filterOptions.length-1].Id&&s.filterOptions.pop(),useNewFilters){if(!s.filtersMap)return!1;var e=s.filtersMap[s.filter.selectedFilter]||s.filtersMap.All;s.filtersMap[s.filter.selectedFilter]||(s.filter.selectedFilter="All",e.selectedFilter="All"),u.GetUserSettingsProperty("Selected_List_View__c")!==s.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",s.filter.selectedFilter),e&&!e.old?function(){if(s.filtersMap){var e=s.filtersMap[s.filter.selectedFilter];if(e&&!e.old){var t=new Date(s.filter.endDate),i=new Date(s.filter.endDate);"Invalid Date"===s.filter.endDate.toString()&&(t=new Date(scheduler._max_date),i=new Date(scheduler._max_date)),e.List_only_appointments_on_the_gantt?(t=scheduler._min_date,i=scheduler._max_date):(t.setDate(t.getDate()-e.Days_before_horizon-1),i.setDate(i.getDate()+e.Days_after_horizon)),R(i,Math.ceil((i-t)/1e3/60/60/24),[])}}}():s.loadServiceAppointmentsToList()}else s.loadServiceAppointmentsToList()},s.fieldsTypes=o.fieldsTypes,s.openConsoleTab=o.openConsoleTab,s.useNewFilters=window.useNewFilters,s.isMapEnabled=p.isMapEnabled(),s.contractorSupport=p.areContractorsSupported(),s.statuses=S,s.statusCategory=y,s.statusTranslations=o.statusTranslations,s.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,s.ganttSettings=o.ganttSettings,s.showServiceList=o.showServiceList,s.hasCustomPermission=o.hasCustomPermission,s.isLightning=o.isLightning,s.loadingServicesToList=0,s.isOptimizationEnabled=isOptimizationEnabled,s.bulkActionsOrder=bulkActionsOrder,s.isInConsole=p.isInConsole,s.matchGantt=u.GetUserSettingsProperty("Match_Gantt_Dates__c"),s.fullScreen=!1,window.location.search.match(/[&?]fullScreen=(\d)/)&&(s.fullScreen="1"===window.location.search.match(/[&?]fullScreen=(\d)/)[1]?"0":"1"),s.servicesObjects=v.serviceAppointments,s.selectedServiceId=null,s.lastSelectedServiceId=null,s.servicesListVisitedDays={},s.servicesListInited=!1;var I={},k=[];function R(t,i,n){var e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;if(null===e&&(R.loadedSoFar=0),R.loadedSoFar>=maxNumberOfServicesToLoad)return o.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List),void(R.loadedSoFar=0);s.loadingServicesToList++,m.loadServicesInBulk(s.servicesObjects(),s.servicesListVisitedDays,t,i,e).then(function(e){e.totalFetched===numberOfServicesToLoadInEachBulk?(R.loadedSoFar+=e.totalFetched,n.push.apply(n,_toConsumableArray(e.needToCheckRules)),R(t,i,n,e.lastFetchedId)):e.scheduledServices&&(n.push.apply(n,_toConsumableArray(e.needToCheckRules)),0<n.length&&a.checkRules(n).then(a.drawViolationsOnGantt))}).catch(function(e){console.warn("loadServiceAppointmentsToList failed "+e)}).finally(function(){return s.loadingServicesToList--})}function F(){var e=scheduler.getState().max_date;return 0===e.getHours()&&0===e.getMinutes()?e=new Date(e.getTime()-6e4):(e.setHours(23),e.setMinutes(59),e.setSeconds(0)),e}s.flagged=a.flagged,s.loadedTerritories=[],s.selectorService=f,s.servicesSelection=s.selectorService.SelectedServices,s.selectedPolicy=null,s.policyOptions=[],s.showGanttSettings=!1,s.ganttSettingDraft=null,s.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],s.reallyHideList=!1,s.showAdvancedFilter=!1,s.invokedAction={},s.invokedActionFor={},s.showCustomFilterDropdown=!1,s.storageFilters=null,s.prevEndDate=null,s.sortingColumn="start",s.sortingColumnName={start:customLabels.Start_time,finish:customLabels.Finish_time,accountName:customLabels.Account,serviceTypeName:customLabels.Service_type,priority:customLabels.Priority,resourceName:customLabels.Resource,earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,locationName:customLabels.Location},s.selectedDates={earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,appStart:customLabels.Appointment_start,appEnd:customLabels.Appointment_finish,start_date:customLabels.Start,end_date:customLabels.Finish},s.filter=a.filter,s.orderByField=a.filter.orderByField,s.reverse=a.filter.reverse,s.filteredServices=a.filteredServices,s.filterOptions=[],o.hasCustomPermission("Service_List_Todo")&&s.filterOptions.push({name:customLabels.Todo,value:"Todo"}),s.filterOptions.push({name:customLabels.AllServices,value:"All"}),s.filterOptions.push({name:customLabels.Recently_used,value:"Recent"}),o.hasCustomPermission("Service_List_Flagged")&&s.filterOptions.push({name:customLabels.Flagged,value:"Flagged"}),o.hasCustomPermission("Service_List_Selected")&&s.filterOptions.push({name:customLabels.Selected_Capital,value:"Selected"}),o.hasCustomPermission("Service_List_Unscheduled")&&s.filterOptions.push({name:customLabels.UnscheduledCapital,value:"Unscheduled"}),o.hasCustomPermission("Service_List_Scheuled")&&s.filterOptions.push({name:customLabels.Scheduled,value:"Scheduled"}),o.hasCustomPermission("Service_List_In_Jeopardy")&&s.filterOptions.push({name:customLabels.In_Jeopardy,value:"inJeopardy"}),o.hasCustomPermission("Service_List_Rule_Violating")&&s.filterOptions.push({name:customLabels.Rules_violating,value:"Violating"}),o.hasCustomPermission("Service_List_Gantt")&&s.filterOptions.push({name:customLabels.Gantt,value:"Gantt filter"}),o.hasCustomPermission("Service_List_Canceled")&&s.filterOptions.push({name:customLabels.Cancelled,value:"Cancelled filter"}),p.areContractorsSupported()&&o.hasCustomPermission("Service_List_Contractors")&&s.filterOptions.push({name:customLabels.Contractors,value:"Contractors filter"}),p.areCrewsSupported()&&o.hasCustomPermission("Service_List_Crews")&&s.filterOptions.push({name:customLabels.crews,value:"Crews filter"}),h.fieldsSetFields().then(function(e){for(var t in I=e)e[t].forEach(function(e){k[e.FullAPIName]=e});s.clickedServiceFieldPairs=[];for(var i=0;i<e.ListExpanded.length;){for(var n=i+2,r=[];i<e.ListExpanded.length&&i<n;i++)r.push(e.ListExpanded[i]);s.clickedServiceFieldPairs.push(r)}}),s.getColumnsToDisplay=function(){var e=w.getFilterById(s.filter.selectedFilter);if(e&&e.Displayed_Fields&&0<e.Displayed_Fields.length){var t=[];return e.Displayed_Fields.forEach(function(e){k[e]&&t.push(k[e])}),t}return I.ListColumns},s.isPinnedStatus=function(e){for(var t=s.pinnedStatusesSF.split(","),i=0;i<t.length;i++)if(e===t[i])return!0;return!1},s.getSingleTaskColumnClass=function(e){var t={SingleTaskColumn:!0,truncate:!0};return t["Field-"+e.Type]=!0,t},s.getHeaderTaskColumnClass=function(e){var t={SortingTasksListColumn:!0};return t["Field-"+e.Type]=!0,t},s.loadServiceAppointmentsToList=function(){R(s.endDate,o.ganttSettings.backHorizon,[])},s.formatServiceField=function(e,t){var i=e[t.APIName];switch(t.Type){case o.fieldsTypes.DateTime:i=n("amDateFormat")(i,"lll");break;case o.fieldsTypes.Date:i=n("amDateFormat")(i,"L")}return i},s.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},s.isFieldEmpty=function(e,t){return void 0===n("displayFieldSetField")(e,t)},s.openCalendarAdvanceFilterStart=function(){s.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(s.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(s,function(){e>new Date(s.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):s.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},s.openCalendarAdvanceFilterFinish=function(){s.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMax",date:new Date(s.endDate),navigation:!0,handler:function(e,t){o.safeApply(s,function(){e<new Date(s.filter.advancedFilter.minDate)?alert(customLabels.startBeforeEnd):s.filter.advancedFilter.maxDate=e}),scheduler.destroyCalendar()}}))},s.openCalendarAdvanceFilterStart=function(){s.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(s.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(s,function(){e>new Date(s.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):s.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},p.promises.policies().then(function(e){s.policyOptions=e;for(var t=!1,i=u.GetUserSettingsProperty("Gantt_Policy__c"),n=0;n<e.length;n++)if(i){if(e[n].Id===i){s.selectedPolicy=e[n],t=!0;break}}else if(e[n].Id===defaultPolicy){s.selectedPolicy=e[n],t=!0;break}t||(s.selectedPolicy=s.policyOptions[0]),p.selectedPolicyId=s.selectedPolicy.Id}).catch(function(e){console.warn(e),cantLoadGantt(customLabels.no_policy_found)}),s.changePolicy=function(){p.selectedPolicyId=s.selectedPolicy.Id,u.SetUserSettingsProperty("Gantt_Policy__c",s.selectedPolicy.Id);var e=[];for(var t in scheduler._events)"service"===scheduler._events[t].type&&e.push(t);0<e.length&&a.checkRules(e).then(a.drawViolationsOnGantt)},s.order=function(e,t){s.filter.orderByField=e,s.filter.reverse=t},s.selectService=function(e){e===s.selectedServiceId?(s.selectedServiceId=null,s.lastSelectedServiceId=e):(s.lastSelectedServiceId=s.selectedServiceId,s.selectedServiceId=e)},s.violationsTooltip=function(e){if(e.isMDT&&!e.violations&&!e.jeopardy)return customLabels.Multi_Day_Service;if(e.violations||e.jeopardy){if(e.jeopardy&&e.jeopardyReason)return e.jeopardyReason;if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+"\n";return t=t&&t.substring(0,t.length-1)}}},s.getStatusClass=function(e){return o.getCSSClassForContext(e.statusCategory,y)},s.$on("initCompleted",function(e){s.initEndDate();var t=u.GetUserSettingsProperty("locations");s.territories=[];for(var i=0;i<t.length;i++)void 0!==d.territories()[t[i]]&&s.territories.push(d.territories()[t[i]]);!function(){if(!useNewFilters){s.storageFilters=x();for(var e=0;e<s.storageFilters.length;e++)s.filterOptions.push({name:s.storageFilters[e].name,value:s.storageFilters[e].name});0<s.storageFilters.length?P(s.storageFilters[0].name):P(null)}}()}),s.initEndDate=function(){s.endDate=F(),s.matchGantt||(s.endDate=o.addDaysToDate(s.endDate,1)),s.prevEndDate=s.endDate,s.filter.endDate=s.endDate,s.horizonDateChanged()},s.horizonDateChanged=function(){if(moment(s.filter.endDate).isValid()){var e=o.addDaysToDate(s.filter.endDate,-o.ganttSettings.backHorizon);p.setDeltaDates(e,s.filter.endDate)}},s.$on("ganttFinishedLoadingServices",function(){!s.matchGantt&&!1!==s.servicesListInited||(s.servicesListInited||null!==s.endDate&&!isNaN(s.endDate.getTime())||s.initEndDate(),s.servicesListInited=!0,s.newFilterChanged())}),scheduler.attachEvent("onBeforeViewChange",function(e,t){return scheduler._old={mode:e,date:t},!0});var M=!0;function x(){return u.GetUserSettingsProperty("Filters__c")?JSON.parse(u.GetUserSettingsProperty("Filters__c")):[]}function O(){return u.SetUserSettingsProperty("Filters__c",JSON.stringify(s.storageFilters))}function P(e){if(s.lastSelectedFilter=e){for(var t=0;t<s.storageFilters.length;t++)s.storageFilters[t].name===e&&(s.filter.advancedFilter=angular.copy(s.storageFilters[t].filter));s.customFilterName=e,s.DisplayComboBowArrow=!0,s.IsCustomFilterReadonly=!0,s.displayNew=!0,s.displayEdit=!0,s.displayDelete=!0}else s.filter.advancedFilter=E(),s.customFilterName="",s.DisplayComboBowArrow=!1,s.IsCustomFilterReadonly=!0,s.displayNew=!0,s.displayEdit=!1,s.displayDelete=!1}function E(){var t={statusCheckboxs:{},minDate:new Date,maxDate:new Date,servicePriority:10,unScheduled:!0,violations:!0,jeopardies:!0,noLocation:!0,locationsCheckboxs:{}};if(0<Object.keys(s.statusTranslations).length)for(var e in s.statusTranslations)t.statusCheckboxs[s.statusTranslations[e]]=!0;else r.$on("gotStatuses",function(){for(var e in s.statusTranslations)t.statusCheckboxs[s.statusTranslations[e]]=!0});for(var i=0;i<s.territories.length;i++){var n=s.territories[i];t.locationsCheckboxs[n.name]=!0}return t}scheduler.attachEvent("onViewChange",function(e,t){scheduler._old.mode===e&&t===scheduler._old.date&&"LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||p.isLoadingNewLocations||(p.setDeltaDates(scheduler.getState().min_date,F()),o.safeApply(s,function(){if(s.matchGantt){var e=F();s.filter.endDate=e,s.endDate=e,s.matchGantt&&!M?s.newFilterChanged():M=!1}}))}),s.matchGanttClicked=function(){if(s.matchGantt)s.prevEndDate=s.endDate,s.filter.endDate=F(),s.endDate=s.filter.endDate,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!0);else{var e=s.prevEndDate;"Invalid Date"===e.toString()&&(e=scheduler._min_date),s.filter.endDate=e,s.endDate=e,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!1)}s.newFilterChanged()},s.openLightBox=function(e){a.recentlyUsed[e]=!0,g.open(e)},s.flagging=function(e){if(!a.flagged[e])return a.flagged[e]=!0,void scheduler.updateEvent(e);a.flagged[e]&&(a.flagged[e]=!a.flagged[e],scheduler.updateEvent(e))},s.showOnGantt=function(e){a.recentlyUsed[e.id]=!0,scheduler._events[e.id]?"none"===$("#GanttMapContainer").css("display")?(r.$broadcast("changeWorkingState","gantt"),c(function(){updateViewDebounced()},20),c(function(){o.showOnGantt(e.id)},120)):o.showOnGantt(e.id):alert(customLabels.location_not_loaded)},s.changeStatusToDispatch=function(t){if(s.invokedActionFor[t]||p.schedulingRunningFor[t])alert(customLabels.another_operation_running);else{a.recentlyUsed[t]=!0,s.invokedAction[t]="dispatch",s.invokedActionFor[t]=!0;var e=[t];a.changeStatus(e,S.DISPATCHED).then(function(e){a.drawServicesAndAbsences(e.services),s.invokedAction[t]=null,s.invokedActionFor[t]=!1})}},s.showOnMap=function(e){r.$broadcast("showServiceOnMap",e)},s.openDateEndCalendar=function(){s.matchGantt||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"DateStart",date:new Date(s.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(s,function(){s.endDate=e,s.endDate.setHours(23),s.endDate.setMinutes(59),s.endDate.setSeconds(0),s.filter.endDate=s.endDate,s.horizonDateChanged(),s.newFilterChanged()}),scheduler.destroyCalendar()}}))},s.openFullScreen=function(){var e=window.location.search.match(/[&?]fullScreen=(\d)/);if(e){var t="1"===e[1]?"0":"1";window.location.search=window.location.search.replace(/[&?]fullScreen=\d/,"&fullScreen="+t)}else window.location.search+="&fullScreen=1"},s.getSlots=function(e){a.recentlyUsed[e]=!0,"none"===$("#GanttMapContainer").css("display")&&(r.$broadcast("changeWorkingState","gantt"),setTimeout(function(){updateViewDebounced()},20)),s.invokedActionFor[e]||p.schedulingRunningFor[e]?alert(customLabels.another_operation_running):i.get(e)},s.scheduleAndReshuffle=function(r){s.invokedActionFor[r]?alert(customLabels.another_operation_running):(a.recentlyUsed[r]=!0,s.invokedAction[r]="reshuffle",s.invokedActionFor[r]=!0,l.runReshuffle(r,p.selectedPolicyId).then(function(n){b.updateOptimizationRequest(n),T.register("optimizationRequests",function i(e){e.forEach(function(e){var t=new OptimizationRequest(e);t.id!==n.Id||"Completed"!==t.status&&"Failed"!==t.status||(s.invokedAction[r]=null,s.invokedActionFor[r]=!1,T.unRegister("optimizationRequests",i))})})},function(){o.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),s.invokedAction[r]=null,s.invokedActionFor[r]=!1}))},s.groupNearby=function(r){s.invokedActionFor[r]?alert(customLabels.another_operation_running):(a.recentlyUsed[r]=!0,s.invokedAction[r]="groupNearby",s.invokedActionFor[r]=!0,l.runGroupNearby(r,p.selectedPolicyId).then(function(n){b.updateOptimizationRequest(n),T.register("optimizationRequests",function i(e){e.forEach(function(e){var t=new OptimizationRequest(e);t.id!==n.Id||"Completed"!==t.status&&"Failed"!==t.status||(s.invokedAction[r]=null,s.invokedActionFor[r]=!1,T.unRegister("optimizationRequests",i))})})},function(){o.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),s.invokedAction[r]=null,s.invokedActionFor[r]=!1}))},s.autoScheduleService=function(e){s.invokedActionFor[e]||p.schedulingRunningFor[e]?alert(customLabels.another_operation_running):(a.recentlyUsed[e]=!0,s.invokedAction[e]="schedule",s.invokedActionFor[e]=!0,a.autoScheduleService(e).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),e.mst||a.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){s.invokedAction[e]=null,s.invokedActionFor[e]=!1}))},s.$on("autoScheduleServiceFinished",function(e,t){s.invokedAction[t]=null,s.invokedActionFor[t]=!1}),s.openGanttSettings=function(){s.showGanttSettings=!0,o.ganttSettings?s.ganttSettings=o.ganttSettings:(s.ganttSettings.filterCandidates=!0,s.ganttSettings.servicesPerPage=200,s.ganttSettings.backHorizon=14,s.ganttSettings.capacityDuration="Day"),s.ganttSettingDraft=angular.copy(s.ganttSettings),setTimeout(function(){$("#ganttSettingsLightbox").draggable({containment:"document",handle:"#ganttSettingsLightboxHeader"})},200)},s.closeSettingsLightbox=function(){s.showGanttSettings=!1,$("#ganttSettingsLightbox").attr("style",""),s.ganttSettingDraft=angular.copy(s.ganttSettings)},s.parseGanttSettingsToUserSetting=function(e){var t={};return t.Gantt_View_Start_Hour__c=e.startHour,t.Gantt_View_Finish_Hour__c=e.finishHour,t.Filter_Candidates__c=e.filterCandidates,t.Services_Per_Page__c=e.servicesPerPage,t.Resource_Row_Height__c=e.resourceRowHeight,t.Scheduling_horizon_limit__c=e.backHorizon,t.View_Capacity_Type__c=e.capacityDuration,t.Load_On_Today__c=e.loadOnToday,t.DefaultLeftPanel__c=e.leftPanel,t.ServiceListColoring__c=e.serviceColoring,t},s.saveGanttSettings=function(){void 0!==s.ganttSettingDraft.backHorizon?(schedulerConfig.setRowHeights(s.ganttSettingDraft.resourceRowHeight,!0),setCapacityFilter(s.ganttSettingDraft.capacityDuration,!0),s.ganttSettings=angular.copy(s.ganttSettingDraft),o.ganttSettings=angular.copy(s.ganttSettingDraft),s.filter.servicesPerPage=parseInt(s.ganttSettings.servicesPerPage),u.SetUserSettingProperties(s.parseGanttSettingsToUserSetting(s.ganttSettings)).then(function(){s.loadServiceAppointmentsToList()}),s.showGanttSettings=!1):alert(customLabels.backHorizonInvalid)},s.$on("keypress",function(e,t){27===t.which&&s.closeSettingsLightbox()}),s.createArray=function(e,t){if("number"!=typeof e||isNaN(e))return[];if("number"!=typeof t||isNaN(t))return[];var i=Math.floor(e/t);return 0<e%t&&i++,new Array(i)},s.changePage=function(e){switch(e){case"right":s.filter.totalPages!=s.filter.currentPage&&(s.filter.currentPage=parseInt(s.filter.currentPage)+1,s.filter.currentPage=s.filter.currentPage.toString());break;case"left":1<s.filter.currentPage&&(s.filter.currentPage=parseInt(s.filter.currentPage)-1,s.filter.currentPage=s.filter.currentPage.toString());break;case"first":1<s.filter.currentPage&&(s.filter.currentPage="1");break;case"last":s.filter.totalPages!=s.filter.currentPage&&(s.filter.currentPage=s.filter.totalPages.toString())}},s.hideServiceList=function(){s.showServiceList.show=!1,s.reallyHideList=!0,c(function(){updateViewDebounced(),r.$broadcast("resizeMap",{})},0)},s.$watch("showServiceList.show",function(e,t){e&&(s.reallyHideList=!1)}),s.isDraggable=function(e){var t=s.servicesObjects()[e];return!!t&&!scheduler._events[t.id+"_dummy"]&&!t.resourceId&&t.statusCategory===y.NONE&&(!t.pinned||t.pinned&&!preventUpdateOfPinned)},s.isBeingSavedNow=function(e){return!!scheduler._events[e+"_dummy"]},s.showAdvancedFilterFunc=function(){$("#AdvancedFilteringOptions").css("display","block"),c(function(){$("#SmartPanelContainer").find(".gutter-vertical").hide(),s.showAdvancedFilter=!0},100)},s.hideAdvancedFilterFunc=function(){s.showAdvancedFilter=!1,setTimeout(function(){$("#SmartPanelContainer").find(".gutter-vertical").show(),$("#AdvancedFilteringOptions").css("display","none")},700)},s.removeSpaces=function(e){return e?e.split(" ").join("+"):""},s.filterChanged=function(){var e=x(),t=function(e,t){for(var i=0;i<t.length;i++)if(t[i].name==e)return t[i].filter;return!1}(s.filter.selectedFilter,e);t?(s.filter.advancedFilter=t,s.customFilterSelected=!0,s.customFilterName=s.filter.selectedFilter):s.customFilterSelected=!1,u.GetUserSettingsProperty("Selected_List_View__c")!==s.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",s.filter.selectedFilter)},s.$on("gotNewResources",function(e,t){s.territories=[];for(var i=t.show,n=0;n<i.length;n++)void 0!==d.territories()[i[n]]&&s.territories.push(d.territories()[i[n]]);s.servicesListVisitedDays={},s.newFilterChanged()}),s.createCustomFilter=function(){s.isEditMode=!1,s.customFilterName="",s.displayCancel=!0,s.IsCustomFilterReadonly=!1,s.DisplayComboBowArrow=!1,s.displayNew=!1,s.displayEdit=!1,s.displaySave=!0,s.displayDelete=!1,s.filter.advancedFilter=E()},s.CancelSaveOrEditCustomFilter=function(){s.displayNew=!0,s.displayEdit=!0,s.DisplayComboBowArrow=!0,s.displaySave=!1,s.displayDelete=!0,s.displayCancel=!1,s.IsCustomFilterReadonly=!0,P(s.lastSelectedFilter)},s.saveCustomFilter=function(){if(0!==s.customFilterName.length){for(var e=0;e<s.filterOptions.length;e++)if(!s.isEditMode&&s.filterOptions[e].name===s.customFilterName||s.isEditMode&&s.filterOptions[e].name===s.customFilterName&&s.filterOptions[e].name!==s.lastSelectedFilter)return void alert("Please select another name");if(s.displayNew=!0,s.displayEdit=!0,s.DisplayComboBowArrow=!0,s.displaySave=!1,s.displayDelete=!0,s.displayCancel=!1,s.IsCustomFilterReadonly=!0,s.isEditMode){for(var t=0;t<s.storageFilters.length;t++)if(s.storageFilters[t].name===s.lastSelectedFilter){s.storageFilters[t].filter=s.filter.advancedFilter,s.storageFilters[t].name=s.customFilterName,O();for(var i=0;i<s.filterOptions.length;i++)if(s.filterOptions[i].name===s.lastSelectedFilter){s.filterOptions[i].name=s.customFilterName,s.filterOptions[i].value=s.customFilterName;break}s.filter.selectedFilter===s.lastSelectedFilter&&(s.filter.selectedFilter=s.customFilterName);break}}else s.storageFilters.push({name:angular.copy(s.customFilterName),filter:angular.copy(s.filter.advancedFilter)}),s.filterOptions.push({name:angular.copy(s.customFilterName),value:angular.copy(s.customFilterName)}),O(),s.customFilterSelected=!0,s.filter.selectedFilter=s.customFilterName;s.lastSelectedFilter=s.customFilterName}else alert(customLabels.Please_give_a_name_to_the_custom_filter)},s.EditCustomFilter=function(){s.isEditMode=!0,s.displayCancel=!0,s.DisplayComboBowArrow=!1,s.displayNew=!1,s.displayEdit=!1,s.displaySave=!0,s.displayDelete=!1,s.IsCustomFilterReadonly=!1,s.DisplayComboBowArrow=!1,s.filter.advancedFilter=angular.copy(s.filter.advancedFilter)},s.deleteCustomFilter=function(){s.IsCustomFilterReadonly=!0,s.DisplayComboBowArrow=!0,s.displayNew=!0,s.displayEdit=!0,s.displaySave=!1,s.displayDelete=!0;for(var e=0;e<s.storageFilters.length;e++)if(s.storageFilters[e].name===s.customFilterName){s.storageFilters.splice(e,1);break}!function(e){for(var t=0;t<s.filterOptions.length;t++)s.filterOptions[t].name===e&&s.filterOptions.splice(t,1)}(s.customFilterName),O(),s.filter.selectedFilter===s.customFilterName&&(s.filter.selectedFilter=customPermissions.Service_List_Todo?"Todo":"All"),0<s.storageFilters.length?P(s.storageFilters[0].name):P(null)},s.customFilterChanged=function(e){P(s.customFilterName=e)},s.showDropdownCustomFilters=function(e){e.stopPropagation(),0<s.storageFilters.length&&(s.showCustomFilterDropdown=!s.showCustomFilterDropdown)},s.toggleStatus=function(e,t){s.IsCustomFilterReadonly||(s.filter.advancedFilter.statusCheckboxs[t]=!s.filter.advancedFilter.statusCheckboxs[t])},s.toggleLocation=function(e){s.IsCustomFilterReadonly||(e?s.filter.advancedFilter.locationsCheckboxs[e]=!s.filter.advancedFilter.locationsCheckboxs[e]:s.filter.advancedFilter.noLocation=!s.filter.advancedFilter.noLocation)},s.clearRecentlyViewed=function(){for(var e in a.recentlyUsed)delete a.recentlyUsed[e]},s.openLocationFiltering=function(){LeftLocationFilteringService.open()},s.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}};var N=null,G=_.debounce(function(){var e=n("servicesListFilter"),t=n("pagination"),i=e(s.servicesObjects(),s.filter,s.getColumnsToDisplay(),s.filtersMap);N===i.checksum&&!__gantt.inday.isInDayRunning||(N=i.checksum,o.safeApply(s,function(){s.filteredServices.servicesArray=t(i,s.filter.currentPage,s.filter.servicesPerPage)}))},400,{maxWait:2e3});s.getServiceListFilter=function(){return G(),s.filteredServices.servicesArray},s.searchServiceByIdOrName=function(e){s.notFoundOnServer=!1,a.searchServiceByIdOrName(e).then(function(e){e?(a.checkRules([e]).then(a.drawViolationsOnGantt),s.filter.searchOnServer=e,s.filterOptions.find(function(e){return"SearchOnServer"===e.Id})||s.filterOptions.push({Name:customLabels.searchOnServer,name:customLabels.searchOnServer,old:!0,Id:"SearchOnServer",value:"SearchOnServer"}),s.filter.lastSelectedFilter=s.filter.selectedFilter,s.filter.selectedFilter="SearchOnServer"):s.notFoundOnServer=!0}).catch(function(e){console.warn(e)})},s.resetSearchText=function(){s.notFoundOnServer=null,s.filter.SearchText="","SearchOnServer"===s.filter.selectedFilter&&(s.filter.selectedFilter=s.filter.lastSelectedFilter,"SearchOnServer"===s.filterOptions[s.filterOptions.length-1].Id&&s.filterOptions.pop())},s.saveSettingsOfHorizonDates=function(){V()};var V=_.debounce(function(){u.SetUserSettingsProperty("Date_Horizon_Properties__c",JSON.stringify(s.filter.selectedFiled))},800);function H(e){switch(e){case y.NONE:return"#a5e2d6";case y.SCHEDULED:return"#F9D058";case y.DISPATCHED:return"#8DD8FA";case y.IN_PROGRESS:return"#D68EF9";case y.COMPLETED:return"#95d155";case y.COULD_NOT_COMPLETE:return"#f58556";case y.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}s.customActions=[],o.customActionsPromise.then(function(){var e,t=o.getCustomActions("list");(e=s.customActions).push.apply(e,_toConsumableArray(t))}),s.runCustomServiceAction=function(e,t){var i=parseInt($(e.currentTarget).attr("actionId")),n=[t],r=o.getCustomActions("list")[i];if(r.visualforce){var s=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),a=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===n.length?L.open(r.name,r.visualforce+"?id="+n[0]+"&start="+s+"&end="+a):L.open(r.name,r.visualforce+"?services="+n.join(",")+"&start="+s+"&end="+a)}else l.runCustomServiceAction(r.className,n,scheduler._min_date,scheduler._max_date).then(function(e){e&&o.addNotification(r.name,e,null,null)}).catch(function(e){return o.addNotification(r.name,e.message,null,null)})},s.showTerritoriesFiltering=function(){C.open()},s.getStyleForServiceItem=function(e){var t={};if(e.violations||e.jeopardy)return t;if("gradient"===s.ganttSettings.serviceColoring)if(window.paletteViewActive&&e.ganttPaletteColor)t.background="linear-gradient(to right, "+e.ganttPaletteColor.color+" -85%,#ffffff 65%)";else if(e.ganttColor)t.background="linear-gradient(to right, "+e.ganttColor+" -85%,#ffffff 65%)";else{var i=H(e.statusCategory);t.background="linear-gradient(to right, "+i+" -85%,#ffffff 65%)"}if("full"===s.ganttSettings.serviceColoring&&"full"===s.ganttSettings.serviceColoring)if(window.paletteViewActive&&e.ganttPaletteColor)t.background=e.ganttPaletteColor.color+"70";else if(e.ganttColor)t.background=e.ganttColor+"70";else{var n=H(e.statusCategory);t.background=n+"70"}return t},s.highlightOnGantt=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];window.__servicesInFilter={applied:e},e&&n("servicesListFilter")(s.servicesObjects(),s.filter,s.getColumnsToDisplay(),s.filtersMap).forEach(function(e){return window.__servicesInFilter[e.id]=!0}),updateViewDebounced()},s.shouldShowClearHighlight=function(){return!!window.__servicesInFilter&&window.__servicesInFilter.applied}}]),angular.module("serviceExpert").filter("ampmOr24",function(){return function(e,t,i){var n=parseInt(e),r=i?":00":"";return"ampm"==t?12===e?"12PM":0===e||24===e?"12AM":12<n?n-12+"PM":n+"AM":"24"==t?n<10?"0"+n+r:n+r:e}}),angular.module("serviceExpert").filter("displayFieldSetField",["utils","$filter",function(n,r){return function(e,t){if(e&&t){var i=e[t.APIName];if(i)if("Status"===t.APIName)i=n.statusTranslations[e.status]||e.status;else switch(t.Type){case n.fieldsTypes.DateTime:i=r("amDateFormat")(i,"l LT");break;case n.fieldsTypes.Date:i=r("amDateFormat")(i,"L");break;case n.fieldsTypes.Currency:i=r("currency")(i,defaultCurrency)}return null==i&&(i=void 0),i}}}]).filter("displayReportField",["utils","$filter",function(e,i){return function(e){if(e){var t=e.Label;switch(e.Type){case"DATETIME_DATA":t=i("amDateFormat")(t,"l LT");break;case"DATE_DATA":t=i("amDateFormat")(t,"L")}return null==t&&(t=void 0),t}}}]),angular.module("serviceExpert").filter("orderObjectBy",function(){return function(e,i,t){var n=[];return angular.forEach(e,function(e){n.push(e)}),n.sort(function(e,t){return e[i]>t[i]?1:-1}),t&&n.reverse(),n}}),angular.module("serviceExpert").filter("pagination",["servicesService",function(a){return function(e,t,i){a.filter.totalServices=e.length,(null==a.filter.currentPage||parseInt(a.filter.currentPage)>a.filter.totalPages)&&(a.filter.currentPage="1",t=1);var n=[],r=(t-1)*i,s=(t-1)*i+i;return n=e.length<=i?e:e.slice(r,s),e.length==a.filter.servicesPerPage?a.filter.totalPages=1:(a.filter.totalPages=Math.floor(e.length/a.filter.servicesPerPage),0<e.length%a.filter.servicesPerPage&&a.filter.totalPages++),a.filter.firstVisibleService=1+r,a.filter.lastVisibleService=s,e.length<=i?a.filter.lastVisibleService=e.length:s>e.length&&(a.filter.lastVisibleService=e.length),n}}]),angular.module("serviceExpert").filter("replaceLabels",function(){return function(e){for(var t=e,i=arguments.length,n=Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var s=0;s<n.length;s++)t=t.replace("$"+s,n[s]);return t}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}angular.module("serviceExpert").filter("servicesListFilter",["utils","$filter","servicesService","userSettingsManager","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY",function(O,P,E,N,$,e,G){return function(e,t,i,n){var r=function(e,t){var i=Object.keys(e).length.toString();for(var n in t)if("object"!==_typeof(t[n])){if("boolean"==typeof t[n]){i+=t[n]?"1":"0";continue}i+=t[n].toString()}for(var r in i+=t.endDate.getTime(),t.selectedFiled)i+=t.selectedFiled[r]?"1":"0";for(var s in t.advancedFilter.selectedFiled)i+=t.advancedFilter.selectedFiled[s]?"1":"0";for(var a in t.advancedFilter.statusCheckboxs)i+=t.advancedFilter.statusCheckboxs[a]?"1":"0";return i+=t.advancedFilter.minDate.toString(),i+=t.advancedFilter.maxDate.toString(),i+=t.advancedFilter.servicePriority,i+=t.advancedFilter.jeopardies?"1":"0",i+=t.advancedFilter.unScheduled?"1":"0",i+=t.advancedFilter.violations?"1":"0"}(e,t);if("SearchOnServer"===t.selectedFilter){var s=[e[t.searchOnServer]],a=0;return s.forEach(function(e){return a+=e.totalModifiedTimes}),s.checksum+=a.toString(),s}var o=n&&n[t.selectedFilter]&&n[t.selectedFilter].old;if(useNewFilters&&!o){var c=P("servicesListFilterNew")(e,t,i);return c.checksum=r+c.totalChecksum.toString(),c}var l=[],d=new Date(t.endDate),u=O.addDaysToDate(d,-O.ganttSettings.backHorizon),p=scheduler.getState().min_date,v=scheduler.getState().max_date,m=function(e){if(null==N.GetUserSettingsProperty("Filters__c"))return null;for(var t="object"===_typeof(N.GetUserSettingsProperty("Filters__c"))?N.GetUserSettingsProperty("Filters__c"):JSON.parse(N.GetUserSettingsProperty("Filters__c")),i=0;i<t.length;i++)if(t[i].name===e)return t[i].filter;return null}(t.selectedFilter),h=null,g=[];-1<t.SearchText.indexOf(",")&&""===(h=t.SearchText.replace(/, /g,",").split(","))[h.length-1]&&h.length--,h?g=h:g.push(t.SearchText);var f,S,_,y,b,T,w,L,C=0;for(var A in e)for(var D=0;D<g.length;D++){var I=V(e[A],g[D],i),k=(b=e[A],T=t.selectedFiled,w=u,void 0,L=new Date(d),!!(void 0!==T.earlyStart&&T.earlyStart&&b.earlyStart&&b.earlyStart>w&&b.earlyStart<=L||void 0!==T.dueDate&&T.dueDate&&b.dueDate&&b.dueDate>w&&b.dueDate<=L||void 0!==T.appStart&&T.appStart&&b.appStart&&b.appStart>w&&b.appStart<=L||void 0!==T.appEnd&&T.appEnd&&b.appEnd&&b.appEnd>w&&b.appEnd<=L||void 0!==T.finish&&T.finish&&b.finish&&b.finish>w&&b.finish<=L||void 0!==T.start&&T.start&&b.start&&b.start>w&&b.start<=L||void 0!==T.display&&T.display&&b.ganttDisplay&&b.ganttDisplay>w&&b.ganttDisplay<=L));if("Selected"===t.selectedFilter){if($.SelectedServices[A]&&$.SelectedServices[A]&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}else if("Flagged"===t.selectedFilter&&I){if(E.flagged[A]){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}else if("Recent"===t.selectedFilter&&I){if(E.recentlyUsed[A]){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}else if("Todo"===t.selectedFilter){if((e[A].statusCategory===G.NONE||e[A].violations||e[A].jeopardy)&&e[A].statusCategory!==G.CANCELED&&e[A].statusCategory!==G.COMPLETED&&k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("All"===t.selectedFilter){if(k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("Unscheduled"===t.selectedFilter){if(!e[A].resource&&e[A].statusCategory!=G.CANCELED&&k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("Violating"===t.selectedFilter){if(e[A].violations&&e[A].statusCategory!=G.CANCELED&&k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("inJeopardy"===t.selectedFilter){if(e[A].jeopardy&&e[A].statusCategory!=G.CANCELED&&k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("Scheduled"===t.selectedFilter){if(e[A].resource&&k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("Gantt filter"===t.selectedFilter){if(e[A].resource&&(e[A].start<=v&&e[A].start>=p||e[A].finish<=v&&e[A].finish>=p)){var R=!0;if("LongView"===scheduler._mode){var F=(e[A].finish-e[A].start)/1e3/60/60;if(window.__currentViewOptions.showMdt){var M=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField;R=F>=window.__currentViewOptions.minServiceDuration&&e[A].fields[M]}else R=F>=window.__currentViewOptions.minServiceDuration}if(1<g[D].length&&I&&R){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1&&R){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("Contractors filter"===t.selectedFilter){if(e[A].resourceContractor&&k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("Cancelled filter"===t.selectedFilter){if(e[A].statusCategory===G.CANCELED&&k){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if("Crews filter"===t.selectedFilter){if(e[A].isAssignToCrew){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}else if(void 0!==e[A].parentFields.MinimumCrewSize||void 0!==e[A].parentFields.RecommendedCrewSize){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}else if(m&&m.statusCheckboxs[statusTranslations[e[A].status]]&&H(m,t.selectedFiled,e[A])&&(f=e[A],S=m.servicePriority,f.priority<=S)&&(_=e[A],y=m,(!_.jeopardy||y.jeopardies)&&(!_.violations||y.violations)&&(null!==_.start_date||y.unScheduled))&&B(e[A],m.locationsCheckboxs,m.noLocation)){if(1<g[D].length&&I){C+=e[A].totalModifiedTimes,l.push(e[A]);break}if(g[D].length<=1){C+=e[A].totalModifiedTimes,l.push(e[A]);break}}}var x=P("orderBy")(l,t.orderByField,t.reverse);return x.checksum=r+C.toString(),x};function V(e,t,i){if(e.name&&-1!=e.name.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.ganttLabel&&-1!=e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.id&&-1!==e.id.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.status&&-1!==e.status.toLowerCase().indexOf(t.toLowerCase()))return!0;for(var n=0;n<i.length;n++)if((i[n].Type===O.fieldsTypes.String||i[n].Type===O.fieldsTypes.TextArea||i[n].Type===O.fieldsTypes.Reference||i[n].Type===O.fieldsTypes.Picklist)&&e[i[n].APIName]&&-1!==e[i[n].APIName].toLowerCase().indexOf(t.toLowerCase()))return!0;return!1}function H(e,t,i){var n,r,s,a,o=new Date(e.minDate),c=new Date(e.maxDate);for(var l in o.setHours(0),o.setMinutes(0),c.setDate(c.getDate()+1),c.setHours(0),c.setMinutes(0),t)if(t[l]&&(s=o,a=c,void 0!==(n=i)[r=l]&&n[r]>=s&&n[r]<=a))return!0;return!1}function B(e,t,i){if(i&&!e.location)return!0;for(var n in t)if(e.serviceTerritoryName===n&&t[n])return!0;return!1}}]),function(){function e(B,U,z,j,e,q,W,Z,K,Y,J,t,X,i,n,Q){var ee=(new Date).getTime();return setInterval(function(){return ee+=6e4},6e4),n.register("positions",function(e){var t=z.getResources();for(var i in e)t[i]&&(t[i].lastKnownLongitude=e[i].longitude,t[i].lastKnownLocationDate=e[i].lastModifiedDate.getTime()-1e3*e[i].lastModifiedDate.getTimezoneOffset()*60,t[i].lastKnownLatitude=e[i].latitude)}),function(e,t,i,n,r,s,a){var o=[],c={},l=[],d=t.replace(/, /g,",").split(","),u=j.resourcesAndTerritories(),p=j.resourceToServiceCrewMembers(),v=U.getTerritoriesSortedByTree(),m=Z.GetUserSettingsProperty("locations");if(__gantt.inday.isInDayRunning=!1,(v=v.filter(function(t){return m.find(function(e){return e===t.id})})).forEach(function(e){o.push(new re(e,z.getOperatingHours()[e.operatingHours],Y)),c[e.id]=o.length-1}),i)for(var h in n)n[h]&&l.push(h);var g=B.ganttSettings&&B.ganttSettings.filterCandidates;for(var f in u){var S=u[f],_=z.getResources()[f];if(_&&(ie(_.name,d)&&(!("and"===r&&0<l.length&&i)||q.doesHaveSkills(f,l,scheduler._min_date,scheduler._max_date))&&(!("or"===r&&0<l.length&&i)||q.doesHaveSomeSkills(f,l,scheduler._min_date,scheduler._max_date)))){var y=!1;for(var b in a.resourceFilteringOptions)if(a.resourceFilteringOptions[b]&&!_.sobject[b]){y=!0;break}if(!y){if("select_a_field"!==a.selectedPicklist){if(0<a.picklistOptions.length&&-1===a.picklistOptions.indexOf(_.sobject[a.selectedPicklist])){if(!a.picklistNullValues)continue;if(void 0!==_.sobject[a.selectedPicklist])continue}if(0===a.picklistOptions.length&&a.picklistNullValues&&void 0!==_.sobject[a.selectedPicklist])continue}if(j.isCrewViewActive){var T=j.currentCrewToShow;if(void 0===T[f])continue;if(void 0!==T[f].members){var w=!1;for(var L in T[f].members){var C,A;if(useLocationTimezone)for(var D in S)ne(scheduler._min_date,scheduler._max_date,S[D].effectiveStartDate,S[D].effectiveEndDate)&&(C=B.convertDateBetweenTimeZones(T[f].members[L].startDate,"GMT",S[D].timezone),A=B.convertDateBetweenTimeZones(T[f].members[L].endDate,"GMT",S[D].timezone),ne(scheduler._min_date,scheduler._max_date,C,A)&&(w=!0));else C=B.convertDateBetweenTimeZones(T[f].members[L].startDate,"GMT",userTimeZone),A=B.convertDateBetweenTimeZones(T[f].members[L].endDate,"GMT",userTimeZone),ne(scheduler._min_date,scheduler._max_date,C,A)&&(w=!0)}if(!1===w)continue}}if(a.crewsSelectionOptions.selectedPicklist!==customLabels.showAll){if(B.crewsFilter=!0,a.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewMembers){if("C"!==_.sobject.ResourceType){var I=!1;for(var k in p[f])ne(scheduler._min_date,scheduler._max_date,p[f][k].startDate,p[f][k].endDate)&&(I=!0);if(!0===I)continue}}else if(a.crewsSelectionOptions.selectedPicklist===customLabels.showCrewsAndCrewMembers){if("C"!==_.sobject.ResourceType){var R=!1;for(var F in p[f])ne(scheduler._min_date,scheduler._max_date,p[f][F].startDate,p[f][F].endDate)&&(R=!0);if(!0!==R)continue}}else if(a.crewsSelectionOptions.selectedPicklist===customLabels.showOnlyCrews){if("C"!==_.sobject.ResourceType)continue}else if(a.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewsAndCrewMembers){if("C"===_.sobject.ResourceType)continue;var M=!1;for(var x in p[f])ne(scheduler._min_date,scheduler._max_date,p[f][x].startDate,p[f][x].endDate)&&(M=!0);if(!0===M)continue}}else B.crewsFilter=!1;if(!g||!K.getCandidatesIds()||K.getCandidatesIds()[f])for(var O in S){var P=B.generateResourceId(S[O].serviceResource,S[O].serviceTerritory);if((!s.showWorkingResource||te(P,W,B))&&((!m||-1!=m.indexOf(S[O].serviceTerritory))&&ne(scheduler._min_date,scheduler._max_date,S[O].effectiveStartDate,S[O].effectiveEndDate))){var E=o[c[S[O].serviceTerritory]],N=new se(B.generateResourceId,z.getResources()[S[O].serviceResource],S[O].serviceTerritory,V(z.getResources()[S[O].serviceResource]),!1,"S"===S[O].serviceTerritoryType,X);E&&-1===E.children.map(function(e){return e.key}).indexOf(N.key)&&E.children.push(N)}}}}}var $=[],G=0;return o.forEach(function(e,t){return 0===e.children.length&&$.push(t)}),$.forEach(function(e){return o.splice(e-G++,1)}),o.forEach(function(e){e.children.sort(H);var t=Q.isTerritoryHasInDayOptimizationInProgress(scheduler._min_date,scheduler._max_date,e.key);t&&(__gantt.inday.isInDayRunning=!0,e.addInDayOptimizationInProgress(t,Q.calculateIndayProgress))}),B.hasCustomPermission("Utilization_on_Service_Territory")&&showDailyUtilization&&"MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&"LongView"!==scheduler._mode&&o.forEach(function(e){for(var t,i=[],n=new Date(scheduler._min_date);n<scheduler._max_date;n.setDate(n.getDate()+1))i.push(X.calculateLocation(e.children,n));var r=i.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0});t=X.calculateLocationUtilization(r),e.addUtilizationHtml(t)}),o;function V(e){return e.lastKnownLocationDate&&e.lastKnownLocationDate&&e.onlineOffset&&(e.lastSeen=parseInt((ee-e.lastKnownLocationDate)/1e3/60),e.lastKnownLocationDate+60*e.onlineOffset*1e3>ee&&0<=e.lastSeen)?e.online=!0:e.online=!1}function H(e,t){var i=z.getResources()[e.resourceId].sobject[J.resourceFieldToSortyBy],n=z.getResources()[t.resourceId].sobject[J.resourceFieldToSortyBy],r=J.descending?1:-1;return n<i?r:i<n?-1*r:0}}}function te(e,t,i){var n=new Date(scheduler._min_date),r=t.resourceToWorkingDates[e];if(!r)return!1;for(;n<scheduler._max_date;){var s=r[i.formatDayToString(n)];if(s&&(0<s.regular||0<s.overtime))return!0;n.setDate(n.getDate()+1)}return!1}function ie(e,t){if(0===t.length)return!0;for(var i=0;i<t.length;i++)if(-1<e.toLowerCase().indexOf(t[i].toLowerCase()))return!0;return!1}function ne(e,t,i,n){return isIntersect(e,t,i,n)}function re(e,t,i){this.key=e.id,this.name=e.name,this.children=[],this.generateHtml(e,t.timezone),void 0===i.ganttOpenedTerritories[e.id]&&(i.ganttOpenedTerritories[e.id]=!0),this.open=i.ganttOpenedTerritories[e.id]}function se(e,t,i,n,r,s,a){this.key=e(t.id,i),this.resourceId=t.id,this.name=t.name,this.contractor=t.isCapacityBased,this.online=n,this.lastSeen=t.lastSeen,this.secondary=s,this.isUndestaffOrOverstaff=r,this.utilization=null,this.calculatePeriodUtilization(a,t),t.isUndestaffOrOverstaff=r,this.generateHtml(t)}angular.module("serviceExpert").filter("timelineFilter",e),e.$inject=["utils","LeftSideLocationFilteringService","ResourcesAndTerritoriesService","TimePhasedDataService","ResourceCrewsService","SkillsService","calendarsService","userSettingsManager","GetSlotsService","StateService","resourceFilterHelper","LastKnownPositionService","monthlyViewHelperService","DeltaService","RegisterService","OptimizationRequestsService"],re.prototype.generateHtml=function(e,t){if(e.parentTerritory?this.label="<div class='truncate ParentName'>"+e.parentTerritory.name.encodeHTML()+"</div>\n                          <div class='truncate LocationName'>"+e.name.encodeHTML()+"</div>":this.label="<div class='truncate LocationName no-parent-location'>"+e.name.encodeHTML()+"</div>","MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode){var i=new Date,n=e.parentTerritory?"margin-top:-26px;":"";(i=new Date(i.valueOf()+6e4*i.getTimezoneOffset())).setMinutes(i.getMinutes()+utils.getLocationOffset(i,e.id)),this.label+="<div class='timeZoneFolder' style=\""+n+'">'+t+" - "+moment(i).format("llll")+"</div>"}},re.prototype.addInDayOptimizationInProgress=function(e,t){var i=this.label.indexOf("</div>"),n=-1<this.label.indexOf("Parent")?'style="margin-top: -9px"':"",r=customLabels.PreparingData,s={percent:0};null!=e.objectToScheduled&&(r=(s=t(e)).text);var a='<div class="left-territory-info-box" '+n+">"+('<div class="inDayOptimizationRunningContainer"><span>'+('<div class="inday-opt-progress">\n                            <span class="opt-progress-preparing">'+r+'</span>\n                                <span class="opt-progress-text">'+s.percent+'%</span>\n\n                                <div class="opt-progress-bar inday-progress-animation" style="width:'+s.percent+'%">\n                            </div>\n\n                        </div>')+"</span></div>")+"</div>";this.label=this.label.slice(0,i+6)+a+this.label.slice(i+6)},re.prototype.addUtilizationHtml=function(e){var t=-1<this.label.indexOf("Parent")?'style="margin-top: -9px"':"",i=this.label.indexOf("</div>"),n="green-daily-utlz",r=this.label.indexOf("inDayOptimizationRunningContainer");e>=monthlyViewSettings.high&&e<monthlyViewSettings.critical?n="yellow-daily-utlz":e>=monthlyViewSettings.critical&&(n="red-daily-utlz");var s="";if(-1<navigator.userAgent.indexOf("rv:11.0")&&(s="dailyViewUtilizationIE"),null!==e){var a='<b class="'+n+'">'+e+"%</b>";-1<r?(e='<div class="dailyViewUtilization '+s+' utilizationWithInday"><span>'+customLabels.UtilizationDaily.replace("$0",a)+" </span></div>",this.label=this.label.slice(0,r-12)+e+this.label.slice(r-12)):(e='<div class="dailyViewUtilization '+s+'" '+t+"><span>"+customLabels.UtilizationDaily.replace("$0",a)+"</span> </div>",this.label=this.label.slice(0,i+6)+e+this.label.slice(i+6))}},se.prototype.calculatePeriodUtilization=function(e,t){if("MonthlyView"===scheduler._mode){for(var i=[],n=new Date(scheduler._min_date);n<scheduler._max_date;n.setDate(n.getDate()+1))i.push(e.calculateDailyResourceCapacity(this,n));var r=i.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0});this.utilization=e.calculateLocationUtilization(r),t.sobject.__Utilization__=this.utilization}},se.prototype.generateHtml=function(e){this.label="";var t=this.online?"online-indicator":"online-indicator offline-indicator",i=this.secondary?"<span class='secondaryGanttLabel' title=\""+customLabels.Secondary+'">('+customLabels.Secondary+")</span>":"",n=e.lastKnownLocationDate&&this.lastSeen<1440&&0<=this.lastSeen?'<div class="'+t+'" title="'+utils.hoursMinutes(this.lastSeen,customLabels.SeenXMinsHoursAgo,customLabels.SeenXAgoHours,customLabels.SeenXAgo)+'"></div>':"";if(void 0!==e.serviceCrew__r){var r=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourceCrewPhoto":"ResourceCrewPhoto";e.pictureLink?this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+r+"' />":this.label+="<span class='"+r+'\'><svg aria-hidden="true" class="crew-slds-icon crewContextMenuIcon"><use xlink:href=\''+lsdIcons.crew+"'></use></svg></span>",this.label+=n}else if(e.pictureLink){var s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhoto":"ResourcePhoto";this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+s+"' />"+n}else{var a=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhotoDefault":"NormalResourcePhotoDefault";this.label+="<div title='"+e.description+"' class=\"ResourcePhotoIcon "+a+'"></div>'+n}this.label+='<div class="resourceMenuBtn">\n                            <svg aria-hidden="true" class="slds-icon resourceMenuIcon">\n                                <use xlink:href="'+lsdIcons.threedots+'"></use>\n                            </svg>\n                        </div>';var o=e.ganttLabel?e.ganttLabel.encodeHTML():"";if("MonthlyView"===scheduler._mode&&null!==this.utilization){var c="resource-utiliz-low";o=customLabels.TotalUtilizationResource,monthlyViewSettings.critical<=this.utilization?c="resource-utiliz-high":monthlyViewSettings.high<=this.utilization&&(c="resource-utiliz-med"),o+=' <span class="'+c+'">'+this.utilization+"%</span>",scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' class=\"truncate smallResourceNameField\" title='"+e.description.encodeHTML()+"'>"+this.name.encodeHTML()+" "+i+"\n                    <div class='smallResourceGanttLabel truncate'>"+o+"</div></a>":this.label+="<a resource='"+this.id+"' class='truncate smallResourceName resourceYup' title='"+e.description.encodeHTML()+"'>"+this.name.encodeHTML()+" "+i+"\n                    <div class='resourceGanttLabel truncate'>"+o+"</div></a>"}else e.ganttLabel?scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' class=\"truncate smallResourceNameField\" title='"+e.description.encodeHTML()+"'>"+this.name.encodeHTML()+" "+i+"\n                        <div class='smallResourceGanttLabel truncate'>"+o+"</div></a>":this.label+="<a resource='"+this.id+"' class='truncate smallResourceName resourceYup' title='"+e.description.encodeHTML()+"'>"+this.name.encodeHTML()+" "+i+"\n                        <div class='resourceGanttLabel truncate'>"+o+"</div></a>":scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' class='truncate smallResourceName resourceYup resource-no-label' style='margin-top:1px;' title='"+e.description.encodeHTML()+"'>"+this.name.encodeHTML()+" "+i+"</a>":this.label+='<a class="truncate resource-no-label" resource=\''+this.id+"' style='margin-top:1px;' title='"+e.description.encodeHTML()+"'>"+this.name.encodeHTML()+" "+i+"</a>";this.label='<div class="resourceY-container">'+this.label+"</div>"}}(),angular.module("serviceExpert").filter("toArray",function(){return function(e){var i=[];return angular.forEach(e,function(e,t){i.push(e)}),i}}),function(){function stringifySingleCondition(e,t,i){if(e[getPropertyName(t.property)]||!1===e[getPropertyName(t.property)]||(e[getPropertyName(t.property)]=""),"FSL__RULE_VIOLATIONS__FSL"===t.property){var n="true"===t.value.toString();return"equals"===t.operator&&n||"not equal to"===t.operator&&!n?"(Array.isArray(__evalRealService.violations) && __evalRealService.violations.length > 0)":"(!__evalRealService.violations || (Array.isArray(__evalRealService.violations) && __evalRealService.violations.length === 0))"}var r=evaluateOperator(t.operator);if(t.value&&t.value.indexOf&&-1<t.value.indexOf(",")&&(t.value=t.value.replace(/, /g,",").split(",")),Array.isArray(t.value))return t.value=t.value.map(function(e){return e.toLowerCase?e.toLowerCase():e}),__picklistArrayForFilter[i]=t.value,evaluateArrayValue(t.operator,t.property,i);if(evaluateValue(t.property,t.value,__ganttFilterFieldSet,i),r){var s=__ganttFilterFieldSet[t.property].Type;return"STRING"===s||"TEXTAREA"===s||"EMAIL"===s||"REFERENCE"===s?"__evalService."+getPropertyName(t.property)+".toLowerCase() "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i+".toLowerCase()":"__evalService."+getPropertyName(t.property)+" "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i}return evaluateSepcialOperator(t.operator,t.value,t.property)}function evaluateArrayValue(e,t,i){switch(e){case"contains":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"does not contain":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === false";case"start with":return"new RegExp('^' + __picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"equals":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) > -1";case"not equal to":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) === -1";default:return"__picklistArrayForFilter["+i+"].some( element => __evalService."+getPropertyName(t)+" "+evaluateOperator(e)+" element)"}}function getPropertyName(e){return"FSL__RULE_VIOLATIONS__FSL"===e?"FSL__RULE_VIOLATIONS__FSL":removeNamespace(__ganttFilterFieldSet[e].APIName)}function evaluateCondition(service,conditions,logic){var serviceFields=service.fields;window.__evalService=serviceFields,window.__evalRealService=service;var stringConditions=logic?replaceLogicOperators(logic):"",conditionsMapped={};for(var i in conditions)conditionsMapped[i]=stringifySingleCondition(serviceFields,conditions[i],i-1),logic||(stringConditions+="{"+i.toString()+"} && ");for(var _i in logic||(stringConditions=stringConditions.substr(0,stringConditions.length-3)),conditionsMapped)stringConditions=stringConditions.replace("{"+_i+"}",conditionsMapped[_i]);return""===stringConditions||eval(stringConditions)}function evaluateValue(e,t,i,n){if(i[e])switch(i[e].Type){case"BOOLEAN":window.__evalConditionValue[e+"_"+n]=!0===t;break;case"DATE":case"DATETIME":window.__evalConditionValue[e+"_"+n]=new Date(t);break;case"STRING":case"EMAIL":case"TEXTAREA":case"REFERENCE":window.__evalConditionValue[e+"_"+n]=t?t.toLowerCase():"";break;default:window.__evalConditionValue[e+"_"+n]=t}else window.__evalConditionValue[e]=null}function evaluateOperator(e){switch(e){case"equals":return"==";case"not equal to":return"!=";case"less than":return"<";case"greater than":return">";case"less or equal":return"<=";case"greater or equal":return">=";default:return null}}function evaluateSepcialOperator(e,t,i){switch(e){case"contains":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') > -1";case"does not contain":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === -1";case"start with":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === 0"}}function replaceLogicOperators(e){return e=(e=(e=e.split("AND").join("&&")).split("OR").join("||")).split("NOT").join("!")}function removeNamespace(e){if(fslNamespace&&0===e.indexOf(fslNamespace)){var t=fslNamespace.length+2;return e.substr(t,e.length-t)}return e}function isServiceInDateRange(e,t,i,n){var r=scheduler._min_date,s=scheduler._max_date;return n.List_only_appointments_on_the_gantt?!(!e.end_date||!isIntersectIncludeLimits(r,s,e.end_date,e.end_date))||!(!e.start_date||!isIntersectIncludeLimits(r,s,e.start_date,e.start_date)):(r=new Date(i),s=new Date(i),r.setDate(r.getDate()-n.Days_before_horizon),s.setDate(s.getDate()+n.Days_after_horizon+1),s.setMinutes(s.getMinutes()-1),!!(t.earlyStart&&e.earlyStart&&isIntersectIncludeLimits(r,s,e.earlyStart,e.earlyStart))||(!!(t.dueDate&&e.dueDate&&isIntersectIncludeLimits(r,s,e.dueDate,e.dueDate))||(!!(t.start&&e.start&&isIntersectIncludeLimits(r,s,e.start,e.start))||(!!(t.finish&&e.finish&&isIntersectIncludeLimits(r,s,e.finish,e.finish))||(!!(t.appStart&&e.appStart&&isIntersectIncludeLimits(r,s,e.appStart,e.appStart))||(!!(t.appEnd&&e.appEnd&&isIntersectIncludeLimits(r,s,e.appEnd,e.appEnd))||!!(t.display&&e.ganttDisplay&&isIntersectIncludeLimits(r,s,e.ganttDisplay,e.ganttDisplay))))))))}function searchOnService(e,t,i){if(e.name&&-1!==e.name.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.ganttLabel&&-1!==e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.id&&-1!==e.id.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.status&&-1!==e.status.toLowerCase().indexOf(t.toLowerCase()))return!0;for(var n=0;n<i.length;n++)if((i[n].Type===utils.fieldsTypes.String||i[n].Type===utils.fieldsTypes.TextArea||i[n].Type===utils.fieldsTypes.Reference||i[n].Type===utils.fieldsTypes.Picklist)&&e[i[n].APIName]&&-1!==e[i[n].APIName].toLowerCase().indexOf(t.toLowerCase()))return!0;return!1}window.__ganttFilterFieldSet={},window.__picklistArrayForFilter=[],window.__evalConditionValue={},angular.module("serviceExpert").filter("servicesListFilterNew",["utils","$filter","GanttFilterService","FieldSetFieldsService",function(e,v,m,t){return t.fieldsSetFields().then(function(e){e.ganttFilter.forEach(function(e){return __ganttFilterFieldSet[e.FullAPIName]=e})}),function(e,t,i){var n=0,r=[],s=m.getFilterById(t.selectedFilter);if(s){var a=null,o=[];for(var c in-1<t.SearchText.indexOf(",")&&""===(a=t.SearchText.replace(/, /g,",").split(","))[a.length-1]&&a.length--,a?o=a:o.push(t.SearchText),e){if(t.SearchText){for(var l=!1,d=0;d<o.length;d++)if(searchOnService(e[c],o[d],i)){l=!0;break}if(!l)continue}t.pivotDate=new Date(t.endDate),t.pivotDate.setHours(0),t.pivotDate.setMinutes(0),isServiceInDateRange(e[c],t.selectedFiled,t.pivotDate,s)&&evaluateCondition(e[c],s.Criterias,s.Logic)&&(n+=e[c].totalModifiedTimes,r.push(e[c]))}}else for(var u in e)n+=e[u].totalModifiedTimes,r.push(e[u]);var p=v("orderBy")(r,t.orderByField,t.reverse);return p.totalChecksum=n,p}}])}(),function(){function e(){function e(i,r,s,n,a,o,c,l,e,d,u,p){i.bulkActionsOrder=bulkActionsOrder,i.customActions=[],i.actionNames={Schedule:{name:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:customLabels.Unschedule,icon:lsdIcons.na}},s.customActionsPromise.then(function(){var e,t=s.getCustomActions("bulk");(e=i.customActions).push.apply(e,_toConsumableArray(t))}),i.runCustomServiceAction=function(n){var e=o.getSelected();if(n.visualforce){var t=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===e.length?u.open(n.name,n.visualforce+"?id="+e[0]+"&start="+t+"&end="+i):u.open(n.name,n.visualforce+"?services="+e.join(",")+"&start="+t+"&end="+i)}else{if(0===e.length)return;d.runCustomServiceAction(n.className,e,scheduler._min_date,scheduler._max_date).then(function(i){d.getServicesById(e).then(function(e){var t=p.updateTimePhaseData(e,"service").services;r.drawServicesAndAbsences(t,[],[],[]),i&&s.addNotification(n.name,i,null,null)})}).catch(function(e){return s.addNotification(n.name,e.message,null,null)})}},i.checkHasCustomPermission=function(e){return null==s.hasCustomPermission("Bulk_"+e)||s.hasCustomPermission("Bulk_"+e)},i.openBulkAction=function(e){switch(e){case"Schedule":l.schedule(o.getSelected());break;case"Dispatch":n.open();break;case"Unschedule":a.open();break;case"Optimize":c.open();break;case"Flag-Unflag":for(var t=o.getSelected(),i=0;i<t.length;i++)r.flagged[t[i]]=!r.flagged[t[i]];updateViewDebounced()}}}return e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService","sfdcService","GeneralLightbox","TimePhasedDataService"],{restrict:"E",template:'<div id="quickActionsButtons">\n\t\t\t                    <div id="actionQuickFirst" class="truncate quickActionBtn" ng-show="bulkActionsOrder.first.length && checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name)" ng-click="openBulkAction(bulkActionsOrder.first[0].title)" title="{{actionNames[bulkActionsOrder.first[0].title].name}}">\n\t\t\t\t\t\t\t\t\t{{actionNames[bulkActionsOrder.first[0].title].name}}\n\t\t\t\t\t\t\t\t</div>\n\t                        \t<div id="actionQuickSecond"\n\t\t\t\t\t\t\t\t\t class="truncate quickActionBtn"\n\t\t\t\t\t\t\t\t\t ng-show="bulkActionsOrder.second.length && checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name)"\n\t\t\t\t\t\t\t\t\t ng-click="openBulkAction(bulkActionsOrder.second[0].title)"\n\t\t\t\t\t\t\t\t\t title="{{actionNames[bulkActionsOrder.second[0].title].name}}">{{actionNames[bulkActionsOrder.second[0].title].name}}</div>\n\t\t                    \t<div class="truncate" id="ActionButton" ng-show="bulkActionsOrder.dropdown.length" cs-toggle="MainActionContainer">\n                                    <span ng-show="(!bulkActionsOrder.first.length &&\n                                                   !bulkActionsOrder.second.length) ||\n                                                   (!checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name) &&\n                                                   !checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name))">\n                                           '+customLabels.Actions+'\n                                    </span>\n                                    <i class="fa fa-caret-down"></i>\n\t\t                    \t</div>\n\t                    \t</div>\n\t                    \t\n\t                        <div id="MainActionContainer">\n\t\t\t                    <div class="truncate BulkActionMenuItem" ng-repeat="action in bulkActionsOrder.dropdown" ng-show="checkHasCustomPermission(actionNames[action.title].name)" ng-click="openBulkAction(action.title)">\n\t\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon mainActionIcon">\n\t\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="{{actionNames[action.title].icon}}"></use>\n\t\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t\t{{actionNames[action.title].name}}\n                                </div>\n                                \n                                \n                                <div class="truncate BulkActionMenuItem" ng-repeat="action in customActions" ng-click="runCustomServiceAction(action)">\n                                \n                                    <svg aria-hidden="true" class="slds-icon mainCustomActionIcon">\n\t\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="{{action.icon}}"></use>\n\t\t\t\t\t\t\t\t\t\u2028</svg>\n                                \n\t\t\t\t\t\t\t\t\t{{action.name}}\n                                </div>\n                                                               \n                                \n\t                        </div>',scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButton",e),e.$inject=[]}(),angular.module("serviceExpert").directive("bulkOptimizeOptions",function(){return{template:customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n\t\t\t\t\t\t\t\t<option value="all">'+customLabels.All+'</option>\n\t\t\t\t\t\t\t\t<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n\t\t\t\t\t\t\t</select>")}}).directive("bulkOptimizePolicy",function(){return{template:customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n\t\t\t\t\t\t\t\t \t<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n\t\t\t\t\t\t\t\t \t<option value="noFilter">'+customLabels.None+"</option>\n\t\t\t\t\t\t\t\t </select>")}}).directive("bulkChangeStatusDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartChangeStatus" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartChangeStatus\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishChangeStatus" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishChangeStatus\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkUnscheduleDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkChangeStatusPicklist",function(){return{template:customLabels.changeStatusBulkMsg.replace("$0",'<select class="selectChangeStatusBulk bulkStatusWidth" ng-model="bulkStatus">\n\t\t\t\t\t\t\t\t<option ng-repeat="(statusType,statusLabel) in statuses" value="{{statusLabel}}" >{{getStatusTranslations()[statusLabel]}}</option>\n\t\t\t\t\t\t\t</select>')}}),function(){function e(){function e(n){n.colors=[{Name:"Red",Hex:"#E53935"},{Name:"Pink",Hex:"#D81B60"},{Name:"Purple",Hex:"#8E24AA"},{Name:"Indigo",Hex:"#3949AB"},{Name:"Blue",Hex:"#1E88E5"},{Name:"Cyan",Hex:"#00ACC1"},{Name:"Teal",Hex:"#00897B"},{Name:"Green",Hex:"#43A047"},{Name:"Lime",Hex:"#C0CA33"},{Name:"Yellow",Hex:"#FDD835"},{Name:"Amber",Hex:"#FFB300"},{Name:"Orange",Hex:"#FB8C00"},{Name:"Brown",Hex:"#6D4C41"},{Name:"Grey",Hex:"#757575"},{Name:"Blue Grey",Hex:"#546E7A"},{Name:"Black",Hex:"#000"}],n.selectColor=function(e){n.selectedColor=e.Hex,n.setSelectedShapeColor(e.Hex),n.showColorMenu=!1},n.showMenuClick=function(e){n.drawState!=n.drawingStates.EDIT&&n.drawState!=n.drawingStates.DRAW||(n.showColorMenu=!n.showColorMenu)},n.selectedColor="#546E7A",n.showColorMenu=!1,angular.element("#mapOptionsContainer").on("click",function(e){for(var t=["color-square","color-button"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;n.showColorMenu&&(n.showColorMenu=!1)})}return e.$inject=["$scope"],{restrict:"E",template:'<div id="select-color-btn" title="'+customLabels.Select_color+'" class="color-button truncate"  ng-click="showMenuClick()" ng-class="{disabledButton: drawState != drawingStates.EDIT && drawState != drawingStates.DRAW}">\n                            <span class="color-square" ng-style="{\'background-color\': selectedColor}"></span><span>'+customLabels.Select_color+'</span>\n                        </div>\n                        <div class="color-menu" id="colorMenu" ng-show="showColorMenu == true">\n                            <span class="color-box" ng-repeat="color in colors" ng-click="selectColor(color)" ng-style="{\'background-color\': color.Hex}"></span>\n                        </div>',scope:!1,controller:e}}angular.module("serviceExpert").directive("csColorPicker",e),e.$inject=[]}(),function(){function e(){function e(a,t,i,n,r,o,s){a.isEmpty=t.isEmpty,a.paletteApplied=!1,a.updatePaletteView=function(){var r,s;a.calculatePaletteColors=!1,(a.paletteDataIsValid=!0)===a.paletteApplied&&a.clearPalette(),void 0!==a.GanttPalettes[a.selectedPalette]&&(a.currentPalette=a.GanttPalettes[a.selectedPalette],a.picklistMap={},t.serviceFieldsMap().then(function(e){var t=e[a.currentPalette.ServiceProperty];try{if(t.Type===FieldTypes.PICKLIST&&(r=Object.keys(a.currentPalette.ColorScheme.picklist[t.Name]),s=Object.values(a.currentPalette.ColorScheme.picklist[t.Name])),t.Type===FieldTypes.BOOLEAN&&(r=[customLabels.Selected,customLabels.Deselected],s=[a.currentPalette.ColorScheme.max.color,a.currentPalette.ColorScheme.min.color]),t.Type===FieldTypes.DATE||t.Type===FieldTypes.DATETIME){var i=o.convertMomentDtToDt(moment().tz(userTimeZone));s=l(a.currentPalette.ColorScheme.min.color,a.currentPalette.ColorScheme.max.color,a.currentPalette.ColorLevel),r=function(e,t,i,n,r,s){for(var a=m(n,t),o=m(r,i),c=e.getTime()+a,l=(e.getTime()+o-c)/s,d=[],u=0;u<s;u++){var p=moment(c+u*l),v=moment(c+(u+1)*l);0===u?d.push(h([customLabels.Earlierthan,v.format("dddd, MMMM Do YYYY, h:mm:ss a")])):u===s-1?d.push(h([customLabels.LaterThan,p.format("dddd, MMMM Do YYYY, h:mm:ss a")])):d.push(customLabels.Between_x_and_y.replaceAll(p.format("dddd, MMMM Do YYYY, h:mm:ss a"),v.format("dddd, MMMM Do YYYY, h:mm:ss a")))}return d}(i,a.currentPalette.ColorScheme.min.value,a.currentPalette.ColorScheme.max.value,a.currentPalette.ColorScheme.min.type,a.currentPalette.ColorScheme.max.type,a.currentPalette.ColorLevel)}t.Type===FieldTypes.DOUBLE&&(s=l(a.currentPalette.ColorScheme.min.color,a.currentPalette.ColorScheme.max.color,a.currentPalette.ColorLevel),r=c(a.currentPalette.ColorScheme.min.value,a.currentPalette.ColorScheme.max.value,a.currentPalette.ColorLevel)),t.Type!==FieldTypes.INTEGER&&t.Type!==FieldTypes.PERCENT||(s=l(a.currentPalette.ColorScheme.min.color,a.currentPalette.ColorScheme.max.color,a.currentPalette.ColorLevel),r=function(e,t,i){e=parseInt(e);var n=((t=parseInt(t))-e)/i;n=Math.round(n);for(var r=[],s=0;s<i;s++){var a=e+s*n,o=e+(s+1)*n;0===s?r.push(h([o,customLabels.OrLower])):s===i-1?r.push(h([customLabels.HigherThan,a])):r.push(customLabels.Between_x_and_y.replaceAll(a,o))}return r}(a.currentPalette.ColorScheme.min.value,a.currentPalette.ColorScheme.max.value,a.currentPalette.ColorLevel)),t.Type!==FieldTypes.LOCATION&&t.Type!==FieldTypes.ADDRESS||(s=l(a.currentPalette.ColorScheme.min.color,a.currentPalette.ColorScheme.max.color,a.currentPalette.ColorLevel),r=c(a.currentPalette.ColorScheme.min.value,a.currentPalette.ColorScheme.max.value,a.currentPalette.ColorLevel,!0)),a.picklistLength=s.length;for(var n=0;n<s.length;n++)a.picklistMap[r[n]]=s[n]}catch(e){a.paletteDataIsValid=!1}}))},a.clearPalette=function(){a.hidePaletteView(),a.paletteApplied=!1,s.$broadcast("paletteUpdated")},a.applyPalette=function(){if(a.calculatePaletteColors)alert("Still applying last palette");else{a.calculatePaletteColors=!0;var e=a.GanttPalettes[a.selectedPalette];if(void 0===e)return alert("No palette selected"),void(a.calculatePaletteColors=!1);t.applyNewPaletteForGantt(e,i.serviceAppointments()).then(function(e){a.showPaletteView(),a.paletteApplied=!0,a.calculatePaletteColors=!1,s.$broadcast("paletteUpdated")})}},a.openPalettesLightbox=function(e){switch(e){case"edit":n.open(customLabels.GanttPalettes,GanttPalettePage)}},a.calculatePalettePortionStyle=function(e){return{background:e,width:100/a.picklistLength+"%",height:"12px"}},t.getGanttPalettes().then(function(e){a.GanttPalettes=e,a.selectedPalette=r.GetUserSettingsProperty("Gantt_Palette__c")||(null==a.GanttPalettes||a.isEmpty(a.GanttPalettes)?customLabels.NoPalettes:customLabels.None),a.updatePaletteView()})}function c(e,t,i,n){e=parseFloat(e);for(var r=((t=parseFloat(t))-e)/i,s=[],a=0;a<i;a++){var o=e+a*r,c=e+(a+1)*r;n?0===a?s.push(h([c,distanceUnit,customLabels.OrLower])):a===i-1?s.push(h([customLabels.HigherThan,o,distanceUnit])):s.push(customLabels.Between_x_and_y.replaceAll(h([o,distanceUnit]),h([c,distanceUnit]))):0===a?s.push(h([c,customLabels.OrLower])):a===i-1?s.push(h([customLabels.HigherThan,o])):s.push(customLabels.Between_x_and_y.replaceAll(o,c))}return s}function m(e,t){var i;switch(e){case"Minutes":i=60*t*1e3;break;case"Hours":i=60*t*60*1e3;break;case"Days":i=24*t*60*60*1e3}return i}function l(e,t,i){for(var n=[],r=e.substr(1,2),s=e.substr(3,4).substr(0,2),a=e.substr(5,6),o=t.substr(1,2),c=t.substr(3,4).substr(0,2),l=t.substr(5,6),d=parseInt(r,16),u=parseInt(s,16),p=parseInt(a,16),v=(parseInt(o,16)-d)/i,m=(parseInt(c,16)-u)/i,h=(parseInt(l,16)-p)/i,g=0;g<i;g++){var f=Math.round(Math.abs(d+v*g))%256,S=Math.round(Math.abs(u+m*g))%256,_=Math.round(Math.abs(p+h*g))%256,y=f.toString(16);1===y.length&&(y="0"+y);var b=S.toString(16);1===b.length&&(b="0"+b);var T=_.toString(16);1===T.length&&(T="0"+T);var w="#"+y+b+T;n.push(w)}return n}function h(e){for(var t="",i=0;i<e.length;i++)t+=e[i]+" ";return t}return e.$inject=["$scope","GanttPalettesService","TimePhasedDataService","GeneralLightbox","userSettingsManager","utils","$rootScope"],{restrict:"E",template:'<div>\n                            <div class="palette-explain-headline">\n                                <div class="palette-explain">\n                                    '+customLabels.PaletteChangeExplain+'\n                                </div>\n\n                                <div ng-if="showPaletteEdit" class="globalWhiteButton palette-editor-button" title="'+customLabels.OpenPaletteEditor+'" ng-click="openPalettesLightbox(\'edit\')">\n                                    <span>\n                                        <svg aria-hidden="true" class="slds-icon palette-icon">\n                                            <use xlink:href=\''+lsdIcons.colorSwatch+'\'></use>\n                                        \u2028</svg>\n                                    </span>\n                                </div>\n                            </div>\n\n                            <div>\n                                <span>\n                                    <select class="ganttPaletteSelector" ng-model="selectedPalette" ng-change="updatePaletteView()">\n                                        <option ng-if="isEmpty(GanttPalettes) == true" value="'+customLabels.NoPalettes+'">--- '+customLabels.NoPalettes+' ---</option>\n                                        <option ng-if="isEmpty(GanttPalettes) == false" value="'+customLabels.None+'">--- '+customLabels.None+' ---</option>\n                                        <option ng-repeat="(key,value) in GanttPalettes" value="{{key}}">{{value.Name}}</option>\n                                    </select>\n                                </span>\n                            </div>\n\n                            <div class="palette-details-container" ng-if="GanttPalettes[selectedPalette] !== undefined">\n                                \n                                <div ng-if="paletteDataIsValid">\n\n                                    '+customLabels.HoverPaletteColor+'\n                                \n                                    <div style="padding-top: 10px">\n                                        <div class="paletteBox">\n                                            <span title="{{key}}" ng-class="{\'roundBoxRight\': $last, \'roundBoxLeft\': $first}" ng-style="calculatePalettePortionStyle(value)" ng-repeat="(key, value) in picklistMap"></span>\n                                        </div>\n                                    </div>\n\n                                    <div class="palette-description" ng-hide="currentPalette.Description === \'\' || currentPalette.Description === undefined">\n                                        <div class="description-label-heading">\n                                            '+customLabels.Description+'\n                                        </div>\n                                        <div class="palette-description-content">\n                                            {{currentPalette.Description}}\n                                        </div>\n                                    </div>\n                                    \n                                    <div class="apply-palette-button-container">\n                                        <span ng-show="paletteApplied === false" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="applyPalette()">'+customLabels.ApplyPalette+'</span>\n                                        <span ng-show="paletteApplied === true" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="clearPalette()">'+customLabels.UseDefaultPalette+'</span>\n                                    </div>\n\n                                </div>\n\n                                <div class="palette-details-error" ng-if="paletteDataIsValid == false">\n                                    '+customLabels.PaletteDataIsInvalid+"\n                                </div>\n\n                            </div>\n                        </div>",scope:{showPaletteView:"=",showPaletteEdit:"=",hidePaletteView:"="},controller:e}}angular.module("serviceExpert").directive("ganttPalette",e),e.$inject=[]}(),function(){function e(){return{restrict:"E",scope:{request:"=",apptCount:"@",progressStatus:"="},template:'<div class="opt-progress">\n                            <span class="opt-progress-preparing"></span>\n\n                            <div class="opt-progress-bar smart_in_progress">\n                                <span class="opt-progress-text"></span>\n                            </div>\n\n                        </div>',link:function(o,i,e){if("Global Optimization"===o.request.type){var c=angular.element(i[0].querySelector(".opt-progress-bar")),l=angular.element(i[0].querySelector(".opt-progress-text")),n=angular.element(i[0].querySelector(".opt-progress-preparing")),d=__gantt[e.optType];o.progressStatus[o.request.id]||(o.progressStatus[o.request.id]={status:o.request.status,objectToScheduled:o.request.objectToScheduled}),o.progressStatus[o.request.id].objectToScheduled||(c.css("width","0%"),n.text(customLabels.PreparingData));var r=o.$watchCollection("[request.objectToScheduled, request.status]",function(e,t){""!=e[0]&&null!=e[0]&&e[0]!=o.progressStatus[o.request.id].objectToScheduled?(n.text(""),o.progressStatus[o.request.id].objectToScheduled=e[0],s()):"In Progress"==e[1]&&null!=e[0]&&"In Progress"==o.progressStatus[o.request.id].status&&(n.text(""),s()),"In Progress"!==e[1]&&"In Progress"==o.progressStatus[o.request.id].status?(o.progressStatus[o.request.id].status=e[1],u(),r()):"Completed"==o.progressStatus[o.request.id].status&&(angular.element(i[0].querySelector(".opt-progress")).remove(),r())})}function s(){if(!o.progressStatus[o.request.id].progressInterval){var e=o.request.objectToScheduled,t=d.maxRunTimeSingleService*e,i=(new moment).diff(moment(o.request.requestProgressStart),"seconds");t>=d.maxRuntimeOverall&&(e=d.maxRuntimeOverall/d.maxRunTimeSingleService,t=d.maxRuntimeOverall);var n=i/t*100,r=7,s=0,a=90/e;t<=i&&"In Progress"==o.request.status&&(r=7+(i-t)/d.maxRunTimeSingleService*.1,s=90),o.progressStatus[o.request.id].progressInterval=setInterval(function(){"Aborted"!==o.request.status&&"Aborting"!==o.request.status||u(),90<(n+=a)&&(n=90),s<90?s=n:100<=s?(s=100,clearInterval(o.progressStatus[o.request.id].progressInterval),delete o.progressStatus[o.request.id].progressInterval):90<=s&&(r+=.1,s=Math.round(Math.atan(r)/(Math.PI/2)*100*1e3)/1e3),c.css("width",s+"%"),l.text(s.toFixed(2)+"%")},1e3*d.maxRunTimeSingleService)}}function u(){clearInterval(o.progressStatus[o.request.id].progressInterval),delete o.progressStatus[o.request.id].progressInterval}}}}angular.module("serviceExpert").directive("csOptimizationProgress",e),e.$inject=[]}(),angular.module("serviceExpert").directive("csRange",["$filter","utils",function(o,c){return{restrict:"CAE",link:function(i,e,n){var r=$($(e[0]).find(".showingDates")),s=isAMPM?"ampm":"24",a=$($(e[0]).find(".sliderSelector"));i.$watchCollection(n.ngModel,function(e,t){!a.slider("instance")||e.start===t.start&&e.end===t.end||(a.slider("values",[e.start,e.end]),r.text(n.showingText.replace("{1}",o("ampmOr24")(parseInt(e.start),s,!0)).replace("{2}",o("ampmOr24")(parseInt(e.end),s,!0))))}),a.slider({range:!0,min:parseInt(n.min),max:parseInt(n.max),values:[parseInt(n.defaultStart),parseInt(n.defaultEnd)],slide:function(e,t){r.text(n.showingText.replace("{1}",o("ampmOr24")(parseInt(t.values[0]),s,!0)).replace("{2}",o("ampmOr24")(parseInt(t.values[1]),s,!0)))},stop:function(e,t){c.safeApply(i,function(){i[n.ngModel].start=t.values[0],i[n.ngModel].end=t.values[1]})}}),r.text(n.showingText.replace("{1}",o("ampmOr24")(parseInt(n.defaultStart),s,!0)).replace("{2}",o("ampmOr24")(parseInt(n.defaultEnd),s,!0)))},scope:!0,template:'<div class="sliderSelector"></div><span class="showingDates"></span>'}}]),angular.module("serviceExpert").directive("safeBinder",[function(){return{restrict:"A",scope:{safeBinder:"="},link:function(e,t,i){$(t[0]).html(e.safeBinder)}}}]),function(){function e(){function e(e){e.callMe=function(e,t,i,n){var r=i+" "+n;return sendCTIMessage("/CLICK_TO_DIAL?DN="+encodeURIComponent(e)+"&amp;ID="+t+"&amp;ENTITY_NAME=User&amp;OBJECT_NAME="+encodeURIComponent(r)+"&amp;DISPLAY_NAME="+encodeURIComponent("User")),!1}}e.$inject=["$scope"];return{restrict:"E",template:'<span class="tel" style="display: none;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, false);"></img>{{number}}\n                                <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" title="Click to dial disabled"></img>\n                            </span> \n                            <span style="display: block;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, true);"></img>\n                                <a href="javascript:void(0);" onclick="disableClicked(this, \'Click to dial disabled\');" ng-click="callMe(number, userId, userFirstName, userLastName)" title="">{{number}}\n                                    <img src="/img/btn_dial_inline.gif" alt="Click to dial" width="16" height="10" title="Click to dial" style="display: inline;"></img>\n                                    <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" style="display: none;" title="Click to dial disabled"></img>\n                                </a>\n                            </span>',scope:{number:"@",userId:"@",userFirstName:"@",userLastName:"@"},controller:e}}angular.module("serviceExpert").directive("csClickToDial",e),e.$inject=[]}(),angular.module("serviceExpert").directive("dhxScheduler",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService",function(u,p,v,m,e,h,g){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(e,t,i){window.utils=angular.element("#serviceExpertApp").injector().get("utils");var n=_.debounce(function(e){scheduler.updateCollection("resources",e)},500);e.$watch(i.resources,function(e){folderJustToggled?folderJustToggled=!1:n(e)},!0),t.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations();var r=v.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),s=v.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),a=v.GetUserSettingsProperty("Resource_Row_Height__c"),o=v.GetUserSettingsProperty("View_Capacity_Type__c"),c=v.GetUserSettingsProperty("Include_Weekends__c"),l=v.GetUserSettingsProperty("Load_On_Today__c"),d=v.GetUserSettingsProperty("Lock_Gantt__c");null!==d&&schedulerConfig.setReadOnly(d),null!==a&&schedulerConfig.setRowHeights(a,!1),null!==o&&setCapacityFilter(o),null!==r&&null!==s&&setHoursToDisplay(r,s,c),u.policy=defaultPolicy,m.all([h.promises.territories(),h.promises.resources(),g.fieldsSetFields()]).then(function(){scheduler.init(t[0],new Date,"ZoomLevel3"),e.scheduler=scheduler,e.datalessMethods=attchDatalessSchedulerEvents(),p(function(){switch(l&&scheduler.setCurrentView(new Date),e.getTimePhasedObjects().then(function(){$("#FirstTimeLoading").remove()}).catch(function(e){bootstrap.handleError(e)}),scheduler._mode){case"ZoomLevel2":e.timelineName=customLabels.In_Day;break;case"ZoomLevel3":e.timelineName=customLabels.Daily;break;case"ZoomLevel4":e.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":e.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":e.timelineName=customLabels.Weekly;break;case"ZoomLevel7":e.timelineName=customLabels.TwoWeeks}},0),u.$broadcast("initCompleted")})}}}]),angular.module("serviceExpert").directive("dragNA",function(){return{restrict:"CAE",scope:{dragService:"="},link:function(e,t,i,n){cachedDomElements.draggedBreak||(cachedDomElements.draggedBreak=$("#draggedBreak")),cachedDomElements.draggedBreakDiv||(cachedDomElements.draggedBreakDiv=$("#draggedBreak div")),t.bind("dragstart",function(e){var t=$("#breakDuration").val();e.originalEvent.dataTransfer.setData("text","absenceNA_"+t),cachedDomElements.draggedBreakDiv.html(t);var i=getMinAndMaxHoursToDisplay(),n=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),r=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60);r.setMinutes(r.getMinutes()+t);var s=getXPositionOfEvent({start_date:n,end_date:r},!1,scheduler.matrix[scheduler._mode]),a=getXPositionOfEvent({start_date:n,end_date:r},!0,scheduler.matrix[scheduler._mode])-s+4;cachedDomElements.draggedBreak.css("width",a+"px");var o=document.getElementById("draggedBreak").cloneNode(!0);document.body.appendChild(o),"setDragImage"in window.DataTransfer.prototype&&e.originalEvent.dataTransfer.setDragImage(o,0,40)})}}}),angular.module("serviceExpert").directive("draggableService",["utils","servicesService","SERVICE_STATUS","SERVICE_CATEGORY",function(d,e,t,u){return{restrict:"CAE",scope:{dragService:"="},link:function(l,e,t,i){cachedDomElements.draggedEvent||(cachedDomElements.draggedEvent=$("#draggedEvent")),cachedDomElements.draggedEventDiv||(cachedDomElements.draggedEventDiv=$("#draggedEvent div")),e.bind("dragstart",function(e){e.originalEvent.dataTransfer.setData("text",l.dragService.id);var t="<b>"+(l.dragService.ganttLabel?l.dragService.ganttLabel:l.dragService.name)+"</b><br/>"+l.dragService.estDuration+" "+l.dragService.durationType;cachedDomElements.draggedEventDiv.html(t);var i=getMinAndMaxHoursToDisplay(),n=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),r=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60);l.dragService.durationType?l.dragService.durationType===d.durationTypes.minutes?r.setMinutes(r.getMinutes()+l.dragService.estDuration):l.dragService.durationType===d.durationTypes.hours?r.setMinutes(r.getMinutes()+Math.floor(60*l.dragService.estDuration)):l.dragService.durationType===d.durationTypes.days&&r.setMinutes(r.getMinutes()+Math.floor(60*l.dragService.estDuration*24)):l.dragService.setMinutes(r.getMinutes()+60);var s=getXPositionOfEvent({start_date:n,end_date:r},!1,scheduler.matrix[scheduler._mode]),a=getXPositionOfEvent({start_date:n,end_date:r},!0,scheduler.matrix[scheduler._mode])-s+4,o="";switch(l.dragService.statusCategory){case u.NONE:o=" eventStatusNew";break;case u.SCHEDULED:o=" eventStatusAssigned";break;case u.DISPATCHED:o="eventStatusDispatched";break;case u.IN_PROGRESS:o=" eventStatusTravel";break;case u.COMPLETED:o=" eventStatusCompleted";break;case u.COULD_NOT_COMPLETE:o=" eventStatusCouldntComplete";break;case u.CANCELED:o=" eventStatusCancelled";break;default:o=" eventCustomStatus"}cachedDomElements.draggedEvent.css("width",a+"px"),cachedDomElements.draggedEvent.removeClass(),cachedDomElements.draggedEvent.addClass(o),l.dragService.ganttColor?cachedDomElements.draggedEvent.css("background",l.dragService.ganttColor):cachedDomElements.draggedEvent.css("background","");var c=document.getElementById("draggedEvent").cloneNode(!0);document.body.appendChild(c),"setDragImage"in window.DataTransfer.prototype&&e.originalEvent.dataTransfer.setDragImage(c,0,28)})}}}]).directive("dragTarget",["$rootScope","$filter","utils","servicesService","sfdcService","kpiCalculationsService","ResourcesAndTerritoriesService","AbsencesService","TimePhasedDataService","SERVICE_CATEGORY","StateService","OptimizationRequestsService",function(e,t,w,L,i,C,A,D,I,k,R,F){return{restrict:"CAE",link:function(T,e,t,i){var v=Date.now();e.bind("dragover",function(e){if(!(cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix")),e.preventDefault(),scheduler.config.readonly||Date.now()-v<500)){v=Date.now();var t=scheduler.getActionData(e.originalEvent),i=A.getResources()[t.section.split("_")[0]],n=t.section.split("_")[1];if(i&&n){var r=w.getLocationOffset(t.date,n)-w.getUserOffset(t.date),s=new Date(t.date);if(s.setMinutes(s.getMinutes()+r),i.name&&(!i.isCapacityBased||i.isCapacityBased&&!contractorSupport)){var a=new Date(t.date),o=t.date.getMinutes(),c=o%serviceJumpsOnGantt,l=serviceJumpsOnGantt-o%serviceJumpsOnGantt;a=l<c?new Date(a.getTime()+60*l*1e3):new Date(a.getTime()-60*c*1e3);var d=moment(a).format("lll"),u=new Date(a);u.setMinutes(u.getMinutes()+r);var p=moment(u).format("lll");e.originalEvent.ctrlKey?cachedDomElements.timesDragFix.html("<b>"+i.name+"</b> "+customLabels.SnapOn+" "+d+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+p)):cachedDomElements.timesDragFix.html("<b>"+i.name+"</b> "+customLabels.on+" "+d+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+p)),cachedDomElements.timesDragFix.show()}else cachedDomElements.timesDragFix.hide()}}}),e.bind("dragleave",function(e){cachedDomElements.timesDragFix.hide(),e.preventDefault()}),e.bind("drop",function(e){if(e.preventDefault(),void 0!==cachedDomElements.draggedEvent&&cachedDomElements.draggedEvent.removeClass(),cachedDomElements.timesDragFix.hide(),!scheduler.config.readonly){var t=scheduler.getActionData(e.originalEvent),i=new Date(t.date),n=t.date.getMinutes(),r=n%serviceJumpsOnGantt,s=serviceJumpsOnGantt-n%serviceJumpsOnGantt;i=s<r?new Date(i.getTime()+60*s*1e3):new Date(i.getTime()-60*r*1e3),t.date=i;var a=A.getResources()[t.section.split("_")[0]];if(A.territories()[t.section.split("_")[1]],a&&a.name){var o=e.originalEvent.dataTransfer.getData("text");if(-1<o.indexOf("absenceNA_")){$("#naOptionsContainer").hide();var c=o.substr(10,o.length-10);c=parseInt(c);var l=new Date(t.date);l.setMinutes(l.getMinutes()+c);var d={end_date:l,resource:a.id,start_date:t.date,start:t.date,absenceType:"None"==T.defaultDragNa.selectedNaType?null:T.defaultDragNa.selectedNaType,ganttLabel:T.defaultDragNa.selectedNaLabel};w.safeApply(T,function(){L.handleSnap(d,e),D.saveNewAbsence(d,R.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e.error?w.addNotification(customLabels.Action_Could_Not_Be_Performed,e.error):w.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})})}else{var u=I.serviceAppointments()[o];if(u){var p=new Date(t.date);if(u.durationType?u.durationType==w.durationTypes.minutes?p.setMinutes(p.getMinutes()+u.estDuration):u.durationType==w.durationTypes.hours?p.setMinutes(p.getMinutes()+Math.floor(60*u.estDuration)):u.durationType==w.durationTypes.days&&p.setDate(p.getDate()+Math.floor(u.estDuration)):p.setMinutes(p.getMinutes()+60),!F.isTerritoryHasInDayOptimizationInProgress(t.date,p,t.section.split("_")[1])||!1!==confirm(customLabels.In_Day_Optimization_In_Progress_Confirm)){if(contractorSupport&&a.isCapacityBased){for(var v=!1,m=!0,h=scheduler.getEvents(t.date,p),g=0;g<h.length;g++)-1<h[g].resourceId.indexOf(t.section)&&"contractorcapacity"==h[g].type&&(v=!0,h[g].timePeriod==w.ganttSettings.capacityDuration&&(m=!1));if(!v)return void alert(customLabels.serviceCantBeAssignedWithoutCapacity);m&&alert(customLabels.is_assigned_to_contractor.replaceAll(u.name,a.name)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}var f=angular.copy(u);f.end_date=p,f.resourceId=t.section,f.start_date=new Date(t.date),f.assignedResource=null;var S,_={statusCategory:k.SCHEDULED,isDummy:!0,id:f.id+"_dummy"},y=angular.copy(f);for(var b in _)y[b]=_[b];S=scheduler.addEvent(y),w.safeApply(T,function(){L.handleSnap(f,e.originalEvent),L.saveChangesToServiceAppointment(u,f).then(function(e){scheduler.deleteEvent(S),C.calculateKpis()}).catch(function(e){console.warn("Couldn't update service. "+e[2]),w.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message||customLabels.user_is_not_allowed_to_perform_action),scheduler.deleteEvent(S)&&scheduler.parse([e[1]],"json")})})}}}}}})}}}]),angular.module("serviceExpert").directive("googlePlaces",function(){return{restrict:"E",replace:!0,scope:{myMap:"=",searchMarker:"="},template:'<input id="google_places_ac" name="google_places_ac" type="text" class="input-block-level"/>',link:function(t,e,i){var n=new google.maps.places.Autocomplete($("#google_places_ac")[0],{});google.maps.event.addListener(n,"place_changed",function(){var e=n.getPlace();t.searchMarker?t.searchMarker.setPosition(e.geometry.location):t.searchMarker=new google.maps.Marker({map:t.myMap,position:e.geometry.location}),e.geometry.viewport?t.myMap.fitBounds(e.geometry.viewport):(t.myMap.setCenter(e.geometry.location),t.myMap.setZoom(17))})}}}),angular.module("serviceExpert").directive("csGroupActions",["$compile",function(m){function h(e,t,i){return Math.ceil($(e).offset().top)>=t+i}return{restrict:"A",link:function(d,u){var p=$('<ul class="moreQuickActionsContainer"></ul>'),v=void 0;angular.element(u[0]).on("click",function(e){e.stopPropagation(),$("#MainActionContainer").hide();var t=$(u).parent().parent().children(),i=$(t).last(),n=$(t).first(),r=$(n).offset().top,s=$(n).outerHeight(!0);if(p.hasClass("viewMoreActive"))return p.removeClass("viewMoreActive"),p.empty(),void p.remove();if(h($(i),r,s)){for(var a=t.length-1;1<a;a--)if(h(v=$(t[a]),r,s)){var o=$("<li></li>");v.find("> div:first-child").clone().removeClass("quickActionGoLeft quickCustomActionGoLeft").addClass("menuQuickAction").css({marginBottom:"0",border:"none",width:"87%"}).appendTo(o),o.css({display:"block"}).appendTo(p),m(o)(d)}$(p.children().get().reverse()).appendTo(p),$(u).append(p),p.addClass("viewMoreActive"),p.show();var c=p.offset().top,l=p.outerHeight(!0);h($("#TaskListPagination"),c,l)||$("#TaskListItems").animate({scrollTop:$("#TaskListItems").scrollTop()+(180<36*p.children().length?180:36*p.children().length)},500)}angular.element("body").on("mousedown",function(e){for(var t=["moreQuickActionsBtn","menuQuickAction","fa-caret-down"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;p.hasClass("viewMoreActive")&&(p.removeClass("viewMoreActive"),p.empty(),p.remove(),angular.element("body").off("mousedown"))})})}}}]).directive("csLastAction",["utils","SERVICE_STATUS","StateService",function(o,c,l){return{restrict:"A",link:function(e,t,i){var n=$(t),r=e.service,s=i.csLastAction,a=o.getCustomActions("list");switch(s){case"edit":!r.pinned&&o.hasCustomPermission("Reshuffle")||r.isScheduled()&&(r.latitude||r.longitude)&&o.hasCustomPermission("Group_Nearby")||!r.pinned&&r.status===c.SCHEDULED||r.isScheduled()||l.isMapEnabled()&&(r.latitude||r.longitude)||0!==a.length||n.hide();break;case"reshuffle":r.isScheduled()&&(r.latitude||r.longitude)&&o.hasCustomPermission("Group_Nearby")||!r.pinned&&r.status===c.SCHEDULED||r.isScheduled()||l.isMapEnabled()&&(r.latitude||r.longitude)||0!==a.length||n.hide();break;case"groupNearby":!r.pinned&&r.status===c.SCHEDULED||r.isScheduled()||l.isMapEnabled()&&(r.latitude||r.longitude)||0!==a.length||n.hide();break;case"dispatch":r.isScheduled()||l.isMapEnabled()&&(r.latitude||r.longitude)||0!==a.length||n.hide();break;case"gantt":l.isMapEnabled()&&(r.latitude||r.longitude)||0!==a.length||n.hide();break;case"map":0===a.length&&n.hide();break;default:parseInt(s)}}}}]),angular.module("serviceExpert").directive("keypressEvents",["$rootScope",function(t){var i=[13,16,18,27,37,38,39,40,48,49,50,51,55,69,70,73,77,79,83,84,85,87,90,96,97,98,99,103];return{restrict:"C",link:function(){angular.element("body").bind("keydown",function(e){-1<i.indexOf(e.which)?t.$broadcast("keypress",e):e.stopPropagation()})}}}]),function(){function e(e,a,t){return{restrict:"E",link:function(s){s.optimizationRequests={},s.optRunning=0,s.optQueued=0,s.replaceText=function(e,t){return customLabels[e].replaceAll(t.toString())},t.register("optimizationRequests",function(e){for(var t=0,i=0,n=0;n<e.length;n++){var r=new OptimizationRequest(e[n]);"Queued"==r.status&&i++,"In Progress"==r.status&&t++,s.optimizationRequests[r.id]&&"Completed"==r.status&&"Completed"!=s.optimizationRequests[r.id].status&&a.addNotification(customLabels.Optimization_Completed,customLabels.x_services_were_sched_out_of.replaceAll(r.scheduledAmount,r.objectToScheduled)+".",function(e){a.openSObjectLink("../"+e)},r.id),s.optimizationRequests[r.id]&&"Failed"==r.status&&"Failed"!=s.optimizationRequests[r.id].status&&a.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){a.openSObjectLink("../"+e)},r.id),s.optimizationRequests[r.id]=r}s.optQueued=i,s.optRunning=t})},scope:{},template:'\n                <div id="optInProgress" ng-show="optRunning">\n                    '+customLabels.Optimization_in_progress+"\n\t            \t<span ng-show=\"optRunning > 1\">{{ replaceText('XoptimizationRunning',optRunning) }}</span>\n\t            \t<span ng-show=\"optQueued\">{{ replaceText('XoptimizationQueued',optQueued) }}</span>\n        \t\t</div>"}}e.$inject=["DeltaService","utils","RegisterService"],angular.module("serviceExpert").directive("optimizationIndicator",e)}(),angular.module("serviceExpert").directive("csStopPropagation",[function(){return{restrict:"A",link:function(e,t,i){angular.element(t[0]).on(i.csStopPropagation,function(e){e.stopPropagation()})}}}]),angular.module("serviceExpert").directive("csToggle",[function(){return{restrict:"A",link:function(e,t,i){for(var n=$("#"+i.csToggle),r=$("[cs-toggle]"),s={},a=0;a<r.length;a++){var o=$(r[a]);s[o.attr("id")]=$("#"+o.attr("cs-toggle"))}1===n.length&&(angular.element(t[0]).on("click",function(e){for(var t in e.stopPropagation(),$(".moreQuickActionsContainer").hide(),s)t!==e.currentTarget.id?(s[t].hide(),$(".dhx_mini_calendar").hide()):n.toggle()}),angular.element("body").on("click",function(e){for(var t in s)s[t].hide()}))}}}]),angular.module("serviceExpert").directive("csTooltip",[function(){return{restrict:"E",transclude:!0,template:'<div class="gantt-tooltip-info-button">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n                                <span class="gantt-tooltip-wrapper" ng-transclude></span>',link:function(e,n,t){var r=!0;n.find(".gantt-tooltip-info-button").bind("mouseenter mouseleave",function(){var e=n.find(".gantt-tooltip-wrapper"),t=e.outerHeight(),i=n.offset();e.toggleClass("active-tooltip"),r&&(r=!1,e.css("top",i.top-t-10+"px"),e.css("position","fixed"),e.css("bottom","initial"))})}}}]),angular.module("serviceExpert").factory("SERVICE_CATEGORY",function(){return{NONE:"None",SCHEDULED:"Scheduled",DISPATCHED:"Dispatched",IN_PROGRESS:"InProgress",COULD_NOT_COMPLETE:"CannotComplete",COMPLETED:"Completed",CANCELED:"Canceled"}}),angular.module("serviceExpert").factory("SERVICE_STATUS",function(){return serviceStatuses}),angular.module("serviceExpert").constant("dhtmlxDays",{Sunday:"0",Monday:"1",Tuesday:"2",Wednesday:"3",Thursday:"4",Friday:"5",Saturday:"6"}),angular.module("serviceExpert").constant("PARENT_RECORD_TYPE",{WORKORDER:"WorkOrder",LINEITEM:"WorkOrderLineItem",ACCOUNT:"Account"}),angular.module("serviceExpert").constant("DRAWING_STATES",{NONE:0,EDIT:1,DRAW:2,SELECTED:3,INTERSECT:4}),angular.module("serviceExpert").constant("POST_MESSAGE_TYPE",{INIT:0,SHOW_ON_MAP:1,DRAW_MARKERS:2}),function(){function e(e,t,l,i,d,n,r){var u={},p={},s={},a={},v={};function o(e){if(e.type===a.IN_DAY){if("In Progress"===e.status||"Completed"===e.status&&v[e.id]&&"Completed"!==v[e.id].status||"In Progress"===e.status&&v[e.id]&&"Aborted"!==v[e.id].status)e.timespan=function(e){var t=[];if(e.territories){for(var i={},n=0;n<e.territories.length;n++)i[e.territories[n].serviceTerritory]=!0;var r=d.getGanttSectionsIdsByTerritory(i,e.start);for(var s in r){var a={start:e.start,end:e.finish};for(var o in useLocationTimezone||(a.start=l.convertDateBetweenTimeZones(e.start,userTimeZone,r[s].tz),a.end=l.convertDateBetweenTimeZones(e.finish,userTimeZone,r[s].tz)),p[s]||(p[s]={}),p[s][e.id]=a,r[s].resources){var c=scheduler.addMarkedTimespan({start_date:a.start,end_date:a.end,sections:{ZoomLevel2:o+"_"+s,ZoomLevel3:o+"_"+s,ZoomLevel4:o+"_"+s,ZoomLevel5:o+"_"+s,ZoomLevel6:o+"_"+s,ZoomLevel7:o+"_"+s},css:"smart-on-gantt-inday-body"});t.push(c)}}}return t}(e);else if("Completed"===e.status||"Failed"===e.status||"Aborted"===e.status)for(var t=0;t<e.territories.length;t++)p[e.territories[t].serviceTerritory]&&p[e.territories[t].serviceTerritory][e.id]&&delete p[e.territories[t].serviceTerritory][e.id]}else"Failed"!==e.status&&"Aborted"!==e.status&&"Completed"!==e.status&&"Global Optimization"!==e.type&&e.start&&e.finish&&(e.timespan=[function(e){if(!e.resource)return(new Date).getTime();var t=void 0,i=d.getResoruceGanttIdByDate(e.resource,e.start),n="reshufle-on-gantt",r="";{if(!i)return(new Date).getTime();t=i.split(",")}switch(e.type){case"Fix Overlaps":n="fix-overlaps-on-gantt",r=customLabels.FixOverlaps;break;case"SA Reshuffle":n="reshufle-on-gantt",r=customLabels.Reshuffle;break;case"Fill-In Schedule":n="fillin-on-gantt",r=customLabels.Fill_in_Schedule;break;case"Group Nearby SAs":n="group-near-on-gantt",r=customLabels.GroupNearby;break;case"Resource Schedule Optimization":n="resource-day-on-gantt",r=customLabels.RDOptimize;break;default:n="reshufle-on-gantt"}if(window.useLocationTimezone&&e.territories&&e.territories[0]&&!e.schedulingRecipe){var s=l.getLocationOffset(e.start,e.territories[0].serviceTerritory),a=l.getLocationOffset(e.finish,e.territories[0].serviceTerritory);e.start.setMinutes(e.start.getMinutes()-s),e.finish.setMinutes(e.finish.getMinutes()-a)}return scheduler.addMarkedTimespan({start_date:e.start,end_date:e.finish,sections:{ZoomLevel2:t,ZoomLevel3:t,ZoomLevel4:t,ZoomLevel5:t,ZoomLevel6:t,ZoomLevel7:t},css:"smart-on-gantt "+n,html:"<div><span>"+r+"</span></div>"})}(e)])}function c(e){if(!l.hasCustomPermission("Abort_Optimization_Request"))return!1;if(v[e.id]&&v[e.id].aborting)return!1;if("Completed"===e.status||"Aborted"===e.status||"Failed"===e.status)return!1;for(var t in a)if(e.type==a[t])return!0;return!1}return e.all([d.promises.initialPhasedData,n.promises.policies(),t.getOptimizationRequests(),t.getOptimizationsRequestTypes()]).then(function(e){e[1].forEach(function(e){s[e.Id]=e}),a=e[3],e[2].forEach(function(e){u[e.Id]=new OptimizationRequest(e),v[e.Id]={canAbort:c(u[e.Id]),status:u[e.Id].status,objectToScheduled:u[e.Id].objectToScheduled,aborting:!1,progressInterval:null},o(u[e.Id])})}),i.register("optimizationRequests",function(e){e.forEach(function(e){var t=new OptimizationRequest(e);if(u[e.Id]&&u[e.Id].timespan)for(var i=0;i<u[e.Id].timespan.length;i++)scheduler.deleteMarkedTimespan(u[e.Id].timespan[i]);if(u[e.Id]&&"Global Optimization"===u[e.Id].type)for(var n in t)u[e.Id][n]=t[n];else u[e.Id]=t;v[e.Id]?v[e.Id].canAbort=c(t):v[e.Id]={canAbort:c(t),status:t.status,objectToScheduled:t.objectToScheduled,aborting:!1,progressInterval:null},o(t)}),updateViewDebounced()}),{getNumOfActiveOptimizationRequests:function(){var e=0;for(var t in u)"Completed"!==u[t].status&&"Failed"!==u[t].status&&"Aborted"!==u[t].status&&e++;return e},optimizationRequests:function(){return u},isTerritoryHasInDayOptimizationInProgress:function(e,t,i){if(p[i])for(var n in p[i])if(isIntersect(p[i][n].start,p[i][n].end,e,t))return u[n];return!1},policies:s,OptimizationRequestsProgressStatus:v,generateRequestResultText:function(e){if(e.failureReason&&0<e.failureReason.length)return"User Aborted"===e.failureReason?e.failureDetails:e.failureReason;if(e.type==a.RSO&&r.getResources()[e.resource])return customLabels.rso_optimization_request_for_name.replaceAll(e.resourceName);if(e.type==a.IN_DAY||e.type==a.BGO){var t=[];if(e.territories.forEach(function(e){t.push(e.serviceTerritoryName)}),t=3<t.length?t.length+" "+customLabels.UTterr:t.join(", "),"In Progress"==e.status)return customLabels.optimization_for_terr_in_progress.replaceAll(e.type,t);if("Completed"==e.status)return customLabels.optimization_for_terr_completed.replaceAll(e.type,t,e.scheduledAmount)}return e.result},calculateIndayProgress:function(i){var e=void 0;if("Completed"==i.status)return v[i.id].status="Completed",setTimeout(function(){if(u[i.id]&&u[i.id].timespan)for(var e=0;e<u[i.id].timespan.length;e++)scheduler.deleteMarkedTimespan(u[i.id].timespan[e]);for(var t=0;t<i.territories.length;t++)p[i.territories[t].serviceTerritory]&&p[i.territories[t].serviceTerritory][i.id]&&delete p[i.territories[t].serviceTerritory][i.id]},2e3),{percent:100,text:customLabels.In_Day_Optimization_Completed};"In Progress"==i.status&&v[i.id]&&"Aborted"==v[i.id].status?e=customLabels.In_Day_Optimization_Aborting:(e=customLabels.In_Day_Optimization_In_Progress,v[i.id].status="In Progress");var t=__gantt.inday,n=i.objectToScheduled,r=t.maxRunTimeSingleService*n,s=(new moment).diff(moment(i.requestProgressStart),"seconds");r>=t.maxRuntimeOverall&&(n=t.maxRuntimeOverall/t.maxRunTimeSingleService,r=t.maxRuntimeOverall);var a=s/r*100,o=7,c=0;return r<=s&&"In Progress"==i.status&&(o=7+(s-r)/t.maxRunTimeSingleService*.1,c=90),c<90&&(c=a),100<=c&&100<=a?c=100:90<=c&&(o+=.1,c=Math.round(Math.atan(o)/(Math.PI/2)*100*1e3)/1e3),{percent:100!==c?c.toFixed(1):c,text:e}},updateProgressStatus:function(e,t){v[e]?v[e].status=t:v[e]={status:t}},canAbortOR:c,abortOptRequest:function(e){confirm(customLabels.confirm_abort_current_optimization)&&(e.status="Aborting",v[e.id]?(v[e.id].aborting=!0,v[e.id].canAbort=!1):v[e.id]={aborting:!0,canAbort:!1},t.abortOptimizationRequest(e.id).then().catch(function(e){console.warn(e)}))}}}e.$inject=["$q","sfdcService","utils","RegisterService","TimePhasedDataService","StateService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("OptimizationRequestsService",e)}(),angular.module("serviceExpert").factory("servicesService",["$q","$rootScope","sfdcService","utils","userSettingsManager","monthlyViewHelperService","TimePhasedDataService","ServiceAppointmentLightboxService","kpiCalculationsService","bulkResultsService","SERVICE_STATUS","SERVICE_CATEGORY","StateService","MstResolver","DeltaService",function(m,e,h,g,c,t,y,f,p,S,i,n,_,b,T){var r=new Date;r.setDate(r.getDate()+3),window.globalStatuses=i,window.globalCategories=n;var w={servicesObjects:{},recentlyUsed:{},flagged:flaggedServices,filteredServices:{servicesArray:[]},filter:{searchOnServer:null,advancedFilter:{statusCheckboxs:{New:!0,Assigned:!0,Dispatched:!0,Travel:!0,"On Site":!0,Incomplete:!0},selectedDates:{dueDate:!0,appEnd:!0,end_date:!0},minDate:new Date(Date.now()-6048e5),maxDate:new Date(Date.now()+6048e5),servicePriority:10,jeopardies:!0,violations:!0,unScheduled:!0},selectedFiled:{appEnd:!0,appStart:!0,dueDate:!0,earlyStart:!0,finish:!0,start:!0,display:!0},selectedFilter:c.GetUserSettingsProperty("Selected_List_View__c")||(customPermissions.Service_List_Todo?"Todo":"All"),orderByField:"start",reverse:!1,SearchText:"",endDate:r,currentPage:1,servicesPerPage:200,totalServices:0,totalPages:1}};if(c.GetUserSettingsProperty("Date_Horizon_Properties__c")){var s=JSON.parse(c.GetUserSettingsProperty("Date_Horizon_Properties__c"));for(var a in s)w.filter.selectedFiled[a]=s[a]}function L(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function v(e){var n={},t=[],r=null,s=null,i={},a=0,o=0,c=0,l=0;e.forEach(function(e){var t=y.serviceAppointments()[e],i=L(t.start);r?r>t.start&&(r=t.start):r=t.start,s?s<t.start&&(s=t.start):s=t.start,n[t.resource]=n[t.resource]||{},n[t.resource][i]=n[t.resource][i]||[],n[t.resource][i].push(e)}),s=new Date(s.getFullYear(),s.getMonth(),s.getDate()+1);for(var d=new Date(r);d<s;d.setDate(d.getDate()+1)){var u=L(d);for(var p in 7==++l&&(c++,l=a=o=0,i={}),n){var v;if(n[p][u]&&(t[c]=t[c]||[],(v=t[c]).push.apply(v,_toConsumableArray(n[p][u])),190<=(o+=n[p][u].length)&&(c++,l=a=o=0,i={}),!i[p]&&(i[p]=!0,40==++a))){if(o<=190){var m=new Date(d);m.setDate(m.getDate()+1);var h=new Date(m);h.setDate(h.getDate()+7-l+1);for(var g=m;g<h;g.setDate(g.getDate()+1)){var f=L(g);for(var S in i){var _;if(n[S][f]&&((_=t[c]).push.apply(_,_toConsumableArray(n[S][f])),o+=n[S][f].length),delete n[S][f],190<=o)break}if(190<=o)break}}c++,l=a=o=0,i={}}delete n[p][u]}}return t=t.filter(function(e){return e})}function l(n,r,s,e){var a=3<arguments.length&&void 0!==e&&e,o={};n.schedulingResult&&Array.isArray(n.schedulingResult)&&n.schedulingResult[0]?(o.partialResults=n.schedulingResult[0].PartialResults||[],0===n.services.length?h.getServicesById([s]).then(function(e){var t;o.absences=y.updateTimePhaseData(n.na,"na",!a).absences,o.services=y.updateTimePhaseData(n.services,"service",!a).services,(t=o.services).push.apply(t,_toConsumableArray(y.updateTimePhaseData(e,"service",!a).services));var i=c.GetUserSettingsProperty("locations");1===e.length&&-1===i.indexOf(o.services[o.services.length-1].ServiceTerritoryId)&&g.addNotification(customLabels.SchedulingResult,customLabels.WasScheduledToFilteredTeritory.replace("$0",o.services[o.services.length-1].AppointmentNumber)),r.resolve(o),w.checkRules(g.getRelatedServices(s)).then(w.drawViolationsOnGantt)}):(o.absences=y.updateTimePhaseData(n.na,"na",!a).absences,o.services=y.updateTimePhaseData(n.services,"service",!a).services,r.resolve(o),w.checkRules(g.getRelatedServices(s)).then(w.drawViolationsOnGantt))):(o.absences=y.updateTimePhaseData(n.na,"na",!a).absences,o.services=y.updateTimePhaseData(n.services,"service",!a).services,r.resolve(o),w.checkRules(g.getRelatedServices(s)).then(w.drawViolationsOnGantt))}return g.ganttSettings&&(w.filter.servicesPerPage=parseInt(g.ganttSettings.servicesPerPage)),w.checkRules=function(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(0===(e=e.filter(function(e){return y.serviceAppointments()[e]&&y.serviceAppointments()[e].isScheduled()})).length){var t=m.defer();return t.resolve([]),t.promise}for(var s=v(e),a=[],o={},c=m.defer(),i=0;i<s.length;i++)a.push(m.defer()),a[i].promise.then(function(n){h.checkRules(s[n],_.selectedPolicyId).then(function(e){for(var t in s[n].forEach(function(e){return o[e]=!0}),e){delete o[t];var i=y.serviceAppointments()[t];0<e[t].length&&i?(i.violations=e[t],r.push(t)):i&&(i.violations=null)}a[n+1]?a[n+1].resolve(n+1):0===Object.keys(o).length?(p.calculateKpis(),c.resolve(r)):w.checkRules(Object.keys(o),r).then(function(e){p.calculateKpis(),c.resolve([].concat(_toConsumableArray(e),_toConsumableArray(r)))})}).catch(function(e){g.addNotification(customLabels.Rule_validation_failed,e.message),c.reject(e),console.warn("rule checking failed"),console.log(e)})});return a[0].resolve(0),c.promise},w.checkRules2=function(e){var r=m.defer(),s=[],a=[],t=[],i=1,n=0,o=void 0,c=[],l={};if(Array.isArray(e)&&0===e.length)return r.resolve([]),r.promise;v(e),e.sort(function(e,t){return y.serviceAppointments()[e]||y.serviceAppointments()[t]?!y.serviceAppointments()[e]&&y.serviceAppointments()[t]?-1:y.serviceAppointments()[e]&&!y.serviceAppointments()[t]?1:y.serviceAppointments()[e].start==y.serviceAppointments()[t].start?0:y.serviceAppointments()[e].start>y.serviceAppointments()[t].start?1:-1:0});for(var d=e.slice(0);0<d.length;){n=0,o=null,l[i-1]={};for(var u=0;u<d.length;u++)if(l[i-1][d[u]]=!0,y.serviceAppointments()[d[u]]&&y.serviceAppointments()[d[u]].start){if(o=o||moment(y.serviceAppointments()[d[u]].start),!(moment(y.serviceAppointments()[d[u]].start).diff(o,"days")<=7&&n<200))break;n++}else n++;t.push(d.splice(0,n)),a.push(m.defer()),i++,a[a.length-1].promise.then(function(n){h.checkRules(t[n],_.selectedPolicyId).then(function(e){for(var t in e)if(delete l[n][t],0<e[t].length){if(!y.serviceAppointments()[t])continue;y.serviceAppointments()[t].violations=e[t],s.push(t)}else y.serviceAppointments()[t]&&(y.serviceAppointments()[t].violations=null);for(var i in l[n])"undefined"!=i&&y.serviceAppointments()[i]&&y.serviceAppointments()[i].resourceId&&c.push(i);a[n+1]?a[n+1].resolve(n+1):(p.calculateKpis(),r.resolve(s),0<c.length&&(debugMode&&console.log("Calling check rules again on "+c.length+" services"),maxNumberOfChecks?maxNumberOfChecks--:maxNumberOfChecks=10,w.checkRules(c,maxNumberOfChecks).then(function(){scheduler.updateView()})))}).catch(function(e){g.addNotification(customLabels.Rule_validation_failed,e.message),r.reject(e),console.warn("rule checking failed"),console.log(e)})})}return a[0].resolve(0),r.promise},w.postToChatter=function(e,t){var i=m.defer();return h.postToChatter(e,t).then(function(e){i.resolve(e)}),i.promise},w.sortServicesByPriority=function(e){var t=m.defer();return h.sortServicesByPriority(e).then(function(e){t.resolve(e)}),t.promise},w.autoScheduleService=function(s){var a=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=m.defer();return null==window.userHasAdminPermissions&&h.userHasAdminPermissions().then(function(e){window.userHasAdminPermissions=e}),h.autoScheduleService(s,_.selectedPolicyId).then(function(e){if(e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]){var t=e.schedulingResult[0].PartialResults||[],i="";0<t.length&&(window.userHasAdminPermissions?t.forEach(function(e){i+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):i+=customLabels.ContactSysAdmin,""!==i&&g.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),i))}if(e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&e.schedulingResult[0].LongOperationId)b.getUpdates(e.schedulingResult[0].LongOperationId).then(function(e){e.services&&(e.mst=!0,a?l(e,o,s,!0):o.resolve(e))}).catch(function(e){console.error(e);var t="string"==typeof e?{eventType:"exception",message:e}:e;o.reject(t)});else{if(e.services=e.deltaResult.updatedGanttServices,e.na=e.deltaResult.updatedAbsence,T.handleDeltaResponse(e.deltaResult),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]){var n=e.schedulingResult[0].PartialResults||[],r="";0<n.length&&(window.userHasAdminPermissions?n.forEach(function(e){r+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):r+=customLabels.ContactSysAdmin,""!==r&&g.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),r))}l(e,o,s)}}).catch(function(e){e.message&&(e.message.includes("Too many SOQL queries")||e.message.includes("Apex CPU time limit"))?T.getDelta():console.log(e),o.reject(e)}),o.promise},w.saveChangesToServiceAppointment=function(t,e){var i=m.defer(),n=new Date(e.start_date.getTime()+1e3*e.travelTo),r=new Date(e.end_date.getTime()-1e3*e.travelFrom);if(useLocationTimezone){var s=y.getIntersectingSrstOffset(e,e.getGanttResource()),a=g.getUserOffset(n),o=g.getUserOffset(r);n.setMinutes(n.getMinutes()+a-s),r.setMinutes(r.getMinutes()+o-s)}w.recentlyUsed[t.id]=!0,e.snapToId&&e.ServiceAppointmentLastModifiedDate--;var c=null,l=null;if(e.snapToId){var d=[],u=scheduler._events[e.snapToId].end||scheduler._events[e.snapToId].finish;for(var p in scheduler._events)if(p!==e.id){var v=scheduler._events[p];v.resourceId===e.resourceId&&"break"!==v.type&&v.latitude&&isIntersect(v.start_date,v.end_date,scheduler._min_date,u)&&d.push(p)}d.sort(function(e,t){return scheduler._events[e].start>scheduler._events[t].start?-1:scheduler._events[e].start<scheduler._events[t].start?1:0}),0<d.length&&(c=scheduler._events[d[0]].latitude,l=scheduler._events[d[0]].longitude)}return h.saveChangesToServiceAppointment(e.id,e.getGanttResource(showSecondarySTMs),e.assignedResource,n,r,_.selectedPolicyId,e.scheduleMode,e.snapToId||null,e.snapToType||null,e.snapDirection||null,c,l).then(function(e){T.handleDeltaResponse(e),e.ValidationError?i.reject(["",t,e.ValidationError]):i.resolve()}).catch(function(e){i.reject([e,t,""]),console.warn(e)}),i.promise},w.handleSnap=function(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(t.ctrlKey){var n=[];for(var r in scheduler._events){var s=scheduler._events[r];"service"!==s.type&&"na"!==s.type||-1<s.id.indexOf("dummy")||s.id===e.id||e.resourceId&&-1===s.resourceId.indexOf(e.resourceId)||isIntersect(s.start_date,s.end_date,e.start_date,e.end_date)&&n.push(s)}n.sort(function(e,t){return e.start>t.start?1:e.start<t.start?-1:0});var a=i?1:0;if(n.length>a){var o=new Date(e.start_date);e.travelTo&&(o=o.setSeconds(o.getSeconds()+e.travelTo));var c="right";o<n[n[0].isDummy?1:0].start&&(c="left");var l=0;n[0].isDummy&&(l=1),n[l]?(e.snapToId=n[l].id,e.snapToType=n[l].type,e.snapDirection=c):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)}else e.snapToId=null,e.snapToType=null,e.snapDirection=null}},w.unscheduleServices=function(l,e,d,u){var p=m.defer(),t=u?h.unscheduleServicesByLocationsId:h.unscheduleServicesByServicesId,v=null;return u||(v=g.getRelatedServices(l)),t(l,e,d,u).then(function(e){var c={};if(e.nothingToUnschedule)p.resolve(e);else{var i=m.defer();e.fslOperation?b.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services;h.getServicesById(e).then(function(e){y.updateTimePhaseData(e,"service").services,i.resolve({services:e,resourceAbsences:[],resourceCapacities:[],failedResults:t.fslOperation.result.failedResults})})}).catch(function(e){var t="string"==typeof e?{eventType:"exception",message:e}:e;i.reject(t)}):i.resolve(e),i.promise.then(function(t){c.absences=y.updateTimePhaseData(t.resourceAbsences,"na",!0).absences,c.services=y.updateTimePhaseData(t.services,"service",!0).services,c.capacities=y.updateTimePhaseData(t.resourceCapacities,"capacity").capacities,c.failedResults=t.failedResults,w.drawServicesAndAbsences(c.services,c.absences),u||w.checkRules(v).then(w.drawViolationsOnGantt),u&&w.checkRules(g.getServicesOfLocations(l,d,u)).then(w.drawViolationsOnGantt);var e=void 0,i=void 0;if(1!==l.length||u){var n=[],r=[];u?t.services.forEach(function(e){t.failedResults[e.Id]&&y.serviceAppointments()[e.Id].isScheduled()?r.push(e.Id):n.push(e.Id)}):l.forEach(function(e){y.serviceAppointments()[e].isScheduled()?r.push(e):n.push(e)}),e=customLabels.x_services_were_unscheduled.replaceAll(n.length),i=u?customLabels.x_services_were_unscheduled_out_of_y.replaceAll(n.length,n.length,r.length+n.length):customLabels.x_services_were_unscheduled_out_of_y.replaceAll(n.length,n.length,l.length),0<r.length&&(i+="<div title='"+r.map(function(e){return y.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_unschedule.replaceAll(r.length)+". "+customLabels.View_services+"</div>");var s=angular.copy(t),a=[];s.services.forEach(function(e){if(u)e.Fields.SchedStartTime||a.push(e);else for(var t=0;t<l.length;t++)e.Id===l[t]&&a.push(e)}),s.services=a,g.addNotification(e,i,function(){var e={success:customLabels.SuccessfullyUnscheduled,fail:customLabels.FailToUnschedule};S.open(s,e)})}else{var o=y.serviceAppointments()[l[0]].name;i=y.serviceAppointments()[l[0]].isScheduled()?(e=customLabels.Couldnt_unschedule.replaceAll(o),customLabels.Couldnt_unschedule.replaceAll(o)+". "+t.failedResults[l[0]].errorMessage):(e=customLabels.was_unscheduled.replaceAll(o),customLabels.was_unscheduled_successfully.replaceAll(o)),g.addNotification(e,i,function(){w.recentlyUsed[l[0]]=!0,f.open(l[0])})}p.resolve(c)})}}).catch(function(e){p.reject(e),console.warn(e)}),p.promise},w.drawServicesAndAbsences=function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[];if(0!==t.length||0!==i.length||0!==n.length||0!==r.length){var s,a={},o={},c={},l={scheduledServices:[],unscheduledServices:[],deletedIds:n};for(var d in Array.isArray(t)?t.forEach(function(e){return a[e.id||e.Id]=e instanceof GanttService?e:new GanttService(e)}):a=t,Array.isArray(i)?i.forEach(function(e){return o[e.id||e.Id]=e}):o=i,Array.isArray(r)?r.forEach(function(e){return c[e.id||e.Id]=e}):c=r,s=angular.extend({},a,o,c)){var u=s[d];((e=u).isScheduled()?(e.setGanttResource(y.resourcesAndTerritories(),g.generateResourceId),1):(scheduler._events[e.id]&&delete scheduler._events[e.id],0))?l.scheduledServices.push(u):l.unscheduledServices.push(u)}if(n.forEach(function(e){return delete scheduler._events[e]}),0<l.scheduledServices.length)scheduler.parse(l.scheduledServices,"json");else for(var p in l)if(Array.isArray(l[p])&&0<l[p].length){updateViewDebounced();break}return l}},w.changeStatus=function(o,c,e,l){var d=4<arguments.length&&void 0!==arguments[4]&&arguments[4],u=m.defer();return(l?h.changeStatusServicesByLocationsId:h.changeStatusServicesByServicesId)(o,c,e,l).then(function(e){var a={};if(e.nothingToDispatch)u.resolve(e);else{var i=m.defer();e.fslOperation?b.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services;h.getServicesById(e).then(function(e){i.resolve({services:e,failedResults:t.fslOperation.result.failedResults})})}).catch(function(e){var t="string"==typeof e?{eventType:"exception",message:e}:e;i.reject(t)}):i.resolve(e),i.promise.then(function(t){a.services=y.updateTimePhaseData(t.services,"service",d).services,a.failedResults=t.failedResults;var e=void 0,i=void 0;if(1!==o.length||l){var n=[],r=[];l?t.services.forEach(function(e){y.serviceAppointments()[e.Id].status!==c?n.push(e.Id):r.push(e.Id)}):o.forEach(function(e){y.serviceAppointments()[e].status===c?r.push(e):n.push(e)}),e=customLabels.x_services_were_changed.replaceAll(r.length,g.statusTranslations[c]||c),i=customLabels.x_services_were_changed_out_of_y.replaceAll(r.length,r.length,r.length+n.length,g.statusTranslations[c]||c),0<n.length&&(i+="<div title='"+n.map(function(e){return y.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_change_status.replaceAll(n.length)+". "+customLabels.View_services+"</div>"),g.addNotification(e,i,function(){var e={success:customLabels.SuccessfullyDispatched,fail:customLabels.FailToDispatch};S.open(t,e)})}else{var s=y.serviceAppointments()[o[0]].name;y.serviceAppointments()[o[0]].status!==c&&(e=customLabels.could_not_change_title.replaceAll(s),i=t.failedResults&&!g.isEmpty(t.failedResults)?customLabels.could_not_change_status.replaceAll(s,g.statusTranslations[c],t.failedResults[o[0]].errorMessage):customLabels.could_not_change_status.replaceAll(s,g.statusTranslations[c],""),g.addNotification(e,i,function(){f.open(o[0])})),w.recentlyUsed[o[0]]=!0}u.resolve(a)})}}).catch(function(e){u.reject(e),console.warn(e)}),u.promise},w.changePin=function(e,t){var i=m.defer();return h.changePin(e,t).then(function(e){var t=fieldNames.Service_Appointment.pinned;e.forEach(function(e){return y.serviceAppointments()[e.Id].pinned=e[t]}),i.resolve()}).catch(function(e){i.reject(e),console.warn(e)}),i.promise},w.setInJeopardy=function(e){var t=m.defer();return h.setServiceAppointmentsInJeopardy(e).then(function(e){e.forEach(function(e){return y.serviceAppointments()[e.Id].jeopardy=e[fieldNames.Service_Appointment.InJeopardy__c]}),g.addNotification("In Jeopardy Service Appointments",e.length+" service appointments were marked as in jeopardy"),t.resolve()}).catch(function(e){t.reject(e),console.warn(e)}),t.promise},w.drawViolationsOnGantt=function(e){updateViewDebounced()},w.searchServiceByIdOrName=function(e){var i=m.defer();return h.searchServiceByIdOrName(e).then(function(e){if(null===e)i.resolve(null);else{var t=y.updateTimePhaseData(e,"service");t.services&&0<t.services.length&&scheduler.parse(t.services.filter(function(e){return e.isScheduled()}),"json"),i.resolve(e[0].Id)}}).catch(function(e){i.reject(e),console.warn(e)}),i.promise},w}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};angular.module("serviceExpert").factory("userSettingsManager",["$q",function(r){function i(e){var n=r.defer();for(var t in e){var i=e[t];e[t]=i+":"+(void 0===i?"undefined":_typeof(i))}return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperties,e,function(e,t){var i=JSON.parse(t.result);i.FailedLocations?(bootstrap.loadedUserSettings=i,n.reject(i)):(bootstrap.loadedUserSettings=i,n.resolve())},{buffer:!1,escape:!1,timeout:12e4}),n.promise}return{GetUserSettingsProperty:function(e){return bootstrap.loadedUserSettings[e]},SetUserSettingsProperty:function(e,t){var i=r.defer(),n=void 0===t?"undefined":_typeof(t);return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperty,e,t,n,function(e,t){null!==t.result&&(bootstrap.loadedUserSettings=JSON.parse(t.result),i.resolve())},{buffer:!1,escape:!1,timeout:12e4}),i.promise},SetUserSettingProperties:i,SetUserSettingPropertiesPromise:function(e){var t=r.defer();return i(e),bootstrap.loadedUserSettings=JSON.parse(ev.result),t.promise}}}]);var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],n=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);n=!0);}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}!function(){function e(e,t,n,i,r,p,v,s,a,o,c){var l=void 0,d=[],u=[],m=[],h=[],g={},f={},S={},_={},y={DateTime:"DATETIME",Date:"DATE",String:"STRING",TextArea:"TEXTAREA",Picklist:"PICKLIST",Reference:"REFERENCE",Currency:"CURRENCY",Phone:"PHONE"},b={minutes:"Minutes",hours:"Hours",days:"Days"},T=[],w=e.defer(),L=new DOMParser;function C(e){this.name=e[fieldNames.CustomGanttAction.Label],this.className=e[fieldNames.CustomGanttAction.Class],this.order=e[fieldNames.CustomGanttAction.Order],this.permission=e[fieldNames.CustomGanttAction.Permission],this.section=e[fieldNames.CustomGanttAction.Section],this.visualforce=e[fieldNames.CustomGanttAction.Visualforce],e[fieldNames.CustomGanttAction.Icon]&&(this.icon=function(e){var t=_slicedToArray(e,2),i=t[0],n=t[1];return window.lsdIcons.globalIcon+"/"+i+"-sprite/svg/symbols.svg#"+n}(e[fieldNames.CustomGanttAction.Icon].split(",")))}function A(e,t){var i=864e5*t;return new Date(e.getTime()+i)}function D(e){I(null,e)||window.open("../"+e,"_blank")}function I(e,t){return!!v.isInConsole()&&(e&&e.preventDefault(),sforce.console.generateConsoleUrl(["/"+t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):k(t)}),!0)}function k(e){sforce.console.openPrimaryTab(null,"/"+e,!0)}function R(e,t){return moment.tz({year:e.getFullYear(),month:e.getMonth(),date:e.getDate(),hours:e.getHours(),minutes:e.getMinutes()},t)}function F(e){return new Date(e.year(),e.month(),e.date(),e.hours(),e.minutes())}function M(e){return customPermissions[e]}return String.prototype.decodeHTML=function(){var e=L.parseFromString(this,"text/html");return""!==e.documentElement.textContent?e.documentElement.textContent:this},String.prototype.encodeHTML=function(){var e=this;return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},n.getCustomActions().then(function(e){e.forEach(function(e){var t=e[fieldNames.CustomGanttAction.Permission];window.customPermissions[t]&&T.push(new C(e))}),w.resolve(T)}),n.getAllFormulaFields().then(function(e){l=e}),n.getWorkOrderPriority().then(function(e){d.push.apply(d,_toConsumableArray(e))}),g.startHour=p.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),null===g.startHour&&(g.startHour=0),g.finishHour=p.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),null===g.finishHour&&(g.finishHour=24),g.filterCandidates=p.GetUserSettingsProperty("Filter_Candidates__c"),null===g.filterCandidates&&(g.filterCandidates=!0),g.servicesPerPage=p.GetUserSettingsProperty("Services_Per_Page__c"),null===g.servicesPerPage&&(g.servicesPerPage="75"),g.resourceRowHeight=p.GetUserSettingsProperty("Resource_Row_Height__c"),null===g.resourceRowHeight&&(g.resourceRowHeight="medium"),g.capacityDuration=p.GetUserSettingsProperty("View_Capacity_Type__c"),null===g.capacityDuration&&(g.capacityDuration="Day"),g.backHorizon=p.GetUserSettingsProperty("Scheduling_horizon_limit__c"),null===g.backHorizon&&(g.backHorizon=14),g.loadOnToday=p.GetUserSettingsProperty("Load_On_Today__c"),null===g.loadOnToday&&(g.loadOnToday=!0),g.leftPanel=p.GetUserSettingsProperty("DefaultLeftPanel__c")||"salist",g.serviceColoring=p.GetUserSettingsProperty("ServiceListColoring__c")||"default",n.getCustomizationFiles().then(function(e){if(e&&e.CSS){var t=jQuery("<link>");t.attr({rel:"stylesheet",type:"text/css",href:e.CSS}),$("head").append(t)}e&&e.JS&&$.ajax({url:e.JS,dataType:"script"})}),window.openConsoleTabFromModal=function(t){v.isInConsole()&&sforce.console.generateConsoleUrl([t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):k(t)})},String.prototype.replaceAll=function(){for(var e=this,t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0;r<i.length;r++)e=e.replace("$"+r,i[r]);return e},n.getStatusFlow().then(function(e){if(e)for(var t in angular.merge(f,e),f)f[t]=f[t].sort()}).catch(function(e){console.warn("could not get status flow :("),console.log(e)}),n.getStatusTranslations().then(function(e){angular.merge(S,e),window.statusTranslations=S}).catch(function(e){console.warn("could not get status translations :("),console.log(e)}),n.getStatuses().then(function(e){angular.merge(_,e)}).catch(function(e){console.warn("could not get status :("),console.log(e)}),{getFilteredLocations:function(){var e=p.GetUserSettingsProperty("locations");return e||[]},getSVGIconHTMLCustom:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use width="17px" height="17px" xlink:href="'+e+'"></use></svg>'},getSVGIconHTML:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use xlink:href="'+e+'"></use></svg>'},getRelatedServices:function(e,t){var i=Array.isArray(e)?e.concat():[e];for(var n in t+=i.reduce(function(e,t){return scheduler._events[t]?e+","+scheduler._events[t].resource:e},""),scheduler._events){var r=scheduler._events[n];"service"===r.type&&-1!=t.indexOf(r.resource)&&(i.push(r.id),r.relatedTo&&i.push(r.relatedTo),r.relatedFather&&i.push(r.relatedFather),r.relatedService2&&i.push(r.relatedService2),r.relatedService1&&i.push(r.relatedService1))}return i},getServicesOfLocations:function(e,t,i){var n=[],r=(e=Array.isArray(e)?e:[e]).join(",");for(var s in scheduler._events){var a=scheduler._events[s];"service"===a.type&&r.indexOf(a.serviceTerritory)&&isIntersect(a.start_date,a.end_date,t,i)&&(n.push(a.id),a.relatedTo&&n.push(a.relatedTo),a.relatedFather&&n.push(a.relatedFather),a.relatedService2&&n.push(a.relatedService2),a.relatedService1&&n.push(a.relatedService1))}return n},getServicesBetweenDates:function(e,t){var i=[];for(var n in scheduler._events){var r=scheduler._events[n];"service"===r.type&&isIntersect(r.start_date,r.end_date,e,t)&&(i.push(r.id),r.relatedTo&&i.push(r.relatedTo),r.relatedFather&&i.push(r.relatedFather),r.relatedService2&&i.push(r.relatedService2),r.relatedService1&&i.push(r.relatedService1))}return i},getServiceDuration:function(e){var t=0;if(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),e.isScheduled())t=e.finish.getTime()-e.start.getTime();else switch(e.durationType){case b.minutes:t=60*e.estDuration*1e3;break;case b.hours:t=60*e.estDuration*60*1e3;break;case b.days:t=24*e.estDuration*60*60*1e3;break;default:t=6e4}return t},safeApply:function(e,t){var i=e.$root.$$phase;"$apply"===i||"$digest"===i?t&&"function"==typeof t&&t():e.$apply(t)},formatDayToString:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},showOnGantt:function(e){if("MonthlyView"!==scheduler._mode){var t=scheduler._events[e],i=getMinAndMaxHoursToDisplay(),n=t.start_date.getHours(),r=t.end_date.getHours();if((scheduler._min_date>t.start||t.start>scheduler._max_date)&&scheduler.setCurrentView(new Date(t.start)),0===t.end_date.getHours()&&t.end_date.getDate()>t.start_date.getDate()&&(r=24),"ZoomLevel2"!==scheduler._mode&&(i.min>r||i.max<=n))alert(customLabels.serviceCantDisplayMsg);else{for(var s=!0,a=scheduler.serverList("resources"),o=0;o<a.length;o++)for(var c=0;c<a[o].children.length;c++)if(-1<t.resourceId.indexOf(a[o].children[c].key)){s=!1;break}if(s)alert(customLabels.resource_filtered_out);else{if(v.areContractorsSupported()){var l=!0;if(t.resourceContractor){for(var d=scheduler.getEvents(t.start,t.finish),u=0;u<d.length;u++)if(d[u].resourceId===t.resourceId&&"contractorcapacity"===d[u].type&&d[u].timePeriod===p.GetUserSettingsProperty("View_Capacity_Type__c")){t=d[u],e=d[u].id,l=!1;break}if(l)return void alert(customLabels.is_assigned_to_contractor.replaceAll(t.name,t.resourceName)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}}try{scheduler._els.dhx_cal_data[0].scrollTop=0,t.showEventPopupEffect=!0,scheduler.showEvent(e)}catch(e){scheduler.callEvent("onAfterEventDisplay",[t,scheduler._mode])}}}}else alert(customLabels.serviceCantDisplayMonthlyMsg)},openConsoleTab:I,trust:function(e){return"string"==typeof e?t.trustAsHtml(e):null},openLink:function(e,t){t.Type==y.Reference&&D(e[t.JsAPIName.replace("__r","__c")])},openSObjectLink:D,openLightningSubtab:function(i){sforce.console.getEnclosingPrimaryTabId(function(e){var t=e.id;sforce.console.openSubtab(t,"/"+i,!0)})},openLightningPrimaryTab:k,getServiceInfoRowClass:function(e){if(e){var t={};return e.Type==y.Reference&&(t.resourceOnServiceTT=!0),t}},isEmpty:function(e){return!Object.keys(e).length},generateResourceId:function(t,i){return Array.isArray(t)&&!Array.isArray(i)?t.map(function(e){return e+"_"+i}).join(","):Array.isArray(t)&&Array.isArray(i)?t.map(function(e,t){return e+"_"+i[t]}).join(","):Array.isArray(t)||Array.isArray(i)?!Array.isArray(t)&&Array.isArray(i)?i.map(function(e){return t+"_"+e}).join(","):void 0:t+"_"+i},addNotification:function(e,t,i,n){var r=4<arguments.length&&void 0!==arguments[4]&&arguments[4];void 0===n&&(n=null);var s=new Date;h.push({title:e,text:t,action:function(){i(n),this.show=!r},when:new Date(s.getTime().valueOf()+60*s.getTimezoneOffset()*1e3),unread:!0,param:n,show:!0})},addDaysToDate:A,setDatesByStartAndMode:function(e){var t=new Date(e);switch(scheduler._mode){case"ZoomLevel2":case"ZoomLevel3":t=A(t,1);break;case"ZoomLevel4":t=A(t,2);break;case"ZoomLevel5":t=A(t,3);break;case"ZoomLevel6":t=A(t,7);break;case"ZoomLevel7":t=A(t,14);break;case"MonthlyView":t=A(t,30);break;case"MTDView":t=A(t,35);break;case"LongView":t=A(t,scheduler.matrix.LongView.x_size)}return{start:new Date(e),end:t}},sortByTime:function(e,t){return e.start>t.start?1:e.start.getTime()==t.start.getTime()?0:-1},getReports:function(){var i=e.defer();return n.getReports().then(function(e){if(e){for(var t=0;t<e.length;t++)u.push(e[t]);i.resolve(u)}else i.resolve(null)}).catch(function(e){return i.reject(e)}),i.promise},getPolygons:function(){var i=e.defer();if(M("Polygons_view"))return n.getPolygons().then(function(e){if(e){for(var t=0;t<e.length;t++)m.push(e[t]);i.resolve(m)}else i.resolve(null)}),i.promise;i.resolve(null)},intersectDates:function(e,t){var i={},n=[];e.start>=t.start&&e.start<t.finish?(i.start=e.start,e.finish<t.finish?i.finish=e.finish:(i.finish=t.finish,n.push({start:t.finish,finish:e.finish,isStart:!1}))):e.finish>t.start&&e.finish<=t.finish?(e.start>t.start?i.start=e.start:(i.start=t.start,n.push({start:e.start,finish:t.start,isStart:!0})),i.finish=e.finish):e.start<t.start&&e.finish>t.finish?(i=angular.copy(t),n.push({start:e.start,finish:t.start,isStart:!0}),n.push({start:t.finish,finish:e.finish,isStart:!1})):i=null;for(var r=[],s=0;s<n.length;s++){var a=n[s];a.start.getTime()!=a.finish.getTime()&&r.push(a)}return{intersection:i,remainderFrom1:r}},getCSSClassForContext:function(e,t){switch(e){case t.NONE:return"serviceList_new";case t.SCHEDULED:return"serviceList_assigned";case t.DISPATCHED:return"serviceList_dispatched";case t.IN_PROGRESS:return"serviceList_travel";case t.COMPLETED:return"serviceList_completed";case t.COULD_NOT_COMPLETE:return"serviceList_couldnt_complete";case t.CANCELED:return"serviceList_cancelled";default:return"serviceList_other"}},fieldsTypes:y,ganttSettings:g,butlerNotifications:function(){return h},getIdsOfSObjectsAbsence:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t},showServiceList:{show:!0},checkBoxFields:function(){return l},woPriorities:d,durationTypes:b,statusFlow:f,statusTranslations:S,statuses:_,convertDateBetweenTimeZones:function(e,t,i){return F(R(e,t).tz(i))},convertDtToMomentDt:R,convertMomentDtToDt:F,getUserOffset:function(e){return-moment.tz.zone(userTimeZone).offset(R(e,userTimeZone).valueOf())},getLocationOffset:function(e,t){if(!t)return null;var i=a.territories()[t],n=a.getOperatingHours()[i.operatingHours].timezone;return-moment.tz.zone(n).offset(R(e,n).valueOf())},setMapCloseButtonPosition:function(){r(function(){$(".gm-style-iw").next().css({right:"12px",left:"",opacity:1})},0)},getIdsOfSObjects:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].id);return t},hoursMinutes:function(e,t,i,n){if(e<60)return n.replaceAll([e]);var r=e%60,s=Math.round(e/60);return 0==r?i.replaceAll([s]):t.replace("$0",s).replace("$1",r)},hasCustomPermission:M,formatDateWithDayOfWeek:function(e){var t=new Date(e);t.setHours(12);try{return t.toLocaleDateString(userLocale.replace("_","-"),{weekday:"short",month:"long",day:"numeric",year:"numeric"})}catch(e){return null}},isLightning:function(){return"undefined"!=typeof sforce&&sforce&&!!sforce.one},getCustomActions:function(t){return T.filter(function(e){return e.section===t})},customActionsPromise:w.promise,removeFSLNamespace:function(e){return 0===e.indexOf("FSL__")?e.substr(5,e.length):e},crewsFilter:!1,generateDateKey:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},isUseEdge:function(e){return __gantt[e].useEdge},getColorHexByCategory:function(e){switch(e){case c.NONE:return"#a5e2d6";case c.SCHEDULED:return"#F9D058";case c.DISPATCHED:return"#8DD8FA";case c.IN_PROGRESS:return"#D68EF9";case c.COMPLETED:return"#95d155";case c.COULD_NOT_COMPLETE:return"#f58556";case c.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}},getRelevantDataForDraggingService:function(e){var t={};t.label=e.ganttLabel?e.ganttLabel:e.name,t.estimatedDurationText=e.estDuration+" "+e.durationType;var i=getMinAndMaxHoursToDisplay(),n=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),r=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60);e.durationType?e.durationType===b.minutes?r.setMinutes(r.getMinutes()+e.estDuration):e.durationType===b.hours?r.setMinutes(r.getMinutes()+Math.floor(60*e.estDuration)):e.durationType===b.days&&r.setMinutes(r.getMinutes()+Math.floor(60*e.estDuration*24)):e.setMinutes(r.getMinutes()+60);var s=getXPositionOfEvent({start_date:n,end_date:r},!1,scheduler.matrix[scheduler._mode]),a=getXPositionOfEvent({start_date:n,end_date:r},!0,scheduler.matrix[scheduler._mode]);return t.meetingLengthInPx=a-s+4,t},getSchedulingPolicyObject:function(e){for(var t=0;t<v.policies.length;t++)if(v.policies[t].Id===e)return v.policies[t]}}}e.$inject=["$q","$sce","sfdcService","$rootScope","$timeout","userSettingsManager","StateService","kpiCalculationsService","ResourcesAndTerritoriesService","$injector","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("utils",e)}(),angular.module("serviceExpert").factory("sfdcService",["$q","$rootScope","userSettingsManager",function(m,n,s){var h={servicesArray:[],servicesObjs:{},activeRequests:{active:0},activeRuleCheckRequests:{active:0},firstTimeGettingEmployees:function(){return e}},e=m.defer();h.getUnPrivilegeUserSettingsFields=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getUnPrivilegeUserSettingsFields,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.isStreamingShouldBeActive=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.isStreamingShouldBeActive,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getAllFormulaFields=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getAllFormulaFields,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getOptimizationsRequestTypes=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationsRequestTypes,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise};var i=null;h.getServiceListFields=function(){return null==i&&(i=m.defer(),h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceListFields,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),i.promise};var r=null;h.getGanttToolTipFields=function(){return null==r&&(r=m.defer(),h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceGanttTooltipFields,function(e,t){t.status?(h.activeRequests.active-=1,r.resolve(e)):(h.activeRequests.active-=1,r.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),r.promise};var a=null;h.getServiceMiniFormFields=function(){return null==a&&(a=m.defer(),h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMiniFormFields,function(e,t){t.status?(h.activeRequests.active-=1,a.resolve(e)):(h.activeRequests.active-=1,a.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),a.promise};var o=null;h.getServiceMapInfoWindowFields=function(){return null==o&&(o=m.defer(),h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMapInfoWindowFields,function(e,t){t.status?(h.activeRequests.active-=1,o.resolve(e)):(h.activeRequests.active-=1,o.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),o.promise};var c=null;function g(){var e=s.GetUserSettingsProperty("locations");return e||[]}function l(){return JSON.parse(s.GetUserSettingsProperty("Show_Orphan_Services__c"))}h.getServiceCapacityColumns=function(){return null==c&&(c=m.defer(),h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceCapacityColumns,function(e,t){t.status?(h.activeRequests.active-=1,c.resolve(e)):(h.activeRequests.active-=1,c.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),c.promise},h.getPolicies=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolicies,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.sortServicesByPriority=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.sortServicesByPriority,e,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.checkRules=function(e,t){var i=m.defer();return h.activeRuleCheckRequests.active+=1,n.policy||(n.policy=null),t=t||n.policy,Visualforce.remoting.Manager.invokeAction(RemoteActions.checkRules,e,t,function(e,t){t.status?(h.activeRuleCheckRequests.active-=1,i.resolve(e)):(h.activeRuleCheckRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getOptimiztionRequestsUpdate=function(e){var i=m.defer(),t=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimiztionRequestsUpdate,e,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getGanttServiceOnAssignedResourceUpdate=function(e){var i=m.defer(),t=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttServiceOnAssignedResourceUpdate,e,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getUpdatedAbsences=function(e){var i=m.defer(),t=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedAbsences,e,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getDeletedAbsences=function(e){var i=m.defer(),t=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDeletedAbsences,e,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getUpdatedServices=function(e,t){var i=m.defer(),n=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedServices,e,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getUpdatedResourceCapacities=function(e){var i=m.defer(),t=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedResourceCapacities,e,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getLivePositionsStreaming=function(e){var i=m.defer(),t=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getLivePositionsStreaming,e,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getDelta=function(e,t,i){var n=m.defer(),r=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDelta,e,r,t,i,function(e,t){t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},h.postToChatter=function(e,t){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.postToChatter,e,t,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getLivePositions=function(){var i=m.defer();h.activeRequests.active+=1;var e=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getLivePositions,e,function(e,t){t.status?i.resolve(e):i.reject(t),h.activeRequests.active-=1},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getSlots=function(e,t){var n=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSlots,e,t,function(e,t){var i={};i.value=e,i.eventType=t.type,"exception"==t.type&&(i.event=t,n.resolve(i),h.activeRequests.active-=1),t.status?n.resolve(i):n.reject(t),h.activeRequests.active-=1},{buffer:!0,escape:!1,timeout:12e4}),n.promise},h.getSkills=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSkills,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getPolygons=function(){var i=m.defer();h.activeRequests.active+=1;var e=g();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolygons,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.savePolygon=function(e,t,i,n,r){var s=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.savePolygon,e,t,i,n,r,function(e,t){t.status?(s.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,s.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),s.promise},h.deletePolygon=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deletePolygon,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getLocale=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocale,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.autoScheduleService=function(e,t){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.autoScheduleService,e,t,g(),function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getDictionaries=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getDictionaries,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.unscheduleServicesByServicesId=function(e,t){var i=m.defer();return h.activeRequests.active+=1,t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByServicesId,e,t,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.unscheduleServicesByLocationsId=function(e,t,i,n){var r=m.defer();return h.activeRequests.active+=1,t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByLocationsId,e,t,i,n,function(e,t){t.status?(r.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,r.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),r.promise},h.getLocationsCurrentTime=function(e,t,i){var n=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocationsCurrentTime,function(e,t){t.status?(n.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,n.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),n.promise},h.getEmployeeAbsenceTypes=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getEmployeeAbsenceTypes,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getWorkOrderPriority=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getWorkOrderPriority,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getReports=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportsWithGeolocationCols,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getReportRowsForMap=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportRowsForMap,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.runOptimization=function(e,t,i,n,r,s,a){var o=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runOptimization,e,t,i,n,r,s,a,function(e,t){t.status?(o.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,o.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),o.promise},h.runRDOptimization=function(e,t,i,n,r,s,a,o){var c=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runRDOptimization,e,t,i,n,r,s,a,o,function(e,t){t.status?(c.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,c.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),c.promise},h.getRequestObject=function(e){var i=m.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getRequestObject,e,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getCustomizationFiles=function(){var i=m.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getCustomizationFiles,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getOptimizationsRequest=function(){var i=m.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationsRequest,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getResourceFieldSetFields=function(){var i=m.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceFieldSetFields,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getStatusTranslations=function(){var i=m.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusTranslations,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getResourcePicklistValues=function(e){var i=m.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourcePicklistValues,e,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.GetResourcesAndTerritories=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.GetResourcesAndTerritories,e||g(),!0,function(e,t){t.status?i.resolve(e):i.reject(t),h.activeRequests.active-=1},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.GetTimePhasedObjects=function(e,t){var i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null,a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,o=7<arguments.length&&void 0!==arguments[7]&&arguments[7],c=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.GetTimePhasedObjects,e,t,g(),i,n,r,maxServicesToLoadEachBulkInGantt,maxAbsencesToLoadEachBulkInGantt,s,a,o,function(e,t){h.activeRequests.active-=1,t.status?c.resolve(e):c.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),c.promise},h.loadServiceAppointmentsToList=function(e,t,i,n){var r=m.defer(),s=l();return h.activeRequests.active+=1,i<0&&(i=100),Visualforce.remoting.Manager.invokeAction(RemoteActions.LoadServiceAppointmentsToServiceList,e,g(),s,t,i,n,function(e,t){t.status?(r.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,r.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),r.promise},h.loadServicesInBulk=function(e,t,i,n,r){var s=m.defer(),a=l();return Visualforce.remoting.Manager.invokeAction(RemoteActions.loadServicesInBulk,e,g(),a,t,i,n,r,function(e,t){t.status?s.resolve(e):s.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),s.promise},h.saveChangesToAbsence=function(e,t,i,n,r,s){var a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:null,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,l=9<arguments.length&&void 0!==arguments[9]?arguments[9]:null,d=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToAbsence,e,t,i,n,r,s,a,o,c,l,g(),function(e,t){t.status?d.resolve(e):d.reject(t),h.activeRequests.active-=1},{buffer:!0,escape:!1,timeout:12e4}),d.promise},h.serviceChangesQueue=[],h.resourceOperationsCounter={},h.saveChangesToServiceAppointment=function(e,i,n,t,r,s,a,o,c,l,d,u){h.resourceOperationsCounter[i]=h.resourceOperationsCounter[i]||0,n&&(h.resourceOperationsCounter[n]=h.resourceOperationsCounter[n]||0);var p=m.defer(),v=m.defer();return h.resourceOperationsCounter[i]?h.serviceChangesQueue.push({deferred:v,srcResource:n,destResource:i,valid:!0}):n&&!h.resourceOperationsCounter[n]?(h.resourceOperationsCounter[i]++,h.resourceOperationsCounter[n]++,v.resolve()):n||(h.resourceOperationsCounter[i]++,v.resolve()),v.promise.then(function(){h.activeRequests.active++,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToServiceAppointment,e,i,n,t,r,s,a,o,c,l,d,u,g(),function(e,t){h.activeRequests.active--,n&&h.resourceOperationsCounter[n]--,h.resourceOperationsCounter[i]--,h.serviceChangesQueue.forEach(function(e){!e.valid||h.resourceOperationsCounter[e.destResource]||(!e.srcResource||h.resourceOperationsCounter[e.srcResource])&&e.srcResource||(h.resourceOperationsCounter[e.srcResource]++,h.resourceOperationsCounter[e.destResource]++,e.valid=!1,e.deferred.resolve())}),t.status?p.resolve(e):p.reject(t)},{buffer:!0,escape:!1,timeout:12e4})}),p.promise},h.changeStatusServicesByServicesId=function(e,t){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByServicesId,e,t,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.changeStatusServicesByLocationsId=function(e,t,i,n){var r=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByLocationsId,e,t,i,n,function(e,t){t.status?(r.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,r.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),r.promise},h.deleteResourceAbsence=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteResourceAbsence,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getStatusFlow=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusFlow,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getStatuses=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatuses,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.changePin=function(e,t){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changePins,e,t,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.setServiceAppointmentsInJeopardy=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.setServiceAppointmentsInJeopardy,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getOptimizationRequests=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationRequests,g(),l(),function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.runFillInSchedule=function(e,t,i){var n=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFillInSchedule,e,t,i,function(e,t){t.status?(n.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},h.runFixOverlaps=function(e,t,i){var n=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFixOverlaps,e,t,i,function(e,t){t.status?(n.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},h.runGroupNearby=function(e,t){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runGroupNearby,e,t,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.runReshuffle=function(e,t){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runReshuffle,e,t,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getResourceActualRoute=function(e,t){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceActualRoute,e,t,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getFslOperation=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getFslOperation,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getServicesById=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServicesById,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getGanttFilters=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttFilters,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise};var d=null;return h.getGanttFilterFields=function(){return null==d&&(d=m.defer(),h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttFilterFields,function(e,t){t.status?(h.activeRequests.active-=1,d.resolve(e)):(h.activeRequests.active-=1,d.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),d.promise},h.getFilterById=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getFilterById,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.hideFilter=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.hideFilter,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.deleteFilter=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteFilter,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.userHasAdminPermissions=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.userHasAdminPermissions,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.getGanttPalettes=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttPalettes,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.getServiceFieldsMap=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceFieldsMap,function(e,t){t.status?(h.activeRequests.active-=1,i.resolve(e)):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.searchServiceByIdOrName=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.searchServiceByIdOrName,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},h.runCustomServiceAction=function(e,t,i,n){var r=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runCustomServiceAction,e,t,i,n,function(e,t){t.status?(r.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,r.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),r.promise},h.runCustomAbsenceAction=function(e,t,i,n,r){var s=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runCustomAbsenceAction,e,t,i,n,r,function(e,t){t.status?(s.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},h.runCustomResourceAction=function(e,t,i,n,r){var s=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runCustomResourceAction,e,t,i,n,r,function(e,t){t.status?(s.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},h.getCustomActions=function(){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getCustomActions,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.abortOptimizationRequest=function(e){var i=m.defer();return h.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.abortOptimizationRequest,e,function(e,t){t.status?(i.resolve(e),h.activeRequests.active-=1):(h.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},h.callRemoteAction=function(e){for(var t=arguments.length,i=Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];var r=m.defer(),s=[e].concat(i).concat(function(e,t){h.activeRequests.active--,t.status?r.resolve(e):r.reject(t)}).concat({buffer:!0,escape:!1,timeout:12e4}).map(function(e){return void 0===e?null:e});return h.activeRequests.active++,window.Visualforce.remoting.Manager.invokeAction.apply(window.Visualforce.remoting.Manager,s),r.promise},h}]),function(){function e(i,n,r,s,a,o){var c=null;function l(){o.setLightBoxStatus(!1),c.$destroy()}function d(e){e!==c.selectedTab&&(c.selectedTab=e)}return{open:function(e){(c=i.$new(!0)).lightboxAbsence=n.resourceAbsences()[e],c.selectedTab="details",c.urls={chatter:r.trustAsResourceUrl(customAbsenceChatterPage+"?id="+e).toString(),details:r.trustAsResourceUrl(customAbsencePage+"?id="+e).toString()},c.changeTab=d,c.closeLightbox=l,c.chatterAvailable=fieldTrackingEnabled.absence,c.openConsoleTab=a.openConsoleTab;var t=angular.element('<div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="AbsenceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="AbsenceLightboxHeader">\n\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                            <h1 class="lightboxHeader">\n                                <i ng-show="lightboxAbsence.type == \'na\'">'+customLabels.NA+":</i>\n                                <i ng-show=\"lightboxAbsence.type == 'break'\">"+customLabels.Break+":</i>\n                                {{ lightboxAbsence.name }}\n                            </h1>\n\n                            <span ng-click=\"changeTab('details')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'details'}\">\n                                "+customLabels.Details+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxAbsence.id)" target="_blank" href="../{{ lightboxAbsence.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'details\'" ng-src="{{ urls.details }}"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'chatter\'" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");t.find("#AbsenceLightbox").draggable({containment:"document",handle:"#AbsenceLightboxHeader"}),o.setLightBoxStatus(),c.$on("$destroy",function(){return t.remove()}),c.$on("keypress",function(e,t){27==t.which&&c.$evalAsync(c.closeLightbox)}),s(t)(c),a.safeApply(c,function(){angular.element("body").append(t)})}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("AbsenceLightboxService",e)}(),function(){function e(l,d,u,p,e,v){var i={};return{saveChangesToAbsence:function(t,e,i){var n=l.defer(),r=new Date(e.start_date.getTime()+1e3*e.travelTo),s=new Date(e.end_date.getTime()-1e3*e.travelFrom);if(useLocationTimezone){var a=d.getIntersectingSrstOffset(e,e.getGanttResource()),o=v.getUserOffset(r),c=v.getUserOffset(s);r.setMinutes(r.getMinutes()+o-a),s.setMinutes(s.getMinutes()+c-a)}return u.saveChangesToAbsence(e.id,e.getGanttResource(),i,r,s,e.absenceType,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){p.handleDeltaResponse(e),e.error?n.reject([e,t]):n.resolve()}).catch(function(e){n.reject([e,t])}),n.promise},saveNewAbsence:function(e,t){var i=l.defer();if(useLocationTimezone){var n=d.getIntersectingSrstOffset(e,e.resource),r=v.getUserOffset(e.start_date),s=v.getUserOffset(e.end_date);e.start_date.setMinutes(e.start_date.getMinutes()+r-n),e.end_date.setMinutes(e.end_date.getMinutes()+s-n)}return u.saveChangesToAbsence(null,e.resource,t,e.start_date,e.end_date,e.absenceType,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){p.handleDeltaResponse(e),e.error?i.reject(e):i.resolve()}).catch(function(e){i.reject(e)}),i.promise},deleteAbsence:function(e){var t=l.defer();return u.deleteResourceAbsence(e).then(function(e){e?p.getDelta():v.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.Failed_To_Delete_Break,null,null)}).catch(function(e){t.reject(e)}),t.promise},getEmployeeAbsenceTypes:function(){var t=l.defer();return u.getEmployeeAbsenceTypes().then(function(e){e&&(i=e,t.resolve(i))}).catch(function(e){t.reject(e)}),t.promise}}}e.$inject=["$q","TimePhasedDataService","sfdcService","DeltaService","servicesService","utils"],angular.module("serviceExpert").factory("AbsencesService",e)}(),function(){function e(i,n,r,s,a,o,c,l,d){for(var u=null,p=[],e=0;e<60;e++)p.push(e);function v(){"running"!==u.bulkState&&(o.setLightBoxStatus(!1),u.$destroy())}function m(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(u.endMinutes)),i.setHours(parseInt(u.endHour)),i<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=i,scheduler.destroyCalendar(),u.$apply()}})}function h(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(u.startMinutes)),i.setHours(parseInt(u.startHour)),i>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=i,scheduler.destroyCalendar(),u.$apply()}})}function g(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function f(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function S(e){c.flagged[e]=!c.flagged[e]}function _(e){return c.flagged[e]}function y(e){return l.serviceAppointments()[e].name}function b(){var i=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var n in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[n]&&i.push(n);if(0===i.length)return void alert(customLabels.noLocationWasSelected)}else i=s.getSelected();o.setBulkActionRunning(),u.bulkState="running",c.changeStatus(i,d.DISPATCHED,e,t,!0).then(function(e){if(e.nothingToDispatch)u.nothingToDispatch=!0;else{c.drawServicesAndAbsences(e.services),u.results.dispatched=[],i="locations"===u.targetServices?e.services.map(function(e){return e.id}):i;for(var t=0;t<i.length;t++)l.serviceAppointments()[i[t]].status===d.DISPATCHED&&u.results.dispatched.push(l.serviceAppointments()[i[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk dispatch failed :("),console.log(e)}).finally(function(){o.setBulkActionRunning(!1),u.bulkState="finished"})}return{open:function(){(u=n.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=a.GetUserSettingsProperty("locations");u.filteredLocations=e.map(function(e){return r.territories()[e]}),u.selectedCount=s.countSelectedServices(),u.contractorSupport=o.areContractorsSupported(),u.minutes=p,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=m,u.dateSelectStartWidget=h,u.validateDatesStart=g,u.validateDatesEnd=f,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkDispatch=b,u.results={},u.toggleFlag=S,u.isFlagged=_,u.getServiceName=y,u.selectedLocations={},u.nothingToDispatch=!1,u.isAmpm=isAMPM?"ampm":"24",u.selectedMashu=customLabels.x_selected;var t=function(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkDispatch+'</h1>\n                    </div>\n\n                    \n                    <div id="ori-ohev-banim" ng-show="bulkState == \'finished\'">\n                        <div ng-show="bulkState == \'finished\'">\n    \n                            <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n    \n                            <div ng-show="results.dispatched.length" class="lightboxResultContainer dispatchResultsContainer1">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyDispatched+'</div>\n    \n                                <div ng-repeat="dispatced in results.dispatched" class="lightboxTableRow">\n                                    {{ dispatced.name }}\n                                    <div ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(dispatced.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(dispatced.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToDispatch+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n    \n                        </div>\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.DispatchingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.DispatchLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ selectedMashu | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkDispatch()">'+customLabels.Dispatch+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}();t.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=v,u.$on("$destroy",function(){return t.remove()}),i(t)(u),t.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkDispatchService",e)}(),function(){function e(r,s,a,t,o){for(var c=null,l=null,e=[],i=0;i<60;i++)e.push(i);function d(e){c.flagged[e]=!c.flagged[e]}function u(e){return c.flagged[e]}function p(e){return t.serviceAppointments()[e].name}function v(){a.setLightBoxStatus(!1),l.$destroy()}return{open:function(e,t){c=o.get("servicesService"),(l=s.$new(!0)).getServiceName=p,l.results={success:[],failed:0<Object.keys(e.failedResults).length?e.failedResults:null},l.labels=t,l.toggleFlag=d,l.isFlagged=u;for(var i=0;i<e.services.length;i++)e.failedResults[e.services[i].Id]||l.results.success.push(e.services[i].Id);l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)});var n=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkActionResults+'</h1>\n                        </div>\n\n                        <div class="resultsContainerOverflow">\n                            <div ng-show="results.success && results.success.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">{{labels.success}}</div>\n    \n                                <div ng-repeat="id in results.success" class="lightboxTableRow">\n                                    {{ getServiceName(id) }}\n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed && results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">{{labels.fail}}</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkResultLine">{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+"</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n            ");n.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(n),l.closeLightbox=v,l.$on("$destroy",function(){return n.remove()}),r(n)(l),n.show(),a.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkResultsService",e)}(),function(){function e(r,s,a,t,o){var c=null;function l(e){return angular.isObject(e)}function d(e){return t.serviceAppointments()[e]}function u(e){c.flagged[e]=!c.flagged[e]}function p(e){return c.flagged[e]}function v(e){a.setLightBoxStatus(!1),e.$destroy()}return{open:function(e){var i=null;for(var t in c=o.get("servicesService"),(i=s.$new(!0)).isAdmin=!1,null==window.userHasAdminPermissions?sfdcService.userHasAdminPermissions().then(function(e){window.userHasAdminPermissions=!!e&&(i.isAdmin=!0)}):i.isAdmin=window.userHasAdminPermissions,i.toggleFlag=u,i.isFlagged=p,i.results=e,i.getService=d,i.isError=l,i.successfullyScheduled=0,i.globalSelectedCount=Object.keys(e).length,i.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},i.replaceLabelsForSebas=function(){return customLabels.x_services_scheduled_of_y_here_are_results.replaceAll(i.successfullyScheduled,i.globalSelectedCount)},e)"scheduled"===e[t].textResult&&i.successfullyScheduled++;i.$on("keypress",function(e,t){27==t.which&&i.$evalAsync(i.closeLightbox)}),i.closeLightbox=v,i.$on("$destroy",function(){return n.remove()});var n=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox(this)" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkScheduleResults+'</h1>\n                        </div>\n\n                        <div style="padding:0 15px">\n                        \n                            <p>{{ replaceLabelsForSebas() }}</p>\n            \n                            <div id="ResultTableHeader">\n                                <span>'+customLabels.ID+'</span>\n                                <span id="ResultHeaderStart">'+customLabels.Start+"</span>\n                                <span>"+customLabels.Finish+'</span>\n                                <span id="ResultResourceHeader">'+customLabels.Resource+'</span>\n                            </div>\n            \n                            <div id="ScheduledResultsTable">\n                                <div ng-repeat="(id,res) in results" class="ScheduleResultRow">\n                                \n                                    <span class="scheduledResultColName">{{ getService(id).name }}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).start | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).finish | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).resourceName}}</span>\n                                    <span class="ScheduleResultUnscheduled" ng-if="isError(res)">{{ res.msg }}</span>\n                                    \x3c!--<span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.NoCandidates+'</span>--\x3e\n                                    <span class="ScheduleResultUnscheduled" ng-if="res.textResult == \'no candidates\'">'+customLabels.NoCandidates+'</span>\n                                    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                    \n                                    <div class="PartialResultsBulk" ng-show="res.partialResults.length > 0" ng-init="res.showDetails = false;">\n                                        <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="res.showDetails = !res.showDetails">'+customLabels.ShowDetails+'</u></div>\n            \n                                        <div ng-show="res.showDetails">\n                                            <ul>\n                                                <li ng-repeat="partial in res.partialResults">\n                                                    {{ generatePartialResult(partial) }}\n                                                </li>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                    \n                                </div>\n                            </div>\n                            \n                        </div>\n                    </div>\n\n                </div>\n            ');n.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),r(n)(i),angular.element("body").append(n),n.show(),a.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkScheduleResultsService",e)}(),function(){function e(a,t,i,o,c,l,e,n){var d=null;function r(){(d=i.$new(!0)).isInConsole=l.isInConsole(),d.actionName="Schedule",d.currentSchedulingIndex=0,d.successfullyScheduled=0,d.afterSchedulingServiceObjects={},d.close=s,d.showResults=u,d.progressBarStyle=p,d.getLabel=function(e){return customLabels[e]};var e=angular.element('\n            <div id="SchedulingInProgress" class="slideInProgressBox" ng-class="{SchedulingInProgressConsole: isInConsole}">\n\n\t\t\t\t<div ng-show="currentSchedulingIndex != globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-spinner fa-spin"></i> '+customLabels.Scheduling_Services+'\n\t\t\t\t\t<div class="ProgressBar">\n\t\t\t\t\t\t<div ng-style="progressBarStyle()"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div ng-cloak class="ProgressBarLabel">{{ getLabel(\'Scheduling_service\') | replaceLabels : (currentSchedulingIndex+1) : globalSelectedCount }}</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div ng-show="currentSchedulingIndex == globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-check"></i> '+customLabels.Scheduling_Complete+'\n\t\t\t\t\t<div ng-cloak class="HowManyWereScheduled">{{  getLabel(\'Scheduled_x_out_of_y\') | replaceLabels : successfullyScheduled : globalSelectedCount }}</div>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="close()">'+customLabels.Close+'</span>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="showResults()">'+customLabels.View_services+"</span>\n\t\t\t\t</div>\n\n\t\t\t</div>");angular.element("body").append(e),d.$on("$destroy",function(){return e.remove()}),t(e)(d),e.show()}function s(){d.$destroy()}function u(){e.open(d.afterSchedulingServiceObjects),d.$destroy()}function p(){return{width:(d.currentSchedulingIndex+1)/d.globalSelectedCount*100+"%"}}return{schedule:function(e){0===e.length||l.isScheduleRunning||(d&&d.$destroy(),r(),l.isScheduleRunning=!0,d.globalSelectedCount=e.length,o.sortServicesByPriority(e).then(function(e){var n=[],r=[];e.forEach(function(e){r.push(c.serviceAppointments()[e.ServiceId])}),d.globalSelectedServiceObjects=r;for(var t=0;t<d.globalSelectedCount;t++){var i=a.defer();i.promise.then(s),n.push(i)}function s(i){l.schedulingRunningFor[r[i].id]=!0,o.autoScheduleService(r[i].id,!0).then(function(e){o.drawServicesAndAbsences(e.services,e.absences),d.afterSchedulingServiceObjects[r[i].id]={},d.afterSchedulingServiceObjects[r[i].id].partialResults=e.partialResults,d.afterSchedulingServiceObjects[r[i].id].textResult="no candidates",e.services.forEach(function(e){e.id===r[i].id&&(d.afterSchedulingServiceObjects[r[i].id].textResult="scheduled",d.successfullyScheduled++)})}).catch(function(e){var t={};t.msg=e.message,d.afterSchedulingServiceObjects[r[i].id]=t}).finally(function(){if(d.currentSchedulingIndex++,l.schedulingRunningFor[r[i].id]=!1,i+1<d.globalSelectedCount&&n[i+1].resolve(i+1),i+1===d.globalSelectedCount){var e=[];for(var t in scheduler._events)"service"===scheduler._events[t].type&&e.push(t);0<e.length&&o.checkRules(e).then(o.drawViolationsOnGantt),l.isScheduleRunning=!1}})}n[0].resolve(0)}))}}}e.$inject=["$q","$compile","$rootScope","servicesService","TimePhasedDataService","StateService","bulkScheduleResultsService","utils"],angular.module("serviceExpert").factory("bulkScheduleService",e)}(),function(){function e(i,n,r,s,a,o,c,l,d){for(var u=null,p=[],e=0;e<60;e++)p.push(e);function v(){"running"!==u.bulkState&&(o.setLightBoxStatus(!1),u.$destroy())}function m(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(u.endMinutes)),i.setHours(parseInt(u.endHour)),i<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=i,scheduler.destroyCalendar(),u.$apply()}})}function h(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(u.startMinutes)),i.setHours(parseInt(u.startHour)),i>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=i,scheduler.destroyCalendar(),u.$apply()}})}function g(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function f(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function S(e){c.flagged[e]=!c.flagged[e]}function _(e){return c.flagged[e]}function y(e){return l.serviceAppointments()[e].name}function b(){var i=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var n in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[n]&&i.push(n);if(0===i.length)return void alert(customLabels.noLocationWasSelected)}else i=s.getSelected();o.setBulkActionRunning(),u.bulkState="running",c.unscheduleServices(i,o.selectedPolicyId,e,t).then(function(e){if(e.nothingToUnschedule)u.nothingToUnschedule=!0;else{c.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),u.results.unscheduled=[],i="locations"===u.targetServices?e.services.map(function(e){return e.id}):i;for(var t=0;t<i.length;t++)l.serviceAppointments()[i[t]].isScheduled()||u.results.unscheduled.push(l.serviceAppointments()[i[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk unschedule failed :("),console.log(e),u.exception=e}).finally(function(){o.setBulkActionRunning(!1),u.bulkState="finished",d.calculateKpis()})}return{open:function(){(u=n.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=a.GetUserSettingsProperty("locations");u.filteredLocations=e.map(function(e){return r.territories()[e]}),u.selectedCount=s.countSelectedServices(),u.contractorSupport=o.areContractorsSupported(),u.minutes=p,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=m,u.dateSelectStartWidget=h,u.validateDatesStart=g,u.validateDatesEnd=f,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkUnschedule=b,u.results={},u.toggleFlag=S,u.isFlagged=_,u.getServiceName=y,u.selectedLocations={},u.nothingToUnschedule=!1,u.isAmpm=isAMPM?"ampm":"24",u.exception=null;var t=function(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="UnschduleLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkUnschedule+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n\n                        <div ng-show="nothingToUnschedule" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div class="resultsContainerOverflow class="unschedule_res_thingy_qa_halash">\n                        \n                            <div class="bulk-exception" ng-show="exception">\n                                <svg aria-hidden="true" class="slds-icon kpiIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n                                \u2028</svg>\n                                {{ exception.message }} \n                            </div>\n                        \n                            <div ng-show="results.unscheduled.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyUnscheduled+'</div>\n    \n                                <div ng-repeat="unscheduled in results.unscheduled track by $index" class="lightboxTableRow">\n                                    {{ unscheduled.name }}\n                                    <div ng-click="toggleFlag(unscheduled.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(unscheduled.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(unscheduled.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToUnschedule+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed track by $index" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.UnschedulingPleaseWait+'\n                    </div>\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.UnscheduleLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ getCustomLabel(\'x_selected\') | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+'</label>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    '+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkUnschedule()">'+customLabels.Unschedule+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}();t.find("#UnschduleLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=v,u.getCustomLabel=function(e){return customLabels[e]},u.$on("$destroy",function(){return t.remove()}),i(t)(u),t.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","kpiCalculationsService"],angular.module("serviceExpert").factory("bulkUnscheduleService",e)}(),angular.module("serviceExpert").factory("calendarsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils",function(D,d,e,I){var o={},S={},c={};function l(e,t,i,n,r){var s={P:[],R:[],S:[]},a={};for(var o in n){for(var c=n[o].slice(),l=I.generateResourceId(i,o),d=e,u=0;u<c.length;u++){var p=c[u],v=I.intersectDates({start:d,finish:t},p);if(s[p.type].push(p),"S"!=p.type){if(v.intersection){for(var m=0;m<v.remainderFrom1.length;m++){var h=v.remainderFrom1[m];h.isStart&&x(h.start,h.finish,l)}if("R"!=p.type||S[p.id]||r||y(p,n,i),d=v.intersection.finish,D.allTerritories[o]){var g=p.operatingHours||D.allTerritories[o].operatingHours;g?f(v.intersection.start,v.intersection.finish,g,l,r):x(v.intersection.start,v.intersection.finish,l)}}}else a[p.serviceTerritory]=p}d.getTime()==t.getTime()||a[l.split("_")[1]]||x(d,t,l)}!showSecondarySTMs||I.isEmpty(a)||r||function(e,t,i,n,r){for(var s in n){for(var a=n[s].slice(),o=I.generateResourceId(i,s),c=e,l=0;l<a.length;l++){var d=a[l],u=I.intersectDates({start:c,finish:t},d);if(u.intersection){for(var p=0;p<u.remainderFrom1.length;p++){var v=u.remainderFrom1[p];v.isStart&&x(v.start,v.finish,o)}c=u.intersection.finish;var m=void 0;try{m=d.operatingHours?d.operatingHours:D.allTerritories[d.ohTerr]?D.allTerritories[d.ohTerr].operatingHours:d.serviceTerritory__r?d.serviceTerritory__r.OperatingHoursId:void 0}catch(e){m=null}if(m){var h=void 0;D.getOperatingHours()[m]||(h=d.serviceTerritory__r.OperatingHours),f(u.intersection.start,u.intersection.finish,m,o,r,h)}else x(u.intersection.start,u.intersection.finish,o)}}c.getTime()!=t.getTime()&&x(c,t,o)}}(e,t,i,b(function(e,t){var i={};i[t]={};for(var n=0;n<e.P.length;n++){var r=e.P[n];if(0!=e.R.length)for(var s=0;s<e.R.length;s++){var a=e.R[s],o=I.intersectDates(r,a);if(o.intersection||(i[t][r.id]=r),0<o.remainderFrom1.length)for(var c=0;c<o.remainderFrom1.length;c++){var l=angular.copy(r);l.start=o.remainderFrom1[c].start,l.finish=o.remainderFrom1[c].finish,i[t][r.id+"_"+c]=l}if(!i[t][a.id]){var d=angular.copy(a);d.serviceTerritory=r.serviceTerritory,i[t][d.id]=d}}else i[t][r.id]=r}var u={};u[t]={};for(var p=0;p<e.S.length;p++){var v=e.S[p];for(var m in i[t]){var h=i[t][m],g=I.intersectDates(h,v);if(g.intersection){var f=angular.copy(h);f.start=g.intersection.start,f.finish=g.intersection.finish,window.isShowSecondaryOperatingHours&&v.operatingHours&&(f.operatingHours=v.operatingHours),f.ohTerr=f.serviceTerritory,f.serviceTerritory=v.serviceTerritory,u[t][m+"_"+p]=f}}}return u}(s,i))[i],!0)}function k(e,t){return I.convertDtToMomentDt(e,t)}function R(e){return I.convertMomentDtToDt(e)}function f(e,t,i,n,r){f(e,t,i,n,r,null)}function f(e,t,i,n,r,s){var a=D.getOperatingHours()[i]||s,o=a.timezone,c=useLocationTimezone?o:userTimeZone;if(r&&useLocationTimezone)for(var l=n.split(","),d=0;d<l.length;d++){var u=l[d].split("_")[1],p=D.territories()[u].operatingHours;c=D.getOperatingHours()[p].timezone}for(var v=k(e,c),m=k(t,c),h=(v.clone().tz(o),m.clone().tz(o),R(v)),g=R(m),f=h,S=[v.clone().add(-1,"days"),v.clone(),v.clone().add(1,"days")],_=0;_<S.length;_++)for(var y=S[_],b=a.slots[y.get("day")]||[],T=0;T<b.length;T++){var w=b[T],L=F(y,w,"startHour","startMinute",o,c,r);0==w.startHour&&24==w.endHour&&0!==w.endMinute&&(w.endHour=0);var C=F(y,w,"endHour","endMinute",o,c,r),A=I.intersectDates({start:L,finish:C},{start:h,finish:g}).intersection;A&&(L=A.start,C=A.finish,"Extended"==w.type?(x(f,L,n,null),x(L,C,n,w.type)):x(f,L,n,w.type),M(L,C,w.type,n),f=C)}x(f,g,n,null)}function F(e,t,i,n,r,s,a){var o=R(e);o.setHours(t[i]),o.setMinutes(t[n]);var c=useLocationTimezone?r:userTimeZone;return a&&useLocationTimezone&&(c=s),R(k(o,r).tz(c))}function M(e,t,i,n){var r=(t.getTime()-e.getTime())/6e4,s=c[n];s||(s={},c[n]=s);var a=I.formatDayToString(e),o=s[a];o||(o={regular:0,overtime:0},s[a]=o),"Extended"==i?o.overtime+=r:o.regular+=r}function y(e,t,i){var n=[];if(showSecondarySTMs)for(var r in t)for(var s=0;s<t[r].length;s++)"S"!=t[r][s].type&&-1==n.indexOf(r)&&n.push(r);else n=Object.keys(t);n.splice(n.indexOf(e.serviceTerritory),1);var a=e.serviceTerritory;if(D.territories()[a])var o=D.territories()[a].operatingHours,c=D.getOperatingHours()[o].timezone;for(var l=0;l<n.length;l++){var d=[I.generateResourceId(i,n[l])];S[e.id]=!0;var u=e.start,p=e.finish;if(useLocationTimezone&&D.territories()[n[l]]){var v=D.territories()[n[l]].operatingHours,m=D.getOperatingHours()[v].timezone;u=R(k(u,c).tz(m)),p=R(k(p,c).tz(m))}var h=D.territories()[e.serviceTerritory]?D.territories()[e.serviceTerritory].name:null,g=null,f=null;f=h?(g=customLabels.Relocated_to.replace("$0",_.escape(h)),_.escape(customLabels.Relocated_to_many_params.replaceAll(h||customLabels.Relocated_No_Permissions,moment(u).format("llll"),moment(p).format("llll")))):(g=customLabels.Relocated_No_Permissions,_.escape(customLabels.Relocated_to_no_permissions_many_params.replaceAll(moment(u).format("llll"),moment(p).format("llll")))),scheduler.addMarkedTimespan({start_date:u,end_date:p,sections:{ZoomLevel2:d,ZoomLevel3:d,ZoomLevel4:d,ZoomLevel5:d,ZoomLevel6:d,ZoomLevel7:d},html:"<div class='relocatedLabel' title='"+f+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg> "+g+"</div>",css:"relocation"}),scheduler.addMarkedTimespan({start_date:u,end_date:p,sections:{MonthlyView:d,MTDView:d,LongView:d},html:"<div class='relocatedLabel' title='"+f+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg></div>",css:"relocation_monthly"})}}function x(e,t,i,n){if(e.getTime()!=t.getTime()){var r={};for(var s in scheduler.matrix)"MonthlyView"!==s&&"LongView"!==s&&(r[s]=-1<i.indexOf(",")?i.split(","):[i]);var a="gray_section";"Extended"===n&&(a="overtime_section"),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:r,css:a})}}function b(e){var t={},i=e||d.resourcesByPrimariesAndRelocations();for(var n in i){var r=i[n],s={};for(var a in t[n]=s,r){var o=r[a],c=s[o.serviceTerritory];c||(c=[],s[o.serviceTerritory]=c),c.push({start:o.effectiveStartDate||o.start,finish:o.effectiveEndDate||o.finish,serviceTerritory:o.serviceTerritory,operatingHours:o.operatingHours,type:o.serviceTerritoryType||o.type,id:o.id,ohTerr:o.ohTerr||null,serviceTerritory__r:o.serviceTerritory__r||null})}for(var l in s)s[l].sort(I.sortByTime)}return t}e.$on("gotNewTimePhasedObjects",function(e,t){!function(e,t){for(var i=new Date(e),n=null;i<t;){var r=I.formatDayToString(i);if(!o[r]){o[r]=!0,n=n||b(d.resourcesAndTerritories());var s=new Date(i);for(var a in s.setDate(s.getDate()+1),D.getResources())l(new Date(i),new Date(s),a,n[a])}i.setDate(i.getDate()+1)}}(t.start,t.finish,t.resourceToServiceCrewMembers)});var t={resourceToWorkingDates:c,relocationsOnGantt:S,reset:function(){o={},S={},c={},t.resourceToWorkingDates=c}};return t}]),function(){function e(i,r,s,e,n,a,o,t,c,l,d){var u=null;function p(){o.setLightBoxStatus(!1),u.$destroy()}function v(e){u.capacityKpi={hoursCapacity:0,hoursInUse:0,completed:0,jeopardy:0,workItemsCapacity:0,workItemsAllocated:0},u.dummyServicesCount=0;var t=scheduler.getEvent(e),i=scheduler.getEvents(t.start_date,t.end_date);u.servicesScheduledToCapacity={},u.capacityKpi.hoursCapacity=t.hoursPerTimePeriod?t.hoursPerTimePeriod:0,u.capacityKpi.hoursInUse=t.hoursInUse?t.hoursInUse:0,u.capacityKpi.completed=0,u.capacityKpi.jeopardy=0,u.capacityKpi.violations=0,u.capacityKpi.workItemsCapacity=t.workItemsPerTimePeriod?t.workItemsPerTimePeriod:0,u.capacityKpi.workItemsAllocated=t.workItemsAllocated?t.workItemsAllocated:0;for(var n=u.capacityKpi.total=0;n<i.length;n++)i[n].resourceId===t.resourceId&&"service"===i[n].type&&(i[n].isDummy?u.dummyServicesCount++:("LongView"!==scheduler._mode||scheduler.filter_LongView(i[n].id,i[n],!1))&&i[n].start.getTime()>=t.start_date.getTime()&&i[n].start.getTime()<=t.end_date.getTime()&&(u.capacityKpi.total++,i[n].statusCategory===c.COMPLETED&&u.capacityKpi.completed++,i[n].jeopardy&&u.capacityKpi.jeopardy++,i[n].violations&&u.capacityKpi.violations++,u.servicesScheduledToCapacity[i[n].id]=i[n]))}function m(){return customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(u.kpiStart).format("llll"),moment(u.kpiEnd).format("llll"))}function h(e){return 0<Object.keys(e).length?Object.keys(e):0}function g(e){r.flagged[e]?r.flagged[e]&&(r.flagged[e]=!r.flagged[e]):r.flagged[e]=!0}function f(e,t){""===t&&(t=prompt(customLabels.msg_to_post_to_chatter,"")),""!==t?(r.recentlyUsed[e]=!0,r.postToChatter([e],t).then(function(e){})):alert(customLabels.no_empty_msg_to_chatter)}function S(t){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var i=[],n=[];t.forEach(function(e){u.invokedActionFor[e]=!0,n.push(s.serviceAppointments()[e]),i.push(s.serviceAppointments()[e].resource),r.recentlyUsed[e]=!0}),r.unscheduleServices(t).then(function(e){r.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),v(u.lightboxCapacity.id),u.invokedActionFor[t[0]]=!1}).catch(function(e){a.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),u.invokedActionFor[t[0]]=!1})}function _(e){if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+" - "+e.violations[i].ViolationString+"\n";return t=t&&t.substring(0,t.length-1)}}return{open:function(e){(u=i.$new(!0)).lightboxCapacity=s.resourceCapacities()[e],u.fieldsTypes=a.fieldsTypes,u.selectedTab="details",u.kpiStart=u.lightboxCapacity.start_date,u.kpiEnd=u.lightboxCapacity.end_date,u.servicesScheduledToCapacity={},u.tableSort={orderByField:"",reverse:!1},u.flaggedServices=r.flagged,u.invokedActionFor={},u.SERVICE_CATEGORY=c,u.currentMenu=null,u.dummyServicesCount=0,u.closeLightbox=p,u.openConsoleTab=a.openConsoleTab,u.formatKpitText=m,u.getObjectKeys=h,u.flagService=g,u.unscheduleServices=S,u.postToChatter=f,u.getStatusClass=a.getCSSClassForContext,u.violationsTooltip=_,u.calculateKpisForCapacity=v,u.showLongTermWarning=function(){return"LongView"===scheduler._mode},d.fieldsSetFields().then(function(e){u.servicesListFields=e.CapacityServiceColumns,u.tableSort.orderByField=u.servicesListFields[0].FullAPIName}),u.order=function(e,t){u.tableSort.orderByField=e,u.tableSort.reverse=t},u.getRefFieldID=function(e,t){return e[t.FullAPIName.replace("__r","__c")]},u.setCurrentMenu=function(e){u.currentMenu===e?u.currentMenu=null:u.currentMenu=e},u.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}},v(e);var t=angular.element('<div class="LightboxBlackContainer">\n\t\t\t\t<div class="LightboxContainer" id="ContractorCapacityLightbox">\n\n\t\t\t\t\t<div class="lightboxHeaderContainer" id="ContractorCapacityLightboxHeader">\n\n\t\t\t\t\t\t<svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n\t\t\t\t\t\t</svg>\n\n\t\t\t\t\t\t<h1 class="lightboxHeader">\n\t\t\t\t\t\t\t<i>'+customLabels.Capacity+':</i>\n\t\t\t\t\t\t\t{{ lightboxCapacity.name }}\n\t\t\t\t\t\t</h1>\n\n\t\t\t\t\t\t<span class="lightboxSelectedTab">\n\t\t\t\t\t\t\t'+customLabels.Details+'\n\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t<div class="ExtendedForm">\n\t\t\t\t\t\t\t<a ng-click="openConsoleTab($event,lightboxCapacity.id)" target="_blank" href="../{{ lightboxCapacity.id }}" title="'+customLabels.ExtandedForm+'">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon openExternalIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.external+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div id="KPIforCapacity" class="KPIforCapacity">\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.hoursCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.hoursInUse }}/{{ capacityKpi.hoursCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Hours_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.workItemsCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.standard_objects+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.workItemsAllocated }}/{{ capacityKpi.workItemsCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Services_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t\x3c!--<i class="fa fa-warning"></i>--\x3e\n\t\t\t\t\t\t\t\t{{ capacityKpi.violations }}</div>\n\t\t\t\t\t\t\t'+customLabels.Violations+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.jeopardy+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.jeopardy }}</div>\n\t\t\t\t\t\t\t'+customLabels.In_Jeopardy+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\n\t\t\t\t\t\t\t\t{{ capacityKpi.completed }}/{{ capacityKpi.total }}</div>\n\t\t\t\t\t\t\t'+customLabels.Completed+'\n\t\t\t\t\t\t</div>\n\n                        <div class="KpiRange">{{formatKpitText()}}</div>\n\t\t\t\t\t\t<div class="KpiRange updateKpiData" ng-if="dummyServicesCount > 0" ng-click="calculateKpisForCapacity(lightboxCapacity.id)">\n                            New KPI data is available - click to update\n                        </div>\n\t\t\t\t\t</div>\n                    <div id="ContractorCapacityButtons">\n                    \n                            <span id="LongViewWarning" ng-if="showLongTermWarning()">'+customLabels.LongTermCapacityLBWarning+'</span>\n                    \n                            <span class="capacityServiceUnscheduleAll" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0" ng-click="unscheduleServices(getObjectKeys(servicesScheduledToCapacity))">\n                                <i class="fa fa-ban"></i>\n                                 '+customLabels.Unschedule_All+'\n                            </span>\n                        </div>\n\t\t\t\t\t<div id="ContractorCapacityLightboxContent">\n\t\t\t\t\t\n                            <div class="NoServicesFound" ng-show="!getObjectKeys(servicesScheduledToCapacity)">\n                                <i class="fa fa-times"></i>\n                                <div>'+customLabels.No_services+'</div>\n                            </div>\n                        \n                        <table id="CapacityServicesTable" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0">\n                          <thead>\n                            <tr class="table-header">\n                                <th></th>\n                                <th></th>\n                                <th></th>\n                                <th ng-attr-title="{{field.Label}}" ng-repeat="field in servicesListFields" ng-class="{sortCapacityServicesBy: tableSort.orderByField == field.FullAPIName}" class="truncate capacityServiceColName" ng-click="tableSort.reverse=!tableSort.reverse;order(field.FullAPIName, tableSort.reverse)">\n                                    <span class="">{{field.Label}}</span>\n                                    <span ng-show="tableSort.orderByField == field.FullAPIName">\n                                        <span>\n                                            <svg ng-show ="!tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </span>\n                                    </span>\n                                </th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="(key, capacityService) in servicesScheduledToCapacity | orderObjectBy:tableSort.orderByField:tableSort.reverse" class="capacityServiceRow">\n                                <td ng-style="getStyleForServiceInList(capacityService)" class="TaskStatusColor {{ getStatusClass(capacityService.statusCategory, SERVICE_CATEGORY) }}" ></td>\n                                <td class="moreOptions">\n                                    <div class="serviceCapacityActionsButton" title="Actions" ng-click="setCurrentMenu($index)">\n                                          <svg class="slds-icon carretDownIcon" aria-hidden="true" ng-show="!invokedActionFor[capacityService.id]">\n                                                <use xlink:href="'+lsdIcons.down+'"></use>\n                                          </svg>\n                                          <img class="capacityServiceLoading"\n                                             src="'+lsdIcons.spinnerGif+'"\n                                             ng-show="invokedActionFor[capacityService.id]"/>\n                                    </div>   \n                                    <div id="actions-menu-{{$index}}" class="serviceCapacityActions" ng-show="currentMenu == $index">\n                                        <a class="saSingleAction" ng-click="openConsoleTab($event,capacityService.id); setCurrentMenu($index);" target="_blank" href="../{{ capacityService.id }}">'+customLabels.Details+'</a>\n                                        <div class="saSingleAction" ng-click="flagService(capacityService.id); setCurrentMenu($index);">\n                                            <span ng-show="!flaggedServices[capacityService.id]">'+customLabels.Flag+'</span>\n                                            <span ng-show="flaggedServices[capacityService.id]">'+customLabels.Unflag+'</span>\n                                        </div>\n                                        <div class="saSingleAction" ng-click="unscheduleServices([capacityService.id]); setCurrentMenu($index);">'+customLabels.Unschedule+'</div>\n                                        <div class="saSingleAction" ng-click="postToChatter(capacityService.id, \'\'); setCurrentMenu($index);">'+customLabels.Chatter+'</div>\n                                    </div>\n                                </td>\n                                <td class="iconOnServiceRow"\n                                        title="{{ violationsTooltip(capacityService) }}"\n                                        ng-class="{\'serviceList_jeopardy\': capacityService.jeopardy, \'serviceList_violations\': !capacityService.jeopardy && capacityService.violations}">\n                                        <i class="fa fa-bell" ng-if="capacityService.jeopardy"></i>\n                                        <i class="fa fa-warning" ng-if="capacityService.violations && !capacityService.jeopardy"></i>\n                                </td>\n                                <td ng-attr-title="{{capacityService | displayFieldSetField : field}}" ng-repeat="field in servicesListFields" class="truncate">\n                                    <span ng-show="field.Type != fieldsTypes.Reference" title="{{capacityService | displayFieldSetField : field}}">{{capacityService | displayFieldSetField : field}}</span>\n                                    <a ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(capacityService, field))" target="_blank" href="../{{ getRefFieldID(capacityService, field) }}" title="{{capacityService | displayFieldSetField : field}}">\n                                        {{capacityService | displayFieldSetField : field}}\n                                    </a>\n\n                                </td>\n                            </tr>\n                          </tbody>\n                        </table>\n\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>');t.find("#ContractorCapacityLightbox").draggable({containment:"document",handle:"#ContractorCapacityLightboxHeader"}),angular.element("body").append(t),o.setLightBoxStatus(),u.$on("$destroy",function(){return t.remove()}),u.$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),n(t)(u),a.safeApply(u)}}}e.$inject=["$rootScope","servicesService","TimePhasedDataService","$sce","$compile","utils","StateService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","FieldSetFieldsService"],angular.module("serviceExpert").factory("CapacityLightboxService",e)}(),function(){function e(t,e,c,l,d,u,i,r){var p=null,s=deltaInterval||10,v={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]};function a(t){p=t.updateTime;var i=[];if(t.deletedAbsence&&0<t.deletedAbsence.length||t.updatedAbsence&&0<t.updatedAbsence.length){var n={};if(0<t.updatedAbsence.length){var e=c.updateTimePhaseData(t.updatedAbsence,"na");n.updated=e.absences,n.deleted=e.notApprovedAbsencesIds;var r=n.updated.map(function(e){return e.resource}).join(",");i.push.apply(i,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(n.updated),r)))}0<t.deletedAbsence.length&&(n.deleted?n.deleted=n.deleted.concat(c.deleteTimePhaseData(t.deletedAbsence,"na").absences):n.deleted=c.deleteTimePhaseData(t.deletedAbsence,"na").absences,i.push.apply(i,_toConsumableArray(u.getRelatedServices(n.deleted)))),(n.updated||n.deleted)&&v.absences.forEach(function(e){return e(n)})}if(t.updatedGanttServices&&0<t.updatedGanttServices.length||t.deletedGanttServices&&0<t.deletedGanttServices.length){var s={};0<t.deletedGanttServices.length&&(s.deleted=c.deleteTimePhaseData(t.deletedGanttServices,"service").services,i.push.apply(i,_toConsumableArray(u.getRelatedServices(s.deleted)))),0<t.updatedGanttServices.length&&(s.updated=c.updateTimePhaseData(t.updatedGanttServices,"service").services,i.push.apply(i,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(s.updated))))),(s.updated||s.deleted)&&v.services.forEach(function(e){return e(s)})}if(t.updatedLivePositions){var a=l.updatePositions(t.updatedLivePositions);a.isUpdated&&v.positions.forEach(function(e){return e(a.dic)})}if(0<i.length&&v.rules.forEach(function(e){return e(i)}),d.areContractorsSupported&&(t.deletedCapacities&&0<t.deletedCapacities.length||t.updatedCapacities&&0<t.updatedCapacities.length)){var o={};0<t.deletedCapacities.length&&(o.deleted=c.deleteTimePhaseData(t.deletedCapacities,"capacity").capacities),0<t.updatedCapacities.length&&(o.updated=c.updateTimePhaseData(t.updatedCapacities,"capacity").capacities),(o.updated||o.deleted)&&v.capacities.forEach(function(e){return e(o)})}d.isOptimizationEnabled&&t.optimizationRequests&&0<t.optimizationRequests.length&&v.optimizationRequests.forEach(function(e){return e(t.optimizationRequests)})}return r(function i(){var n=new Date;if(!1===d.getStreamingActiveState()){var e=d.getDeltaDates();t.getDelta(p,e.minDate,e.maxDate).then(function(e){var t=1e3*s-function(e){return new Date-e}(n);r(i,t<0?0:t),a(e)}).catch(function(e){console.warn(e)})}},1e3*s),{register:function(e,t){return v[e]&&v[e].push(t)},unRegister:function(e,t){v[e].splice(v[e].indexOf(t),1)},getDelta:function(){if(!1===d.getStreamingActiveState()){var e=d.getDeltaDates();t.getDelta(p,e.minDate,e.maxDate).then(a).catch(function(e){console.warn(e)})}},updateOptimizationRequest:function(t){v.optimizationRequests.forEach(function(e){return e([t])})},handleDeltaResponse:a}}e.$inject=["sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","MstResolver","$timeout"],angular.module("serviceExpert").factory("DeltaService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(e,t){var s=e.defer(),a={};return e.all([t.getServiceListFields(),t.getServiceMiniFormFields(),t.getServiceMapInfoWindowFields(),t.getGanttToolTipFields(),t.getServiceCapacityColumns(),t.getGanttFilterFields()]).then(function(e){if(a={ListColumns:e[0],ListExpanded:e[1],MapInfo:e[2],GanttToolTip:e[3],CapacityServiceColumns:e[4],ganttFilter:e[5]},"object"!==_typeof(GanttService.prototype.allFieldSets)){GanttService.prototype.allFieldSets=a;var t={};for(var i in GanttService.prototype.allFieldSets)for(var n=GanttService.prototype.allFieldSets[i],r=0;r<n.length;r++)t[n[r].APIName]=n[r];GanttService.prototype.allFieldSetsSet=t}s.resolve(a)}).catch(function(e){s.reject(),console.warn("FieldSetFieldsService: unable to get service appointment field sets")}),{fieldsSetFields:function(){return s.promise}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("FieldSetFieldsService",e)}(),function(){function e(t,i,n,e){var a=t.defer(),o=[],r={};if(useNewFilters){var s=i.getGanttFilters(),c=e.fieldsSetFields();t.all([s,c]).then(function(e){var t=e[1],i=e[0],n={FSL__RULE_VIOLATIONS__FSL:!0};for(var r in t)t[r].forEach(function(e){n[e.FullAPIName]=!0,n[e.APIName]=!0});var s=[];i.forEach(function(e){var t=d(e);!function(e,t){if(!e.Criterias)return!0;for(var i in e.Criterias){if(-1<e.Criterias[i].property.indexOf("."))return console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")"),!1;if(!t[e.Criterias[i].property])return console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")"),!1}return!0}(t,n)||s.push(t)}),o=s,a.resolve(s)})}function l(e){for(var t=e,i=1;i<=10;i++)if(1===i&&-1<e.indexOf("1")){var n=t.indexOf(1),r=t.indexOf(10);-1!==n&&n===r&&(n=t.lastIndexOf(1)),t=t.substr(0,n)+"{1} "+t.substr(n+2)}else-1!==t.indexOf(i)&&(t=t.replace(i,"{"+i+"}"));return t}function d(t){var e=!1,i=!1;try{t[fieldNames.GanttFilter.Criterias]&&(e=JSON.parse(t[fieldNames.GanttFilter.Criterias]))}catch(e){i=!0,n.addNotification(window.customLabels.CustomFilterInvalidCriteriaButlerMsg,window.customLabels.CustomFilterInvalidCriteriaButlerBody.replace("$0",t[fieldNames.GanttFilter.Name]),null,null)}return{Id:t.Id,Name:t[fieldNames.GanttFilter.Name],Description:t[fieldNames.GanttFilter.Description],Days_after_horizon:t[fieldNames.GanttFilter.Days_after_horizon],Days_before_horizon:t[fieldNames.GanttFilter.Days_before_horizon],Criterias:e,List_only_appointments_on_the_gantt:t[fieldNames.GanttFilter.List_only_appointments_on_the_gantt],Logic:function(e,t){if(e)return l(e);for(var i in e="",t)e+=i+" AND ";return l(e.substr(0,e.length-5))}(t[fieldNames.GanttFilter.Logic],e),Public:t[fieldNames.GanttFilter.Public],Hidden:t[fieldNames.GanttFilter.Hidden],CreatedById:t.CreatedById,Displayed_Fields:t[fieldNames.GanttFilter.Displayed_Fields]?JSON.parse(t[fieldNames.GanttFilter.Displayed_Fields]):null,disabled:i}}return{filtersPromise:a.promise,getFilterById:function(t){var i=null;return o.forEach(function(e){i=e.Id===t?e:i}),i},getFilterFromSalesforce:function(e){var r=t.defer();return i.getFilterById(e).then(function(e){for(var t=d(e),i=!0,n=0;n<o.length;n++)if(o[n].Id===t.Id){o[n]=t,i=!1;break}i&&o.push(t),r.resolve(t)}),r.promise},deleteFilter:function(n){var r=t.defer();return i.deleteFilter(n).then(function(e){for(var t=-1,i=0;i<o.length;i++)if(o[i].Id===n){t=i;break}-1!==t&&o.splice(t,1),r.resolve(n)}),r.promise},hideFilter:function(n){var r=t.defer();return i.hideFilter(n).then(function(e){for(var t=-1,i=0;i<o.length;i++)if(o[i].Id===n){t=i;break}-1!==t&&o.splice(t,1),r.resolve(n)}),r.promise},setFilterMap:function(e){r=Object.assign(e,{})},getFilterMap:function(){return r}}}e.$inject=["$q","sfdcService","utils","FieldSetFieldsService"],angular.module("serviceExpert").factory("GanttFilterService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}!function(){function e(s,e,v,r,p,m){var a=void 0,h=void 0,g=void 0;function o(e,t){for(var i in e)t(e[i])}function c(e){e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===h.Id||(!0===e.fields[h.ServicePropertyNoNamespace]?e.ganttPaletteColor={color:h.ColorScheme.max.color,palleteId:h.Id}:e.ganttPaletteColor={color:h.ColorScheme.min.color,palleteId:h.Id})}function l(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t,i=e.fields[h.ServicePropertyNoNamespace];t=void 0===i?h.ColorScheme.empty:h.ColorScheme.picklist[h.ServiceProperty][i],e.ganttPaletteColor={color:t,palleteId:h.Id}}}function d(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace];if(useLocationTimezone){var i=void 0;if(e.resourceId){var n=m.getRelevantSTMToGanttService(e);n&&n.operatingHours?i=n.operatingHours:n.serviceTerritory&&(i=p.territories()[n.serviceTerritory].operatingHours)}else e.ServiceTerritoryId&&(i=p.territories()[e.ServiceTerritoryId].operatingHours);var r=p.getOperatingHours()[i],s=r?r.timezone:userTimeZone;t=function(e,t,i){return v.convertDateBetweenTimeZones(e,t,i)}(new Date(t),s,userTimeZone).getTime()}var a=void 0,o=void 0,c=void 0,l=void 0,d=void 0;if(void 0===t)a=h.ColorScheme.empty;else{for(var u in g){if(g[u].start<t&&t<=g[u].end){a=u;break}(void 0===o||g[u].start<=o)&&(o=g[u].start,l=u),(void 0===c||g[u].end>c)&&(c=g[u].end,d=u)}void 0===a&&(a=c<t?d:l)}e.ganttPaletteColor={color:a,palleteId:h.Id}}}function u(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],i=void 0,n=void 0,r=void 0,s=void 0,a=void 0;if(void 0===t)i=h.ColorScheme.empty;else{for(var o in g){if(g[o].start<t&&t<=g[o].end){i=o;break}(void 0===n||g[o].start<=n)&&(n=g[o].start,s=o),(void 0===r||g[o].end>r)&&(r=g[o].end,a=o)}void 0===i&&(i=r<t?a:s)}e.ganttPaletteColor={color:i,palleteId:h.Id}}}function f(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],i=void 0,n=void 0,r=void 0,s=void 0,a=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)i=h.ColorScheme.empty;else{var o=y(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,t.latitude,t.longitude);for(var c in g){if(g[c].start<o&&o<=g[c].end){i=c;break}(void 0===n||g[c].start<=n)&&(n=g[c].start,s=c),(void 0===r||g[c].end>r)&&(r=g[c].end,a=c)}void 0===i&&(i=r<o?a:s)}e.ganttPaletteColor={color:i,palleteId:h.Id}}}function S(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){e.fields[h.ServicePropertyNoNamespace];var t=void 0,i=void 0,n=void 0,r=void 0,s=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)t=h.ColorScheme.empty;else{var a=y(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,e.latitude,e.longitude);for(var o in g){if(g[o].start<a&&a<=g[o].end){t=o;break}(void 0===i||g[o].start<=i)&&(i=g[o].start,r=o),(void 0===n||g[o].end>n)&&(n=g[o].end,s=o)}void 0===t&&(t=n<a?s:r)}e.ganttPaletteColor={color:t,palleteId:h.Id}}}function _(e,t){var i;switch(e){case"Seconds":i=1e3*t;break;case"Minutes":i=60*t*1e3;break;case"Hours":i=60*t*60*1e3;break;case"Days":i=24*t*60*60*1e3}return i}function y(e,t,i,n){var r=Math.PI*e/180,s=Math.PI*i/180,a=t-n,o=Math.PI*a/180,c=Math.sin(r)*Math.sin(s)+Math.cos(r)*Math.cos(s)*Math.cos(o);return c=60*(c=180*(c=Math.acos(c))/Math.PI)*1.1515,"km"===distanceUnit?1.609344*c:.8684*c}return{serviceFieldsMap:function(){var i=s.defer();return void 0!==a?setTimeout(function(){i.resolve(a)},0):e.getServiceFieldsMap().then(function(e){for(var t in a={},e)a[t]=JSON.parse(e[t].replace(/&quot;/g,'"'));i.resolve(a)}).catch(function(e){i.reject(e)}),i.promise},applyNewPaletteForGantt:function(e,t){var i=s.defer();if(void 0===h||h.Id!==e.Id){r.SetUserSettingsProperty("Gantt_Palette__c",e.Id);var n=a[(h=e).ServiceProperty];switch(function(e){var t,i,n=!1;g={},FieldTypes.DATETIME!==e&&FieldTypes.DATE!==e||(i=function(e,t,i,n,r){for(var s=v.convertMomentDtToDt(moment().tz(userTimeZone)),a=_(i,e),o=_(n,t),c=s.getTime()+a,l=(s.getTime()+o-c)/r,d=[],u=0;u<r;u++){var p={start:c+u*l,end:c+(u+1)*l};d.push(p)}return d}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorScheme.min.type,h.ColorScheme.max.type,h.ColorLevel),n=!0);FieldTypes.DOUBLE!==e&&FieldTypes.LOCATION!==e&&FieldTypes.ADDRESS!==e||(i=function(e,t,i){e=parseFloat(e);for(var n=((t=parseFloat(t))-e)/i,r=[],s=0;s<i;s++){var a={start:e+s*n,end:e+(s+1)*n};r.push(a)}return r}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),n=!0);FieldTypes.INTEGER!==e&&FieldTypes.PERCENT!==e||(i=function(e,t,i){e=parseInt(e);var n=((t=parseInt(t))-e)/i;n=Math.round(n);for(var r=[],s=0;s<i;s++){var a={start:e+s*n,end:e+(s+1)*n};r.push(a)}return r}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),n=!0);if(n){t=function(e,t,i){for(var n=[],r=e.substr(1,2),s=e.substr(3,4).substr(0,2),a=e.substr(5,6),o=t.substr(1,2),c=t.substr(3,4).substr(0,2),l=t.substr(5,6),d=parseInt(r,16),u=parseInt(s,16),p=parseInt(a,16),v=parseInt(o,16),m=parseInt(c,16),h=parseInt(l,16),g=(v-d)/i,f=(m-u)/i,S=(h-p)/i,_=0;_<i;_++){var y=Math.round(Math.abs(d+g*_))%256,b=Math.round(Math.abs(u+f*_))%256,T=Math.round(Math.abs(p+S*_))%256,w=y.toString(16);1===w.length&&(w="0"+w);var L=b.toString(16);1===L.length&&(L="0"+L);var C=T.toString(16);1===C.length&&(C="0"+C);var A="#"+w+L+C;n.push(A)}return n}(h.ColorScheme.min.color,h.ColorScheme.max.color,h.ColorLevel);for(var r=0;r<t.length;r++)g[t[r]]=i[r]}}(n.Type),n.Type){case FieldTypes.BOOLEAN:o(t,c);break;case FieldTypes.PICKLIST:o(t,l);break;case FieldTypes.DATETIME:case FieldTypes.DATE:o(t,d);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:o(t,u);break;case FieldTypes.LOCATION:o(t,f);break;case FieldTypes.ADDRESS:o(t,S);break;default:console.log("Other")}i.resolve()}else i.resolve();return i.promise},getGanttPalettes:function(){var r=s.defer();return e.getGanttPalettes().then(function(e){for(var t={},i=0;i<e.length;i++){var n={};if(n.Id=e[i].Id,n.Name=e[i][fieldNames.GanttServicePalette.Name],n.ServiceProperty=e[i][fieldNames.GanttServicePalette.ServiceProperty],n.ServicePropertyNoNamespace=v.removeFSLNamespace(n.ServiceProperty),void 0!==e[i][fieldNames.GanttServicePalette.ColorScheme])try{n.ColorScheme=JSON.parse(e[i][fieldNames.GanttServicePalette.ColorScheme])}catch(e){n.ColorScheme=void 0}else n.ColorScheme=void 0;n.Description=e[i][fieldNames.GanttServicePalette.Description],n.ColorLevel=e[i][fieldNames.GanttServicePalette.ColorLevel],n.Active=e[i][fieldNames.GanttServicePalette.Active],t[n.Id]=n}r.resolve(t)}).catch(function(e){r.reject(e)}),r.promise},updateGanttServicePaletteColor:function(e){if(void 0!==h)switch(a[h.ServiceProperty].Type){case FieldTypes.BOOLEAN:c(e);break;case FieldTypes.PICKLIST:l(e);break;case FieldTypes.DATETIME:case FieldTypes.DATE:d(e);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:u(e);break;case FieldTypes.LOCATION:f(e);break;case FieldTypes.ADDRESS:S(e);break;default:console.log("Other")}},resetCurrentPalette:function(){h=void 0,window.paletteViewActive=!1},isEmpty:function(e){if(null==e)return!0;if(0<e.length)return!1;if(0===e.length)return!0;if("object"!==(void 0===e?"undefined":_typeof(e)))return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0}}}e.$inject=["$q","sfdcService","utils","userSettingsManager","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("GanttPalettesService",e)}(),function(){function e(n,r,s,a,o){var c=null;function t(){return c.closeLightbox()}function l(){c.killWatch&&c.killWatch(),o.setLightBoxStatus(!1),c.$destroy(),c=null}return window.addEventListener("message",function(e){"closeLightbox"===e.data&&t()},!1),{open:function(e,t){if(!c){(c=n.$new(!0)).url=r.trustAsResourceUrl(t).toString(),__gantt.communityNetworkId&&(c.url=c.url.replace("/apex/","")),c.title=e,c.closeLightbox=l;var i=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer lightbox-general" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            \n                            <h1 class="light-box-header" ng-bind="title"></h1>\n                        </div>\n                        \n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ url }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");i.find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),i.find("#ResourceLightbox").resizable({minHeight:560,minWidth:940,maxWidth:940,handles:"s"}),angular.element("body").append(i),o.setLightBoxStatus(),c.$on("$destroy",function(){return i.remove()}),c.$on("keypress",function(e,t){27==t.which&&c.$evalAsync(c.closeLightbox)}),s(i)(c),a.safeApply(c)}},closeLightboxFromOutside:t}}e.$inject=["$rootScope","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("GeneralLightbox",e)}(),function(){function e(y,i,b,l,n,T,w,r,e,d,u,s,p,a){var o=2,L=null,m=null,c=!1,v={STAR:candidatesGrades.ideal,EXCELLENT:candidatesGrades.ideal,GOOD:candidatesGrades.reecommended};function t(e){L&&h(),L=y.$new(!0),window.__servicesInFilter&&(window.__servicesInFilter.applied=!1,updateViewDebounced()),m=null,L.StateService=w,L.gettingSlots=!0,L.closePanel=h,L.getResourceField=f,L.generateMstText=N,L.formatDateIntervalFinish=_,L.formatDateInterval=S,L.service=b.serviceAppointments()[e],L.generateResultText=A,L.allSlotsArray=null,L.slotsTimespansIds=[],L.trustHtml=T.trust,L.jumpToDate=R,L.GRADES=v,L.scheduleToSlot=V,L.replaceLabels=F,L.openLightbox=M,L.showOnGantt=x,L.formatDateHeader=C,L.notifyWhenDoneGettingSlots=D,L.shouldNotify=!1,L.scheduledActionInvoked=!1,L.groupSlotsBy="Resource",L.roundGrade=g,L.bestSlot=null,L.gotSlots=!0,L.exception=null,L.isMst=!1,L.mstPromise=null,L.schedulingTakesLong=!1,L.rawTimespans=[],L.partialResults=[],L.showPartialData=!1,L.generateAsyncLabel=E,L.formatTooltipHeader=O,L.formatAsapObjective=P,L.isAdmin=!1,void 0===window.userHasAdminPermissions?l.userHasAdminPermissions().then(function(e){window.userHasAdminPermissions=!!e&&(L.isAdmin=!0)}):L.isAdmin=window.userHasAdminPermissions,L.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},c||function(e){console.time("getting slots"),l.getSlots(e,w.selectedPolicyId).then(function(e){if(e&&e.value&&e.value.FSLOperationId)return console.log("get candidates with MST"),L.isMst=!0,i(function(){return L.schedulingTakesLong=!0},1e3*o),void(L.mstPromise=s.getUpdates(e.value.FSLOperationId).then(function(e){return console.log(e),console.log(e.fslOperation.result),console.timeEnd("getting slots"),L.shouldNotify||I({value:e.fslOperation.result}),e}).catch(function(e){console.error(e);var t={message:e.message||e};return L.shouldNotify||I({eventType:"exception",event:t}),a.reject({eventType:"exception",event:t})}));I(e)}).catch(function(e){var t={message:e.message||e};console.warn("could not get candidates"),console.log(e),L.shouldNotify||I({eventType:"exception",event:t})})}(e);var t=function(){var e='\n                <div id="GetSlotsPanel" xmlns="http://www.w3.org/1999/html">\n\n                    <div class="slots-panel-title">\n                        {{ replaceLabels(\'ShowingCandidatesTo\', [service.name] ) }}\n                        <div class="clear-slots" ng-click="closePanel()">'+customLabels.HideSlots+'</div>\n                    </div>\n\n\n                    <div ng-show="gettingSlots" class="getting-slots">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.FindingCandidates+'\n                        \n                        <div class="get-slots-mst" ng-show="isMst && schedulingTakesLong">\n                            {{ generateAsyncLabel() }}\n                            <div class="get-slots-mst-button" ng-click="notifyWhenDoneGettingSlots()">'+customLabels.MstNotifyMeWhenDone+'</div>\n                        </div>\n                    </div>\n                    \n                    \n                    <div ng-show="exception" class="get-slots-error">\n                        <svg aria-hidden="true" class="slds-icon">\n                          \u2028<use xlink:href=\''+lsdIcons.violation+"'></use>\n                        \u2028</svg>\n                        {{ exception.message }}\n                        \n                        <div>"+customLabels.ContactSysAdmin+'</div>\n                    </div>\n                    \n                    <div ng-show="!gotSlots && !exception" class="get-slots-error">\n                        <i class="fa fa-frown-o"></i>\n                        \n                        <div>'+customLabels.noCandidatesMessageGantt+'</div>\n                        \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                    </div>\n\n\n\n\n                    <div class="slots-results-recommendations" ng-if="allSlotsArray" ng-show="gotSlots">\n                        <span id="slotsSentence"></span>\n                        <div class="assign-to-recommended" ng-click="scheduleToSlot(bestSlot.Interval.Start, bestSlot.Resource.m_resource.Id, StateService.selectedPolicyId, bestSlot)">'+customLabels.AssignToRecommended+'</div>\n                    </div>\n\n\n\n                    <div class="slots-grouping" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="truncate groupSlotsBy" title="'+customLabels.GroupSlotsBy+'">'+customLabels.GroupSlotsBy+'</span>\n                        <input type="radio" id="groupByResource" name="groupBy" ng-model="groupSlotsBy" value="Resource" checked="checked">\n                        <label class="groupSlotsBy slots-groupByResource truncate" for="groupByResource" title="'+customLabels.Resource+'">'+customLabels.Resource+'</label>\n                        <input type="radio" id="groupByName" name="groupBy" ng-model="groupSlotsBy" value="Date">\n                        <label class="groupSlotsBy truncate slots-groupByName" for="groupByName" title="'+customLabels.Date+'">'+customLabels.Date+'</label>\n\n                        <div class="button-on-grouping" ng-show="service.isScheduled()" ng-click="showOnGantt()" title="'+customLabels.Show_on_gantt+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.table+'"></use>\n                            \u2028</svg>\n                        </div>\n\n                        <div class="button-on-grouping" ng-click="openLightbox()" title="'+customLabels.OpenDetailsWindow+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                        </div>\n                    </div>\n\n\n                    <div id="Slots-List-In-Panel" ng-show="gotSlots">\n                    \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                        \n                        \n                    \n                        <div ng-repeat="candidate in allSlotsArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Resource\'">\n    \n                            <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'name\')" class="candidates-container-row" ng-click="candidate.showSlots = !candidate.showSlots">\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null && getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') == undefined" class="ResourcePhotoIcon"></div>\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') != undefined && getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null" class="ResourcePhotoIcon CrewPhotoIcon"></div>\n                                <img ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') != null" ng-src="{{getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\')}}" class="ResourcePhotoIcon" />\n                                <h1>{{ getResourceField(candidate.Resource.m_resource.Id, \'name\') }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [candidate.SchedulingOptions.length] ) }}\n                                \n                                <div ng-show="candidate.highest.Grade > -1" class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": candidate.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": candidate.highest.Grade >= GRADES.GOOD && candidate.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": candidate.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(candidate.highest.Grade)}}/100\n                                </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in candidate.SchedulingOptions" class="time-interval" ng-init="intervalItem.showExplain[\'Resource\'] = false; intervalItem.showExplain[\'Date\'] = false;" ng-show="candidate.showSlots">\n                               \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                               \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start) }}</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, candidate.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                               \n                            </div>\n    \n                        </div>\n                        \n                       \n                       \n                        <div ng-repeat="date in dateKeysArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Date\'">\n                            <div class="candidates-container-row date-title-container" ng-click="slotsByDateObject[date].showDatesSlots = !slotsByDateObject[date].showDatesSlots">\n                                <h1>{{ formatDateHeader(date) }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [slotsByDateObject[date].length] ) }}\n                                \n                                        <div class="slot-grade slots-highest-grade" ng-show="slotsByDateObject[date].highest.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": slotsByDateObject[date].highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": slotsByDateObject[date].highest.Grade >= GRADES.GOOD && slotsByDateObject[date].highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": slotsByDateObject[date].highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(slotsByDateObject[date].highest.Grade)}}/100\n                                        </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in slotsByDateObject[date]" class="time-interval" ng-show="slotsByDateObject[date].showDatesSlots">\n                            \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                            \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start, true)}}</span>\n                                <span> ({{intervalItem.Resource.m_resource.Name}})</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, intervalItem.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                                \n                                \n                            </div>\n    \n                        </div>\n\n                </div>\n            ';return angular.element(e)}();angular.element("#LeftSideContainer").prepend(t),L.$on("$destroy",function(){return t.remove()}),window.__closeLeftSideTerritories&&window.__closeLeftSideTerritories(),n(t)(L),T.safeApply(L)}function h(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];L&&(m=null,e&&y.$broadcast("GotSlotsEnded"),showCandidates.on=!1,showCandidates.id=null,function(){for(var e=0;e<L.slotsTimespansIds.length;e++)scheduler.deleteMarkedTimespan(L.slotsTimespansIds[e])}(),updateViewDebounced(),e&&L.$destroy())}function g(e){return Math.round(e)}function f(e,t){return e&&r.getResources()[e]?r.getResources()[e][t]:null}function S(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=60*new Date(e).getTimezoneOffset()*1e3,n=new Date(e+i);return t?moment(n).format("LT"):moment(n).format("llll")}function _(e,t){var i=60*new Date(e).getTimezoneOffset()*1e3,n=new Date(e+i);return new Date(t+i).getDate()!==n.getDate()?moment(n).format("llll"):moment(n).format("LT")}function C(e){var t=e.split("_"),i=new Date(t[2],t[1],t[0],0,0,0,0);return moment(i).format("LL")}function A(e){if(e){var t=0,i=0;return e.forEach(function(e){t++,i+=e.SchedulingOptions.length}),customLabels.getSlotsExpText.replaceAll("<b>"+t+"</b>","<b>"+i+"</b>","<b>"+L.service.name+"</b>","<b>"+S(L.bestSlot.Interval.Start)+"</b>","<b>"+L.bestSlot.Resource.m_resource.Name+"</b>","<b>"+Math.round(L.bestSlot.Grade)+"</b>")}}function D(){L.shouldNotify=!0,L.mstPromise.then(function(e){T.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",L.service.AppointmentNumber),customLabels.MstFinishedGettingSlotsMessage,function(){!function(e){c=!0,t(e.fslOperation.result.Service.Id),"exception"===e.eventType&&I(e),I({value:e.fslOperation.result}),c=!1}(e)},null,!0)}).catch(function(e){console.error(e),T.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",L.service.AppointmentNumber),e,function(){})}),h(!0)}function I(e){if(L.gettingSlots=!1,"exception"===e.eventType)return L.gotSlots=!1,void(L.exception=e.event);if(L.partialResults=e.value.PartialResults||[],function(e){var t="",i=null,n=!1;for(var r in e.ResourceIDToScheduleData)if(e.ResourceIDToScheduleData[r].SchedulingOptions)for(var s=e.ResourceIDToScheduleData[r].SchedulingOptions,a=0;a<s.length;a++){var o=(g=s[a].Interval,void 0,f=60*new Date(g.Start).getTimezoneOffset()*1e3,S=60*new Date(g.Finish).getTimezoneOffset()*1e3,{startDate:new Date(g.Start+f),endDate:new Date(g.Finish+S)}),c=b.getResoruceGanttIdByDate(r,o.startDate);if(showSecondarySTMs&&L.service.ServiceTerritoryId&&(c=b.getResoruceGanttIdByDateAndTerritory(r,o.startDate,L.service.ServiceTerritoryId)),c)for(var l in 0===a&&(t+=e.ResourceIDToScheduleData[r].Resource.m_resource.Name+", ",n=!0),(o.startDate<i||null===i)&&(i=new Date(o.startDate)),scheduler.matrix){var d={};d[l]=-1<c.indexOf(",")?c.split(","):[c];var u="";s[a].MSTOptions&&(u=(new Date).getTime()+Math.floor(1e5*Math.random()),window.mstOptions=window.mstOptions||{},window.mstOptions[u]=s[a].MSTOptions);var p="background-color: rgba(118, 226, 164,"+(.11+parseInt(s[a].Grade)/100*.64)+");",v=s[a].Grade<0?"":Math.round(s[a].Grade)+"/100",m=customLabels.CandidateGradeGantt.replaceAll(moment(o.startDate).format("dddd LT"),moment(o.endDate).format("dddd LT"),v),h={start_date:o.startDate,end_date:o.endDate,sections:d,html:"<div oncontextmenu='scheduleSlot(event, \""+L.service.id+'", "'+o.startDate.getTime()+'", "'+c+'", "'+w.selectedPolicyId+'", "'+u+"\")', title='"+m+"' style='"+p+"'><span class='slotText'>"+v+"</span></div>",css:"slotMark"};L.rawTimespans.push(h)}}var g,f,S;if(n){var _=T.setDatesByStartAndMode(i);_.start.setDate(_.start.getDate()-1),_.end.setDate(_.end.getDate()+1),b.getTimePhasedObjects(_.start,_.end).then(function(){for(var e=0;e<L.rawTimespans.length;e++)L.slotsTimespansIds.push(scheduler.addMarkedTimespan(L.rawTimespans[e]));updateViewDebounced()}),showCandidates.on=!0,showCandidates.id=L.service.id,T.ganttSettings&&T.ganttSettings.filterCandidates&&(L.service.resourceId&&-1===t.indexOf(L.service.resourceName)&&(t+=L.service.resourceName+", "),t=t.substr(0,t.length-2)),y.$broadcast("GotSlots",{resourceToFilter:t,minDateOfCandidate:i}),scheduler.setCurrentView(i)}else L.gotSlots=!1}(e.value),L.gotSlots){L.allSlotsArray=[],L.slotsByDateObject={},L.dateKeysArray=[];var t=[],i=[];for(var n in m={},e.value.ResourceIDToScheduleData){var r=e.value.ResourceIDToScheduleData[n];L.allSlotsArray.push(r);for(var s=0;s<r.SchedulingOptions.length;s++){var a=new Date(r.SchedulingOptions[s].Interval.Start),o=60*new Date(r.SchedulingOptions[s].Interval.Start).getTimezoneOffset()*1e3;m[n]=!0,a.setMilliseconds(a.getMilliseconds()+o);var c=a.getFullYear()+" "+a.getMonth()+" "+a.getDate();t.includes(c)||(t.push(c),i.push(a));var l=B(a);L.slotsByDateObject[l]=L.slotsByDateObject[l]||[],r.SchedulingOptions[s].Resource=e.value.ResourceIDToScheduleData[n].Resource,L.slotsByDateObject[l].push(r.SchedulingOptions[s])}}i.sort(function(e,t){return e-t});for(var d=0;d<i.length;d++)L.dateKeysArray[d]=B(i[d]);L.allSlotsArray.sort(function(e,t){return e.Resource.m_resource.Name>t.Resource.m_resource.Name?1:e.Resource.m_resource.Name<t.Resource.m_resource.Name?-1:0});for(var u=0;u<L.allSlotsArray.length;u++)L.allSlotsArray[u].highest=k(L.allSlotsArray[u].SchedulingOptions);for(var p in L.slotsByDateObject){var v=L.slotsByDateObject[p];v.sort(function(e,t){return e.Interval.Start>t.Interval.Start?1:e.Interval.Start<t.Interval.Start?-1:0}),v.highest=k(v),L.bestSlot?L.bestSlot.Grade<v.highest.Grade&&(L.bestSlot=v.highest):L.bestSlot=v.highest}setTimeout(function(){return angular.element("#slotsSentence").html(A(L.allSlotsArray))},100)}}function k(e){for(var t=0,i=e,n=i[0],r=0;r<i.length;r++)i[t].Grade<i[r].Grade&&(n=i[t=r]);return n}function R(e){y.$broadcast("JumpToDate",new Date(e))}function F(e,t){var i;return(i=customLabels[e]).replaceAll.apply(i,_toConsumableArray(t))}function M(){e.open(L.service.id)}function x(){T.showOnGantt(L.service.id)}function O(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:-1,t=0;return L.allSlotsArray.forEach(function(e){return t+=e.SchedulingOptions.length}),customLabels.AB_Explanation_Header.replace("{0}",e).replace("{1}",t)}function P(e){var t=parseInt(e);return moment.tz(t,userTimeZone).format("llll")}function E(){return L.service.Use_Async_Logic?customLabels.ServiceUsingAsync:customLabels.MstTakingLongTime}function N(e){var t="";for(var i in e)t=customLabels.MstCandidatesGanttLine.replace("$0",b.serviceAppointments()[i].name).replace("$1",S(e[i].Interval.Start)).replace("$2",e[i].Resource.m_resource.Name);return t}function G(e,t,i){var n=e.Interval.Start,r=e.Interval.Finish,s=e.Resource.m_resource.Id,a=b.serviceAppointments()[t],o=60*new Date(n).getTimezoneOffset()*1e3,c=b.getResoruceGanttIdByDate(s,n);if(n+=o,r+=o,!a)return n=new Date(n),r=new Date(r),l.saveChangesToServiceAppointment(t,s,null,n,r,w.selectedPolicyId,"AutomaticGetSlots"),void p.getDelta();H(a,n,c||s,i),d.saveChangesToServiceAppointment(a,a).then(function(e){u.calculateKpis()})}function V(t,e,i,n){if(!L.scheduledActionInvoked){if(L.scheduledActionInvoked=!0,n.MSTOptions&&0<Object.keys(n.MSTOptions).length)for(var r in n.MSTOptions)G(n.MSTOptions[r],r,i);var s=L.service,a=60*new Date(t).getTimezoneOffset()*1e3;t+=a,s.resourceBeforeDrag=s.resourceId,s.eventBeforeDrag=angular.copy(s);var o=b.getResoruceGanttIdByDate(e,t);H(s,t,o||e,i),scheduler._events[s.id]?(scheduler.updateEvent(s.id),scheduler.callEvent("onEventChanged",[s.id,scheduler.getEvent(s.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),h()):d.saveChangesToServiceAppointment(s,s).then(function(e){u.calculateKpis(),y.$broadcast("JumpToDate",new Date(parseInt(t)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),T.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){y.$broadcast("JumpToDate",new Date(parseInt(t))),h()}),h()}}function H(e,t,i,n){var r=T.getServiceDuration(e);e.start=new Date(t),e.finish=new Date(t+r),e.start_date=new Date(t),e.end_date=new Date(t+r),e.travelTo=0,e.travelFrom=0,i&&(e.resourceId=i),e.policyUsed=n,e.scheduleMode="AutomaticGetSlots"}function B(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}return window.scheduleSlot=function(e,t,i,n,r,s){e.preventDefault(),$("#ScheduleOnSlot").remove(),$('<div id="ScheduleOnSlot">'+customLabels.ScheduleHere+"</div>").css("left",e.clientX-30+"px").css("top",e.clientY+5+"px").on("click",function(){s&&function(e,t){for(var i in mstOptions[e])G(mstOptions[e][i],i,t)}(s,r);var e=L.service;e&&(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),(!e.start||e.start.getTime()===parseInt(i)&&e.resourceId===n)&&e.start||H(e,parseInt(i),n,r),$("#ScheduleOnSlot").remove(),scheduler._events[e.id]?(scheduler.updateEvent(e.id),scheduler.callEvent("onEventChanged",[e.id,scheduler.getEvent(e.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),h()):d.saveChangesToServiceAppointment(e,e).then(function(e){u.calculateKpis(),y.$broadcast("JumpToDate",new Date(parseInt(i)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),T.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){y.$broadcast("JumpToDate",new Date(parseInt(i))),h()}))}).appendTo("body")},$("body").on("click",function(){$("#ScheduleOnSlot").remove()}),{get:t,close:h,getCandidatesIds:function(){return m}}}e.$inject=["$rootScope","$timeout","TimePhasedDataService","sfdcService","$compile","utils","StateService","ResourcesAndTerritoriesService","ServiceAppointmentLightboxService","servicesService","kpiCalculationsService","MstResolver","DeltaService","$q"],angular.module("serviceExpert").factory("GetSlotsService",e)}(),function(){function e(e,t,i,a){var o={};return{getLastKnownPositions:function(){return t.getLivePositions().then(function(e){for(var t in e)o[t]=new LastKnownPosition(e[t]);return o})},updatePositions:function(e){var t={},i=!1;for(var n in e){var r=new LastKnownPosition(e[n]),s=void 0;e[n].ServiceCrewMembers&&e[n].ServiceCrewMembers[0].IsLeader&&(s=a.getCrewToResources()[e[n].ServiceCrewMembers[0].ServiceCrewId]),(!o[r.id]||o[r.id].lastModifiedDate<r.lastModifiedDate)&&(t[n]=r,o[n]=r,i=!0,s&&(t[s.Id]=r,o[s.Id]=r))}return{dic:t,isUpdated:i}},lastKnownPositions:function(){return o}}}e.$inject=["$q","sfdcService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("LastKnownPositionService",e)}(),function(){function e(e,n,t,p,v,m,h,r,s,a,o,c,l,d,i){var g=n.$new(!0),u=angular.element('\n                        <div class="LeftSideLocationFiltering" >\n\n                            <div class="leftFilteringContentContainer" ng-if="opened">\n\n                                <div id="TF-loadingTerritories" ng-show="currentlySavingTerritories">\n                                    <img src="'+window.lsdIcons.spinnerGif+'" />\n                                    Loading Service Territories\n                                </div>\n\n                                <div class="territories-list-type-tabs">\n                                    <div ng-click="showTree = true; saveTabDebounced()" ng-class="{\'active-territory-tab\' : showTree}">'+customLabels.TerritoriesTree+'</div>\n                                    <div ng-click="showTree = false; saveTabDebounced()" ng-class="{\'active-territory-tab\' : !showTree}">'+customLabels.Favorites+'</div>\n                                </div>\n                                \n                                <div id="leftLocationFiltering-tooltip" tooltip-animation="false" tooltip-popup-delay="500" tooltip-class="horizonTooltip tooltip-location-inner" tooltip-append-to-body="true" tooltip-placement="bottom" \n                                    tooltip="'+(showSecondarySTMs&&useLocationTimezone?customLabels.LocationFilteringParagraph+"\n\n "+customLabels.Stms_with_different_tz:customLabels.LocationFilteringParagraph)+'">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n\n                                <div class="leftLocationFilteringConf">\n                                \n\n                                    <div class="addBorderBottom">\n                                        <input type="checkbox" ng-model="$parent.showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input \n                                        id="locationFilteringSearch" \n                                        ng-show="(!showAutocompleteTerritoryPicker)" \n                                        type="search" ng-model="locationSearchTerm.text" \n                                        placeholder="'+customLabels.Search_location+'" \n                                    />\n                                    \n                                    <span \n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(true, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span \n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(false, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                                    \n                                    <img class="tp-spinner" ng-show="$parent.currentlyLoading && showTree" src="'+window.lsdIcons.spinnerGif+'" />\n                                    \n                                    <svg aria-hidden="true" class="slds-icon tp-clear-territory-search" ng-show="$parent.searchText && !$parent.currentlyLoading && showTree" ng-click="clearAutocompleteSearch()">\n                                        \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                                    \u2028</svg>\n                                    \n                                    \n                                    <input type="text" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        class="tp-search-input"\n                                        placeholder="Search Service Territories" \n                                        ng-model="$parent.searchText" \n                                        ng-model-options="{ debounce: 333 }" \n                                        ng-change="searchTerritory(searchText)" \n                                        ng-click="setSearchResultBox($event)" \n                                    />\n                                    \n                                    \n                                    <span \n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(true)" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span \n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(false)"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                               \n                                </div>\n                                \n                                   \n                                   \n                                \x3c!-- Territories tree with auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTreeWithAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && showTree">\n                                \n                                \n                                    \x3c!-- SEARCH RESULTS --\x3e\n                                    \n                                    <div class="tp-territories-found-summary" ng-show="$parent.searchText && !currentlyLoading && !noTerritoriesFoundOnSearch">\n                                        Showing search results ({{currentResults.length}} territories found)\n                                    </div>\n                                \n                                    <div ng-repeat="territory in currentResults" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territory.Id]" id="location_{{ territory.Id }}" ng-change="addToCurrentLoadedTerritories(territory.Id, locationFilter[territory.Id])" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territory.Id)}" ng-click="toggleFavorite(territory.Id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territory.Id }}" ng-bind="territory.Name"></label>\n                                        <span class="ter-search-parent" ng-if="territory.ParentTerritory">({{ territory.ParentTerritory.Name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territory.Id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                    \n                                    \n                                    \x3c!-- CURRENTLY LOADED --\x3e\n                                    \n                                    <div ng-repeat="territoryId in currentlyLoadedTerritories" ng-show="!$parent.searchText" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        <span class="ter-search-parent" ng-if="getParentTerritory(territoryId)">({{ getParentTerritory(territoryId).name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                   \n                                    <div class="tp-no-territories-found" ng-show="noTerritoriesFoundOnSearch && !currentlyLoading">\n                                        '+customLabels.NoServiceTerritoriesWereFound+'\n                                    </div>\n                                    \n                                </div>\n                                   \n                                   \n                                <div id="TF-TerritoriesFavoritesAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && !showTree">\n                                    \n                                    <div ng-repeat="territoryId in favorites" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                </div>      \n                                   \n                                   \n                                   \n                                   \n                                \x3c!-- Territories tree without auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTree" class="LocationsTree" ng-show="showTree && !showAutocompleteTerritoryPicker">\n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                \n                                \n                                \n                                \x3c!-- Territories list without auto complete --\x3e\n                                \n                                <div id="TF-TerritoriesListFavorites" class="LocationsTree" ng-show="!showTree && !showAutocompleteTerritoryPicker">\n                                \n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" ng-show="isTerritoryInFavorite(l.id)" class="locationFilterRow">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_f_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_f_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                    \n\n                            </div>\n                            \n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="applyFilterLocationWithRowsCheck()">'+customLabels.Save+'</div>\n                                <div class="lightboxSaveButton cancelButtonAndClose" ng-click="closeLightbox()">'+customLabels.Cancel+"</div>\n                            </div>\n\n                        </div>\n                ").hide();angular.element("#LeftSideContainer").append(u),i.close(),g.trust=h.trust,g.showOrphanServices=!0,g.locationSearchTerm={text:""},g.showLocationFiltering=!1,g.noLocationsLoad=!1,g.locationFilter={},g.locationFilterCopy={},g.locationsFlat=[],g.territoriesSortedByTree=[],g.showTree=!0,g.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,g.spinnerIcon=window.lsdIcons.spinnerGif,g.showAutocompleteTerritoryPicker=window.__gantt.shouldShowAutoCompleteUi,g.currentResults=[],g.showResults=!1,g.noTerritoriesFoundOnSearch=!1,g.cachedTerritoriesQueryResults={},g.currentlyLoading=!1,g.searchText=null,g.allTerritoriesQueried={},g.territoriesIdsToNames={},g.currentlyLoadedTerritories=[],g.currentlySavingTerritories=!1,g.getParentTerritory=function(e){var t=p.territories()[e];return t&&t.parentTerritory?p.territories()[t.parentTerritory.id]:null},null!==v.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(g.showTree=!v.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),g.favorites=v.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(v.GetUserSettingsProperty("FavoriteTerritories__c")):[];var f=_.debounce(function(){v.SetUserSettingsProperty("FavoriteTerritories__c",JSON.stringify(g.favorites))},800);function S(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];g.opened=!0,g.showTree=!0,g.reload=e,function(){var e=v.GetUserSettingsProperty("locations");g.currentlyLoadedTerritories=e?[].concat(_toConsumableArray(e)):[]}(),null!==v.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(g.showTree=!v.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),g.favorites=v.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(v.GetUserSettingsProperty("FavoriteTerritories__c")):[],u.show()}function y(e,t,i){if(e.depth=t,i.push(e),e.items)for(var n=0,r=e.items.length;n<r;n++)e.items[n].depth=t,y(e.items[n],t+1,i)}return g.saveTabDebounced=_.debounce(function(){v.SetUserSettingsProperty("ShowFavoriteTerritoriesTab__c",!g.showTree)},800),e(u)(g),window.__openLocationFilteringAndReload=function(){return S(!0)},g.toggleFavorite=function(e){var t=g.favorites.indexOf(e);-1<t?g.favorites.splice(t,1):g.favorites.push(e),f()},g.isTerritoryInFavorite=function(e){return g.favorites.includes(e)},g.closeLightbox=function(){if(!g.noLocationsLoad){for(var e in g.locationFilterCopy)g.locationFilter[e]=g.locationFilterCopy[e];g.showOrphanServices=g.showOrphanServicesOldValue,u.hide(),window.__closeLeftSideTerritories=null,g.opened=!1}},window.__closeLeftSideTerritories=g.closeLightbox,g.styleForLocationTree=function(e){return{"margin-left":20*e+"px"}},g.switchToTerritory=function(e){for(var t in g.locationFilter)g.locationFilter[t]=!1;g.locationFilter[e]=!0,g.applyFilterLocation()},p.promises.territories().then(function(){var i={},e=[],t=[],n=[];for(var r in p.territories()){var s=p.territories()[r];s.hasSharing&&(i[r]={id:r,parent:s.parentTerritory?s.parentTerritory:0,text:s.name,items:[]},g.territoriesIdsToNames[s.id]=s.name)}for(var a in i){var o=i[a],c=l(o);0!==o.parent&&c?i[c.id].items.push(o):e.push(o)}function l(e){if(e.id&&e.parent){if(i[e.parent.id])return e.parent;var t={};return p.allTerritories[e.parent.id]&&(t={id:p.allTerritories[e.parent.id].id,parent:p.allTerritories[e.parent.id].parentTerritory?p.allTerritories[e.parent.id].parentTerritory:0}),l(t)}}g.locationsTree=e;for(var d=0;d<e.length;d++)y(e[d],0,g.locationsFlat);if(g.showOrphanServices=JSON.parse(v.GetUserSettingsProperty("Show_Orphan_Services__c")),g.showOrphanServicesOldValue=g.showOrphanServices,g.territoriesSortedByTree=function(t,e){return Object.keys(t).map(function(e){return t[e]}).sort(function(i,n){var r=0,s=0;return e.forEach(function(e,t){e.id===i.id&&(r=t),e.id===n.id&&(s=t)}),s<r?1:r<s?-1:0})}(p.territories(),g.locationsFlat),null!==v.GetUserSettingsProperty("locations")&&(t=v.GetUserSettingsProperty("locations")),m.getUnPrivilegeUserSettingsFields().then(function(e){if(1<e.length){for(var t=customLabels.Unprivileged_Usersettings_Fields_Msg.split("{1}"),i=t[0],n="",r=0;r<e.length&&r<3;++r)n+="<br>"+e[r];if(3<e.length){var s=e.length-3;n+="<br>",i+=t[1].replace("{2}",s)}i=i.replace("{0}",n),h.addNotification(customLabels.Unprivileged_Usersettings_Fields,i)}}).catch(function(e){console.warn("GetUserSettingsProperty failed :-("),console.error(e)}),g.showAutocompleteTerritoryPicker&&0===g.locationsFlat.length||0===t.length)return g.showLocationFiltering=!0,g.noLocationsLoad=!0,void S();for(var u=0;u<g.locationsFlat.length;u++)g.noLocationsLoad=!1,g.locationFilter[g.locationsFlat[u].id]=-1<t.indexOf(g.locationsFlat[u].id),g.locationFilter[g.locationsFlat[u].id]&&n.push(g.locationsFlat[u].id);g.locationFilterCopy=angular.copy(g.locationFilter),v.SetUserSettingsProperty("locations",JSON.stringify(n))}),g.applyFilterLocationWithRowsCheck=function(){var e=[];for(var t in g.locationFilter)g.locationFilter[t]&&e.push(t);if(0!==e.length){var i=new Date(scheduler._min_date),n=new Date(scheduler._max_date);i.setDate(i.getDate()-window.daysToLoadOnGanttInit),n.setDate(n.getDate()+window.daysToLoadOnGanttInit),g.currentlySavingTerritories=!0,m.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,i,n,e).then(function(e){e?(g.currentlySavingTerritories=!1,alert(customLabels.MaxedRowsReachedOnGanttAlert)):g.applyFilterLocation()})}else alert(customLabels.One_loaded_location)},g.applyFilterLocation=function(){var i=[],e=[];for(var t in g.locationFilter)g.locationFilter[t]?i.push(t):e.push(t);if(0===i.length)return g.currentlySavingTerritories=!1,void alert(customLabels.One_loaded_location);g.noLocationsLoad=!1,angular.extend(g.locationFilterCopy,g.locationFilter),g.showOrphanServicesOldValue=g.showOrphanServices,s.isLoadingNewLocations=!0,d.resetCurrentPalette(),v.SetUserSettingProperties(g.parseLocationSettings(JSON.stringify(i),g.showOrphanServices)).then(function(){g.reload?window.window.location.reload():p.getResourceAndTerritories(function(){o.reset(),p.reset(),scheduler._events={},scheduler.deleteMarkedTimespan(),r.reset(),a.reset(),c.reset(),l.reset()}).then(function(){r.resetReachedMaxRows();var e=new Date(scheduler.getState().min_date),t=new Date(scheduler.getState().max_date);e.setDate(e.getDate()-1),t.setDate(t.getDate()+1),r.getTimePhasedObjects(e,t).then(function(){g.currentlySavingTerritories=!1,updateViewDebounced(),n.$broadcast("gotNewResources",{show:i}),s.isLoadingNewLocations=!1}).catch(function(){g.currentlySavingTerritories=!1})})}).catch(function(e){g.currentlySavingTerritories=!1;for(var t=customLabels.territories_r_failure_msg+"\n",i=JSON.parse(e.FailedLocations),n=0;n<i.length;n++)t+=i[n].Name+"\n";h.addNotification(customLabels.territories_r_failure,t),s.isLoadingNewLocations=!1}),g.closeLightbox()},g.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},g.selectLocation=function(e){var t=g.locationFilter[e],i=function e(t,i){var n=null;for(var r=0;r<t.length;r++){if(t[r].id===i)return t[r];if(n=e(t[r].items,i))return n}return n}(g.locationsTree,e);i&&!function e(t,i){for(var n=0;n<t.items.length;n++)g.locationFilter[t.items[n].id]=i,e(t.items[n],i)}(i,t)},g.selectAllLocations=function(t,e,i,n){n?angular.forEach(e,function(e){i[e.id]=t}):g.selectAllFavoriteLocations(t,e,i)},g.selectAllFavoriteLocations=function(t,e,i){angular.forEach(e,function(e){g.isTerritoryInFavorite(e.id)&&(i[e.id]=t)})},g.searchTerritory=function(i){return""===i?(g.currentResults=[],g.showResults=!1,void(g.noTerritoriesFoundOnSearch=!1)):g.cachedTerritoriesQueryResults[i.toLocaleLowerCase()]?(g.currentResults=g.cachedTerritoriesQueryResults[i.toLocaleLowerCase()],g.showResults=!0,void(0===g.currentResults.length?g.noTerritoriesFoundOnSearch=!0:g.noTerritoriesFoundOnSearch=!1)):(g.currentlyLoading=!0,void window.Visualforce.remoting.Manager.invokeAction(window.RemoteActions.searchTerritories,i,function(e,t){t.status?h.safeApply(g,function(){g.cachedTerritoriesQueryResults[i.toLocaleLowerCase()]=e,g.showResults=!0,g.searchText===i&&(g.currentlyLoading=!1,0===(g.currentResults=e).length?g.noTerritoriesFoundOnSearch=!0:(g.noTerritoriesFoundOnSearch=!1,e.forEach(function(e){g.allTerritoriesQueried[e.Name]=e,g.territoriesIdsToNames[e.Id]=e.Name})))}):console.warn(t)},{buffer:!0,escape:!1,timeout:12e4}))},g.addToCurrentLoadedTerritories=function(e,t){var i=g.currentlyLoadedTerritories.indexOf(e);t&&-1===i&&g.currentlyLoadedTerritories.push(e),!t&&1<i&&g.currentlyLoadedTerritories.splice(i,1)},g.clearAutocompleteSearch=function(){g.currentResults=[],g.showResults=!1,g.noTerritoriesFoundOnSearch=!1,g.currentlyLoading=!1,g.searchText=""},g.selectTerritoriesWithAutocomplete=function(t){g.searchText?g.currentResults.forEach(function(e){g.locationFilter[e.Id]=t,g.addToCurrentLoadedTerritories(e.Id,t)}):g.currentlyLoadedTerritories.forEach(function(e){g.locationFilter[e]=t})},{isOpen:function(){return g&&g.opened},open:S,getFlatTerritoriesArray:function(){return g.locationsFlat},getTerritoriesSortedByTree:function(){return g.showAutocompleteTerritoryPicker?window._.toArray(p.territories()):g.territoriesSortedByTree},isNoTerritoryLoadded:function(){return g.noLocationsLoad}}}e.$inject=["$compile","$rootScope","$q","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService","ResourceCrewsService","ResourceCapacitiesService","GanttPalettesService","GetSlotsService"],angular.module("serviceExpert").factory("LeftSideLocationFilteringService",e)}(),function(){function e(l,d,u,p,v){function m(e,t,i){var n=void 0,r=void 0,s=u.addDaysToDate(t,1-i),a=t;if(e[s]){for(r=s;r<=a&&e[r];)r=u.addDaysToDate(r,1);return n=(a.getTime()-r.getTime())/864e5,{date:a,horizon:++n}}for(r=a;s<=r&&e[r];)r=u.addDaysToDate(r,-1);return n=(r.getTime()-s.getTime())/864e5,{date:r,horizon:++n}}function h(e,t,i){var n=u.addDaysToDate(t,-i);return!!(e.earlyStart&&e.earlyStart>n&&e.earlyStart<=t)||(!!(e.dueDate&&e.dueDate>n&&e.dueDate<=t)||(!!(e.appStart&&e.appStart>n&&e.appStart<=t)||(!!(e.appEnd&&e.appEnd>n&&e.appEnd<=t)||(!!(e.finish&&e.finish>n&&e.finish<=t)||!!(e.start&&e.start>n&&e.start<=t)))))}return{getBackHorizonToFetch:m,loadServicesInBulk:function(e,t,i,n,r){var s=l.defer(),a=m(t,i,n),o=u.addDaysToDate(a.date,1-a.horizon),c=function(e,t,i){var n=[];for(var r in e)h(e[r],t,i)&&n.push(r);return n}(e,i,n);return function(e,t,i){var n=new Date(t),r=!1;for(;i;)e[u.generateDateKey(n)]||(r=!0),e[u.generateDateKey(n)]=!0,n.setDate(n.getDate()-1),i--;return r}(t,i,n)||r?d.loadServicesInBulk(a.date,a.horizon,numberOfServicesToLoadInEachBulk,c,r).then(function(e){var t=[];e.ganttServiceAppointments.forEach(function(e){e.AssignedResource&&!scheduler._events[e.Id]&&t.push(e.Id)}),Array.isArray(e.stms)&&0<e.stms.length&&p.updateTimePhaseData(e.stms,"stm");var i=p.updateTimePhaseData(e.ganttServiceAppointments,"service"),n=p.resourcesAndTerritories(),r={needToCheckRules:t,scheduledServices:[],unscheduledServices:[],remainingCount:e.remainingCount,fetchedFromDate:o,horizon:a,totalFetched:e.ganttServiceAppointments.length,lastFetchedId:e.ganttServiceAppointments[e.ganttServiceAppointments.length-1]?e.ganttServiceAppointments[e.ganttServiceAppointments.length-1].Id:null};i.services.forEach(function(e){e.isScheduled()?(e.setGanttResource(n,u.generateResourceId),r.scheduledServices.push(e)):(scheduler._events[e.id]&&delete scheduler._events[e.id],r.unscheduledServices.push(e))}),v.drawServicesAndAbsences(r.scheduledServices,[],[],[]),s.resolve(r)}).catch(function(e){s.reject(e),console.warn("loadServicesInBulk: something went wrong"),u.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}):s.resolve([]),s.promise}}}e.$inject=["$q","sfdcService","utils","TimePhasedDataService","servicesService"],angular.module("serviceExpert").factory("LoadServiceListService",e)}();var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],n=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);n=!0);}catch(e){r=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw s}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function GanttService(e,t){if(!t){for(var i in this.sfdcType="service",this.fields={},e.Fields)this.fields[i]=e.Fields[i];this.id=e.Fields.Id||null,this.name=e.Fields.AppointmentNumber||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e.Fields["Account.Name"]||null,this.accountId=e.Fields.AccountId||null,this.latitude=e.Fields.Latitude||null,this.longitude=e.Fields.Longitude||null,this.arrivalWindowEndTime=e.Fields.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.Fields.ArrivalWindowStartTime||null,this.dueDate=e.Fields.DueDate||null,this.ganttDisplay=e.Fields.Gantt_Display_Date__c||null,this.durationType=e.Fields.DurationType||null,this.earliestStartTime=e.Fields.EarliestStartTime||null,this.estDuration=e.Fields.Duration||null,this.travelTimeFrom=e.Fields.EstimatedTravelTimeFrom__c||null,this.travelTimeTo=e.Fields.EstimatedTravelTime||null,this.ganttLabel=e.Fields.GanttLabel__c||null,this.jeopardy=e.Fields.InJeopardy__c||null,this.jeopardyReason=e.Fields.InJeopardyReason__c||null,this.parentRecord=e.Fields.ParentRecordId||null,this.parentRecordStatus=e.Fields.ParentRecordStatusCategory||null,this.parentRecordType=e.Fields.ParentRecordType||null,this.pinned=e.Fields.Pinned__c||!1,this.schedEndTime=e.Fields.SchedEndTime||null,this.schedStartTime=e.Fields.SchedStartTime||null,this.serviceTerritory=e.Fields.ServiceTerritory||null,this.serviceTerritoryName=e.Fields["ServiceTerritory.Name"]||null,this.status=e.Fields.Status||null,this.statusCategory=e.Fields.StatusCategory||null,this.subject=e.Fields.Subject||null,this.ganttColor=e.Fields.GanttColor__c||null,this.resource=e.Resource||null,this.resourceName=e.ResourceName||null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.AssignedResource||null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Fields.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Fields.Schedule_Mode__c||null,this.emergency=e.Fields.Emergency__c||!1,this.isServiceInChain=usingNewMstModel&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null,this.ganttPaletteColor=null,this.Use_Async_Logic=e.Fields.Use_Async_Logic__c||!1,this.icons=e.Fields.GanttIcon__c?e.Fields.GanttIcon__c.split(";"):null,this.totalModifiedTimes=this.ServiceAppointmentLastModifiedDate,this.AssignedResourceLastModifiedDate&&(this.totalModifiedTimes+=this.AssignedResourceLastModifiedDate),this.icons&&(this.icons=this.icons.map(function(e){return window.encodeURI(e)}));var n="WorkOrder"==e.Fields.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField;n&&e.ParentFields&&e.ParentFields[n]&&(this.priority=e.ParentFields[n]);var r=fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField;for(var s in this.isMDT=!!e.Fields[r],e.Fields.MDT_Operational_Time__c?this.calculateMdtTimes(e.Fields.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={},e.ParentFields)this.parentFields[s]=e.ParentFields[s];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttService.prototype.allFieldSetsSet,e.Fields,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&1<t.length)for(var i=0;i<t.length;i++)if(e.resourceBeforeDrag.split(",")[i]!=t[i]){e.resourceId=t[i];break}}}function addFieldSetToServiceObject(e,t,i){for(var n in e){var r=null;if((r=t[e[n].APIName])||0==r){switch(e[n].Type){case"DATE":case"DATETIME":var s=60*new Date(r).getTimezoneOffset()*1e3;r=new Date(r+s),i.fields[e[n].APIName]=r.getTime();break;case"REFERENCE":var a=e[n].JsAPIName.replace("__r","__c");i[a]=t[a]}i[e[n].APIName]=r}}}function LastKnownPosition(e){this.id=e.Id,this.latitude=e[fieldNames.ServiceResource.LastKnownLocation__Latitude__s],this.longitude=e[fieldNames.ServiceResource.LastKnownLocation__Longitude__s],this.lastModifiedDate=e[fieldNames.ServiceResource.LastKnownLocationUpdate__c];var t=void 0;this.lastModifiedDate&&(t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3),this.lastModifiedDate=this.lastModifiedDate?new Date(this.lastModifiedDate+t):null}function OptimizationRequest(e){if(this.id=e.Id,this.lastModifiedDate=e.LastModifiedDate,this.lastModifiedDate){var t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3;this.lastModifiedDate=new Date(this.lastModifiedDate.valueOf()+t)}if(this.name=e.Name,this.scheduledAmount=e[fieldNames.Optimization_Request.Objects_Scheduled__c],this.objectToScheduled=e[fieldNames.Optimization_Request.Objects_To_Schedule__c],this.status=e[fieldNames.Optimization_Request.Status__c]||null,this.statusLabel=e.statusLabel||e[fieldNames.Optimization_Request.Status__c]||null,this.allTasks=e[fieldNames.Optimization_Request.All_Tasks_Mode__c]||null,this.includeEmptyLocations=e[fieldNames.Optimization_Request.Include_Services_With_Empty_Location__c]||null,this.type=e[fieldNames.Optimization_Request.Type__c]||null,this.failureReason=e[fieldNames.Optimization_Request.Failure_Reason__c]||null,this.failureDetails=e[fieldNames.Optimization_Request.Failure_Details__c]||null,this.optimizationData=e[fieldNames.Optimization_Request.Optimization_Data__c]||null,this.orgResourceAbsence=e[fieldNames.Optimization_Request.Originating_Resource_Absence__c]||null,this.orgServiceAppointment=e[fieldNames.Optimization_Request.Originating_Service_Appointment__c]||null,this.policy=e[fieldNames.Optimization_Request.Scheduling_Policy__c]||null,this.serviceAppointment=e[fieldNames.Optimization_Request.Service_Appointment__c]||null,this.resource=e[fieldNames.Optimization_Request.Service_Resource__c]||null,this.result=e[fieldNames.Optimization_Request.Result__c]||null,this.schedulingRecipe=e[fieldNames.Optimization_Request.Scheduling_Recipe__r]||null,this.territories=[],this.resourceName=null,this.resource&&(this.resourceName=e[fieldNames.Optimization_Request.Service_Resource__c.replace("__c","__r")].Name),this.requestProgressStart=e[fieldNames.Optimization_Request.Request_Progress_Start__c]||null,e[territoryOptimizationRequestRelationshipName])for(var i=0;i<e[territoryOptimizationRequestRelationshipName].length;i++)this.territories.push(new TerritoryOptimizationRequest(e[territoryOptimizationRequestRelationshipName][i]));if(this.timespan=null,this.finish=e[fieldNames.Optimization_Request.Finish__c]||null,this.start=e[fieldNames.Optimization_Request.Start__c]||null,this.start){var n=60*new Date(this.start).getTimezoneOffset()*1e3;this.start=new Date(this.start.valueOf()+n)}if(this.finish){var r=60*new Date(this.finish).getTimezoneOffset()*1e3;this.finish=new Date(this.finish.valueOf()+r)}}function ResourceAbsence(e){this.id=e.Id,this.end=e[fieldNames.ResourceAbsence.End],this.resource=e[fieldNames.ResourceAbsence.Resource],this.start=e[fieldNames.ResourceAbsence.Start],this.absenceType=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.reason=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.ganttLabel=e[fieldNames.ResourceAbsence.GanttLabel__c]||null,this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.AbsenceNumber,this.resourceName=e[fieldNames.ResourceAbsence.Resource__r].Name,this.ganttColor=e[fieldNames.ResourceAbsence.Gantt_Color__c],this.approved=e[fieldNames.ResourceAbsence.Approved__c],this.latitude=e.Latitude,this.longitude=e.Longitude,this.travelTo=e[fieldNames.ResourceAbsence.EstTravelTime__c]?60*e[fieldNames.ResourceAbsence.EstTravelTime__c]:0,this.travelFrom=e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]?60*e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]:0,this.sfdcType="absence",e.RecordType&&e.RecordType.DeveloperName&&"Non_Availability"==e.RecordType.DeveloperName?this.type="na":this.type="break",this.setSchedulerProperties()}function ResourceCapacity(e){this.sfdcType="capacity",this.id=e.Id,this.end=e[fieldNames.ResourceCapacity.EndDate],this.resource=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceId=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource__r]?e[fieldNames.ResourceCapacity.ServiceResource__r].Name:null,this.start=e[fieldNames.ResourceCapacity.StartDate],this.hoursInUse=e[fieldNames.ResourceCapacity.HoursInUse__c],this.hoursPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInHours]||0,this.minutesUsed=e[fieldNames.ResourceCapacity.MinutesUsed__c],this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.CapacityNumber,this.timePeriod=e[fieldNames.ResourceCapacity.TimePeriod],this.workItemsAllocated=e[fieldNames.ResourceCapacity.Work_Items_Allocated__c],this.workItemsPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInWorkItems]||0,this.setSchedulerProperties()}function addDaysToDate(e,t){var i=864e5*t;return new Date(e.getTime()+i)}function calcCapacityPercentage(e,t){return parseFloat((e/t*100).toFixed(2))}function ResourcesAndTerritories(e){this.id=e.Id,this.name=e.MemberNumber,this.effectiveEndDate=e[fieldNames.ServiceTerritoryMember.EffectiveEndDate]||null,this.effectiveStartDate=e[fieldNames.ServiceTerritoryMember.EffectiveStartDate],this.latitude=e[fieldNames.ServiceTerritoryMember.Latitude],this.longitude=e[fieldNames.ServiceTerritoryMember.Longitude],this.serviceResource=e[fieldNames.ServiceTerritoryMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceTerritoryMember.ServiceResource__r],this.serviceTerritory=e[fieldNames.ServiceTerritoryMember.ServiceTerritory],this.serviceTerritory__r=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r],this.serviceTerritoryType=e[fieldNames.ServiceTerritoryMember.TerritoryType],this.operatingHours=e[fieldNames.ServiceTerritoryMember.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritoryMember.OperatingHours__r];var t=void 0,i=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(i=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+i):new Date(24e11),this.timezone=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r][fieldNames.ServiceTerritory.OperatingHours__r][fieldNames.OperatingHours.Timezone]}function ServiceCrewMember(e){this.id=e.Id,this.name=e.Name,this.endDate=e[fieldNames.ServiceCrewMember.EndDate]||null,this.startDate=e[fieldNames.ServiceCrewMember.StartDate],this.serviceResource=e[fieldNames.ServiceCrewMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceCrewMember.ServiceResource__r],this.serviceCrew=e[fieldNames.ServiceCrewMember.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceCrewMember.ServiceCrew__r],this.leader=e[fieldNames.ServiceCrewMember.Leader],this.ganttLabel=e[fieldNames.ServiceCrewMember.GanttLabel],this.ganttColor=e.ServiceCrew?e.ServiceCrew[fieldNames.ServiceCrew.GanttColor__c]:null;var t=void 0,i=void 0;this.startDate&&(t=60*new Date(this.startDate).getTimezoneOffset()*1e3),this.endDate&&(i=60*new Date(this.endDate).getTimezoneOffset()*1e3),this.startDate=this.startDate?new Date(this.startDate+t):new Date(24e11),this.endDate=this.endDate?new Date(this.endDate+i):new Date(24e11)}function ServiceResource(e){var t=this;this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Name,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},(this.sobject=e)[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceResourceSkill(e){this.id=e.Id,this.name=e.SkillNumber,this.effectiveEndDate=e[fieldNames.ServiceResourceSkill.EffectiveEndDate],this.effectiveStartDate=e[fieldNames.ServiceResourceSkill.EffectiveStartDate],this.level=e[fieldNames.ServiceResourceSkill.SkillLevel],this.serviceResource=e[fieldNames.ServiceResourceSkill.ServiceResource],this.skill=e[fieldNames.ServiceResourceSkill.Skill];var t=void 0,i=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(i=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+i):new Date(864e11)}function ServiceTerritory(e){this.id=e.Id,this.name=e.Name,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory__r]?e[fieldNames.ServiceTerritory.ParentTerritory]:void 0,this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory__r]&&(this.parentTerritory=new ServiceTerritory(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}function TerritoryOptimizationRequest(e){this.id=e.Id,this.optimizationRequest=e[fieldNames.TerritoryOptimizationRequest.OptimizationRequest]||null,this.serviceTerritory=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory]||null,this.serviceTerritoryName=null,this.serviceTerritory&&(this.serviceTerritoryName=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory.replace("__c","__r")].Name||null)}!function(){function e(n,o,l,d,a,i,r,s,t,e,c,u,p,v,m,h){var g="[POLYGONS]",f={IFRAME_TYPE:{SECURED:"1",NORMAL:"2"},IFRAME_RECEIVED_MESSAGES_TYPES:{FSL_MAP_LOADED:"FSL_MAP_LOADED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_DATA_UPDATE:"FSL_MAP_DATA_UPDATE",VIEW_DETAILS:"VIEW_DETAILS",API_REQUEST:"API_REQUEST",GET_ICON:"GET_ICON"},IFRAME_SEND_MESSAGES_TYPES:{API_REQUEST_SUCCEED:"API_REQUEST_SUCCEED",API_REQUEST_FAILED:"API_REQUEST_FAILED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_SERVICES_UPDATE:"FSL_MAP_SERVICES_UPDATE",SHOW_SERVICE_ON_MAP:"SHOW_SERVICE_ON_MAP",GET_ICON_SUCCEED:"GET_ICON_SUCCEED",GET_ICON_FAILED:"GET_ICON_FAILED",FSL_MAP_LIVE_POSITION:"FSL_MAP_LIVE_POSITION",FSL_MAP_UPDATE_FILTER:"FSL_MAP_UPDATE_FILTER",FSL_MAP_UPDATE_VIEW:"FSL_MAP_UPDATE_VIEW"},POLYGON_MENU_ACTIONS:{SCHEDULE:g+" SCHEDULE",UNSCHEDULE:g+" UNSCHEDULE",DISPATCH:g+" DISPATCH",IN_JEOPARDY:g+" IN_JEOPARDY",DELETE_POLYGON:g+" DELETE_POLYGON",CUSTOM_ACTION:g+" CUSTOM_ACTION"}},S={showServiceOnMapId:void 0,showServiceOnMap:!1,reactDomain:void 0,targetOrigin:void 0,reactMapInitialize:!1,iframeMapMode:window.iframeMapMode,debugMode:window.debugMode,iframeWindow:void 0,serviceFields:[],dynamicIcons:{}};d.getLastKnownPositions(),e.fieldsSetFields().then(function(e){S.serviceFields=e.MapInfo});function y(e){var t=e;S.iframeMapMode===f.IFRAME_TYPE.NORMAL&&(t=e.data),void 0!==t.type&&(t.type.includes(g)?L(t):w(t))}setTimeout(function(){S.iframeMapMode===f.IFRAME_TYPE.SECURED&&(S.debugMode?SfdcApp.iframe.addMessageHandler("GanttReactMapIframeDebug",y):SfdcApp.iframe.addMessageHandler("GanttReactMapIframe",y)),S.iframeMapMode===f.IFRAME_TYPE.NORMAL&&(S.targetOrigin=window.location.origin+window.location.pathname,S.iframeWindow=document.getElementById("GanttReactMapIframeSF").contentWindow,function(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent&&e.attachEvent("on"+t,i)}(window,"message",y))},0);function b(e){S.iframeMapMode===f.IFRAME_TYPE.SECURED&&(S.debugMode?SfdcApp.iframe.sendMessage("GanttReactMapIframeDebug",e):SfdcApp.iframe.sendMessage("GanttReactMapIframe",e)),S.iframeMapMode===f.IFRAME_TYPE.NORMAL&&S.iframeWindow.postMessage(e,S.targetOrigin)}function T(e){var r=o.defer();try{var s={};if(s.id=e.Id,s.name=e[window.GanttMap.fieldNames.CustomGanttAction.Label],s.className=e[window.GanttMap.fieldNames.CustomGanttAction.Class],s.order=e[window.GanttMap.fieldNames.CustomGanttAction.Order],s.permission=e[window.GanttMap.fieldNames.CustomGanttAction.Permission],s.section=e[window.GanttMap.fieldNames.CustomGanttAction.Section],s.visualforce=e[window.GanttMap.fieldNames.CustomGanttAction.Visualforce],e[window.GanttMap.fieldNames.CustomGanttAction.Icon])k(R(e[window.GanttMap.fieldNames.CustomGanttAction.Icon].split(","))).then(function(e){var t=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),i=window.atob(t).replace(/fill="#[A-Za-z0-9]+"/,'fill="#17325c"'),n=window.btoa(i);s.icon="url('data:image/svg+xml;base64,"+n+"')",r.resolve(s)})}catch(e){r.reject(e)}return r.promise}var w=function(i){switch(i.type){case f.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_LOADED:break;case f.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_INITIALIZATION:S.reactMapInitialize=!0,N(),E(),$();break;case f.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_DATA_UPDATE:S.showServiceOnMap&&S.showServiceOnMapId&&setTimeout(function(){var e={serviceId:S.showServiceOnMapId,type:f.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};b(e),S.showServiceOnMap=!1,S.showServiceOnMapId=void 0},7e3);break;case f.IFRAME_RECEIVED_MESSAGES_TYPES.VIEW_DETAILS:O(i.id,i.objectType);break;case f.IFRAME_RECEIVED_MESSAGES_TYPES.API_REQUEST:M(i.method,i.filter,i.params).then(function(e){if("getCustomActions"===i.method)C(e).then(function(e){var t={response:e,feature:i.feature,type:f.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(t)}).catch(function(e){console.warn(e)});else if("getReportRowsForMap"===i.method)I(e).then(function(e){var t={response:e,feature:i.feature,type:f.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(t)});else if("getReportsWithGeolocationCols"===i.method)A(e).then(function(e){var t={response:e,feature:i.feature,type:f.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(t)});else if("getMapReports"===i.method)D(e).then(function(e){var t={response:e,feature:i.feature,type:f.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(t)});else{var t={response:e,feature:i.feature,type:f.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(t)}}).catch(function(e){var t={response:e,feature:i.feature,type:f.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_FAILED};b(t)});break;case f.IFRAME_RECEIVED_MESSAGES_TYPES.GET_ICON:F(i.hex,i.folder,i.icon,i.iconKey).then(function(e){var t={response:e,iconKey:i.iconKey,type:f.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_SUCCEED};b(t)}).catch(function(e){var t={response:e,iconKey:i.iconKey,type:f.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_FAILED};b(t)})}},L=function(e){switch(e.type){case f.POLYGON_MENU_ACTIONS.CUSTOM_ACTION:x(e.servicesIds,e.action);break;case f.POLYGON_MENU_ACTIONS.DISPATCH:i.changeStatus(e.servicesIds,m.DISPATCHED).then(function(e){i.drawServicesAndAbsences(e.services)}).catch(function(e){a.addNotification(window.customLabels.Action_Could_Not_Be_Performed,e.message||window.customLabels.user_is_not_allowed_to_perform_action)});break;case f.POLYGON_MENU_ACTIONS.UNSCHEDULE:i.unscheduleServices(e.servicesIds);break;case f.POLYGON_MENU_ACTIONS.SCHEDULE:t.schedule(e.servicesIds);break;case f.POLYGON_MENU_ACTIONS.IN_JEOPARDY:i.setInJeopardy(e.servicesIds)}},C=function(e){for(var t=o.defer(),i={},n=0;n<e.length;n++)a.hasCustomPermission(e[n][window.GanttMap.fieldNames.CustomGanttAction.Permission])&&"map"===e[n][window.GanttMap.fieldNames.CustomGanttAction.Section]&&(i[e[n].Id]=T(e[n]));return o.all(i).then(function(e){t.resolve(e)}).catch(function(e){console.warn(e.message),t.reject()}),t.promise},A=function(n){var r=o.defer(),e=[];try{for(var t=0;t<n.length;t++)if(n[t].icon){var i=n[t].icon.split(",");e.push(F("#ffffff",i[0],i[1],"report_"+i[0]+"_"+i[1]))}}catch(e){console.warn("failed to add icon to report based on configuration"),r.reject(e)}return o.all(e).then(function(e){for(var t=0,i=0;i<n.length;i++)n[i].icon&&(n[i].icon=e[t],t++);r.resolve(n)}).catch(function(e){r.resolve(reportRows)}),r.promise},D=function(e){for(var t=o.defer(),i=Object.keys(e),n={},r=0;r<i.length;r++)n[i[r]]=I(e[i[r]]);return o.all(n).then(function(e){t.resolve(e)}),t.promise},I=function(i){for(var n=o.defer(),e=[],t=0;t<i.length;t++){var r=i[t],s=r.sObjectType.split(/(?=[A-Z])/).join("_").toLowerCase();"ServiceAppointment"===r.sObjectType&&(s="work_order"),"ServiceResource"===r.sObjectType&&(s="home"),"Asset"===r.sObjectType&&(s="product"),e.push(F("#ffffff","standard",s,"report_"+s))}return o.all(e).then(function(e){for(var t=0;t<i.length;t++)i[t].reportIcon=e[t];n.resolve(i)}).catch(function(e){n.resolve(i)}),n.promise};function k(e){var t=o.defer(),i=new XMLHttpRequest;return i.onload=function(){if(404==i.status)t.reject();else{var e=new FileReader;e.onloadend=function(){t.resolve(e.result)},e.readAsDataURL(i.response)}},i.open("GET",e),i.responseType="blob",i.send(),t.promise}function R(e){var t=_slicedToArray(e,2),i=t[0],n=t[1];return window.GanttMap.icons.globalIcon+"/"+i+"/"+n+".svg"}function F(r,t,e,s){var a=o.defer();try{if(S.dynamicIcons[s])a.resolve(S.dynamicIcons[s]);else k(R([t,e])).then(function(e){var t=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),i=window.atob(t).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+r+'"'),n=window.btoa(i);S.dynamicIcons[s]="data:image/svg+xml;charset=utf-8;base64,"+n,a.resolve(S.dynamicIcons[s])}).catch(function(e){k(R([t,"report"])).then(function(e){var t=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),i=window.atob(t).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+r+'"'),n=window.btoa(i);S.dynamicIcons[s]="data:image/svg+xml;charset=utf-8;base64,"+n,a.resolve(S.dynamicIcons[s])})})}catch(e){a.reject(e.message)}return a.promise}var M=function(s,a){for(var e=arguments.length,o=Array(2<e?e-2:0),t=2;t<e;t++)o[t-2]=arguments[t];return new Promise(function(i,n){var e,t=(e=[RemoteActions[s]]).concat.apply(e,o).concat(function(e,t){t.status?i(e):n(t)}).concat({buffer:!0,escape:!1}),r=t;r=a?t.filter(function(e){return!!e}):t.map(function(e){return void 0===e?null:e}),Visualforce.remoting.Manager.invokeAction.apply(Visualforce.remoting.Manager,r)})},x=function(e,t){if(t.visualforce){var i=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===e.length?c.open(t.name,t.visualforce+"?id="+e[0]+"&start="+i+"&end="+n):c.open(t.name,t.visualforce+"?services="+e.join(",")+"&start="+i+"&end="+n)}else v.runCustomServiceAction(t.className,e,scheduler._min_date,scheduler._max_date).then(function(e){e&&a.addNotification(t.name,e,null,null)}).catch(function(e){return a.addNotification(t.name,e.message,null,null)})},O=function(e,t){switch(t){case"service":i.recentlyUsed[e]=!0,r.open(e);break;case"liveposition":s.open(e);break;case"report":default:a.openSObjectLink(e)}},P=function(e){if(e||!S.reactMapInitialize){var t=q(),i=j(),n={ganttMapDefinitions:window.GanttMap,livePositions:i,territories:t,type:f.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_INITIALIZATION};b(n)}},E=function(){if(S.reactMapInitialize){var e={filteredServices:H(),type:f.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_FILTER};b(e)}else setTimeout(function(){P(!1)},5e3)},N=function e(){if(S.reactMapInitialize){var t={relevantStms:z(),type:f.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_VIEW};b(t)}else setTimeout(function(){e()},5e3)},$=function e(){if(S.reactMapInitialize){var t={livePositions:j(),type:f.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_LIVE_POSITION};b(t)}else setTimeout(function(){e(servicesToUpdate,deletedServicesIds,clearServices)},5e3)};h.register("positions",function(e){$()});var G=_.debounce(E,300,{maxWait:1e3}),V=_.debounce(N,300,{maxWait:1e3}),H=function(){for(var e={},t=0;t<i.filteredServices.servicesArray.length;t++)e[i.filteredServices.servicesArray[t].id]=!0;return e},B=function(e){var t={};if(Array.isArray(e))for(var i=0;i<e.length;i++)t[e[i].id]=U(e[i]);else for(var n in e)t[e[n].id]=U(e[n]);return t},U=function(e){var t={fields:{}};t.latitude=e.latitude,t.longitude=e.longitude,t.pinned=e.pinned,t.statusCategory=e.statusCategory,t.resourceId=e.resourceId,t.id=e.id,t.Status=e.Status,t.AppointmentNumber=e.AppointmentNumber,t.dragData=e.isScheduled()?null:a.getRelevantDataForDraggingService(e),t.icons=e.icons,window.paletteViewActive&&e.ganttPaletteColor?t.color=e.ganttPaletteColor.color:e.ganttColor?t.color=e.ganttColor:t.color=a.getColorHexByCategory(e.statusCategory);for(var i=0;i<S.serviceFields.length;i++){var n=void 0,r=void 0,s=void 0;void 0!==e.fields[S.serviceFields[i].APIName]&&(r=e.fields[S.serviceFields[i].APIName],s=e.fields[S.serviceFields[i].FullAPIName],n=S.serviceFields[i].APIName!==S.serviceFields[i].FullAPIName?{Value:r,Id:s}:{Value:r}),t.fields[S.serviceFields[i].APIName]=n}return t},z=function(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i={},n=l.resourcesByPrimariesAndRelocations();for(var r in n){var s=n[r];for(var a in s){var o=s[a];isIntersect(e,t,o.effectiveStartDate,o.effectiveEndDate)&&(i[o.id]=o)}}return i},j=function(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=l.resourcesAndTerritories(),n=d.lastKnownPositions(),r={};for(var s in n){var a=i[s];for(var o in a){var c=a[o];isIntersect(e,t,c.effectiveStartDate,c.effectiveEndDate)&&(r[n[s].id]={latitude:n[s].latitude,longitude:n[s].longitude,resource:c.serviceResource__r,lastKnowLocation:n[s]})}}return r},q=function(){var t=p.GetUserSettingsProperty("locations"),i=u.territories();return Object.keys(i).filter(function(e){return t.includes(e)}).reduce(function(e,t){return e[t]=i[t],e},{})};return{showServiceOnMap:function(e,t,i){S.showServiceOnMap=!0,S.showServiceOnMapId=e,"map"===i||t||n.$broadcast("changeWorkingState","map"),S.reactMapInitialize?setTimeout(function(){var e={serviceId:S.showServiceOnMapId,type:f.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};b(e),S.showServiceOnMap=!1,S.showServiceOnMapId=void 0},150):P(!1)},initializeGanttMap:P,updateGanttMapServices:function e(t,i,n){var r=2<arguments.length&&void 0!==n&&n;if(S.reactMapInitialize){if(_.isEmpty(t)&&_.isEmpty(i))return;var s={clearServices:!1,services:B(t),deletedServicesIds:i,type:f.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_SERVICES_UPDATE};b(s)}else setTimeout(function(){e(t,i,r)},5e3)},updateGanttMapFilter:G,updateGanttMapView:V,IFRAME_SEND_MESSAGES_TYPES:f.IFRAME_SEND_MESSAGES_TYPES,reactDomain:S.reactDomain}}e.$inject=["$rootScope","$q","TimePhasedDataService","LastKnownPositionService","utils","servicesService","ServiceAppointmentLightboxService","ResourceLightboxService","bulkScheduleService","FieldSetFieldsService","GeneralLightbox","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","SERVICE_STATUS","RegisterService"],angular.module("serviceExpert").factory("MapService",e)}(),function(){function e(n,r,s,a,o,e,c,l){for(var d=null,t=[],i=0;i<60;i++)t.push(i);function u(){o.setLightBoxStatus(!1),d.$destroy()}function p(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(d.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(d.endMinutes)),i.setHours(parseInt(d.endHour)),i<d.actionStart?alert(customLabels.finishAfterStart):d.actionFinish=i,scheduler.destroyCalendar(),d.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(d.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(d.startMinutes)),i.setHours(parseInt(d.startHour)),i>d.actionFinish?alert(customLabels.startBeforeEnd):d.actionStart=i,scheduler.destroyCalendar(),d.$apply()}})}function m(){var e=new Date(d.actionStart);e.setMinutes(parseInt(d.startMinutes)),e.setHours(parseInt(d.startHour)),e>=d.actionFinish?(alert(customLabels.startBeforeEnd),d.startMinutes=d.actionStart.getMinutes(),d.startHour=d.actionStart.getHours().toString()):d.actionStart=e}function h(){var e=new Date(d.actionFinish);e.setMinutes(parseInt(d.endMinutes)),e.setHours(parseInt(d.endHour)),e<=d.actionStart?(alert(customLabels.finishAfterStart),d.endMinutes=d.actionFinish.getMinutes().toString(),d.endHour=d.actionFinish.getHours().toString()):d.actionFinish=e}function g(){var e,t,i,n=[],r=void 0;for(var s in d.selectedLocations)d.selectedLocations[s]&&n.push(s);0!==n.length?(e=d.actionStart,(r=d.actionFinish).setDate(r.getDate()+1),t="noFilter"===d.optimizeSelectedFilter?null:d.optimizeSelectedFilter,i="all"===d.optimizeAllServices,o.setBulkActionRunning(),l.runOptimization(e,r,n,i,d.orphanServices,d.selectedPolicy.Id,t).then(function(e){e?l.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?c.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){c.openSObjectLink("../"+e)},e.Id):c.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){c.openSObjectLink("../"+e)},e.Id)}):c.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e)}).finally(function(){o.setBulkActionRunning(!1)}),d.closeLightbox()):alert(customLabels.noLocationWasSelected)}function f(){return d.selectedPolicy[fieldNames.SchedulingPolicy.DailyOptimization]}return{open:function(){(d=r.$new(!0)).$on("keypress",function(e,t){27==t.which&&d.$evalAsync(d.closeLightbox)});var e=a.GetUserSettingsProperty("locations");d.filteredLocations=e.map(function(e){return s.territories()[e]}),d.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),d.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),d.startHour="0",d.endHour="0",d.startMinutes="0",d.endMinutes="0",d.dateSelectFinishWidget=p,d.dateSelectStartWidget=v,d.validateDatesStart=m,d.validateDatesEnd=h,d.optimizeAllServices="all",d.runOptimizion=g,d.selectedLocations={},d.checkBoxFields=c.checkBoxFields,d.optimizeSelectedFilter="noFilter",d.orphanServices=!1,d.isInDayPolicy=f,d.policyOptions=o.policies,d.selectedPolicy=d.policyOptions[0];for(var t=0;t<o.policies.length;t++)if(o.policies[t].Id===o.selectedPolicyId){d.selectedPolicy=o.policies[t];break}var i=function(){var e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n\t\t\t\t\t\t\t\t<option value="all">'+customLabels.All+'</option>\n\t\t\t\t\t\t\t\t<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n\t\t\t\t\t\t\t</select>"),t='<div id="PolicyInOptimize">'+customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" title="{{selectedPolicy.Name}}" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n\t\t\t\t\t\t\t\t \t<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields()" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n\t\t\t\t\t\t\t\t \t<option value="noFilter">'+customLabels.None+"</option>\n\t\t\t\t\t\t\t\t </select>")+"</div>";return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div id="BulkActionsLightbox" class="LightboxContainer OptimizationLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.Optimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SelectServicesOptimize+'</p>\n\n                            <div class="selectedTargetLocations">\n                                <label for="bulkRadioSelectedIds">'+customLabels.ChooseLocationsLB+'</label>\n                            </div>\n\n\n                            <div id="bulkLocationNames">\n                                <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                    <input ng-model="selectedLocations[location.id]" type="checkbox" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                    <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                </div>\n\n                                <div>\n                                    <input ng-model="orphanServices" type="checkbox" name="orphanLocationsOptimize" id="orphanLocationsOptimize" />\n                                    <label for="orphanLocationsOptimize">'+customLabels.IncludeServicesNoLocations+'</label>\n                                </div>\n                            </div>\n\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+"\n                                "+t+'\n                                <div class="inday-policy-selected" ng-show="isInDayPolicy()">'+customLabels.In_Day_Policy_Selected+'</div>\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <div class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</div>\n                        </div>\n\n\n                    </div>\n                </div>\n            ")}();i.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(i),d.closeLightbox=u,d.$on("$destroy",function(){return i.remove()}),n(i)(d),i.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("optimizeLightboxService",e)}(),function(){function e(s,a,o,e,c,t,l,d){var u=null;function p(){c.setLightBoxStatus(!1),u.$destroy()}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(u.endMinutes)),i.setHours(parseInt(u.endHour)),i<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=i,scheduler.destroyCalendar(),u.$apply()}})}function m(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(u.startMinutes)),i.setHours(parseInt(u.startHour)),i>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=i,scheduler.destroyCalendar(),u.$apply()}})}function h(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function g(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function f(){var e,t,i,n,r=void 0;e=u.actionStart,(r=u.actionFinish).setDate(r.getDate()+1),i=u.optimizeSelectedFilter,t=u.optimizeCalloutSelectedFilter,n=!u.optimizeOnlyUnscheduledServices,function(){var e={optimizeOnlyUnscheduledServices:u.optimizeOnlyUnscheduledServices,scheduleOnlyResourceFutureJobs:u.scheduleOnlyResourceFutureJobs,selectedPolicy:u.selectedPolicy,optimizeSelectedFilter:u.optimizeSelectedFilter,optimizeCalloutSelectedFilter:u.optimizeCalloutSelectedFilter};localStorage.setItem(sfdcUser+"_RSO",JSON.stringify(e))}(),c.setBulkActionRunning(),d.runRDOptimization(u.resource.id,e,r,n,u.scheduleOnlyResourceFutureJobs,u.selectedPolicy.Id,i,t).then(function(e){e?d.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?l.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){l.openSObjectLink("../"+e)},e.Id):l.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){l.openSObjectLink("../"+e)},e.Id)}):l.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e),l.addNotification(customLabels.Optimization_Failed,e.message)}).finally(function(){c.setBulkActionRunning(!1)}),u.closeLightbox()}return{open:function(e){(u=a.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),u.resource=o.getResources()[e];var t=JSON.parse(localStorage.getItem(sfdcUser+"_RSO"))||{},i=c.selectedPolicyId;t.selectedPolicy&&(i=t.selectedPolicy.Id),u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=v,u.dateSelectStartWidget=m,u.validateDatesStart=h,u.validateDatesEnd=g,"all"===t.optimizeAllServices?t.optimizeOnlyUnscheduledServices=!1:"unscheduled"===t.optimizeAllServices&&(t.optimizeOnlyUnscheduledServices=!0),u.optimizeOnlyUnscheduledServices=t.optimizeOnlyUnscheduledServices||!1,u.runOptimizion=f,u.checkBoxFields=l.checkBoxFields(),u.optimizeSelectedFilter=t.optimizeSelectedFilter||Object.keys(u.checkBoxFields)[0],u.optimizeCalloutSelectedFilter=t.optimizeCalloutSelectedFilter||Object.keys(u.checkBoxFields)[0],u.scheduleOnlyResourceFutureJobs=null==t.scheduleOnlyResourceFutureJobs||t.scheduleOnlyResourceFutureJobs,u.policyOptions=c.policies;for(var n=0;n<c.policies.length;n++)if(c.policies[n].Id===i){u.selectedPolicy=c.policies[n];break}var r=function(){var e='<div id="ResourceToOptimize">'+customLabels.OptimizeTheFollowingResourceDay.replace("$0",'<span class="rdoResourceName">{{resource.name}}</span>').replace("$1",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$2",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>')+"</div>",t=customLabels.OptimizeOnlySAsAssignedTo.replace("$0",'<span class="rdoResourceName" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">{{resource.name}}</span>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer rso-lb" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.RDOptimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+'\n                            </div>\n   \n                            <div class="bulkOptimizeOptionsContainer">\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.Only_optimize_unscheduled_appointments+"\n                                        <cs-tooltip>"+customLabels.Only_optimize_unscheduled_appointments_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="optimizeOnlyUnscheduledServices" type="checkbox" name="optimizeAllServices" id="optimizeAllServices" />\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.SchedulingPolicyName+"\n                                        <cs-tooltip>"+customLabels.rso_scheduling_policy_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions">\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeFilterText+"\n                                        <cs-tooltip>"+customLabels.rso_filter_services_by_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeKeepTheFollowingSAsScheduled+"\n                                        <cs-tooltip>"+customLabels.OptimizeKeepTheFollowingSAsScheduled_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeCalloutSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                         </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">\n                                        '+t+"\n                                        <cs-tooltip>"+customLabels.OptimizeOnlySAsAssignedTo_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="scheduleOnlyResourceFutureJobs" type="checkbox" name="scheduleOnlyResourceFutureSa" id="scheduleOnlyResourceFutureSa" />\n                                    </div>\n                                </div>\n\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <div class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</div>\n                        </div>\n\n\n                    </div>\n                </div>\n            ")}();r.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(r),u.closeLightbox=p,u.$on("$destroy",function(){return r.remove()}),s(r)(u),r.show(),c.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("rdOptimizeLightboxService",e)}(),function(){function e(i,n){return{register:function(e,t){i.register(e,t),n.register(e,t)},unRegister:function(e,t){i.unRegister(e,t),n.unRegister(e,t)}}}e.$inject=["DeltaService","StreamingAPIService"],angular.module("serviceExpert").factory("RegisterService",e)}(),angular.module("serviceExpert").factory("ResourceCapacitiesService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(c,l,e,d,i){var o={};function u(e,t,i){if(e.getTime()!==t.getTime()){var n={};for(var r in scheduler.matrix)n[r]=[i];scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:n,css:"capacityPattern"})}}function p(){for(var e=[],t=l.resourcesAndTerritories(),i=c.getCapacityBasedResources(),n=0;n<=i.length;n++){var r=i[n],s=t[r];for(var a in s){var o=s[a];e.push(d.generateResourceId(r,o.serviceTerritory))}}return e}return e.$on("gotNewTimePhasedObjects",function(e,t){i.areContractorsSupported()&&t.resourcesAndTerritories&&Object.keys(t.resourcesAndTerritories).length&&function(e,t){for(var i=new Date(e),n=null;i<t;){var r=d.formatDayToString(i);if(!o[r]){o[r]=!0,n=n||p();var s=new Date(i);s.setDate(s.getDate()+1);for(var a=0;a<=n.length;a++)u(new Date(i),new Date(s),n[a])}i.setDate(i.getDate()+1)}}(t.start,t.finish)}),{reset:function(){o={}}}}]),angular.module("serviceExpert").factory("ResourceCrewsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,c,t,D,i){var l={};function d(e,t,i){if(e.getTime()!==t.getTime()){var n;n=i.member.ganttLabel?i.member.ganttLabel.encodeHTML():customLabels.XCrewMember.replaceAll(i.member.serviceCrew__r.Name.encodeHTML());var r=i.member&&i.member.ganttColor||null;s(e,t,i,n,"S",r),s(e,t,i,n,"R",r),function(e,t,i,n,r){var s,a,o,c,l,d=i.territoriesByType.P,u=i.territoriesByType.R;if(void 0===u)!function(e,t,i,n,r){var s=i.territoriesByType.P;if(void 0!==s)for(var a=0;a<s.length;a++){var o=s[a],c=useLocationTimezone?o.operatingHours.TimeZone:userTimeZone,l=k(i.member.startDate,"GMT",c),d=k(i.member.endDate,"GMT",c),u=D.intersectDates({start:e,finish:t},{start:l,finish:d}).intersection;if(null!==u){var p=D.intersectDates({start:o.start,finish:o.finish},{start:u.start,finish:u.finish}).intersection;null!==p&&I(p.start,p.finish,o.sectionsToDraw,"crewMember",n,"crewLabelStyle",r)}}}(e,t,i,n,r);else if(void 0!==d)for(var p=0;p<d.length;p++){var v=!1,m=d[p],h=useLocationTimezone?m.operatingHours.TimeZone:userTimeZone,g=k(i.member.startDate,"GMT",h),f=k(i.member.endDate,"GMT",h),S=D.intersectDates({start:g,finish:f},{start:e,finish:t}).intersection;if(null!==S){var _=D.intersectDates({start:m.start,finish:m.finish},{start:S.start,finish:S.finish}).intersection;if(null!==_){for(var y=0;y<u.length;y++){var b=u[y],T=useLocationTimezone?b.operatingHours.TimeZone:userTimeZone,w=k(b.start,T,h),L=k(b.finish,T,h),C=D.intersectDates({start:w,finish:L},{start:e,finish:t}).intersection;if(null!==C){var A=D.intersectDates({start:C.start,finish:C.finish},{start:_.start,finish:_.finish}).intersection;null!==A&&(s=A,a=_,o=m.sectionsToDraw,c=n,l=r,a.start.getTime()<s.start.getTime()&&I(a.start,s.start,o,"crewMember",c,"crewLabelStyle",l),s.finish.getTime()<a.finish.getTime()&&I(s.finish,a.finish,o,"crewMember",c,"crewLabelStyle",l),v=!0)}}v||null===_||I(_.start,_.finish,m.sectionsToDraw,"crewMember",n,"crewLabelStyle",r)}}}}(e,t,i,n,r)}}function s(e,t,i,n,r,s){var a=i.territoriesByType[r];if(void 0!==a&&(showSecondarySTMs||"R"===r))for(var o=0;o<a.length;o++){var c,l,d=a[o],u=useLocationTimezone?d.operatingHours.TimeZone:userTimeZone;l=useLocationTimezone?(c=k(d.start,d.operatingHours.TimeZone,u),k(d.finish,d.operatingHours.TimeZone,u)):(c=d.start,d.finish);var p=D.intersectDates({start:c,finish:l},{start:e,finish:t}).intersection;if(null!==p){var v=k(i.member.startDate,"GMT",u),m=k(i.member.endDate,"GMT",u),h=D.intersectDates({start:p.start,finish:p.finish},{start:v,finish:m}).intersection;null!==h&&I(h.start,h.finish,d.sectionsToDraw,"crewMember",n,"crewLabelStyle",s)}}}function I(e,t,i,n,r,s,a){var o="background: "+(a=a||"#a99be8")+"90; box-shadow: 0 0 0 1px "+a;scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.daily,css:n,html:"<div class='"+s+"' title='"+r+"' style='"+o+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.crewMember+"'></use></svg> "+r+" </div>"}),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.monthly,html:"<div class='crewUtilizBox' title='"+r+"' style='"+o+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.crewMember+"'></use></svg></div>",css:"crewmember_monthly"})}function k(e,t,i){return D.convertDateBetweenTimeZones(e,t,i)}function u(e){var t={},i=c.resourcesAndTerritories();for(var n in e){void 0===t[n]&&(t[n]={},t[n].territoriesByType={},t[n].member=e[n]);var r=i[e[n].serviceResource];for(var s in r){var a=r[s],o=D.generateResourceId(e[n].serviceResource,a.serviceTerritory);void 0===t[n].territoriesByType[a.serviceTerritoryType]&&(t[n].territoriesByType[a.serviceTerritoryType]=[]),t[n].territoriesByType[a.serviceTerritoryType].push({start:a.effectiveStartDate,finish:a.effectiveEndDate,serviceTerritory:a.serviceTerritory,operatingHours:a.serviceTerritory__r.OperatingHours,type:a.serviceTerritoryType,id:a.id,section:o,sectionsToDraw:p(o)})}void 0!==t[n].territoriesByType.P&&t[n].territoriesByType.P.sort(D.sortByTime),void 0!==t[n].territoriesByType.R&&t[n].territoriesByType.R.sort(D.sortByTime),void 0!==t[n].territoriesByType.S&&t[n].territoriesByType.S.sort(D.sortByTime)}return t}function p(e){var t={monthly:{},daily:{}};for(var i in scheduler.matrix)"MonthlyView"===i||"MTDView"===i||"LongView"===i?t.monthly[i]=[e]:t.daily[i]=[e];return t}return t.$on("gotNewTimePhasedObjects",function(e,t){i.areCrewsSupported()&&t.serviceCrewMembers&&Object.keys(t.serviceCrewMembers).length&&function(e,t,i){for(var n=new Date(e),r=void 0;n<t;){var s=D.formatDayToString(n);if(!l[s]){void 0===r&&(r=u(i.serviceCrewMembers)),l[s]=!0;var a=new Date(n);for(var o in a.setDate(a.getDate()+1),r)d(new Date(n),new Date(a),r[o])}n.setDate(n.getDate()+1)}}(t.start,t.finish,t)}),{reset:function(){l={}}}}]),angular.module("serviceExpert").factory("resourceFilterHelper",["$q","sfdcService","$sce","userSettingsManager",function(e,i,t,n){var r={sortBy:customLabels.name,asc:!0,showWorkingResource:!1,booleanFields:{},picklistField:"select_a_field",picklistOptions:[],picklistOptionsModel:[],picklistNullValues:!1,crewsOption:customLabels.showAll},s=JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c"))||r,a=null,o=null,c={selectedPicklist:s.picklistField,resourceFilteringOptions:s.booleanFields,picklistOptionsModel:s.picklistOptionsModel,picklistOptions:s.picklistOptions,picklistNullValues:s.picklistNullValues,crewsSelectionOptions:{selectedPicklist:s.crewsOption,crewFilteringOptions:[customLabels.showAll,customLabels.hideCrewMembers,customLabels.showCrewsAndCrewMembers,customLabels.showOnlyCrews,customLabels.hideCrewsAndCrewMembers]}};function l(e){var t="",i="",n=customLabels.SelectAfieldToResourceFilter;e&&(t="<b>"+customLabels.CurrentlyWorking+"</b>");var r=c.picklistOptions.map(function(e){return e?e.encodeHTML():e});for(var s in a)"BOOLEAN"===a[s][1]&&c.resourceFilteringOptions[a[s][2]]?""===t?t="<b>"+a[s][0].encodeHTML()+"</b>":t+=" and <b>"+a[s][0].encodeHTML()+"</b>":"PICKLIST"===a[s][1]&&c.selectedPicklist===a[s][2]&&(0<(i=r.join("</b> "+customLabels.or+" <b>")).length&&(i="<b>"+a[s][0].encodeHTML()+"</b> is <b>"+i+"</b>"),c.picklistNullValues&&(""===i?i="<b>"+customLabels.None+"</b>":i+=" "+customLabels.or+" <b>"+customLabels.None+"</b>"));return""!==t&&""!==i?n=customLabels.Resources_That_Are_x_and_y.replaceAll(t,i):""===t&&""!==i?n=customLabels.Resources_That_Are_x.replaceAll(i):""!==t&&""==i&&(n=customLabels.Resources_That_Are_x.replaceAll(t)),n}return i.getResourceFieldSetFields().then(function(e){for(var t in(a=e).Name=["Name","STRING","Name"],a)"BOOLEAN"===a[t][1]&&(c.resourceFilteringOptions[t]=s.booleanFields[t]);monthlyViewSettings.isMonthlyAvailable&&(a.__Utilization__=[customLabels.AggregatedUtilization,"UTILIZATION","__Utilization__"])}).then(function(){var e=[];for(var t in a)"PICKLIST"===a[t][1]&&e.push(t);i.getResourcePicklistValues(e).then(function(e){o=e,$("#resourceExplainCrap").html(l(s.showWorkingResource))})}),{getResourceFieldset:function(){return a},getCrewFilteringOptions:function(){return c.crewsSelectionOptions.crewFilteringOptions},getPicklistNames:function(){return o},selectionInfo:c,updateSelectedPicklist:function(e,t){var i=c.picklistOptions.indexOf(e);-1===i?c.picklistOptions.push(e):c.picklistOptions.splice(i,1)},resetFilter:function(){for(var e in c.selectedPicklist="select_a_field",c.length=0,c.picklistOptions.length=0,c.picklistNullValues=!1,c.resourceFilteringOptions)c.resourceFilteringOptions[e]=!1},setAll:function(){for(var e in c.resourceFilteringOptions)c.resourceFilteringOptions[e]=!0},generateFilterExplanation:l,isResourceFilterApplied:function(){if(c.selectedPicklist&&(c.picklistOptions.length||c.picklistNullValues))return!0;for(var e in c.resourceFilteringOptions)if(c.resourceFilteringOptions[e])return!0;return!1},resourceFieldToSortyBy:s.sortBy,resourceCrewFilter:c.crewsSelectionOptions.selectedPicklist,resourceCrewDefaultFilter:customLabels.showAll,descending:s.asc,showWorkingResource:s.showWorkingResource}}]),function(){function e(n,u,r,s,p,a,v,o,e,c,m,l,d){var h=null;function g(){h.killWatch&&h.killWatch(),a.setLightBoxStatus(!1),h.$destroy(),h=null}function f(e){if(e.ganttColor)return e.ganttColor;switch(e.statusCategory){case c.NONE:return"#a5e2d6";case c.SCHEDULED:return"#F9D058";case c.DISPATCHED:return"#8DD8FA";case c.IN_PROGRESS:return"#D68EF9";case c.COMPLETED:return"#95D055";case c.COULD_NOT_COMPLETE:return"#f58556";case c.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}function S(e){e!==h.selectedTab&&(h.selectedTab=e)}function _(e){h.currentlyShowingOnMap=e.id;var t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);h.map.setCenter(t),h.map.setZoom(13)}function y(){h.bounds.isEmpty()||h.map.fitBounds(h.bounds),h.currentlyShowingOnMap=null}function b(){$("#mapCarouselWrapper").slideToggle("slow",function(){}),h.showSideRoute=!h.showSideRoute}function T(e){var t=Math.floor(e/60/60),i=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+i+customLabels.kpi_m}function w(){return h.isDaily?customLabels.KPIsAreCalculatedFrom.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll")):customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll"))}function L(e){return e?moment(e).format("LT"):null}function C(e,t){return""===e||""===t?"":customLabels.Between_x_and_y.replaceAll(moment(e).format("ll"),moment(t).format("ll"))}function A(e){h.resourceSLRPath={stroke:{weight:2,color:"#16325C"},path:[],geodesic:!0,toggle:!0},h.polyLinePath={path:[],geodesic:h.resourceSLRPath.geodesic,strokeColor:h.resourceSLRPath.stroke.color,strokeWeight:h.resourceSLRPath.stroke.weight,strokeOpacity:1},h.markersArray=[],h.bounds=new google.maps.LatLngBounds;var t=function(){var e=h.resourceServicesDate,t=new Date(e);t.setHours(24,0,0,0);var i=v.resourcesAndTerritories();for(var n in i){var r=i[n];for(var s in r){var a=r[s];if(-1<h.terMemberKey.indexOf(p.generateResourceId(a.serviceResource,a.serviceTerritory))&&isIntersect(e,t,a.effectiveStartDate,a.effectiveEndDate))return a}}return null}();h.resourceServices=function(){var e=h.resourceServicesDate,t=new Date(e);return t.setHours(24,0,0,0),scheduler.getEvents(e,t).filter(function(e){return-1<e.resourceId.indexOf(h.terMemberKey)&&e.latitude&&("service"===e.type||h.showAbsencesOnMap&&"na"===e.type)}).sort(function(e,t){return e.start.getTime()-t.start.getTime()})}();var i={};if(t)if(t.latitude)i={latitude:t.latitude,longitude:t.longitude};else{var n=u.territories()[t.serviceTerritory];n.latitude&&(i={latitude:n.latitude,longitude:n.longitude})}var r=null;i.latitude&&(h.markersArray.push({id:t.serviceResource,type:"resource",coords:i,markerOptions:{icon:staticResources.homebase_png},resourceName:h.lightboxResource.name}),r=new google.maps.LatLng(i.latitude,i.longitude),h.polyLinePath.path.push(r),h.bounds.extend(r));for(var s=0;s<h.resourceServices.length;s++){var a=h.resourceServices[s];if(a.latitude){if(h.showServices){var o="service"===a.type?staticResources.service_png:staticResources.resource_absence_icon,c={id:a.id,type:a.type,coords:{latitude:a.latitude,longitude:a.longitude},markerOptions:{icon:o,labelContent:"<span>"+(s+1)+"</span>"+moment(a.start).format("LT"),labelClass:"ResourceMapServiceMarkerLabel",zIndex:200},item:a};h.markersArray.push(c)}var l=new google.maps.LatLng(a.latitude,a.longitude);h.bounds.extend(l),h.resourceSLRPath.path.push({location:l,stopover:!0}),h.polyLinePath.path.push(l)}}if(i.latitude&&h.polyLinePath.path.push(r),!e){if(h.showRoute)if(allowStreetLevelRouting&&0<h.resourceSLRPath.path.length)(new google.maps.DirectionsService).route({origin:r||h.resourceSLRPath.path[0].location,destination:r||h.resourceSLRPath.path[h.resourceSLRPath.path.length-1].location,waypoints:h.resourceSLRPath.path,travelMode:google.maps.TravelMode.DRIVING},function(e,t){t===google.maps.DirectionsStatus.OK?(h.polyLineGoogleObj&&(h.polyLineGoogleObj.setMap(null),h.polyLineGoogleObj=null),h.directionsDisplay||(h.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0})),h.directionsDisplay.setMap(h.map),h.directionsDisplay.setDirections(e)):(window.alert("Directions request failed due to "+t),D())});else D();else h.polyLineGoogleObj?h.polyLineGoogleObj.setMap(null):h.directionsDisplay&&h.directionsDisplay.setMap(null);var d=new google.maps.LatLng(37.794024,-122.394837);h.bounds.isEmpty()?h.map.setCenter(d):h.map.fitBounds(h.bounds)}!function(){var e=m.lastKnownPositions();for(var t in e)i=e[t],void 0,n=u.getResources()[i.id],r={id:i.id+"_position",markerOptions:{icon:staticResources.livepos_png},type:"lastKnownPosition",resourceId:i.id,coords:{latitude:i.latitude,longitude:i.longitude},item:angular.extend(angular.copy(i),{resourceName:n.name})},h.markersArray.push(r);var i,n,r}()}function D(){h.directionsDisplay&&(h.directionsDisplay.setMap(null),h.directionsDisplay=null),h.polyLineGoogleObj&&h.polyLineGoogleObj.setMap(null),h.polyLineGoogleObj=new google.maps.Polyline(h.polyLinePath),h.polyLineGoogleObj.setMap(h.map)}function I(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"resourceServicesDateStart",date:new Date(h.resourceServicesDate),navigation:!0,handler:function(e,t){h.$apply(function(){h.resourceServicesDate=e,h.generateMarkersAndRoute(),d.getResourceActualRoute(h.lightboxResource.id,e).then(R)}),scheduler.destroyCalendar()}})}function k(e){h.resourceServicesDate.setDate(h.resourceServicesDate.getDate()+e),h.generateMarkersAndRoute(),d.getResourceActualRoute(h.lightboxResource.id,h.resourceServicesDate).then(R)}function R(e){h.actualRoute&&(h.actualRoute.visible=!1,h.actualRoute.setMap(h.map));var t={},i=[];for(var n in e.forEach(function(e){"LastKnownLatitude"!==e.Field&&"LastKnownLongitude"!==e.Field||(t[e.CreatedDate]=t[e.CreatedDate]||{},t[e.CreatedDate][-1<e.Field.indexOf("Long")?"lng":"lat"]=e.NewValue,t[e.CreatedDate].date=e.CreatedDate)}),t)i.push(t[n]);h.actualRoute=new google.maps.Polyline({path:i,geodesic:!0,strokeColor:"#ff73bf",strokeOpacity:1,strokeWeight:3}),h.showActual&&h.actualRoute.setMap(h.map)}function F(){h.actualRoute&&(h.actualRoute.visible=h.showActual,h.actualRoute.setMap(h.map))}function M(e){for(var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=[],n=[],r=0;r<t.length;r++)t[r].resource==e&&"contractorcapacity"==t[r].type&&("Week"==t[r].timePeriod&&i.push(t[r]),"Month"==t[r].timePeriod&&n.push(t[r]));h.donutCharts=function(){var e={segmentShowStroke:!1,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:75,animation:!0,animationSteps:100,animationEasing:"easeOutSine",animateRotate:!0,animateScale:!1,showTooltips:!0};return{labels:[customLabels.Hours_Used,customLabels.Hours_Available],weekly:{data:[],percentage:"",start:"",end:"",show:!1,options:e},monthly:{data:[],percentage:"",start:"",end:"",show:!1,options:e}}}(),setTimeout(function(){!function(e,t){var i;e?((i=e.hoursPerTimePeriod-e.hoursInUse)<0&&(i=0),h.donutCharts.weekly.data=[e.hoursInUse,i],h.donutCharts.weekly.percentage=x(e.hoursInUse,e.hoursPerTimePeriod)+"%",h.donutCharts.weekly.start=e.start_date,h.donutCharts.weekly.end=e.end_date,h.donutCharts.weekly.show=!0):(h.donutCharts.weekly.data=[0,10],h.donutCharts.weekly.show=!1,h.donutCharts.weekly.options.showTooltips=!1,h.donutCharts.weekly.start=h.kpiStart,h.donutCharts.weekly.end=h.kpiEnd);t?((i=t.hoursPerTimePeriod-t.hoursInUse)<0&&(i=0),h.donutCharts.monthly.data=[t.hoursInUse,i],h.donutCharts.monthly.percentage=x(t.hoursInUse,t.hoursPerTimePeriod)+"%",h.donutCharts.monthly.start=t.start_date,h.donutCharts.monthly.end=t.end_date,h.donutCharts.monthly.show=!0):(h.donutCharts.monthly.data=[0,10],h.donutCharts.monthly.show=!1,h.donutCharts.monthly.options.showTooltips=!1,h.donutCharts.monthly.start=scheduler.getState().min_date,h.donutCharts.monthly.end=scheduler.getState().max_date)}(i[0],n[0])},1e3)}function x(e,t){return parseFloat((e/t*100).toFixed(2))}function O(){o(function(){h.actualRoute&&h.actualRoute.setMap(h.map)},500)}return{open:function(e,t){if(!h){(h=n.$new(!0)).lightboxResource=u.getResources()[e],h.terMemberKey=t||v.getResoruceGanttIdByDate(e,scheduler.getState().min_date),h.selectedTab="details",h.urls={related:r.trustAsResourceUrl(customResourceRelatedListLightboxPage+"?id="+e).toString(),chatter:r.trustAsResourceUrl(customResourceChatter+"?id="+e).toString(),details:r.trustAsResourceUrl(customResourceLightboxPage+"?id="+e).toString(),calendar:r.trustAsResourceUrl("vf079_ResourceCalendar?id="+e).toString()},h.urls.custom1=CustomResourceTab1?r.trustAsResourceUrl(CustomResourceTab1+"?id="+e).toString():null,h.urls.custom2=CustomResourceTab2?r.trustAsResourceUrl(CustomResourceTab2+"?id="+e).toString():null,h.changeTab=S,h.closeLightbox=g,h.chatterAvailable=fieldTrackingEnabled.resource,h.formatTravel=T,h.openConsoleTab=p.openConsoleTab,h.formatKpitText=w,h.formatDateToTime=L,h.formatCapacityKpitText=C,h.getContractorCapacityStatus=M,h.isMapEnabled=a.isMapEnabled(),h.contractorSupport=a.areContractorsSupported(),h.isDaily="ZoomLevel3"==scheduler._mode,h.actualRoute=null,h.showActual=!0,h.toggleShowRoute=F,h.toggleActualVisibilityWhenMapTabClicked=O,h.boundOnCaruselItem=_,h.showSideRoute=!0,h.zoomOutToFitAll=y,h.slideToggle=b,h.currentlyShowingOnMap=null,h.changeDate=k,h.getColorByStatus=f,h.showAbsencesOnMap=window.showAbsencesOnMap,Chart.defaults.global.colours=["#16325c","#DCDCDC","#F7464A","#46BFBD","#FDB45C","#949FB1","#4D5360"],h.donutCharts=null,h.haveItemsToShowOnSideRoute=function(e){for(var t=0;t<e.length;t++)if("na"===e[t].type||"service"===e[t].type)return!0;return!1},h.isMapEnabled&&(h.getServiceInfoRowClass=p.getServiceInfoRowClass,h.firstMapShow=!0,h.showRoute=!0,h.showTrafficLayer=!1,h.showServices=!0,h.mapControl={},h.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER},fullscreenControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},h.serviceInfoWindow={show:!1},h.livePosInfoWindow={show:!1},h.resourceInfoWindow={show:!1},h.absenceInfoWindow={show:!1},h.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},absence:{pixelOffset:new google.maps.Size(0,-38)}},h.resourceServicesDate=scheduler.getState().min_date,h.markersArray=[],l.fieldsSetFields().then(function(e){h.serviceFields=e.MapInfo}),h.killWatch=h.$watch("selectedTab",function(e){"map"==e&&o(function(){if(h.map=h.mapControl.getGMap(),google.maps.event.trigger(h.map,"resize"),h.firstMapShow){h.firstMapShow=!1;var e=h.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};e.setOptions(t),h.firstMapShow=!1,h.generateMarkersAndRoute()}},0)}),h.generateMarkersAndRoute=A,h.openDatePicker=I,h.routeToggled=function(){h.generateMarkersAndRoute();var e=h.showRoute?h.map:null;h.polyLineGoogleObj&&h.polyLineGoogleObj.setMap(e),h.directionsDisplay&&h.directionsDisplay.setMap(e)},h.markerClicked=function(e,t,i){!function(e){var t=e.type;switch(h.serviceInfoWindow.show=!1,h.absenceInfoWindow.show=!1,h.livePosInfoWindow.show=!1,h.resourceInfoWindow.show=!1,h.currentMarker=e,t){case"service":h.serviceInfoWindow.show=!0;break;case"lastKnownPosition":h.livePosInfoWindow.show=!0;break;case"resource":h.resourceInfoWindow.show=!0;break;case"na":case"break":h.absenceInfoWindow.show=!0}o(function(){h.$apply(),p.setMapCloseButtonPosition()},0)}(i)},h.markerCloseClicked=function(){h.serviceInfoWindow.show=!1,h.livePosInfoWindow.show=!1,h.absenceInfoWindow={show:!1},h.resourceInfoWindow.show=!1,h.$apply()},h.openFieldSetLink=function(e,t){p.openLink(e,t)},h.openLink=function(e){p.openSObjectLink(e)}),function(e){var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date);h.resourceKpi={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};for(var i=0;i<t.length;i++)t[i].resource==e&&("na"===t[i].type&&(h.resourceKpi.avgTravelTime+=t[i].travelTo+t[i].travelFrom),"service"===t[i].type&&(h.resourceKpi.total++,t[i].statusCategory==c.COMPLETED&&h.resourceKpi.completed++,t[i].violations&&h.resourceKpi.violations++,t[i].jeopardy&&h.resourceKpi.jeopardy++,h.resourceKpi.avgTravelTime+=t[i].travelTo+t[i].travelFrom,t[i].start_date&&t[i].end_date&&(h.resourceKpi.totalScheduledDuration+=(t[i].finish-t[i].start)/1e3)));0<t.length&&0<h.resourceKpi.total?h.resourceKpi.avgTravelTime=Math.floor(h.resourceKpi.avgTravelTime/60/h.resourceKpi.total):h.resourceKpi.avgTravelTime=0}(e),M(e);var i=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <img ng-show="lightboxResource.pictureLink" class="resourcePhotoLightbox" ng-src="{{ lightboxResource.pictureLink }}" alt="{{ lightboxResource.name }}" />\n                            <div ng-show="!lightboxResource.pictureLink" alt="{{ lightboxResource.name }}" class="ResourcePhotoIcon resourcePhotoLightbox"></div>\n\n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="lightboxResource.name"></h1>\n                            <span ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+"\n                            </span>\n\n                            <span ng-click=\"changeTab('relatedLists')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'relatedLists'}\">\n                                "+customLabels.Related+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <span ng-if="isMapEnabled" ng-click="changeTab(\'map\'); " ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                                '+customLabels.Map+"\n                            </span>\n\n                            <span ng-click=\"changeTab('calendar')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'calendar'}\">\n                                "+customLabels.Calendar+'\n                            </span>\n                            \n                            <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                                '+customLabels.CustomResourceTab1+'\n                            </span>\n                            \n                            <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                                '+customLabels.CustomResourceTab2+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxResource.id)" target="_blank" href="../{{ lightboxResource.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <section ng-if="isMapEnabled" id="resourceLightboxMap" ng-show ="selectedTab == \'map\'">\n                            <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                                <ui-gmap-markers click="markerClicked" models="markersArray" idKey="id" coords="\'coords\'" options="\'markerOptions\'"">\n                                </ui-gmap-markers>\n\n                                <ui-gmap-window show="serviceInfoWindow.show" ng-show="currentMarket.type === \'service\'" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" src="'+staticResources.wo_icon_png+'"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="resourceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.resource">\n                                    <div class="googleMapInfoWindowHomebase">\n                                        <svg aria-hidden="true" class="slds-icon homebaseTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.home+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ "'+customLabels.homebase_of+'" | replaceLabels : currentMarker.resourceName }}</span></h1>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                                \n                                \n                                \n                                <ui-gmap-window show="absenceInfoWindow.show && showAbsencesOnMap" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.absence">\n                                    <div class="googleMapInfoWindowAbsence">\n                                        <svg aria-hidden="true" class="slds-icon absenceeTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.absence+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ $parent.$parent.currentMarker.item.name }}</span></h1>\n                                        <div>'+customLabels.Start_time+": {{ $parent.$parent.currentMarker.item.start | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Finish_time+": {{ $parent.$parent.currentMarker.item.end | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Reason+': {{ $parent.$parent.currentMarker.item.reason }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                               \n                                <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                    <div class="googleMapInfoWindowLivePos">\n                                        <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                        \u2028\t<use xlink:href="'+lsdIcons.user+'"></use>\n                                    \u2028\t</svg>\n                                        <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                        <div>'+customLabels.Last_seen+' {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.resourceId)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-layer type="TrafficLayer" show=\'showTrafficLayer\'></ui-gmap-layer>\n                                \n                            </ui-gmap-google-map>\n                            <div id="ResourceMapOptions">\n                                <div id="ResourceMapOptionsWrapper">\n                                    <input ng-model="$parent.showServices" ng-change="generateMarkersAndRoute(true)" type="checkbox" id="ResourceServicesFilter"></input>\n                                    <label for="ResourceServicesFilter">'+customLabels.Show_services_for+'</label>\n                                    <div class="resourceMapDateArrow" ng-click="changeDate(-1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronleft+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <u id="resourceServicesDateStart" class="bulkDatePicker" ng-click ="openDatePicker()" >{{resourceServicesDate | amDateFormat:\'L\'}}</u>\n                                    <div class="resourceMapDateArrow" ng-click="changeDate(1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronright+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showRoute" ng-change="routeToggled()" type="checkbox" id="RouteFilter"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="RouteFilter">'+customLabels.Route+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showActual" ng-change="toggleShowRoute()" type="checkbox" id="actualToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="actualToggle">'+customLabels.ActualRoute+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="showTrafficLayer" type="checkbox" id="trafficToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="trafficToggle">'+customLabels.Traffic+'</label>\n                                </div>\n                            </div>\n                            <div id="ResourceMapCarousel" ng-show="resourceServices.length > 0">\n                                <div class="truncate" id="toggleResourceMapServiceCarousel" ng-click="slideToggle()">\n                                    {{showSideRoute ? "'+customLabels.HideDetailedRoute+'" : "'+customLabels.ToggleDetailedRoute+'"}}\n                                </div>\n                                <div id="mapCarouselWrapper">\n                                    <div class="carouselArrow crouselLeft">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronleft+'"></use>\u2028</svg>\n                                    </div>\n                                    <div class="carouselArrow crouselRight">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronright+'"></use>\u2028</svg>                                \n                                    </div>\n                                    \n                                    \n                                    <div class="resource-map-no-route" ng-hide="haveItemsToShowOnSideRoute(markersArray)">\n                                        There are no services or absences to show\n                                    </div>\n                                    \n                                    <div ng-repeat="marker in markersArray" class="carouselItem" ng-if=" marker.type === \'na\' || marker.type == \'service\'">\n                                    \n                                        <div ng-if="marker.type === \'na\'">\n                                            <span class="numberingOnMapRouteSide numberingOnMapRouteSideNA" title="'+customLabels.CenterOnMapp+'" ng-click="boundOnCaruselItem(marker)">{{$index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.name}}</span>\n  \n                                            <div class="appointment-rows">\n                                                <div>'+customLabels.Start_time+": {{ marker.item.start | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Finish_time+": {{ marker.item.end | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Reason+': {{ marker.item.reason }}</div>\n                                            </div>\n                                        </div>\n                                    \n                                    \n                                        <div ng-if="marker.type == \'service\'">\n                                            <span class="numberingOnMapRouteSide" title="'+customLabels.CenterOnMapp+'" ng-click="boundOnCaruselItem(marker)" ng-style="{\'background-color\': getColorByStatus(marker.item)}">{{$index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.AppointmentNumber}}</span>\n                                            \x3c!-- <div class="boundOnMarker globalBlueButton" ng-click="boundOnCaruselItem(marker)" ng-hide="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.checkin+'"></use>\u2028</svg>                                            \n                                            </div>\n                                            <div class="boundOnMarker globalBlueButton" ng-click="zoomOutToFitAll()" ng-show="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.location+'"></use>\u2028</svg>                                            \n                                            </div>--\x3e\n                                            <div class="appointment-rows">\n                                                <span ng-repeat="field in serviceFields" class="">\n                                                    <div ng-show="marker.item[field.JsAPIName]">{{field.Label}}: <span ng-click="openFieldSetLink(marker.item, field)" ng-class="getServiceInfoRowClass(field)">{{marker.item | displayFieldSetField : field}}</span></div>                                            \n                                                </span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </section>\n\n                        <div class="capacitiesDonuts" ng-show="selectedTab == \'details\' && lightboxResource.isCapacityBased && contractorSupport">\n                            <div id="weeklyCapacity">\n                                <div id="weeklyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.weekly.show" ng-bind="donutCharts.weekly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.weekly.show">'+customLabels.No_Weekly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.weekly.show" title="'+customLabels.Weekly_Capacity+'">'+customLabels.Weekly_Capacity+'</div>\n                                </div>\n                                <canvas id="weeklyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.weekly.options"\n                                        chart-data="donutCharts.weekly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.weekly.start, donutCharts.weekly.end)}}</div>\n                            </div>\n\n                            <div id="monthlyCapacity">\n                                <div id="monthlyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.monthly.show" ng-bind="donutCharts.monthly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.monthly.show">'+customLabels.No_Monthly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.monthly.show" title="'+customLabels.Monthly_Capacity+'">'+customLabels.Monthly_Capacity+'</div> \n                                </div>\n                                <canvas id="monthlyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.monthly.options"\n                                        chart-data="donutCharts.monthly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.monthly.start, donutCharts.monthly.end)}}</div>\n                            </div>\n                        </div>\n\n                        <div id="KPIforResource" ng-show="selectedTab == \'details\'" ng-class="{KPIforResourceWithCapacity: (lightboxResource.isCapacityBased && contractorSupport)}">\n                            <div class="kpiIndicator" ng-show="!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport)">\n                                <div class="kpiResourceValue" >\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.totalScheduledDuration) }}\n                                </div>\n\n                                '+customLabels.Total_Scheduled+'\n                            </div>\n\n                            <div class="kpiIndicator" ng-show="isMapEnabled && (!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport))">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIconTravel"><use xlink:href="'+lsdIcons.car+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.avgTravelTime * 60) }}\n                                </div>\n\n                                '+customLabels.Average_Travel+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\u2028</svg>\n                                    {{ resourceKpi.violations }}\n                                </div>\n\n                                '+customLabels.Violations+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.jeopardy+'"></use>\u2028</svg>\n                                    {{ resourceKpi.jeopardy }}\n                                </div>\n                                 '+customLabels.In_Jeopardy+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\u2028</svg>\n                                    {{ resourceKpi.completed }}/{{ resourceKpi.total }}\n                                </div>\n\n                                '+customLabels.Completed+'\n                            </div>\n\n                            <div class="KpiRange">{{formatKpitText()}}</div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.details }}" id="detailsIframeResource" ng-class="{detailsIframeResourceContractor: lightboxResource.isCapacityBased && contractorSupport}" ng-show="selectedTab == \'details\'"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.related }}" id="relatedListIframeResource" ng-show="selectedTab == \'relatedLists\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable" id="chatterIframeResource" ng-show="selectedTab == \'chatter\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.calendar }}" id="calendarIframeResource" ng-show="selectedTab == \'calendar\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}" class="resourceLightboxIframe"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");i.find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),angular.element("body").append(i),a.setLightBoxStatus(),h.$on("$destroy",function(){return i.remove()}),h.$on("keypress",function(e,t){27==t.which&&h.$evalAsync(h.closeLightbox)}),s(i)(h),p.safeApply(h),d.getResourceActualRoute(h.lightboxResource.id,scheduler.getState().min_date).then(function(e){R(e),setTimeout(function(){h.actualRoute.setMap(h.map)},1500)})}}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$sce","$compile","utils","StateService","TimePhasedDataService","$timeout","SERVICE_STATUS","SERVICE_CATEGORY","LastKnownPositionService","FieldSetFieldsService","sfdcService"],angular.module("serviceExpert").factory("ResourceLightboxService",e)}(),function(){function e(s,a,o,l,e,d,u,p,v,t,c){var m=null,h=[];function g(){m.$destroy()}function f(){e.open(m.resourceId,m.section)}function S(t){var e,i=void 0;i=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),e=u.selectedPolicyId;var n={FillInSchedule:{FunctionName:d.runFillInSchedule,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.Fill_in_Schedule),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.Fill_in_Schedule,m.menuResource.name,moment(i).format("L"))},FixOverlaps:{FunctionName:d.runFixOverlaps,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.FixOverlaps),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.FixOverlaps,m.menuResource.name,moment(i).format("L"))}};if(useLocationTimezone){var r=i,s=addDaysToDate(i,1),a={start_date:r,end_date:s},o=v.getIntersectingSrstOffset(a,m.resourceId),c=l.getUserOffset(r);l.getUserOffset(s);i.setMinutes(r.getMinutes()+c-o)}(0,n[t].FunctionName)(i,m.resourceId,e).then(function(e){e?(e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?l.addNotification(n[t].NotificationHeaderText,n[t].NotificationText,function(e){l.openSObjectLink("../"+e)},e.Id):l.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){l.openSObjectLink("../"+e)},e.Id),p.updateOptimizationRequest(e)):l.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).then(function(){}).catch(function(e){console.warn(t+" failed :("),console.log(e),l.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){}),g()}function _(){var e=a.getResources(),t=v.currentCrewToShow;t={};var i=v.crewToServiceCrewMembers()[m.menuResource.serviceCrew];for(var n in t[m.resourceId]=m.menuResource,i)t[i[n].serviceResource]=e[i[n].serviceResource],void 0===t[i[n].serviceResource].members&&(t[i[n].serviceResource].members={}),t[i[n].serviceResource].members[n]=i[n];v.currentCrewToShow=t,g(),s.$broadcast("moveToCrewView")}function y(){t.open(m.resourceId)}function b(t){var e=null,i=window.__lastResourceClicked.key.split("_")[1],n=v.resourcesAndTerritories()[m.resourceId];for(var r in n)n[r].serviceTerritory===i&&(e=r);if(t.visualforce){var s=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),a=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();return c.open(t.name,t.visualforce+"?id="+m.resourceId+"&stm="+e+"&start="+s+"&end="+a),void g()}d.runCustomResourceAction(t.className,m.resourceId,e,scheduler._min_date,scheduler._max_date).then(function(e){return l.addNotification(t.name,e,null,null)}).catch(function(e){return l.addNotification(t.name,e.message,null,null)}),g()}return l.customActionsPromise.then(function(){var e=l.getCustomActions("resource");h.push.apply(h,_toConsumableArray(e))}),{open:function(e,t,i){(m=s.$new(!0)).menuResource=a.getResources()[e],m.resourceId=e,m.section=t,m.openResourceLightbox=f,m.runDynamicGanttFunction=S,m.hasCustomPermission=l.hasCustomPermission,m.showCrew=_,m.openResourceDayOptimizationLightbox=y,m.isCrew=!1,m.customActions=h,m.runCustomResourceAction=b,void 0!==a.getCrewResources()[e]&&(m.isCrew=!0);var n=angular.element('\n                    <div id="resourceMenu" class="resourceMenuContainer">\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceLightbox()" title="'+customLabels.Details+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Details+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceDayOptimizationLightbox()" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Resource_Schedule_Optimization\')" title="'+customLabels.RDOptimize+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.magicwand+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.RDOptimize+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FixOverlaps\')" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Fix_Overlaps\')" title="'+customLabels.FixOverlaps+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.crossfilter+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.FixOverlaps+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FillInSchedule\')" ng-hide="!hasCustomPermission(\'Fill_in\')" title="'+customLabels.Fill_in_Schedule+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.summarydetail+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Fill_in_Schedule+'\n                        </div>\n                        <div class="truncate resMenuSingleAction" ng-click="showCrew()" ng-show="isCrew" title="'+customLabels.showCrewAndHisMemebers+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon crew-icon-menu">\n                                    <use xlink:href="'+lsdIcons.crew+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.showCrew+'\n                        </div>\n                        \n                        \n                        <div ng-repeat="action in customActions" class="truncate resMenuSingleAction" ng-click="runCustomResourceAction(action)" title="{{action.name}}">\n                        \n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon customResourceAction" ng-show="action.icon">\n                                    <use xlink:href="{{action.icon}}"></use>\n                                \u2028</svg>\n                            </div>\n                        \n                            {{action.name}}\n                        </div>\n                    </div>\n                '),r=$($(i).closest(".resourceMenuBtn")).offset();angular.element("body").append(n),$(".resourceMenuContainer").css({top:r.top,left:r.left}),m.$on("$destroy",function(){return n.remove()}),angular.element("body").on("mousedown",function(e){for(var t=["resMenuSingleAction"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;g(),e.stopPropagation(),angular.element("body").off("mousedown")}),o(n)(m),l.safeApply(m)}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$compile","utils","ResourceLightboxService","sfdcService","StateService","DeltaService","TimePhasedDataService","rdOptimizeLightboxService","GeneralLightbox"],angular.module("serviceExpert").factory("ResourceSmallMenu",e)}(),function(){function e(e,t){var r={territories:e.defer(),resources:e.defer(),operatingHours:e.defer()},s={},a={},o={},c=[],l={},d={},u={};function i(){var i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,n=e.defer();return t.GetResourcesAndTerritories().then(function(e){i&&i(),n.resolve();var t=e.withoutSharingTerritories.reduce(function(e,t){return e[t.Id]=t,e},{});e.territories.forEach(function(e){e.IsActive&&(s[e.Id]=new ServiceTerritory(e),s[e.Id].hasSharing=!t[e.Id]),a[e.Id]=new ServiceTerritory(e)}),e.resources.forEach(function(e){o[e.Id]=new ServiceResource(e),o[e.Id].isCapacityBased&&c.push(e.Id),o[e.Id].serviceCrew&&(d[e.Id]=e,u[o[e.Id].serviceCrew]=e)}),e.operatingHours.forEach(function(e){l[e.Id]=new OperatingHours(e)}),r.territories.resolve(s),r.resources.resolve(o),r.operatingHours.resolve(l)}).catch(function(e){n.reject(e),r.resources.reject(),r.territories.reject(),r.operatingHours.reject(),console.warn("GetResourcesAndTeritorries: unable to load resources, territories, or operating hours"),bootstrap.handleError(e)}),n.promise}return i(),{promises:{territories:function(){return r.territories.promise},resources:function(){return r.resources.promise},operatingHours:function(){return r.operatingHours.promise}},territories:function(){return s},allTerritories:a,getResources:function(){return o},operatingHours:l,getOperatingHours:function(){return l},getCapacityBasedResources:function(){return c},getCrewResources:function(){return d},getCrewToResources:function(){return u},contractorResources:function(){return c},crewResources:function(){return d},crewToResources:function(){return u},getResourceAndTerritories:i,reset:function(){s={},o={},l={},c=[],d={},u={}}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("ResourcesAndTerritoriesService",e)}(),function(){function e(i,n,r,s,a,o,c,l,d,u,p,v,e,m){var h=null;function g(){switch(h.selectedTab){case"account":return h.lightboxService.accountId?h.lightboxService.accountId:h.lightboxService.id;case"wo":return h.lightboxService.parentRecord?h.lightboxService.parentRecord:h.lightboxService.id;default:return h.lightboxService.id}}function f(e){return!("wo"!==e||"WorkOrder"!==h.lightboxService.parentRecordType||!fieldTrackingEnabled.workorder)||(!("wo"!==e||"WorkOrderLineItem"!==h.lightboxService.parentRecordType||!fieldTrackingEnabled.woli)||!("service"!==e||!fieldTrackingEnabled.service))}function S(e){return e===o.LINEITEM||e===o.WORKORDER}function _(){c.setLightBoxStatus(!1),h.killWatch&&h.killWatch(),h.$destroy()}function y(e){e!==h.selectedTab&&(h.selectedTab=e)}return{open:function(e){(h=i.$new(!0)).lightboxService=n.serviceAppointments()[e],h.selectedTab="service",h.urls={service:r.trustAsResourceUrl(customLightboxPage+"?id="+e).toString()},h.lightboxService.accountId&&(h.urls.account=r.trustAsResourceUrl(customAccountLightbox+"?id="+h.lightboxService.accountId).toString()),h.urls.service_chatter=r.trustAsResourceUrl(customServiceChatterLightbox+"?id="+h.lightboxService.id).toString(),h.lightboxService.parentRecordType===o.WORKORDER?(h.urls.wo=r.trustAsResourceUrl(customWoLightbox+"?id="+h.lightboxService.parentRecord).toString(),h.urls.wo_chatter=r.trustAsResourceUrl(customWoChatterLightbox+"?id="+h.lightboxService.parentRecord).toString(),h.urls.related=r.trustAsResourceUrl(customWoRelatedLightbox+"?id="+h.lightboxService.parentRecord).toString()):h.lightboxService.parentRecordType===o.LINEITEM?(h.urls.wo=r.trustAsResourceUrl(customWoliLightbox+"?id="+h.lightboxService.parentRecord).toString(),h.urls.wo_chatter=r.trustAsResourceUrl(customWoliChatterLightbox+"?id="+h.lightboxService.parentRecord).toString(),h.urls.related=r.trustAsResourceUrl(customWoliRelatedLightbox+"?id="+h.lightboxService.parentRecord).toString()):h.lightboxService.parentRecordType===o.ACCOUNT?(h.urls.related=null,h.urls.account=r.trustAsResourceUrl(customAccountLightbox+"?id="+h.lightboxService.parentRecord).toString()):h.urls.related=null,h.urls.custom1=CustomServiceTab1?r.trustAsResourceUrl(CustomServiceTab1+"?id="+h.lightboxService.id).toString():null,h.urls.custom2=CustomServiceTab2?r.trustAsResourceUrl(CustomServiceTab2+"?id="+h.lightboxService.id).toString():null,h.changeTab=y,h.isChatterAvailable=f,h.closeLightbox=_,h.chatterAvailable=fieldTrackingEnabled.service,h.openConsoleTab=a.openConsoleTab,h.isMapEnabled=c.isMapEnabled(),h.selectedSubTabWo="details",h.selectedSubTabService="details",h.showWOTab=S,h.getIdOfObjectInActiveTab=g,h.isMapEnabled&&function(){if(h.serviceIcon=staticResources.wo_icon_png,h.resourceIcon=lsdIcons.user,h.lastSeenLabel=customLabels.Last_seen,h.getServiceInfoRowClass=a.getServiceInfoRowClass,h.currentMarker={},h.map=null,h.mapControl={zoom:19,center:{latitude:0,longitude:0}},h.allMarkersArray=[],h.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},h.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},h.serviceInfoWindow={show:!1},h.livePosInfoWindow={show:!1},u.fieldsSetFields().then(function(e){h.serviceFields=e.MapInfo}),null!=h.lightboxService.latitude&&null!=h.lightboxService.longitude)var i=d(function(){if(!h.mapControl||h.mapControl.getGMap){d.cancel(i),h.map=h.mapControl.getGMap();var e=staticResources.service_png;h.lightboxService.statusCategory==m.COMPLETED&&(e=staticResources.service_completed_png),h.allMarkersArray.push({id:h.lightboxService.id,icon:e,type:"service",coords:{latitude:h.lightboxService.latitude,longitude:h.lightboxService.longitude},item:h.lightboxService}),function(){var e=p.lastKnownPositions();for(var t in e)i=e[t],void 0,n=v.getResources()[i.id],r={id:i.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:i.id,coords:{latitude:i.latitude,longitude:i.longitude},item:angular.extend(angular.copy(i),{resourceName:n.name})},h.allMarkersArray.push(r);var i,n,r}();var t=new google.maps.LatLng(h.lightboxService.latitude,h.lightboxService.longitude);h.map.setCenter(t)}},500);h.openLink=function(e,t){a.openLink(e,t)},h.markerCloseClicked=function(){h.serviceInfoWindow.show=!1,h.livePosInfoWindow.show=!1,h.$apply()},h.markerClicked=function(e,t,i){!function(e){var t=e.type;switch(h.serviceInfoWindow.show=!1,h.livePosInfoWindow.show=!1,h.currentMarker=e,t){case"service":h.serviceInfoWindow.show=!0;break;case"lastKnownPosition":h.livePosInfoWindow.show=!0}l(function(){h.$apply(),a.setMapCloseButtonPosition()},0)}(i)},h.killWatch=h.$watch("selectedTab",function(e){"map"==e&&l(function(){google.maps.event.trigger(h.map,"resize")},0)})}(),h.$on("$destroy",function(){return t.remove()}),h.$on("keypress",function(e,t){27==t.which&&h.$evalAsync(h.closeLightbox)});var t=angular.element('<div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="ServiceLightbox">\n\n                    <div class="lightboxHeaderContainer" id="ServiceLightboxHeader">\n\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                        <h1 class="lightboxHeader">{{lightboxService.name}}</h1>\n\n                        <span ng-click="changeTab(\'service\')" ng-class="{lightboxSelectedTab: selectedTab == \'service\'}">\n                            '+customLabels.Service+'\n                        </span>\n\n                        <span ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-click="changeTab(\'wo\')" ng-class="{lightboxSelectedTab: selectedTab == \'wo\'}">\n                            <div ng-show="lightboxService.parentRecordType === \'WorkOrder\'">'+customLabels.WorkOrder+"</div>\n                            <div ng-show=\"lightboxService.parentRecordType === 'WorkOrderLineItem'\">"+customLabels.Woli+'</div>\n                        </span>\n\n                        <span ng-show="urls.related" ng-click="changeTab(\'relatedList\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedList\'}">\n                            '+customLabels.Related+'\n                        </span>\n\n                        <span ng-if="isMapEnabled" ng-show="lightboxService.latitude && lightboxService.longitude" ng-click="changeTab(\'map\')" ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                            '+customLabels.Map+'\n                        </span>\n\n                        <span ng-show="urls.account" ng-click="changeTab(\'account\')" ng-class="{lightboxSelectedTab: selectedTab == \'account\'}">\n                            '+customLabels.Account+'\n                        </span>\n                        \n                        <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                            '+customLabels.CustomServiceTab1+'\n                        </span>\n                        \n                        <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                            '+customLabels.CustomServiceTab2+'\n                        </span>\n\n                        <div class="ExtendedForm">\n                            <a ng-click="openConsoleTab($event,getIdOfObjectInActiveTab())" target="_blank" href="../{{ getIdOfObjectInActiveTab() }}" title="'+customLabels.ExtandedForm+'">\n                                <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                \u2028</svg>\n                            </a>\n                        </div>\n\n                    </div>\n                   \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'service\') && selectedTab == \'service\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabService == \'details\'}" ng-click="selectedSubTabService=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabService == 'feed'}\" ng-click=\"selectedSubTabService='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'wo\') && selectedTab == \'wo\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabWo == \'details\'}" ng-click="selectedSubTabWo=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabWo == 'feed'}\" ng-click=\"selectedSubTabWo='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'relatedList\' && urls.related" ng-src="{{ urls.related }}"></iframe>  \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'account\' && urls.account" ng-src="{{ urls.account }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}"></iframe>\n                    \n                    \n                    \n                    <div id="lightbox-loading-cover">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.loading+'\n                    </div>\n                    \n                 \n                    <section ng-if="isMapEnabled" id="serviceLightboxMap" ng-show ="selectedTab == \'map\'">\n                        <ui-gmap-google-map pan="false" control="mapControl" center="mapControl.center" options="mapOptions" zoom="mapControl.zoom" class="map-canvas">\n                            <ui-gmap-markers click="markerClicked" models="allMarkersArray" idKey="id" coords="\'coords\'" icon="\'icon\'">\n                            </ui-gmap-markers>\n\n                            <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" ng-src="{{serviceIcon}}"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                            </ui-gmap-window>\n\n                            <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                <div class="googleMapInfoWindowLivePos">\n                                    <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                    \u2028\t<use xlink:href="{{resourceIcon}}"></use>\n                                \u2028\t</svg>\n                                    <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                    <div>{{lastSeenLabel}} {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                </div>\n                            </ui-gmap-window>\n                        </ui-gmap-google-map>\n                    </section>\n\n                </div>\n            </div>');t.find("#ServiceLightbox").draggable({containment:"document",handle:"#ServiceLightboxHeader"}),c.setLightBoxStatus(),s(t)(h),a.safeApply(h,function(){angular.element("body").append(t)})}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","PARENT_RECORD_TYPE","StateService","$timeout","$interval","FieldSetFieldsService","LastKnownPositionService","ResourcesAndTerritoriesService","SERVICE_STATUS","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("ServiceAppointmentLightboxService",e)}(),function(){function e(s,e,i,t,n,r,a){var o={},c=e.filter,l=[],d={};function u(e,t,i,n){var r=n&&n[t.selectedFilter]&&n[t.selectedFilter].old;return useNewFilters&&!r?s("servicesListFilterNew")(e,t,i):s("servicesListFilter")(e,t,i,n)}function p(){for(var e in o)o[e]=!1}return r.register("services",function(e){e.deleted&&e.deleted.forEach(function(e){return delete o[e]})}),t.getServiceListFields().then(function(e){l=e}),{SelectedServices:o,unselectAll:p,selectAll:function(){d=u(i.serviceAppointments(),c,l,a.getFilterMap());for(var e=0;e<d.length;e++)o[d[e].id]=!0},selectViolations:function(){p();var e=angular.copy(c);e.selectedFilter="Violating","Custom filter"==c.selectedFilter&&(e.endDate=c.advancedFilter.maxDate),d=u(d=u(i.serviceAppointments(),c,l,a.getFilterMap()),e,l,a.getFilterMap());for(var t=0;t<d.length;t++)o[d[t].id]=!0},selectInJeopardy:function(){p();var e=angular.copy(c);e.selectedFilter="inJeopardy","Custom filter"==c.selectedFilter&&(e.endDate=c.advancedFilter.maxDate),d=u(d=u(i.serviceAppointments(),c,l,a.getFilterMap()),e,l,a.getFilterMap());for(var t=0;t<d.length;t++)o[d[t].id]=!0},selectUnscheduled:function(){p();var e=angular.copy(c);e.selectedFilter="Unscheduled","Custom filter"==c.selectedFilter&&(e.endDate=c.advancedFilter.maxDate),d=u(d=u(i.serviceAppointments(),c,l,a.getFilterMap()),e,l,a.getFilterMap());for(var t=0;t<d.length;t++)o[d[t].id]=!0},countSelectedServices:function(){var e=0;for(var t in o)o[t]&&e++;return e},getSelected:function(){var e=[];for(var t in o)o[t]&&e.push(t);return e}}}e.$inject=["$filter","servicesService","TimePhasedDataService","sfdcService","DeltaService","RegisterService","GanttFilterService"],angular.module("serviceExpert").factory("ServiceSelectorService",e)}(),function(){function e(e,t,o){var i=[],n={skills:e.defer()};return t.getSkills().then(function(e){for(var t=0;t<e.length;t++)i.push(e[t]);n.skills.resolve(i)}).catch(function(e){n.skills.reject(e),console.log(e),console.warn("unable to get skill list")}),{skills:i,doesHaveSkills:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,r=o.getResources()[e];Array.isArray(t)||(t=[t]);for(var s=0,a=t.length;s<a;s++){if(!r.skills[t[s]])return!1;if(i&&n&&!isIntersect(i,n,r.skills[t[s]].effectiveStartDate,r.skills[t[s]].effectiveEndDate))return!1}return!0},doesHaveSomeSkills:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,r=o.getResources()[e];Array.isArray(t)||(t=[t]);for(var s=0,a=t.length;s<a;s++)if(r.skills[t[s]]&&i&&n&&isIntersect(i,n,r.skills[t[s]].effectiveStartDate,r.skills[t[s]].effectiveEndDate))return!0;return!1},promises:{skills:function(){return n.skills.promise}}}}e.$inject=["$q","sfdcService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("SkillsService",e)}(),function(){function e(e,t,i){var n={};if(i.GetUserSettingsProperty("Toggled_Territories__c")){var r=JSON.parse(i.GetUserSettingsProperty("Toggled_Territories__c"));for(var s in r)n[s]=r[s]}var a={policies:e.defer()};var o=userLocale?userLocale.split("_")[0]:"en",c=[];var l=!1;t.getPolicies().then(function(e){c.push.apply(c,_toConsumableArray(e)),0<c.length?a.policies.resolve(c):a.policies.reject("no policies found")}).catch(function(e){a.policies.reject(e)});var d=!1;var u=!1;var p={minDate:null,maxDate:null};return{isOptimizationEnabled:isOptimizationEnabled,lang:o,isOSX:function(){return-1!=window.navigator.userAgent.indexOf("Mac OS X")},isInConsole:function(){return"undefined"!=typeof sforce?sforce.console.isInConsole():null},policies:c,selectedPolicyId:null,areContractorsSupported:function(){return contractorSupport},isMapEnabled:function(){return mapMode},setLightBoxStatus:function(){d=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isLightboxOpened:function(){return d},setBulkActionRunning:function(){l=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isBulkActionRunning:function(){return l},schedulingRunningFor:{},isScheduleRunning:!1,ganttOpenedTerritories:n,areCrewsSupported:function(){return!0},getStreamingActiveState:function(){return u},setStreamingActiveState:function(e){u=e},setDeltaDates:function(e,t){var i=[moment(e),moment(t)];p.minDate&&(i.push(moment(p.minDate)),i.push(moment(p.maxDate))),p.minDate=moment.min(i).toDate(),p.maxDate=moment.max(i).toDate()},getDeltaDates:function(){return null!==p.minDate&&null!==p.maxDate?{minDate:p.minDate.getTime(),maxDate:p.maxDate.getTime()}:{minDate:null,maxDate:null}},promises:{policies:function(){return a.policies.promise}}}}e.$inject=["$q","sfdcService","userSettingsManager"],angular.module("serviceExpert").factory("StateService",e)}(),function(){function e(r,a,e,o,n,s,c){var l={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]},t=!1,i=new Set,d=new Set,u=new Set,p=new Set,v=new Set,m=new Set,h=new Set,g=new Set,f=new Set,S=new Set;return{HandleNotification:function(e){if(t||(t=!0,setTimeout(function(){var e=function(){var e={};return e.deletedAbsencesArray=Array.from(i),e.updatedAbsencesArray=Array.from(d),e.deletedGanttServicesArray=Array.from(u),e.updatedGanttServicesArray=Array.from(p),e.deletedCapacitiesArray=Array.from(v),e.updatedCapacitiesArray=Array.from(m),e.resourcesIdsArray=Array.from(h),e.updatedAssignResourceArray=Array.from(g),e.updatedOptimizationRequestArray=Array.from(f),e.deletedTimeDependencyArray=Array.from(S),e}();t=!1,i.clear(),d.clear(),u.clear(),p.clear(),v.clear(),m.clear(),h.clear(),g.clear(),f.clear(),S.clear(),function(e){var t=[];0!=e.updatedOptimizationRequestArray.length&&t.push(function(e){var i=r.defer();return a.getOptimiztionRequestsUpdate(e).then(function(t){s.isOptimizationEnabled&&t&&0<t.length&&l.optimizationRequests.forEach(function(e){return e(t)}),i.resolve()}),i.promise}(e.updatedOptimizationRequestArray));0!=e.updatedAssignResourceArray.length&&t.push(function(e){var n=r.defer();return a.getGanttServiceOnAssignedResourceUpdate(e).then(function(e){var t=[];if(e&&0<e.length){var i={};0<e.length&&(i.updated=o.updateTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(c.getRelatedServices(c.getIdsOfSObjects(i.updated))))),i.updated&&l.services.forEach(function(e){return e(i)})}n.resolve(t)}),n.promise}(e.updatedAssignResourceArray));0!=e.resourcesIdsArray.length&&t.push(function(e){var i=r.defer();return a.getLivePositionsStreaming(e).then(function(e){var t=n.updatePositions(e);t.isUpdated&&l.positions.forEach(function(e){return e(t.dic)}),i.resolve()}),i.promise}(e.resourcesIdsArray));0!=e.updatedCapacitiesArray.length&&t.push(function(e){var i=r.defer();return a.getUpdatedResourceCapacities(e).then(function(e){if(e&&0<e.length){var t={};t.updated=o.updateTimePhaseData(e,"capacity").capacities,t.updated&&l.capacities.forEach(function(e){return e(t)})}i.resolve()}),i.promise}(e.updatedCapacitiesArray));0==e.updatedGanttServicesArray.length&&0==e.deletedTimeDependencyArray.length||t.push(function(e,t){var n=r.defer();return a.getUpdatedServices(e,t).then(function(e){var t=[];if(e&&0<e.length){var i={};0<e.length&&(i.updated=o.updateTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(c.getRelatedServices(c.getIdsOfSObjects(i.updated))))),i.updated&&l.services.forEach(function(e){return e(i)})}n.resolve(t)}),n.promise}(e.updatedGanttServicesArray,e.deletedTimeDependencyArray));0!=e.updatedAbsencesArray.length&&t.push(function(e){var s=r.defer();return a.getUpdatedAbsences(e).then(function(e){var t=[],i={};if(0<e.length){var n=o.updateTimePhaseData(e,"na");i.updated=n.absences,i.deleted=n.notApprovedAbsencesIds;var r=i.updated.map(function(e){return e.resource}).join(",");t.push.apply(t,_toConsumableArray(c.getRelatedServices(c.getIdsOfSObjects(i.updated),r))),t.push.apply(t,_toConsumableArray(c.getRelatedServices(i.deleted))),(i.updated||i.deleted)&&l.absences.forEach(function(e){return e(i)})}s.resolve(t)}),s.promise}(e.updatedAbsencesArray));0!=e.deletedAbsencesArray.length&&t.push(function(e){var n=r.defer();return a.getDeletedAbsences(e).then(function(e){var t=[],i={};0<e.length&&(i.deleted=o.deleteTimePhaseData(e,"na").absences,t.push.apply(t,_toConsumableArray(c.getRelatedServices(i.deleted))),(i.updated||i.deleted)&&l.absences.forEach(function(e){return e(i)})),n.resolve(t)}),n.promise}(e.deletedAbsencesArray));0!=e.deletedGanttServicesArray.length&&function(e){var t=[];if(e&&0<e.length){var i={};i.deleted=o.deleteTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(c.getRelatedServices(i.deleted))),i.deleted&&l.services.forEach(function(e){return e(i)}),0<t.length&&l.rules.forEach(function(e){return e(t)})}}(e.deletedGanttServicesArray);0!=e.deletedCapacitiesArray.length&&function(e){if(e&&0<e.length){var t={};t.deleted=o.deleteTimePhaseData(e,"capacity").capacities,t.deleted&&l.capacities.forEach(function(e){return e(t)})}}(e.deletedCapacitiesArray);0!=t.length&&r.all(t).then(function(e){e.forEach(function(e){!function(t){t&&0<t.length&&l.rules.forEach(function(e){return e(t)})}(e)})})}(e)},0)),-1<e.channel.indexOf("AbsencesTopic"))try{return void("deleted"==e.data.event.type?i.add(e.data.sobject.Id):d.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("ServicesTopic"))try{return void("deleted"==e.data.event.type?u.add(e.data.sobject):p.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("CapacitiesTopic"))try{return void("deleted"==e.data.event.type?v.add(e.data.sobject):m.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("LivePositionsTopic"))try{return void h.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("AssignedResourcesTopic"))try{return void g.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("OptReqTopic"))try{return void f.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("TimeDependencyTopic"))try{return void("deleted"==e.data.event.type?S.add(e.data.sobject.Id):(p.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment1]),p.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment2])))}catch(e){console.log("Streaming API failure : "+e)}},register:function(e,t){return l[e]&&l[e].push(t)},unRegister:function(e,t){l[e].splice(l[e].indexOf(t),1)}}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils"],angular.module("serviceExpert").factory("StreamingAPIService",e)}(),function(){function e(e,t,i,n,r){var s=["ServicesTopic","AbsencesTopic","AssignedResourcesTopic","LivePositionsTopic","CapacitiesTopic","OptReqTopic","TimeDependencyTopic"];function a(){$.cometd.addListener("/meta/handshake",function(e){e.successful?(console.log("Handshake successful!"),function(){try{for(var e=0;e<s.length;e++){$.cometd.getExtension(s[e])||o(s[e]),$.cometd.subscribe("/topic/"+s[e],t.HandleNotification)}}catch(e){console.log(e)}}(),n.setStreamingActiveState(!0)):(n.setStreamingActiveState(!1),console.warn("Handshake! error: "+e.error))}),$.cometd.addListener("/meta/connect",function(e){e.successful?n.setStreamingActiveState(!0):(console.warn("disconnected! error: "+e.error),n.setStreamingActiveState(!1))}),i.connectToPush()}function o(e){var t="/topic/"+e,i=new cometdReplayExtension;i.setChannel(t),i.setReplay(-1),$.cometd.registerExtension(e,i)}return{initStreaming:function(){try{1==n.getStreamingActiveState()?a():i.connectToPush()}catch(e){console.log(e)}}}}e.$inject=["$q","StreamingAPIService","MstResolver","StateService","DeltaService"],angular.module("serviceExpert").factory("StreamingClientResolverService",e)}(),function(){function e(l,m,d,h,g){var f={initialPhasedData:l.defer()},S={},_={},y={},b={},T={},w={},L={},C={},e={},A={},t={},u=!1,p=!0;function c(e,t){var i=l.defer();"LongView"!==scheduler._mode&&(e.setDate(e.getDate()-window.daysToLoadOnGanttInit),t.setDate(t.getDate()+window.daysToLoadOnGanttInit)),0===e.getMinutes()&&0===e.getHours()||(e.setHours(0),e.setMinutes(0)),0===t.getMinutes()&&0===t.getHours()||(t.setHours(0),t.setMinutes(0),t.setDate(t.getDate()+1));var n="LongView"===scheduler._mode;if("LongView"!==scheduler._mode)for(var r=new Date(e);r<t;r.setDate(r.getDate()+1))if(!A[h.formatDayToString(r)]){n=!0;break}if(!n)return i.resolve(),i.promise;var s=l.defer(),a=l.defer(),o=[],c=l.defer();return p?d.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,e,t,window.bootstrap.loadedUserSettings.locations).then(function(e){e?(u=!0,$("#FirstTimeLoading").remove(),g.get("LeftSideLocationFilteringService").open()):c.resolve()}):c.resolve(),c.promise.then(function(){D(s,e,t,!0,null,null,o),D(a,e,t,!1,null,null),p?p=!1:d.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,e,t,window.bootstrap.loadedUserSettings.locations).then(function(e){e&&h.addNotification(customLabels.MaxedRowsReachedOnGanttNotificationTitle,customLabels.MaxedRowsReachedOnGanttNotificationBody)})}),l.all([a.promise,s.promise]).then(function(e){0<Object.keys(o).length&&m.$broadcast("timePhasedObjectsCheckRules",o),i.resolve(e)}),i.promise}function D(t,i,n,r,e,s,a){var o=[i,n,r,e,s];"LongView"===scheduler._mode&&o.push(window.__currentViewOptions.minServiceDuration,window.__currentViewOptions.minNaDuration,window.__currentViewOptions.showMdt),d.GetTimePhasedObjects.apply(d,o).then(function(e){!function(e,t,i,n,r,s){var a=g.get("monthlyViewHelperService"),o={resourcesAndTerritories:{},resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},serviceCrewMembers:{},start:i,finish:n},c={};"LongView"===scheduler._mode&&(t?window.__gantt.reachedMaxNumberOfServicesInLongView=!!r.maxServicesInLongTermExceeded:window.__gantt.reachedMaxNumberOfAbsencesInLongView=!!r.maxAbsencesInLongTermExceeded,updateViewDebounced());if("LongView"!==scheduler._mode)for(var l=new Date(i);l<n;l.setDate(l.getDate()+1))A[h.formatDayToString(l)]=!0;if(0===f.initialPhasedData.promise.$$state.status&&f.initialPhasedData.resolve(),r.resourcesAndTerritories.forEach(function(e){var t=new ResourcesAndTerritories(e);S[t.serviceResource]=S[t.serviceResource]||{},S[t.serviceResource][t.id]=t,o.resourcesAndTerritories[t.serviceResource]=o.resourcesAndTerritories[t.serviceResource]||{},"S"!==(o.resourcesAndTerritories[t.serviceResource][t.id]=t).serviceTerritoryType&&(_[t.serviceResource]=_[t.serviceResource]||{},_[t.serviceResource][t.id]=t,o.resourcesByPrimariesAndRelocations[t.serviceResource]=o.resourcesByPrimariesAndRelocations[t.serviceResource]||{},o.resourcesByPrimariesAndRelocations[t.serviceResource][t.id]=t),"P"!==t.serviceTerritoryType&&(c[t.serviceResource]=c[t.serviceResource]||{},c[t.serviceResource][t.id]=t)}),0<Object.keys(c).length){var d={};for(var u in y)c[y[u].resource]&&0<Object.keys(c[y[u].resource]).length&&(d[u]=y[u]);m.$broadcast("gotNewTimePhasedObjects",{start:i,finish:n,serviceAppointments:d})}if(r.services.forEach(function(e){var t=new GanttService(e);(!y[t.id]||y[t.id].isChanged(t)||y[t.id].isChainChanged(t)||y[t.id].isGotNewSTM(t))&&(y[e.Id]=t,o.serviceAppointments[e.Id]=t,s.push(t.id),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&a.updateMonthlyCapacity(t))}),r.resourceAbsences.forEach(function(e){b[e.Id]&&e.LastModifiedDate===b[e.Id].lastModifiedDate||(b[e.Id]=new ResourceAbsence(e),o.resourceAbsences[e.Id]=b[e.Id],a.updateMonthlyCapacity(b[e.Id]))}),r.resourceCapacities.forEach(function(e){T[e.Id]&&e.LastModifiedDate===T[e.Id].lastModifiedDate||(T[e.Id]=new ResourceCapacity(e),useLocationTimezone||I(T[e.Id]),o.resourceCapacities[e.Id]=T[e.Id])}),r.serviceCrewMembers.forEach(function(e){w[e.Id]=new ServiceCrewMember(e),L[w[e.Id].serviceResource]||(L[w[e.Id].serviceResource]={}),C[w[e.Id].serviceCrew]||(C[w[e.Id].serviceCrew]={}),C[w[e.Id].serviceCrew][e.Id]=w[e.Id],L[w[e.Id].serviceResource][e.Id]=w[e.Id],o.serviceCrewMembers[e.Id]=w[e.Id]}),m.$broadcast("gotNewTimePhasedObjects",o),t&&r.services.length===maxServicesToLoadEachBulkInGantt){var p=r.services[r.services.length-1].Id;D(e,i,n,t,p,null,s)}else if(t||r.resourceAbsences.length!==maxAbsencesToLoadEachBulkInGantt)e.resolve();else{var v=r.resourceAbsences[r.resourceAbsences.length-1].Id;D(e,i,n,t,null,v)}}(t,r,i,n,e,a)}).catch(function(e){0===f.initialPhasedData.promise.$$state.status&&f.initialPhasedData.reject(e),console.warn("GetTimePhasedObjects: something went wrong "+e.message),h.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),0!==numberOfAllowedRecoveries?(numberOfAllowedRecoveries--,r?(maxServicesToLoadEachBulkInGantt=Math.round(maxServicesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxServicesToLoadEachBulkInGantt+" SERVICES","background: #222; color: #bada55")):(maxAbsencesToLoadEachBulkInGantt=Math.round(maxAbsencesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxAbsencesToLoadEachBulkInGantt+" ABSENCES","background: #222; color: #bada55")),c(i,n)):console.log("maximum allowed times to recover reached")})}function I(e){var t=h.getUserOffset(e.start_date),i=h.getUserOffset(e.end_date),n=r(e,e.resource);e.start_date=e.start_date.setMinutes(e.start_date.getMinutes()+t-n),e.end_date=e.end_date.setMinutes(e.end_date.getMinutes()+i-n)}function i(t){Object.keys(t).forEach(function(e){return delete t[e]})}function r(e,t){var i=S[t],n=null;for(var r in i){var s=i[r];if(isIntersect(s.effectiveStartDate,s.effectiveEndDate,e.start_date,e.end_date)&&"R"===(n=s).serviceTerritoryType)break}var a=n&&n.timezone?n.timezone:"GMT";return-moment.tz.zone(a).offset(h.convertDtToMomentDt(e.start_date,a).valueOf())}return{resourcesAndTerritories:function(){return S},resourcesByPrimariesAndRelocations:function(){return _},serviceAppointments:function(){return y},resourceAbsences:function(){return b},resourceCapacities:function(){return T},resourceToServiceCrewMembers:function(){return L},crewToServiceCrewMembers:function(){return C},serviceCrewMembers:function(){return w},getlongVistedDates:function(){return t},getGanttSectionsIdsByTerritory:function(e,t){var i={};for(var n in S)for(var r in S[n]){var s=S[n][r];e[s.serviceTerritory]&&s.effectiveStartDate<=t&&t<=s.effectiveEndDate&&(i[s.serviceTerritory]||(i[s.serviceTerritory]={tz:s.timezone,resources:{}}),i[s.serviceTerritory].resources[n]=!0)}return i},getRelevantSTMToGanttService:function(e){if(e.resourceId){var t=e.resourceId.split("_")[0],i=(e.resourceId.split("_")[1],S[t]);for(var n in i){var r=i[n];if(isIntersect(r.effectiveStartDate,r.effectiveEndDate,e.start_date,e.end_date))return r}}return null},getTimePhasedObjects:c,updateTimePhaseData:function(e,r){var s=2<arguments.length&&void 0!==arguments[2]&&arguments[2],a=g.get("monthlyViewHelperService"),o=g.get("GanttPalettesService"),c={absences:[],notApprovedAbsencesIds:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){if("na"===r){if(s||b[e.Id]&&e.LastModifiedDate===b[e.Id].lastModifiedDate)return;var t=new ResourceAbsence(e);window.isApprovedAbsencesSupported&&!t.approved&&"break"!==t.type?(b[e.Id]&&(b[e.Id].isDeleted=!0,a.updateMonthlyCapacity(b[e.Id]),delete b[e.Id]),c.notApprovedAbsencesIds.push(e.Id)):(b[e.Id]=t,c.absences.push(b[e.Id]),a.updateMonthlyCapacity(b[e.Id]))}if("service"===r){var i=new GanttService(e);o.updateGanttServicePaletteColor(i),(s||!y[i.id]||y[i.id].isChanged(i)||y[i.id].isChainChanged(i))&&(y[e.Id]=i,c.services.push(i),scheduler._events[i.id]&&scheduler._events[i.id].violations&&i.isScheduled()&&(i.violations=scheduler._events[i.id].violations),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[i.id]||scheduler._events[e.Id])&&a.updateMonthlyCapacity(i))}if("capacity"===r){if(T[e.Id]&&e.LastModifiedDate===T[e.Id].lastModifiedDate)return;T[e.Id]=new ResourceCapacity(e),useLocationTimezone||I(T[e.Id]),c.capacities.push(T[e.Id])}if("stm"===r){var n=new ResourcesAndTerritories(e);S[n.serviceResource]=S[n.serviceResource]||{},"S"!==(S[n.serviceResource][n.id]=n).serviceTerritoryType&&(_[n.serviceResource]=_[n.serviceResource]||{},_[n.serviceResource][n.id]=n)}}),m.$broadcast("updateTimePhaseData",c.services),c},deleteTimePhaseData:function(e,t){var i=g.get("monthlyViewHelperService"),n={absences:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){"na"===t?(b[e.Id]&&(b[e.Id].isDeleted=!0),b[e.Id]&&i.updateMonthlyCapacity(b[e.Id]),delete b[e.Id],n.absences.push(e.Id)):"service"===t?(y[e.Id]&&(y[e.Id].isDeleted=!0),i.updateMonthlyCapacity(y[e.Id]),delete y[e.Id],n.services.push(e.Id)):"capacity"===t&&(delete T[e.Id],n.capacities.push(e.Id))}),m.$broadcast("deleteTimePhaseData",n.services),n},reset:function(){i(S),i(_),i(y),i(b),i(T),i(w),i(e),i(L),i(C),i(A),i(t)},getResoruceGanttIdByDate:function(e,t){for(var i in S[e]){var n=S[e][i];if(n.effectiveStartDate<=t&&t<=n.effectiveEndDate&&"R"===n.serviceTerritoryType)return h.generateResourceId(e,n.serviceTerritory)}var r=[];for(var s in S[e]){var a=S[e][s];if(!showSecondarySTMs&&a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&"P"===a.serviceTerritoryType)return h.generateResourceId(e,a.serviceTerritory);a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&r.push(a.serviceTerritory)}return 0<r.length?h.generateResourceId(e,r):null},getResoruceGanttIdByDateAndTerritory:function(e,t,i){for(var n in S[e]){var r=S[e][n];if(r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&"R"===r.serviceTerritoryType)return h.generateResourceId(e,r.serviceTerritory)}var s=null,a=null;for(var o in S[e]){var c=S[e][o];c.effectiveStartDate<=t&&t<=c.effectiveEndDate&&"P"===c.serviceTerritoryType&&(a=c.serviceTerritory),c.effectiveStartDate<=t&&t<=c.effectiveEndDate&&c.serviceTerritory===i&&(s=c.serviceTerritory)}return s?h.generateResourceId(e,s):h.generateResourceId(e,a)},getIntersectingSrstOffset:r,isTimephaseAvailable:function(e,t){var i=!1;for(var n in S[e]){var r=S[e][n];isIntersect(t,t,r.effectiveStartDate,r.effectiveEndDate)&&(i=!0)}return i},isResourceRelocated:function(e,t){var i=e.split("_")[0],n=e.split("_")[1],r=S[i]||{};for(var s in r){var a=r[s];if(a.serviceTerritory!==n&&"R"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1},isResourceSecondary:function(e,t){var i=e.split("_")[0],n=e.split("_")[1],r=S[i]||{};for(var s in r){var a=r[s];if(a.serviceTerritory===n&&"S"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1},isResourceCrewMembers:function(e,t){var i=e.split("_")[0],n=(e.split("_")[1],L[i]||{});for(var r in n){var s=n[r];if(isIntersect(s.startDate,s.endDate,t,t))return!0}return!1},isCrewViewActive:!1,currentCrewToShow:e,reachedMaxRows:function(){return u},resetReachedMaxRows:function(e){return u=!1},promises:{initialPhasedData:f.initialPhasedData.promise}}}e.$inject=["$q","$rootScope","sfdcService","utils","$injector"],angular.module("serviceExpert").factory("TimePhasedDataService",e)}(),function(){function e(p,v,m){var h={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};return{calculateKpis:function(){var e=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),t=0;!function(){for(var e in h)h[e]=0}();for(var i=m.GetUserSettingsProperty("locations"),n=0;n<e.length;n++){var r=e[n],s=!0;if(showSecondarySTMs&&-1<e[n].resourceId.indexOf(",")){for(var a=e[n].resourceId.split(","),o=null,c=0;c<a.length;c++){var l=a[c].split("_")[1];if(-1<i.indexOf(l)){o=l;break}}if(!o)continue}else if(-1===i.indexOf(e[n].resourceId.split("_")[1]))continue;if("na"===r.type&&(h.avgTravelTime+=r.travelTo+r.travelFrom),"service"===r.type){if(p.areContractorsSupported()&&r.resourceContractor?s=!1:t++,h.total++,r.statusCategory===v.COMPLETED&&h.completed++,r.violations&&h.violations++,r.jeopardy&&h.jeopardy++,s)if(r.isMDT){var d=0;r.mdtTimes.travel.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(d+=e.Finish-e.Start)}),h.avgTravelTime+=d/1e3}else h.avgTravelTime+=r.travelTo+r.travelFrom;if(r.isMDT){var u=0;r.mdtTimes.working.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(u+=e.Finish-e.Start)}),h.totalScheduledDuration+=u/1e3}else h.totalScheduledDuration+=(r.finish-r.start)/1e3}}0<e.length&&0<h.total&&0<t?p.areContractorsSupported()?h.avgTravelTime=Math.floor(h.avgTravelTime/60/t):h.avgTravelTime=Math.floor(h.avgTravelTime/60/h.total):h.avgTravelTime=0},kpis:h}}e.$inject=["StateService","SERVICE_CATEGORY","userSettingsManager"],angular.module("serviceExpert").factory("kpiCalculationsService",e)}(),function(){function e(m,i,t,n,c,s,h,e){var g={regular:0,overtime:0},f={},p={},v={services:!0,na:!0,travel:!0,breaks:!0,overtime:!0};if(e.GetUserSettingsProperty("Utilization_Properties__c")){var r=JSON.parse(e.GetUserSettingsProperty("Utilization_Properties__c"));for(var a in r)v[a]=r[a]}function o(e){if(-1<e.resourceId.indexOf(","))for(var t=e.resourceId.split(","),i=0;i<t.length;i++)f[t[i]]=f[t[i]]||{};else f[e.resourceId]=f[e.resourceId]||{};var n={start:new Date(e.start_date),finish:new Date(e.start)},r={start:new Date(e.start),finish:new Date(e.finish)},s={start:new Date(e.finish),finish:new Date(e.end_date)};return{travelBeforeSum:e.isMDT?l(e.mdtTimes.travel):l(n.start,n.finish),scheduledObjectSum:e.isMDT?l(e.mdtTimes.working):l(r.start,r.finish),travelAfterSum:e.isMDT?{}:l(s.start,s.finish)}}function l(e,n){var r={};if(!n)return e.forEach(function(e){n=new Date(e.Finish);for(var t=new Date(e.Start);t<n;t=d(t)){var i=d(t);i=n<i?n:i,r[S(t)]?r[S(t)]+=Math.round((i.getTime()-t.getTime())/1e3/60):r[S(t)]=Math.round((i.getTime()-t.getTime())/1e3/60)}}),r;for(var t=new Date(e);t<n;t=d(t)){var i=d(t);i=n<i?n:i,r[S(t)]=Math.round((i.getTime()-t.getTime())/1e3/60)}return r}function S(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function d(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,0,0)}function u(e,t,i,n,r){for(var s=!(4<arguments.length&&void 0!==r)||r,a=t.split(","),o=0;o<a.length;o++)for(var c in t=a[o],i)if(f[t]=f[t]||{},void 0===f[t][c]&&(f[t][c]=new y),s)f[t][c][n]+=i[c],-1===f[t][c].events.indexOf(e)&&f[t][c].events.push(e);else{f[t][c][n]-=i[c];var l=f[t][c].events.indexOf(e);-1<l&&f[t][c].events.splice(l,1)}}function y(){this.break=0,this.na=0,this.service=0,this.travel=0,this.capacity=-1,this.overtime=0,this.events=[]}function b(e,t){for(var i=new y,n=S(t),r=i.capacity=0;r<e.length;r++){var s=null,a=e[r].key;if((!contractorSupport||!e[r].contractor)&&(!c.isResourceRelocated(a,t)&&!c.isResourceCrewMembers(a,t)&&!c.isResourceSecondary(a,t))){f[a]||(f[a]={}),f[a][n]&&(s=f[a][n]),s||(f[a][n]=new y,s=f[a][n]),s.capacity;var o=g;m.resourceToWorkingDates[a]&&m.resourceToWorkingDates[a][n]&&(o=m.resourceToWorkingDates[a][n]),s&&(i.break+=s.break,i.na+=s.na>o.regular?o.regular:s.na,i.service+=s.service,i.travel+=s.travel,i.capacity+=-1<o.regular?o.regular:0,i.overtime+=o.overtime)}}return i}function T(e){var t=e%60;return t<10&&(t="0"+t),{hours:Math.floor(e/60),minutes:t}}function w(e){return e.hours+"h "+e.minutes+"m"}function L(e,t,i){var n=2<arguments.length&&void 0!==i?i:g;if(e.service){var r=T(e.service);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                        '+w(r)+"\n                        <div>"+customLabels.TotalScheduled+"</div>\n                    </div>"}if(e.travel){var s=T(e.travel);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>\n                        '+w(s)+"\n                        <div>"+customLabels.TotalTravel+"</div>\n                    </div>"}if(e.na){var a=T(e.na);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.na+'"></use></svg>\n                        '+w(a)+"\n                        <div>"+customLabels.TotalNAs+"</div>\n                    </div>"}if(e.break){var o=T(e.break);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.coffee+'"></use></svg>\n                        '+w(o)+"\n                        <div>"+customLabels.TotalBreaks+"</div>\n                    </div>"}e.capacity,e.overtime;if(n.regular){var c=T(n.regular);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.bucket+'"></use></svg>\n                        '+w(c)+"\n                        <div>"+customLabels.TotalCapacity+"</div>\n                    </div>"}if(n.overtime){var l=T(n.overtime);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_overtime_icon"><use xlink:href="'+lsdIcons.overtime+'"></use></svg>\n                        '+w(l)+"\n                        <div>"+customLabels.TotalOvertime+"</div>\n                    </div>"}return t}return scheduler.attachEvent("onSchedulerReady",function(){scheduler.attachEvent("onXScaleClick",function(e,t,i){"MonthlyView"===scheduler._mode&&scheduler.setCurrentView(t,"ZoomLevel3")}),scheduler.templates.MonthlyView_scalex_class=function(e){return"monthlyXScale"},scheduler.templates.MonthlyView_cell_value=function(e,t){var i=t.key;if(!contractorSupport||!t.contractor){if(t.children){var n=b(t.children,e);return p[t.key]||(p[t.key]={}),function(e,t,i,n){var r=0;v.services&&(r+=e.service);v.breaks&&(r+=e.break);v.na&&(r+=e.na);v.travel&&(r+=e.travel);var s=v.overtime?e.capacity+e.overtime:e.capacity;if(0<s){var a=r/s;a=Math.round(100*a);var o="";o=a<=monthlyViewSettings.high?"style='box-shadow: inset 0 -2px 0 rgb(24, 165, 146)'":a>monthlyViewSettings.high&&a<=monthlyViewSettings.critical?"style='box-shadow: inset 0 -2px 0 #FFEB3B'":"style='box-shadow: inset 0 -2px 0 rgb(236, 95, 84)'";var c="";return e.travel/s>monthlyViewSettings.highTravel/100&&(c='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),"<div "+o+' onmouseout="removeMonthlyLocationTooltip()" onmouseover="createLocationMonthlyTooltip(event,\''+t+"', '"+i.encodeHTML()+"', '"+n+"')\">"+c+'<div class="monthlyViewHoursContainer">'+a+"%</div></div>"}return""}(p[t.key][S(e)]=n,t.key,t.name,S(e))}if(f[i]&&f[t.key][S(e)]){var r=0,s=f[i][S(e)],a=g;if(m.resourceToWorkingDates[i]&&(a=m.resourceToWorkingDates[i][S(e)]||g),v.services&&(r+=s.service),v.breaks&&(r+=s.break),v.na){var o=s.na;s.na>a.regular&&(o=a.regular),r+=o}if(v.travel&&(r+=s.travel),0===r)return;var c=void 0,l=void 0,d=v.overtime?a.regular+a.overtime:a.regular;if(0<d){l=r/d,l=Math.round(100*l);var u="";return s.travel/d>monthlyViewSettings.highTravel/100&&(u='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),c="",c=l<=monthlyViewSettings.high?"rgba(125, 195, 125, "+l/100+")":l>monthlyViewSettings.high&&l<=monthlyViewSettings.critical?"rgba(242, 207, 91, "+(.11+l/100*.65)+")":"rgba(239, 110, 100, "+(.11+l/100*.65)+")",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+i+"', '"+S(e)+'\')" style="background: '+c+'">'+u+'<div class="monthlyViewHoursContainer">'+l+"%</div></div>"}return c="rgba(239, 110, 100, 1)",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+i+"', '"+S(e)+'\')" style="background: '+c+'"><div class="monthlyViewHoursContainer"><i class="fa fa-ban"></i></div></div>'}}}}),window.createLocationMonthlyTooltip=function(e,t,i,n){$("#MonthlyLocationViewTooltip").remove(),$("#MonthlyViewTooltip").remove();var r=p[t][n],s="";s=L(r,s,{regular:r.capacity,overtime:r.overtime});var a=n.split("_");a=new Date(a[2],a[1],a[0],0,0,0,0),a=moment(a).format("ll");var o=window.innerHeight,c=window.innerWidth,l=e.clientX+340<=c?e.clientX:e.clientX-340;$('<div id="MonthlyLocationViewTooltip">\n                    <h1>'+_.escape(i)+" - "+_.escape(a)+'</h1>\n                    <div id="CapacityIconsContainer">'+s+"</div>\n               </div>").css("left",l+"px").css("top",e.clientY+5+"px").appendTo("body");var d=$("#MonthlyViewTooltip"),u=d.height();u+e.clientY>o&&d.css("top",e.clientY-u-20+"px")},window.removeMonthlyLocationTooltip=function(){$("#MonthlyLocationViewTooltip").remove()},window.createMonthlyTooltip=function(e,t,i){e.stopPropagation(),$("#MonthlyViewTooltip").remove(),$("#MonthlyLocationViewTooltip").remove();var n=h.getResources()[t.split("_")[0]].name,r=f[t][i],s="",a=g;m.resourceToWorkingDates[t]&&m.resourceToWorkingDates[t][i]&&(a=m.resourceToWorkingDates[t][i]),s=L(r,s,a);var o=r.events.sort(function(e,t){return scheduler._events[e].start_date.getTime()>scheduler._events[t].start_date.getTime()?-1:scheduler._events[e].start_date.getTime()<scheduler._events[t].start_date.getTime()?1:0}).map(function(e){var t="",i="";scheduler._events[e]&&"service"===scheduler._events[e].type?(t="__monthlyViewFunctions.service('"+e+"')",i="<div onclick=\"__monthlyViewFunctions.flag(event, '"+e+'\')" class="monthlyViewFlag">'+(flaggedServices[e]?customLabels.Unflag:customLabels.Flag)+"</div>"):t="__monthlyViewFunctions.absence('"+e+"')";var n=" ";n+=scheduler._events[e]&&scheduler._events[e].jeopardy?"monthlyView_JeopardyTooltip":"",n+=scheduler._events[e]&&scheduler._events[e].violations&&!scheduler._events[e].jeopardy?"monthlyView_ViolationsTooltip":"";var r="";scheduler._events[e]&&"break"!==scheduler._events[e].type&&(r=""+w(T(r=Math.floor((scheduler._events[e].travelTo+scheduler._events[e].travelFrom)/60))),r='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg> '+r);var s=Math.floor((scheduler._events[e].finish-scheduler._events[e].start)/1e3/60);s=""+w(T(s)),s='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg> '+s;var a=""===r?"mytooltip_breakfix":"";return'\n                        <div class="'+n+' monthlyView_TooltipEventRow" title="'+function(e){return customLabels.Start+": "+moment(e.start).format("llll")+"\n"+customLabels.Finish+": "+moment(e.finish).format("llll")}(scheduler._events[e])+'">\n                            <div class="monthlyView_EventName" onclick="'+t+'">'+scheduler._events[e].name+'</div>\n                            <div class="monthlyView_EventDate"><span class="mytooltip_duration '+a+'">'+s+'</span><span class="mytooltip_travel">'+r+"</span>"+i+"</div>\n                        </div>"}),c=i.split("_");c=new Date(c[2],c[1],c[0],0,0,0,0),c=moment(c).format("ll");var l=window.innerHeight,d=window.innerWidth,u=e.clientX+340<=d?e.clientX:e.clientX-340;$('<div id="MonthlyViewTooltip">\n                    <h1>\n                        '+_.escape(n)+" - "+c+'\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.close+'"></use></svg>\n                    </h1>\n                    <div id="CapacityIconsContainer">'+s+'</div>\n                    <div id="MonthlyTooltipListContainer">'+o.join("")+"</div>\n               </div>").css("left",u+"px").css("top",e.clientY+5+"px").appendTo("body");var p=$("#MonthlyViewTooltip"),v=p.height();v+e.clientY>l&&p.css("top",e.clientY-v-20+"px")},$("body").on("click",function(){$("#MonthlyViewTooltip").remove()}),window.__monthlyViewFunctions={service:function(e){n.open(e)},absence:function(e){t.open(e)},flag:function(e,t){e.currentTarget.innerHTML=e.currentTarget.innerHTML===customLabels.Flag?customLabels.Unflag:customLabels.Flag,e.stopPropagation(),i.$broadcast("flagService",t),i.$apply()}},{updateMonthlyCapacity:function(e){if(e){e.setGanttResource(c.resourcesAndTerritories(),s.generateResourceId);var t=scheduler._events[e.id],i=null;if((e.resourceId||t)&&(!e.isMDT||e.mdtTimes)){if(t){var n=o(t.eventBeforeDrag||t);t.eventBeforeDrag&&(t.eventBeforeDrag=null),"service"===e.type||"na"===e.type?(i=t.resourceName===e.resourceName?e.resourceId:t.resourceBeforeDrag||t.resourceId,t.resourceBeforeDrag=null):"break"===e.type&&(i=t.resourceId),u(t.id,i,n.travelBeforeSum,"travel",!1),u(t.id,i,n.scheduledObjectSum,t.type,!1),u(t.id,i,n.travelAfterSum,"travel",!1)}if(!e.resourceId||e.isDeleted||e.locationRemovedMe)e.locationRemovedMe&&(e.locationRemovedMe=!1);else{var r=o(e);u(e.id,e.resourceId,r.travelBeforeSum,"travel"),u(e.id,e.resourceId,r.scheduledObjectSum,e.type),u(e.id,e.resourceId,r.travelAfterSum,"travel")}}}},capacityCalculationFields:v,workingTimesByLocation:p,calculateLocation:b,calculateLocationUtilization:function(e){var t=0;v.services&&(t+=e.service),v.breaks&&(t+=e.break),v.na&&(t+=e.na),v.travel&&(t+=e.travel);var i=v.overtime?e.capacity+e.overtime:e.capacity;if(0<i){var n=t/i;return n=Math.round(100*n)}return null},calculateDailyResourceCapacity:function(e,t){var i=new y,n=null,r=S(t),s=e.key;if(i.capacity=0,contractorSupport&&e.contractor)return i;if(c.isResourceRelocated(s,t))return i;if(c.isResourceCrewMembers(s,t))return i;if(c.isResourceSecondary(s,t))return i;f[s]||(f[s]={}),f[s][r]&&(n=f[s][r]),n||(f[s][r]=new y,n=f[s][r]);var a=g;return m.resourceToWorkingDates[s]&&m.resourceToWorkingDates[s][r]&&(a=m.resourceToWorkingDates[s][r]),n&&(i.break+=n.break,i.na+=n.na>a.regular?a.regular:n.na,i.service+=n.service,i.travel+=n.travel,i.capacity+=-1<a.regular?a.regular:0,i.overtime+=a.overtime),i},reset:function(){f={},p={}}}}e.$inject=["calendarsService","$rootScope","AbsenceLightboxService","ServiceAppointmentLightboxService","TimePhasedDataService","utils","ResourcesAndTerritoriesService","userSettingsManager"],angular.module("serviceExpert").factory("monthlyViewHelperService",e)}(),function(){var o=7500;angular.module("MstResolver",[]).provider("MstResolver",function(){var t={fslOperationRemoteAction:null,getAsyncApexJobRemoteAction:null,apiVersion:"41.0",fieldNames:{Initiator:"Initiator__c",Request_Type:"Request_Type__c",ResultText:"ResultText__c"},autoConnect:!0};this.setConfig=function(e){return t=e},this.$get=function(e){return function(t,s){var a={},n={},i=-1;function e(){$.cometd.addListener("/meta/handshake",function(e){if(e.successful){if(console.log("Handshake successful!"),null==$.cometd.getExtension("myReplayExtensionName")){var t=new cometdReplayExtension;t.setChannel("/topic/MstCompletedChannel"),t.setReplay(i),$.cometd.registerExtension("myReplayExtensionName",t)}$.cometd.subscribe("/topic/MstCompletedChannel",r)}else console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful||console.warn("disconnected! msg: "+e)});$.cometd.init({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/"+s.apiVersion+"/",requestHeaders:{Authorization:"OAuth "+sessionId}})}function r(e){if("deleted"!==e.data.event.type){console.info("message from stream, type: "+e.data.event.type+", replayId: "+e.data.event.replayId+", fslOp: "+e.data.sobject.Id),i=e.data.event.replayId,n[e.data.sobject.Id]=e;var t=a[e.data.sobject.Id];t&&t.deferred.resolve(e)}}return function(){try{s.autoConnect&&e()}catch(e){console.log(e)}}(),{getUpdates:function(e){a[e]={time:(new Date).getTime()-3e3,deferred:t.defer(),mstPromise:t.defer(),asyncMethodCheckerTimeout:null,gotReply:!1};var i=a[e];a[e].deferred.promise.then(function(e){s.fslOperationRemoteAction&&Visualforce.remoting.Manager.invokeAction(s.fslOperationRemoteAction,i.time,e.data.sobject.Id,function(e,t){t.status&&!e.fslOperation.fslOperation[s.fieldNames.ResultText]?(e.fslOperation.result&&(e.fslOperation.result=JSON.parse(e.fslOperation.result)),"Get Candidates"===e.fslOperation.fslOperation[s.fieldNames.Request_Type]&&function(e){var t=e.ResourceIDToScheduleData;for(var i in t)t[i].SchedulingOptions.forEach(function(e){for(var t in e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf(),e.MSTOptions)e.MSTOptions[t].Interval.Start=moment(e.MSTOptions[t].Interval.Start).valueOf(),e.MSTOptions[t].Interval.Finish=moment(e.MSTOptions[t].Interval.Finish).valueOf()})}(e.fslOperation.result),"Appointment Booking"===e.fslOperation.fslOperation[s.fieldNames.Request_Type]&&function(e){e.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf()})}(e.fslOperation.result.Slots),i.mstPromise.resolve(e)):e&&e.fslOperation&&e.fslOperation.fslOperation?i.mstPromise.reject(e.fslOperation.fslOperation[s.fieldNames.ResultText]):i.mstPromise.reject(t),i.gotReply=!0},{buffer:!1,escape:!1,timeout:12e4})}),n[e]&&(i.deferred.resolve(n[e]),delete n[e]);return a[e].asyncMethodCheckerTimeout=setInterval(function(){!function(n){var r=a[n];Visualforce.remoting.Manager.invokeAction(s.getAsyncApexJobRemoteAction,n,function(e,t){if(!e)return clearInterval(r.asyncMethodCheckerTimeout),void(t.status||(t.xhr&&"communication failure"===t.xhr.statusText?r.mstPromise.reject({message:t.message}):r.mstPromise.reject({message:customLabels.wentWrongContactSysAdmin}),console.log(t)));if("Aborted"!==e.Status&&"Failed"!==e.Status||(r.gotReply||r.mstPromise.reject({message:e.ExtendedStatus}),clearInterval(r.asyncMethodCheckerTimeout)),"Completed"===e.Status){var i={data:{sobject:{Id:n}}};r.deferred.resolve(i),clearInterval(r.asyncMethodCheckerTimeout)}})}(e)},o),a[e].mstPromise.promise},connectToPush:e,handleCometdConnection:r}}(e,t)},this.$get.$inject=["$q"]})}(),GanttService.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0,i=void 0,n=void 0,r=void 0,s=void 0,a=void 0,o=void 0,c=void 0;this.schedStartTime&&(e=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(t=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.dueDate&&(s=60*new Date(this.dueDate).getTimezoneOffset()*1e3),this.earliestStartTime&&(r=60*new Date(this.earliestStartTime).getTimezoneOffset()*1e3),this.arrivalWindowStartTime&&(a=60*new Date(this.arrivalWindowStartTime).getTimezoneOffset()*1e3),this.arrivalWindowEndTime&&(o=60*new Date(this.arrivalWindowEndTime).getTimezoneOffset()*1e3),this.actualStartTime&&(i=60*new Date(this.actualStartTime).getTimezoneOffset()*1e3),this.actualEndTime&&(n=60*new Date(this.actualEndTime).getTimezoneOffset()*1e3),this.ganttDisplay&&(c=60*new Date(this.ganttDisplay).getTimezoneOffset()*1e3),this.text=this.ganttLabel?this.ganttLabel.encodeHTML():this.name,this.start=this.schedStartTime?new Date(this.schedStartTime+e):null,this.finish=this.schedEndTime?new Date(this.schedEndTime+t):null,this.dueDate=this.dueDate?new Date(this.dueDate+s):null,this.earlyStart=this.earliestStartTime?new Date(this.earliestStartTime+r):null,this.appStart=this.arrivalWindowStartTime?new Date(this.arrivalWindowStartTime+a):null,this.appEnd=this.arrivalWindowEndTime?new Date(this.arrivalWindowEndTime+o):null,this.actualStartTime=this.actualStartTime?new Date(this.actualStartTime+i):null,this.actualEndTime=this.actualEndTime?new Date(this.actualEndTime+n):null,this.ganttDisplay=this.ganttDisplay?new Date(this.ganttDisplay+c):null,this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null},GanttService.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var i=e[this.resource],n=[],r=void 0,s=void 0;for(var a in this.resourceId=null,this.schedStartTime&&(r=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(s=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.start_date=this.schedStartTime?new Date(this.schedStartTime+r):null,this.end_date=this.schedEndTime?new Date(this.schedEndTime+s):null,i){var o=i[a];"R"===o.serviceTerritoryType&&(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&n.push(o.serviceTerritory)}if(0===n.length)for(var c in i){var l=i[c];isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.start_date)&&n.push(l.serviceTerritory)}else if(showSecondarySTMs)for(var d in i){var u=i[d];"S"===u.serviceTerritoryType&&isIntersect(u.effectiveStartDate,u.effectiveEndDate,this.start_date,this.end_date)&&n.push(u.serviceTerritory)}this.resourceId=t(this.resource,n),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttService.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60))))},GanttService.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttService.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId?this.resourceId.substr(0,18):this.resourceId},GanttService.prototype.getGanttTerritory=function(){return this.resourceId?this.resourceId.substr(19,37):this.resourceId},GanttService.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttService.prototype.isGotNewSTM=function(e){return""===this.resourceId&&e.resource},GanttService.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttService.prototype.minPriority=1e6,GanttService.copy=function(e){var t=new GanttService(null,!0);return angular.merge(t,e),t},GanttService.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var n=1e3*(new Date).getTimezoneOffset()*60,r={travel:[],working:[]};this.mdtTimes.forEach(function(e){var t=moment.tz(e.Start,userTimeZone),i=moment.tz(e.Finish,userTimeZone);t=new Date(t.valueOf()+60*t._offset*1e3+n),i=new Date(i.valueOf()+60*i._offset*1e3+n),e.Start=t,e.Finish=i,"OperationalSlot"===e.Type?r.working.push(e):"Travel"===e.Type&&r.travel.push(e)}),this.mdtTimes=r}catch(e){this.mdtTimes={travel:[],working:[]}}},function(e){var a={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};e.TimeSlot=function(e){this.startHour=Math.floor(e[fieldNames.TimeSlot.StartTime]/1e3/60/60),this.startMinute=Math.ceil(e[fieldNames.TimeSlot.StartTime]/1e3/60/60%1*60),this.endHour=Math.floor(e[fieldNames.TimeSlot.EndTime]/1e3/60/60),this.endMinute=Math.ceil(e[fieldNames.TimeSlot.EndTime]/1e3/60/60%1*60),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.OperatingHours=function(e){this.id=e.Id,this.name=e.Name,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};var t=e[fieldNames.OperatingHours.Time_Slots__r];t=t||[];for(var i=0;i<t.length;i++){var n=t[i],r=n[fieldNames.TimeSlot.DayOfWeek];r=a[r];var s=this.slots[r];s||(s=[],this.slots[r]=s),s.push(new TimeSlot(n))}}}(window),ResourceAbsence.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start=new Date(this.start+e),this.finish=new Date(this.end+t),this.end=new Date(this.end+t)},ResourceAbsence.prototype.setGanttResource=function(e,t){var i=e[this.resource],n=[];if(this.resourceId=null,this.isScheduled()){for(var r in this.start_date=this.start?new Date(this.start.getTime()):null,this.end_date=this.finish?new Date(this.finish.getTime()):null,i){var s=i[r];"R"===s.serviceTerritoryType&&(isIntersect(s.effectiveStartDate,s.effectiveEndDate,this.start_date,this.end_date)||!s.effectiveEndDate&&s.effectiveStartDate<this.end_date)&&(n.includes(s.serviceTerritory)||n.push(s.serviceTerritory))}if(0===n.length)for(var a in i){var o=i[a];(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&(n.includes(o.serviceTerritory)||n.push(o.serviceTerritory))}else if(showSecondarySTMs)for(var c in i){var l=i[c];"S"===l.serviceTerritoryType&&(isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.end_date)||!l.effectiveEndDate&&l.effectiveStartDate<this.end_date)&&(n.includes(l.serviceTerritory)||n.push(l.serviceTerritory))}this.resourceId=t(this.resource,n),this.isScheduled()&&this.updateDatesBasedOnTravel()}},ResourceAbsence.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60))))},ResourceAbsence.prototype.isScheduled=function(){return!!this.resource},ResourceAbsence.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId},ResourceCapacity.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;switch(this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start_date=this.start?new Date(this.start+e):null,this.end_date=this.end?new Date(this.end+t):null,this.timePeriod){case"Day":this.end_date=addDaysToDate(this.start_date,1);break;case"Week":this.end_date=addDaysToDate(this.start_date,7);break;case"Month":this.end_date=addDaysToDate(this.end_date,1)}0<this.hoursPerTimePeriod?this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.hoursInUse,this.hoursPerTimePeriod)+"%")+"</b> (<b>"+customLabels.x_Hours_scheduled_out_of_y.replaceAll(this.hoursInUse,this.hoursPerTimePeriod)+"</b>)":0<this.workItemsPerTimePeriod&&(this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.workItemsAllocated,this.workItemsPerTimePeriod)+"%")+"</b> (<b>"+customLabels.NumServicesScheduled.replaceAll(this.workItemsAllocated,this.workItemsPerTimePeriod)+"</b>)"),this.type="contractorcapacity"},ResourceCapacity.prototype.setGanttResource=function(e,t){var i=e[this.resource],n=[];for(var r in i){var s=i[r];(isIntersect(s.effectiveStartDate,s.effectiveEndDate,this.start_date,this.end_date)||!s.effectiveEndDate&&s.effectiveStartDate<this.end_date)&&n.push(s.serviceTerritory)}this.resourceId=t(this.resource,n)},ResourceCapacity.prototype.isScheduled=function(){return!!this.resource},ResourceCapacity.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId};var bootstrap={};function handleTabSettingAndRecordTypesPermissions(c){return new Promise(function(e,t){var i=JSON.parse(c.Admin.replace(/&quot;/g,'"')),n=JSON.parse(c.Agent.replace(/&quot;/g,'"')),r=JSON.parse(c.Community.replace(/&quot;/g,'"')),s=JSON.parse(c.CommunityDispatcher.replace(/&quot;/g,'"')),a=JSON.parse(c.Dispatcher.replace(/&quot;/g,'"')),o=JSON.parse(c.Resource.replace(/&quot;/g,'"'));Promise.all([createTabAndRecordTypePermission("FSL_Admin","FSL Admin",i.tabSettings,i.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Agent","FSL Agent",n.tabSettings,n.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Dispatcher","FSL Dispatcher",a.tabSettings,a.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Community_Self_Service","FSL Self Service",r.tabSettings,r.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Community_Dispatcher","FSL Community Dispatcher",s.tabSettings,s.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Resource","FSL Resource",o.tabSettings,o.recordTypeVisibilities)]).then(function(){e()},function(){e()})})}function createTabAndRecordTypePermission(a,o,c,l){new Promise(function(n,e){for(var t=window.location.origin,i='<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:met="http://soap.sforce.com/2006/04/metadata"><soapenv:Header><met:SessionHeader><met:sessionId>'+sessionId+'</met:sessionId></met:SessionHeader></soapenv:Header><soapenv:Body><met:updateMetadata><met:metadata xsi:type="met:PermissionSet"><fullName>'+a+"_Permissions</fullName><label>"+o+" Permissions</label>",r=0;r<c.length;r++)i+="<tabSettings><tab>"+c[r].tab+"</tab><visibility>"+c[r].visibility+"</visibility></tabSettings>";for(var s=0;s<l.length;s++)i+="<recordTypeVisibilities><recordType>"+l[s].recordType+"</recordType><visible>"+l[s].visible+"</visible></recordTypeVisibilities>";i+="</met:metadata></met:updateMetadata></soapenv:Body></soapenv:Envelope>",window.$.ajax({url:t+"/services/Soap/m/38.0",type:"POST",dataType:"xml",data:i,beforeSend:function(e){e.setRequestHeader("Content-Type","text/xml"),e.setRequestHeader("SOAPAction",'""')}}).then(function(e,t,i){n()},function(e,t,i){console.log("Failed to update permissions on load of VF"),n()})})}bootstrap.loadUserSettings=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.IsUserSettingExist,function(e,t){t.status?0==t.result?Visualforce.remoting.Manager.invokeAction(RemoteActions.CreateNewUserSettingsLocStorage,localStorage.getItem(sfdcUser+"_serviceExpertLocations"),localStorage.getItem(sfdcUser+"_serviceExpertOrphan"),localStorage.getItem(sfdcUser+"_serviceExpertSettings"),localStorage.getItem(sfdcUser+"_serviceExpertFilters"),function(e,t){t.status&&(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"]))},{buffer:!1,escape:!1,timeout:12e4}):Visualforce.remoting.Manager.invokeAction(RemoteActions.GetCreateUserSettings,function(e,t){t.status?(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"])):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4}):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4})},bootstrap.Start=function(){bootstrap.UpdatePermissionSets()},bootstrap.UpdatePermissionSets=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.updatePermissionSets,function(e,t){if(null==e||null==e)bootstrap.loadUserSettings();else try{handleTabSettingAndRecordTypesPermissions(e).then(function(){bootstrap.loadUserSettings()})}catch(e){console.log(e),bootstrap.loadUserSettings()}})},bootstrap.UpdatePermissionSetsBootstrap=function(i,n){Visualforce.remoting.Manager.invokeAction(sharedRemoteActions.updatePermissionSets,function(e,t){if(null==e||null==e)angular.bootstrap(document.getElementById(i),[n]);else try{handleTabSettingAndRecordTypesPermissions(e).then(function(){angular.bootstrap(document.getElementById(i),[n])})}catch(e){console.log(e),angular.bootstrap(document.getElementById(i),[n])}})},bootstrap.handleError=function(e){var t=!1;for(var i in{no_dispatcher_license_found:!0,Apex_CPU_time_limit_exceeded:!0})customLabels[i]==e.message&&(t=!0);-1!=e.message.toLowerCase().indexOf("dml")?cantLoadGantt(customLabels.no_dispatcher_permissions_found.replace("{0}",'<a href="vf066_settings#page=0&tab=1" target="_blank">').replace("{1}","</a>")):cantLoadGantt(t?e.message:customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+e.message+"</div>")},moment.defineLocale("en_NZ",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(e){var t=e%10;return e+(1==~~(e%100/10)?"th":1==t?"st":2==t?"nd":3==t?"rd":"th")},week:{dow:1,doy:4}});var globalStatuses={},globalCategories={},flaggedServices={},contextShown=!1,snapTo=!1,globalSelectedGanttServices={},capacityDurationFilter="Day",cachedDomElements={},violationDelimiter="&lt;br/&gt;",minHourToDisplay=0,maxHourToDisplay=24,includeWeekends=!1,gameOn=!1,ctrlPressed=!1,paletteViewActive=!1,showCandidates={on:!1,id:null},folderJustToggled=!1;function setHoursToDisplay(e,t,i){minHourToDisplay=e,maxHourToDisplay=t,includeWeekends=i}function updateTimesToSnapIn(){if(void 0!==cachedDomElements&&void 0!==cachedDomElements.timesDragFix){var e=cachedDomElements.timesDragFix.html(),t=null;0!==e.indexOf(customLabels.SchedulingTimesGantSnap)||ctrlPressed?0!==e.indexOf(customLabels.SchedulingTimesGantSnap)&&ctrlPressed&&(t=customLabels.SchedulingTimesGantSnap+" "+e.substr(customLabels.SchedulingTimesGant.length,e.length),cachedDomElements.timesDragFix.html(t)):(t=customLabels.SchedulingTimesGant+" "+e.substr(customLabels.SchedulingTimesGantSnap.length,e.length),cachedDomElements.timesDragFix.html(t))}}function showTimesWhenDragging(e,t){cachedDomElements.timesDragFix=cachedDomElements.timesDragFix||$("#timesDragFix");var i=(t.start_date.getMinutes()+t.travelTo/60)%60,n=i%serviceJumpsOnGantt,r=serviceJumpsOnGantt-i%serviceJumpsOnGantt;if(scheduler.getState().drag_id===t.id){var s=t.finish-t.start,a=new Date(e);a.setSeconds(0),t.travelTo&&a.setSeconds(a.getSeconds()+t.travelTo),a=r<n?new Date(a.getTime()+60*r*1e3):new Date(a.getTime()-60*n*1e3);var o=new Date(a.getTime()+s),c=moment(a).format("lll"),l=moment(o).format("lll"),d=customLabels.SchedulingTimesGant+"<br/>"+c+" - "+l;ctrlPressed&&(d=customLabels.SchedulingTimesGantSnap+"<br/>"+c+" - "+l),cachedDomElements.timesDragFix.html(d).show()}else scheduler.getState().drag_id||cachedDomElements.timesDragFix.hide()}function generateBreakEventHtml(e){var t="Break_Laebl",i="breakIcon";return"ZoomLevel2"!=scheduler._mode&&"ZoomLevel3"!=scheduler._mode&&(t="Break_Laebl BreakLabelSmall",i="breakIconSmall"),e.ganttLabel?'<span class="'+t+'">\n                    <img src="'+lsdIcons.breakImg+'" class="'+i+'" draggable="false"/>\n                    '+e.ganttLabel.encodeHTML()+"\n                </span>":'<span class="'+t+'">\n                <img src="'+lsdIcons.breakImg+'" class="'+i+' NA_Break_NoLabel_Icon" draggable="false"/>\n            </span>'}function generateCapacityHtml(e){var t="",i="fa-battery-empty",n=0;return 0<e.hoursPerTimePeriod?n=e.hoursInUse/e.hoursPerTimePeriod*100:0<e.workItemsPerTimePeriod&&(n=e.workItemsAllocated/e.workItemsPerTimePeriod*100),i=n<=25?"fa-battery-empty":n<=50?"fa-battery-quarter":n<=75?"fa-battery-half":n<=90?"fa-battery-three-quarters":"fa-battery-full",t+='<span class="contractorCapacityHoursUsed " style="width:calc('+(n=100<n?100:n)+'% - 5px);"></span>',e.text&&("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode?t+='<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+i+'"></i>'+e.text.split(" ")[0]+"</span></div>":"MonthlyView"===scheduler._mode||"LongView"===scheduler._mode?t+='<div class="ServiceEventPadding"><span class="Capacity_Label Capacity_Label_LongView">'+e.text.split(" ")[0]+"</span></div>":t+='<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+i+'"></i>'+e.text+"</span></div>"),t}function generateNAhtml(e,t,i){var n=e.ganttLabel||e.reason||"";return i?'<div class="ServiceEvent" style="'+t+'">\n                    <div class="ServiceEventPadding">\n                        <svg aria-hidden="true" class="slds-icon naIcon">\n                            <use xlink:href="'+lsdIcons.na+'"></use>\n                        </svg>\n                        <span class="NA_Label">\n                            '+n.encodeHTML()+"\n                        </span>\n                    </div>\n                </div>":'<div class="ServiceEventPadding" style="'+t+'">\n                <svg aria-hidden="true" class="slds-icon naIcon">\n                    <use xlink:href="'+lsdIcons.na+'"></use>\n                </svg>\n                <span class="NA_Label">\n                    '+n.encodeHTML()+"\n                </span>\n            </div>"}function generateIconsHtmlForService(e){var t="";if(e.violations&&(t="<div class='violationsOnService'><i class='fa fa-warning'></i></div>"),e.jeopardy&&(t='<div class="jeopardyOnService"><img src="'+lsdIcons.jeopardyImg+'"></div>'),e.icons){var i="";e.icons.forEach(function(e){i+='<div class="customIconOnService"><img src="'+e+'"></div>'}),t+=i}e.emergency&&(t+='<svg aria-hidden="true" class="slds-icon emergencyOnService"><use xlink:href="'+lsdIcons.emergency+'"></use></svg>'),e.pinned&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.pin+'"></use></svg>'),flaggedServices[e.id]&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.flag+'"></use></svg>'),(e.relatedFather||e.relatedTo||e.isServiceInChain)&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.related+'"></use></svg>'),e.isMDT&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>'+('<svg aria-hidden="true" class="slds-icon onServiceIcon forwardIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>'));return t}function generateServiceColorAndFont(e){var t="";if("na"===e.type&&e.ganttColor&&e.travelTo&&(t+="margin-right:-6px;"),(e.ganttPaletteColor||e.ganttColor)&&!globalSelectedGanttServices[e.id]){var i=e.ganttColor;if(paletteViewActive&&e.ganttPaletteColor&&(i=e.ganttPaletteColor.color),i)t+="color:#"+generateGanttTextColor(i.substr(1,7))+";background:"+i+";"}return"ZoomLevel3"!==scheduler._mode&&"ZoomLevel2"!==scheduler._mode&&(t+="font-size:10px;"),t}function attchDatalessSchedulerEvents(){scheduler.date.ZoomLevel1_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.date.ZoomLevel2_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.templates.event_bar_text=function(e,t,i){var n,r=void 0,s=void 0,a=void 0,o=f(),c=i.finish-i.start,l=new Date(e);if(l.setSeconds(0),i.travelTo&&l.setSeconds(l.getSeconds()+i.travelTo),n=new Date(l.getTime()+c),showTimesWhenDragging(e,i),"break"===i.type)return generateBreakEventHtml(i);if("contractorcapacity"===i.type)return generateCapacityHtml(i);var d=generateIconsHtmlForService(i),u=generateServiceColorAndFont(i),p=!0,v=new Date(scheduler._min_date),m=new Date(scheduler._max_date);if(v.setHours(o.min),m.setHours(o.max),isIntersect(l,n,v,m)||"ZoomLevel2"===scheduler._mode||(p=!1),p&&(i.travelTo||i.travelFrom)){if(r=getXPositionOfEvent({start_date:l,end_date:n},!1,scheduler.matrix[scheduler._mode]),(s=getXPositionOfEvent({start_date:l,end_date:n},!0,scheduler.matrix[scheduler._mode])-r+12)<=2&&(s=3),u+="width:"+s+"px;",i.travelTo){var h=new Date(e);h.setMinutes(h.getMinutes()+i.travelTo/60),a=getXPositionOfEvent({start_date:i.start_date,end_date:h},!1,scheduler.matrix[scheduler._mode]),u+="margin-left:"+(getXPositionOfEvent({start_date:i.start_date,end_date:h},!0,scheduler.matrix[scheduler._mode])-a+7)+"px;"}return"na"===i.type?generateNAhtml(i,u,!0):'<div class="ServiceEvent" territory_id="'+i.getGanttTerritory()+'" style="'+u+'");"><div class="ServiceEventPadding">'+d+i.text+"</div></div>"}if("na"===i.type)return generateNAhtml(i,u,!1);var g=d+i.text;return p||i.isDummy||(g=""),'<div class="ServiceEventPadding" style="'+u+'">'+g+"</div>"},scheduler.templates.event_class=function(e,t,i){if("break"===i.type&&window.__servicesInFilter&&window.__servicesInFilter.applied)return"NA_Break service-faded";if("break"===i.type)return"NA_Break";var n="";return i.showEventPopupEffect&&(n+=" ShowEventEffect "),window.__servicesInFilter&&window.__servicesInFilter.applied&&!window.__servicesInFilter[i.id]&&!i.isDummy&&(n+=" service-faded "),"na"===i.type&&(n+=" NA_Absence "),"na"===i.type&&i.ganttColor&&!i.travelTo&&(n+=" na_with_color_no_travel_to "),"na"===i.type&&i.ganttColor&&i.travelTo&&(n+=" na_with_color "),"contractorcapacity"===i.type?(n+=" eventContractorCapacity","LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||(n+=" eventContractorCapacity_LongView"),0<i.hoursPerTimePeriod?0<i.hoursInUse&&i.hoursInUse>i.hoursPerTimePeriod&&(n+=" overCapacityPattern"):0<i.workItemsPerTimePeriod&&0<i.workItemsAllocated&&i.workItemsAllocated>i.workItemsPerTimePeriod&&(n+=" overCapacityPattern"),showCandidates.on&&(n+=" fadedSlot")):("service"===i.type&&(n+=getClassByStatus(i.statusCategory),i.isDummy&&(n+=" savingDummyService ")),i.isMDT&&(n+=" mdtEvent"),showCandidates.on&&i.id!==showCandidates.id&&(n+=" fadedSlot"),i.hiddenTravelFrom&&(n+=" dhx_long_travel_from_time_background"),i.hiddenTravelTo&&(n+=" dhx_long_travel_to_time_background"),i.travelTo&&i.travelFrom?n+=" dhx_travelToFrom dhx_travel_time_background":i.travelTo&&!i.travelFrom?n+=" dhx_travelTo dhx_travel_time_background":!i.travelTo&&i.travelFrom?n+=" dhx_travelFrom dhx_travel_time_background":"na"===i.type?n+=" NA_Absence_NoTravel":n+=" dhx_noTravel","service"===i.type&&(globalSelectedGanttServices[i.id]&&(i.travelTo||i.travelFrom)?n+=" selectedEvent":globalSelectedGanttServices[i.id]?n+=" selectedEventNoTravel":i.id===scheduler._select_id&&(i.travelTo||i.travelFrom)?n+=" selectedEvent":i.id===scheduler._select_id&&(n+=" selectedEventNoTravel")),i.status&&(n+=" GanttCustomStatus_"+i.status.split(" ").join(""))),n};var t=!(scheduler.templates.tooltip_text=function(e,t,i){if(contextShown)return!1;var n=void 0,r='<div class="tooltipBody">',s=getLocationdIdByResource(i.resourceId),a=utils.getLocationOffset(e,s)-utils.getUserOffset(e),o=new Date(i.start),c=0,l=0,d=new Date(i.finish);if(!s)return!1;if(o.setMinutes(o.getMinutes()+a),d.setMinutes(d.getMinutes()+a),"contractorcapacity"===i.type)return n="fa-battery-empty",0<i.hoursPerTimePeriod?(c=i.hoursInUse/i.hoursPerTimePeriod*100,l=Math.floor(i.hoursInUse/i.hoursPerTimePeriod*100*100)/100):0<i.workItemsPerTimePeriod&&(c=i.workItemsAllocated/i.workItemsPerTimePeriod*100,l=Math.floor(i.workItemsAllocated/i.workItemsPerTimePeriod*100*100)/100),r+='<div class="tooltipLine"><b style="font-size:15px"><i class="fa '+(n=c<=25?"fa-battery-empty":c<=50?"fa-battery-quarter":c<=75?"fa-battery-half":c<=90?"fa-battery-three-quarters":"fa-battery-full")+'"></i> '+i.resourceName.encodeHTML()+"</b> ("+l+"%)</div>",i.workItemsPerTimePeriod&&(r+='<div class="tooltipLine">'+customLabels.NumServicesScheduled.replaceAll(i.workItemsAllocated,i.workItemsPerTimePeriod)+"</div>"),i.hoursPerTimePeriod&&(r+='<div class="tooltipLine">'+customLabels.NumHoursScheduled.replace("{0}",i.hoursInUse).replace("{1}",i.hoursPerTimePeriod)+"</div>"),r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start_date).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.end_date).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Duration_Type+"</span> "+i.timePeriod+"</div>",0<i.workItemsAllocated&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.NumberOfServices+"</span> "+i.workItemsAllocated+"</div>"),r+="</div>";if("service"!==i.type)return n=absenceTypeIcon(i.type),i.ganttLabel?r+='<div class="tooltipLine"><b>'+n+'<span class="tooltipName">'+i.ganttLabel.encodeHTML()+"</span> </b> </div>":r+='<div class="tooltipLine"><b>'+n+'<span class="tooltipName">'+i.name+"</span> </b> </div>",r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>",a&&!useLocationTimezone&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_finish+"</span> "+moment(d).format("llll")+"</div>"),i.travelTo&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),i.travelFrom&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),(i.reason||i.comment)&&(r+='<div class="tooltipHR"></div>'),i.reason&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Reason+"</span> "+i.reason.encodeHTML()+"</div>"),r+="</div>";var u="",p=i.ganttColor,v='<svg aria-hidden="true" class="slds-icon tooltipJeopardyIcon">\n                                <use xlink:href="'+lsdIcons.jeopardy+'"></use>\n                            </svg>',m='<svg aria-hidden="true" class="slds-icon tooltipMDTIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',h='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>',g='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.emergency+'"></use>\n                            </svg>';paletteViewActive&&i.ganttPaletteColor&&(p=i.ganttPaletteColor.color),p&&(u='style="background:'+p+'"'),i.ganttLabel?r+='<div class="tooltipLine"><div '+u+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+" / "+i.ganttLabel.encodeHTML()+"</b> ("+statusTranslations[i.status]+")</div>":r+='<div class="tooltipLine"><div '+u+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+"</b> ("+statusTranslations[i.status]+")</div>",i.jeopardy&&i.jeopardyReason&&(r+='<div class="tooltipJeopardy">'+v+"<span>"+customLabels.JeopardyTooltip+" "+i.jeopardyReason.encodeHTML()+"</span></div>"),i.emergency?r+='<div class="tooltipJEmergency">'+g+"<span>"+customLabels.ScheduledWithEmergency+"</span></div>":i.jeopardy&&(r+='<div class="tooltipJeopardy">'+v+"<span>"+customLabels.JeopardyTooltipLong+"</span></div>"),i.pinned&&(r+='<div class="tooltipLine tooltipPinned"><i>'+customLabels.Pinned_Tooltip+"</i></div>");var f=GanttService.prototype.allFieldSets.GanttToolTip;if(f)for(var S=0;S<f.length;S++){var _=i[f[S].APIName];!_||"STRING"!==f[S].Type&&"TEXTAREA"!==f[S].Type&&"REFERENCE"!==f[S].Type&&"PICKLIST"!==f[S].Type||(_=_.encodeHTML()),"Status"===f[S].APIName?_=statusTranslations[i.status]:"DATETIME"===f[S].Type&&_?_=moment(_).format("llll"):"DATE"===f[S].Type&&_&&(_=moment(_).format("L")),_&&(r+='<div class="tooltipLine"><b>'+f[S].Label.encodeHTML()+": </b> "+_+"</div>")}if(r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>",!a&&!alwaysShowLocalTimeTooltip||useLocationTimezone||(r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_finish+"</span> "+moment(d).format("llll")+"</div>"),i.hiddenTravelTo?r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.hiddenTravelTo.hiddenTravel/60)+"</div>":i.travelTo&&(r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),i.hiddenTravelFrom?r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.hiddenTravelFrom.hiddenTravel/60)+"</div>":i.travelFrom&&(r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),i.tooltipText&&(r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine tooltipTitle">'+customLabels.Custom_Tooltip_Field+'</div><div class="tooltipLine">'+i.tooltipText.encodeHTML()+"</div>"),r+="</div>",(i.hiddenTravelTo||i.hiddenTravelFrom||i.isMDT)&&(r+='<div class="tooltipTravel">',(i.hiddenTravelTo||i.hiddenTravelFrom)&&(r+='<div class="tooltipLine tooltipTitle"><i class="fa fa-car"></i>'+customLabels.Travel_time+"</div><div>",r+=customLabels.Travel_time_too_long.replace("{0}",maxTravelTimeInSeconds/60/60)+'<div class="travelExplain">'+customLabels.To_change_maximum_travel_hours+"</div>",r+="</div>"),i.isMDT&&(r+='<div class="tooltipLine tooltipTitle">'+m+h+customLabels.Multi_Day_Service+"</div><div>",r+=customLabels.This_service_spans_across_more_than_one_day,r+="</div>"),r+="</div>"),i.violations){r+='<div class="tooltipViolation">',r+='<div class="tooltipLine tooltipTitle"><i class="fa fa-warning"></i>'+customLabels.Rule_violations_Tooltip+"</div><div>";for(var y=0;y<i.violations.length;y++)-1!=i.violations[y].ViolationString.indexOf(violationDelimiter)?(r+=i.violations[y].RuleName+" - ",r+=i.violations[y].ViolationString.substring(0,i.violations[y].ViolationString.indexOf(violationDelimiter))+"<br/>",r+=i.violations[y].ViolationString.substring(i.violations[y].ViolationString.indexOf(violationDelimiter)+violationDelimiter.length)+"<br/>"):r+=i.violations[y].RuleName+" - "+i.violations[y].ViolationString+"<br/>";r+="</div>"}return r});function e(e){if(o(e))return!0;var t=f();return!(e.getHours()>=t.min&&e.getHours()<t.max)}function o(e){if("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode||"MonthlyView"===scheduler._mode||"MTDView"===scheduler._mode||"LongView"===scheduler._mode){var t=0===firstDayOfTheWeek?6:0,i=0===firstDayOfTheWeek?5:6;if(!includeWeekends&&(e.getDay()===i||e.getDay()===t))return!0}return!1}function f(){var e=scheduler.getState().mode,t=minHourToDisplay,i=maxHourToDisplay,n=null;switch(e){case"ZoomLevel4":n=2;break;case"ZoomLevel5":n=4;break;case"ZoomLevel6":case"ZoomLevel7":n=6}if(null!=n){t-=t%n;var r=n-i%n;r!=n&&(i+=r)}return{min:t,max:i}}function i(e,t){if(gameOn)return!1;var i=function(e){var t=f();if(o(e.start_date)&&o(e.end_date))return!1;var i=[];if("ZoomLevel2"===scheduler._mode)i.push({start:scheduler._min_date.getTime(),finish:scheduler._max_date.getTime()});else for(var n=scheduler._min_date.getTime(),r=scheduler._max_date.getTime(),s=n;s<r;s+=864e5){var a={start:s+1e3*t.min*60*60,finish:s+1e3*t.max*60*60};i.push(a)}return isMultipleIntersection({start:e.start_date.getTime(),finish:e.end_date.getTime()},i)}(t),n=!0;return contractorSupport&&(t.resourceContractor&&(n=!1),"contractorcapacity"===t.type&&t.timePeriod!=capacityDurationFilter&&(n=!1)),i&&n}return dhtmlxEvent(scheduler._obj,"mouseleave",function(e){scheduler.getState().drag_id&&(t=!0,scheduler._on_mouse_up(e),cachedDomElements.timesDragFix.hide(),window.getSelection().removeAllRanges())}),scheduler.attachEvent("onBeforeEventChanged",function(){return!t||(t=!1)}),scheduler._hover=null,scheduler.attachEvent("onMouseMove",function(e,t){if(e){if(scheduler._events[e].relatedTo||scheduler._events[e].relatedFather){var i=$(scheduler.getRenderedEvent(e)).find(".ServiceEvent"),n=null;if(0===i.length&&(i=$(scheduler.getRenderedEvent(e))),scheduler._events[e].relatedFather?0===(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)).find(".ServiceEvent")).length&&(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather))):0===(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)).find(".ServiceEvent")).length&&(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo))),scheduler._hover=e,i&&n){if($(i).hasClass("hoverRelated"))return;$(i).addClass("hoverRelated"),$(n).addClass("hoverRelated")}}}else scheduler._hover&&($(".dhx_cal_event_line, .ServiceEvent").removeClass("hoverRelated"),scheduler._hover=null)}),scheduler.templates.ZoomLevel2_scale_date=function(e){var t=e.getHours(),i=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+":"+i+" AM":12===t?formatNumberToLocaleString(12)+":"+i+" PM":12<t?formatNumberToLocaleString(t-12)+":"+i+" PM":formatNumberToLocaleString(t)+":"+i+" AM":formatNumberToLocaleString(t)+":"+i},scheduler.templates.ZoomLevel3_scale_date=function(e){var t=e.getHours(),i=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+" AM":12==t?formatNumberToLocaleString(12)+" PM":12<t?formatNumberToLocaleString(t-12)+" PM":formatNumberToLocaleString(t)+" AM":(e.getHours()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getHours()):formatNumberToLocaleString(e.getHours()))+":"+i},scheduler.templates.ZoomLevel4_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel5_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel6_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel7_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel4_cell_class=function(e,t,i){var n="";!i.children&&shouldSeparateCell(t)&&(n+="BorderForDayChange ");var r=t.getDay();return!i.children&&window.__currentViewOptions.highlightWeekeneds&&(6===r?n+=" color-weekends":0===r&&1===window.firstDayOfTheWeek?n+=" color-weekends":5===r&&0===window.firstDayOfTheWeek&&(n+=" color-weekends")),n},scheduler.templates.ZoomLevel2_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel3_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel5_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel6_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel7_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.MTDView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.LongView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel4_second_scalex_class=function(e){if(window.__currentViewOptions.highlightWeekeneds){var t=e.getDay();if(6===t)return"color-weekends-date";if(0===t&&1===window.firstDayOfTheWeek)return"color-weekends-date";if(5===t&&0===window.firstDayOfTheWeek)return"color-weekends-date"}},scheduler.templates.ZoomLevel2_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel3_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel5_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel6_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel7_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel2_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.ZoomLevel3_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.ZoomLevel4_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.ZoomLevel5_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.ZoomLevel6_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.ZoomLevel7_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.MTDView_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.LongView_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.templates.MonthlyView_scalex_class=scheduler.templates.ZoomLevel2_second_scalex_class,scheduler.filter_ZoomLevel1=i,scheduler.filter_ZoomLevel2=i,scheduler.filter_ZoomLevel3=i,scheduler.filter_ZoomLevel4=i,scheduler.filter_ZoomLevel5=i,scheduler.filter_ZoomLevel6=i,scheduler.filter_ZoomLevel7=i,scheduler.filter_LongView=function(e,t,i){var n=!(2<arguments.length&&void 0!==i)||i;if(t instanceof ResourceCapacity&&t.timePeriod===capacityDurationFilter)return!0;if(n&&contractorSupport&&t.resourceContractor)return!1;if(window.__gantt.shouldShowLongTermError())return!1;if("break"===t.type)return!1;var r=(t.finish-t.start)/1e3/60/60;if(window.__currentViewOptions.showMdt){var s=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField;return"na"===t.type&&r>=window.__currentViewOptions.minNaDuration||"service"===t.type&&r>=window.__currentViewOptions.minServiceDuration&&t.fields[s]}return"na"===t.type&&r>=window.__currentViewOptions.minNaDuration||"service"===t.type&&r>=window.__currentViewOptions.minServiceDuration},scheduler.filter_MonthlyView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter},scheduler.filter_MTDView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter||t.isMDT||"na"===t.type},scheduler.ignore_ZoomLevel3=e,scheduler.ignore_ZoomLevel4=e,scheduler.ignore_ZoomLevel5=e,scheduler.ignore_ZoomLevel6=e,scheduler.ignore_ZoomLevel7=e,scheduler.ignore_MonthlyView=function(e){return o(e)},scheduler.ignore_LongView=scheduler.ignore_MonthlyView,scheduler.ignore_MTDView=scheduler.ignore_MonthlyView,{isDateInsideWeekend:o}}function shouldSeparateCell(e){var t=getMinAndMaxHoursToDisplay();switch(scheduler._mode){case"ZoomLevel4":t.max-=2;break;case"ZoomLevel5":t.max-=4;break;case"ZoomLevel6":case"ZoomLevel7":t.max-=6}if("ZoomLevel2"===scheduler._mode&&23===e.getHours()&&30===e.getMinutes())return!0;if(e.getHours()===t.max){var i=new Date(e);if(i.setHours(i.getHours()+24),i<=scheduler._max_date)return!0}return!1}function getXPositionOfEvent(e,t,i){var n=0,r=i._step,s=i.round_position,a=0,o=t?e.end_date:e.start_date;o.valueOf()>scheduler._max_date.valueOf()&&(o=scheduler._max_date);var c=o-scheduler._min_date_timeline;if(0<c){var l=scheduler._get_date_index(i,o);scheduler._ignores[l]&&(s=!0);for(var d=0;d<l;d++)n+=scheduler._cols[d];var u=scheduler.date.add(scheduler._min_date_timeline,scheduler.matrix[scheduler._mode].x_step*l,scheduler.matrix[scheduler._mode].x_unit);s?+u<+o&&t&&(a=scheduler._cols[l]):(c=o-u,i.first_hour||i.last_hour?((c-=i._start_correction)<0&&(c=0),(a=Math.round(c/r))>scheduler._cols[l]&&(a=scheduler._cols[l])):a=Math.round(c/r))}return n+=t?0===c||s?a-14:a-12:a+1}function getResourceEventsIds(e,t,i){var n=[];for(var r in scheduler._events)"service"==scheduler._events[r].type&&scheduler._events[r].start_date>=e&&scheduler._events[r].end_date<=t&&scheduler._events[r].resourceId==i&&(n.push(r),scheduler._events[r].relatedTo&&n.push(scheduler._events[r].relatedTo),scheduler._events[r].relatedFather&&n.push(scheduler._events[r].relatedFather));return n}function setCapacityFilter(e,t){contractorSupport&&(capacityDurationFilter=e,t&&scheduler._is_initialized()&&updateViewDebounced())}function cantLoadGantt(e){$(".keypressEvents")&&($(".bodyDiv").css("background","#fff"),$(".keypressEvents").remove(),$("#ErrorLoadingGantt").show()),$("#ErrorContainer").append(e),-1<e.toUpperCase().indexOf("CPU TIME")?($("#OpenTerritoryButton").show(),$("#OpenTerritoryMessage").show(),$("#OpenTerritoryButton").click(function(){__openLocationFilteringAndReload()})):($("#OpenTerritoryButton").hide(),$("#OpenTerritoryMessage").hide())}function getLocationdIdByResource(e){for(var t=scheduler.serverList("resources"),i=0;i<t.length;i++)for(var n=0;n<t[i].children.length;n++)if(e.split(",")[0]===t[i].children[n].key)return t[i].key;return null}function absenceTypeIcon(e){return"break"===e?'<svg aria-hidden="true" class="slds-icon tooltipBreakIcon">\n                    <use xlink:href="'+lsdIcons.break+'"></use>\n                </svg>':'<svg aria-hidden="true" class="slds-icon tooltipNAIcon">\n                <use xlink:href="'+lsdIcons.na+'"></use>\n            </svg>'}function getClassByStatus(e){switch(e){case globalCategories.NONE:return"eventStatusNew";case globalCategories.SCHEDULED:return"eventStatusAssigned";case globalCategories.DISPATCHED:return"eventStatusDispatched";case globalCategories.IN_PROGRESS:return"eventStatusTravel";case globalCategories.RUNNING_LONG:return"eventStatusOnSite";case globalCategories.COMPLETED:return"eventStatusCompleted";case globalCategories.MISSED:return"eventStatusIncomplete";case globalCategories.COULD_NOT_COMPLETE:return"eventStatusCouldntComplete";case globalCategories.CANCELED:return"eventStatusCancelled";default:return"eventCustomStatus"}}function getMinAndMaxHoursToDisplay(){var e=minHourToDisplay,t=maxHourToDisplay,i=null;switch(scheduler._mode){case"ZoomLevel4":i=2;break;case"ZoomLevel5":i=4;break;case"ZoomLevel6":case"ZoomLevel7":i=6}if(null!==i){e-=e%i;var n=i-t%i;n!==i&&(t+=n)}return{min:e,max:t}}function isIntersect(e,t,i,n){return e<n&&i<t}function isIntersectIncludeLimits(e,t,i,n){return e<=n&&i<=t}function isMultipleIntersection(e,t){for(var i=0;i<t.length;i++)if(isIntersect(e.start,e.finish,t[i].start,t[i].finish))return!0;return!1}function generateGanttTextColor(e){return parseInt("0x888888",16)<parseInt("0x"+e,16)?"000000":"ffffff"}function formatNumberToLocaleString(e){try{return e.toLocaleString(jsUserLocale)}catch(e){console.warn("Something wrong with your locale settings: "+jsUserLocale)}return e}function formatDateByLocaleWithDayOfTheWeek(e){var t=utils.formatDateWithDayOfWeek(e);if(t)return t;return-1!==["en_US"].indexOf(userLocale)?moment(e).format("ddd, MMM D YYYY"):moment(e).format("LL")}function generateHoursMinutes(e){if(e<60)return customLabels.MinutesGanttTooltip.replace("$0",e);var t=e%60,i=Math.floor(e/60);return customLabels.MinutesHoursGanttTooltip.replace("$0",i).replace("$1",t)}function removeLightboxLoading(){$("#lightbox-loading-cover").remove()}$(function(){$("body").keydown(function(e){ctrlPressed=e.ctrlKey,updateTimesToSnapIn()}).keyup(function(e){ctrlPressed=!1,updateTimesToSnapIn()})}),$(function(){moment.locale(userLocale)}),$(function(){svg4everybody(),"function"==typeof srcUp&&$("body").css("margin","0")}),scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.ZoomLevel1_second_scale_date=function(e){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.MonthlyView_second_scale_date=function(e){return moment(e).format("MMM")},scheduler.templates.MTDView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.LongView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.ZoomLevel2_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel3_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel4_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel5_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel6_second_scale_date=function(e){return moment(e).format("ddd,  D")},scheduler.templates.ZoomLevel7_second_scale_date=scheduler.templates.ZoomLevel6_second_scale_date,scheduler.templates.ZoomLevel2_date=function(e,t){return e.getDate()!==t.getDate()?formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t):formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel3_date=function(e,t){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel4_date=function(e,t){var i=new Date(t);return i.setDate(i.getDate()-1),formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(i)},scheduler.templates.ZoomLevel5_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel6_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel7_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MTDView=scheduler.templates.ZoomLevel4_date,scheduler.templates.LongView=scheduler.templates.ZoomLevel4_date}),$(function(){-1<window.navigator.userAgent.indexOf("Edge")&&(document.body.className+=" EdgeBrowser")});var BrickBreaker=($.fn.visible=function(e){var t=$(this),i=$(window),n=i.scrollTop(),r=n+i.height(),s=t.offset().top,a=s+t.height();return(!0===e?s:a)<=r&&n<=(!0===e?a:s)},{play:function(){var s=function(){for(var e={scheduled:"#F9D058",new:"#A5E2D6",dispatched:"#8DD8FA",inprogress:"#D68EF9",completed:"#95D055",incomplete:"#EA8288",default:"#B7C9EA"},t=[],i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),n=0;n<i.length;n++){var r=i[n],s=void 0,a=void 0,o=$(scheduler.getRenderedEvent(r.id));o.visible()&&(a=$(o.children()[0]).width(),"service"==r.type?s=e[r.Status.toLowerCase().replace(" ","")]:"break"==r.type?(s="#5e698f",a=o.width()):"na"==r.type&&(s="#d7dfe7"),t.push({color:s,top:o.offset().top-264,left:o.offset().left-$("#LeftSideContainer").width()+8,width:a,height:scheduler.matrix.ZoomLevel3.event_dy-2,name:r.name,status:1}))}return t}();gameOn=!0,updateViewDebounced(),$("#GanttContainer").append('<div id="bricks-overlay" style="position:absolute; top:100px; z-index:100">\n                                            <canvas id="brick-canvas"></canvas>\n                                        </div>');var e=$(".dhx_cal_data"),t=e.width(),i=e.height(),n=document.getElementById("brick-canvas");n.width=t,n.height=i;var a=n.getContext("2d"),r=15,o=n.width/2,c=n.height-30,l=5,d=-5,u=15,p=95,v=($("body").width()-p)/2,m=!1,h=!1,g=0,f=3;function S(e){var t=e.clientX-n.offsetLeft;0<t&&t<n.width&&(v=t-p/2)}function _(){gameOn=!1,document.removeEventListener("mousemove",S),updateViewDebounced(),$("#bricks-overlay").remove()}return 15<$(".item").length||$(".item").length,document.addEventListener("mousemove",S,!1),function e(){if(a.clearRect(0,0,n.width,n.height),function(){for(var e=0;e<s.length;e++)if(0!=s[e].status){var t=s[e].left,i=s[e].top,n=s[e].width,r=s[e].height;a.beginPath(),a.rect(t,i,n,r),a.fillStyle=s[e].color,a.fill(),40<=n&&(a.font="10px Salesforce Sans",a.fillStyle="#000",a.fillText(s[e].name,t+5,i+10)),a.closePath()}}(),a.beginPath(),a.arc(o,c,r,0,2*Math.PI),a.fillStyle="#0095DD",a.fill(),a.closePath(),a.beginPath(),a.rect(v,n.height-u,p,u),a.fillStyle="#0095DD",a.fill(),a.closePath(),function(){for(var e=0;e<s.length;e++){var t=s[e];if(1==t.status&&o>=t.left&&o<=t.left+t.width&&c>=t.top&&c<=t.top+t.height&&(d=-d,t.status=0,(g+=10)/10==s.length))return alert("You win, great... ¯\\_(ツ)_/¯. back to work"),_()}}(),a.font="16px Salesforce Sans",a.fillStyle="#0095DD",a.fillText("Score: "+g+", Lives: "+f,t/2,25),(o+l>n.width-r||o+l<r)&&(l=-l),c+d<r)d=-d;else if(c+d>n.height-r)if(v<o&&o<v+p)d=-d;else{if(!--f)return alert("GAME OVER - back to work"),void _();o=n.width/2,c=n.height-30,d=-(l=5),v=(n.width-p)/2}m&&v<n.width-p?v+=7:h&&0<v&&(v-=7),o+=l,c+=d,requestAnimationFrame(e)}(),"GAME ON!"}}),schedulerConfig=function(){var e={dateTitleFormat:"%D, %F %d",dateFormat:"%g:%i%A",resourceCellSize:170,locationCellHeight:44,rowHeight:46,eventHeight:42,sort:t};function t(e,t){var i=new Date(e.start_date),n=new Date(e.end_date),r=new Date(t.start_date),s=new Date(t.end_date);return"na"===e.type&&"na"!==t.type?(s<i||n<r)&&+r<+i?1:-1:"na"===t.type&&"na"!==e.type?n<r||s<i?+r<+i?1:-1:1:+r<+i?1:-1}return{timelineConfigs:e,configTimelines:function(){scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel2",x_unit:"minute",x_date:e.dateFormat,x_step:30,x_size:16,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel3",x_unit:"minute",x_date:e.dateFormat,x_step:60,x_size:24,x_start:0,x_length:24,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel4",x_unit:"minute",x_date:e.dateFormat,x_step:120,x_size:24,x_start:0,x_length:12,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel5",x_unit:"minute",x_date:e.dateFormat,x_step:240,x_size:18,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel6",x_unit:"minute",x_date:e.dateFormat,x_step:360,x_size:28,x_start:0,x_length:4,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel7",x_unit:"minute",x_date:e.dateFormat,x_step:720,x_size:28,x_start:0,x_length:2,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MonthlyView",x_unit:"day",x_date:"%d",x_step:1,x_size:14,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MTDView",x_unit:"day",x_date:"%d",x_step:1,x_size:35,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"LongView",x_unit:"day",x_date:"%d",x_step:1,x_size:20,x_start:0,x_length:7,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort})},setRowHeights:function(e,t){var i=32;switch(e){case"xsmall":i=27;break;case"small":i=32;break;case"normal":i=39;break;case"large":i=46;break;default:i=39}if(scheduler.matrix.ZoomLevel3.dy!==i){for(var n in scheduler.matrix)scheduler.matrix[n].dy=i,scheduler.matrix[n].event_dy=i-4,scheduler.matrix[n].folder_dy=i+2;t&&scheduler._is_initialized()&&scheduler.setCurrentView()}},setReadOnly:function(e){scheduler.config.readonly=e},setConfigurations:function(){scheduler.config.drag_resize=!1,scheduler.config.multisection=!0,scheduler.config.multisection_shift_all=!1,scheduler.config.limit_drag_out=!1,scheduler.config.dblclick_create=!1,scheduler.config.mark_now=!1,scheduler.config.time_step=1,scheduler.dhtmlXTooltip.config.className="dhtmlXTooltip tooltip expertTooltip",scheduler.dhtmlXTooltip.config.timeout_to_display=375,scheduler.dhtmlXTooltip.config.delta_x=10,scheduler.dhtmlXTooltip.config.delta_y=0,scheduler.config.minicalendar.mark_events=!1,scheduler.config.preserve_length=!1},sortEvents:t}}();scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.calendar_month=function(e){return-1!=["en_US","en_GB"].indexOf(userLocale)?moment(e).format("MMMM YYYY"):moment(e).format("LL")},scheduler.templates.calendar_date=function(e){return moment(e).format("DD")},scheduler.templates.calendar_scale_date=function(e){return moment(e).format("ddd")},scheduler.templates.calendar_time=function(e){return moment(e).format("l")}});